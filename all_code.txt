--- Directory Structure ---
./all_code.txt


Below is the absolute content of all relevant source files in the current folder.
IMPORTANT: DO NOT WRITE ANY CODE! YOU ARE TO DISCUSS THIS CODE ONLY, NOT ATTEMPT TO CHANGE IT!

--- File Contents ---



--- START OF FILE ./backend_addon_fix.md ---


# ðŸš¨ CRITICAL BACKEND BUG: Add-On Duplication

## Severity: High
**Impact:** Updating event add-ons duplicates them in the database instead of updating existing records. This leads to data bloat and potentially incorrect inventory tracking.

## The Issue
When a `PATCH /events/:id` request is sent with an `addOns` array:
1.  The backend appears to be iterating through the list and executing `INSERT` for every item.
2.  It fails to check if the item already exists (via ID) to perform an `UPDATE`.
3.  It fails to remove items that are no longer in the list (if the list represents the full state).

## Frontend Change Applied
The frontend has been updated to **explicitly include the `id` field** in the `addOns` payload objects when an item already exists.

**New Payload Format:**
```json
{
  "addOns": [
    {
      "id": "8f52d871-...",  <-- NOW INCLUDED
      "name": "VIP",
      "price": 20,
      "quantity_total": 1000,
      "min_donation": 10
    },
    {
      "name": "New Merch",   <-- NO ID (New Item)
      "price": 50
    }
  ]
}
```

## Required Backend Fixes

Please update the `PATCH /events/:id` handler logic for `addOns` (and `inventory` if similar logic applies):

1.  **Check for ID:**
    *   Iterate through the incoming `addOns` array.
    *   **If `id` is present:** Execute an `UPDATE inventory SET ... WHERE id = ?`.
    *   **If `id` is missing:** Execute an `INSERT INTO inventory ...`.

2.  **Handle Removals (Smart Sync):**
    *   The frontend sends the *entire* list of active add-ons.
    *   Identify IDs currently in the database for this event (category='ADD_ON') that are **NOT** in the incoming payload.
    *   **Delete** or **Archive** these missing records to prevent orphans.

3.  **Snake Case Mapping:**
    *   Ensure `minDonation` from frontend maps to `min_donation` in DB.
    *   Ensure `quantityTotal` maps to `quantity_total`.

## Verification Steps
1.  Create an event with 1 add-on.
2.  Edit the event, change the add-on's price, and save.
3.  **Success:** `GET /events/:id` should return 1 updated add-on, not 2.

--- END OF FILE ./backend_addon_fix.md ---




--- START OF FILE ./index.tsx ---


import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { GoogleOAuthProvider } from '@react-oauth/google';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
    <GoogleOAuthProvider clientId="660270935217-u1c4tntq4d5brpjr3i28c12rl0fpouol.apps.googleusercontent.com">
        <App />
    </GoogleOAuthProvider>
);

--- END OF FILE ./index.tsx ---




--- START OF FILE ./App.tsx ---


import React, { Suspense, useState, useEffect } from 'react';
import { BrowserRouter, Routes, Route, useLocation, useNavigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import Header from './components/Header';
import Home from './pages/Home';
import EventDetails from './pages/EventDetails';
import HostPage from './pages/HostPage';
import EventAdmin from './pages/EventAdmin';
import Settings from './pages/Settings';
import UserPortal from './pages/UserPortal';
import HostPortal from './pages/HostPortal';
import PromoterPortal from './pages/PromoterPortal';
import ProfilePage from './pages/ProfilePage';
import PublicFormPage from './pages/PublicFormPage';
import { useGoogleOneTapLogin } from '@react-oauth/google';
import { jwtDecode } from "jwt-decode";
import * as api from './services/api';
import { ShieldIcon } from './components/Icons';

// Lazy load System Admin to isolate code
const SystemAdmin = React.lazy(() => import('./pages/SystemAdmin'));

// AppContent uses useLocation to determine the background style
export const AppContent: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate(); // Use hook inside component within Router context
  const { login, user, refreshUser, isLoading } = useAuth();
  
  // Maintenance Mode State
  const [isMaintenanceMode, setIsMaintenanceMode] = useState(false);

  useEffect(() => {
      // Catch error here to prevent app crash if API returns 401 (Unauthorized) for public users
      api.getSystemSettings()
          .then(settings => {
              setIsMaintenanceMode(settings.maintenanceMode);
          })
          .catch(err => {
              // Only log if it's not a 403 (Forbidden) which is currently expected for non-admins
              if (!err.message.includes('403') && !err.message.includes('Forbidden')) {
                  console.warn("Failed to fetch system settings:", err.message);
              }
              setIsMaintenanceMode(false);
          });
  }, []);

  // Determine if we are on a public form page
  const isPublicForm = location.pathname.startsWith('/form/');

  // Google One Tap Implementation
  useGoogleOneTapLogin({
    onSuccess: async (credentialResponse) => {
        if (credentialResponse.credential) {
            const token = credentialResponse.credential;
            const decoded: any = jwtDecode(token);
            if (decoded.email) {
                const email = decoded.email;
                const name = decoded.name || email.split('@')[0];
                
                try {
                    // Try to login directly, passing decoded info to help backend
                    const loggedInUser = await login('google-one-tap', token, { name, email });
                    
                    // FIX: Ensure actual user info is saved if backend used placeholders
                    if (loggedInUser) {
                        const isPlaceholder = 
                            loggedInUser.name === 'Google User' || 
                            loggedInUser.email.includes('placeholder') ||
                            loggedInUser.email.includes('fake');
                        
                        // Also update if details don't match Google data (and we trust Google data more for login)
                        const mismatch = loggedInUser.email !== email || (loggedInUser.name !== name && name);

                        if (isPlaceholder || mismatch) {
                            try {
                                console.log("Updating user profile with Google data...");
                                await api.updateUser(loggedInUser.id, { name, email });
                                await refreshUser();
                            } catch (updateErr) {
                                console.warn("Failed to auto-update user details after Google login", updateErr);
                            }
                        }
                    }
                    
                    // Check for pending checkout
                    const pendingEventId = sessionStorage.getItem('pendingCheckoutEventId');
                    if (pendingEventId) {
                        const pendingPromo = sessionStorage.getItem('pendingCheckoutPromoCode');
                        if (pendingPromo) {
                            navigate(`/event/${pendingEventId}?promo=${pendingPromo}`);
                        } else {
                            navigate(`/event/${pendingEventId}`);
                        }
                    }
                } catch (e) {
                    // Login failed, assumes user needs registration.
                    // Automatically register with default 'attendee' role (api.registerUser also auto-creates host profile)
                    try {
                        await api.registerUser(email, name, 'attendee');
                        // Login again with explicit info
                        await login('google-one-tap', token, { name, email });
                        
                        // Check for pending checkout
                        const pendingEventId = sessionStorage.getItem('pendingCheckoutEventId');
                        if (pendingEventId) {
                            const pendingPromo = sessionStorage.getItem('pendingCheckoutPromoCode');
                            if (pendingPromo) {
                                navigate(`/event/${pendingEventId}?promo=${pendingPromo}`);
                            } else {
                                navigate(`/event/${pendingEventId}`);
                            }
                        }
                    } catch (regError) {
                        console.error("Auto-registration failed", regError);
                    }
                }
            }
        }
    },
    onError: () => {
        console.log('Google One Tap Login Failed');
    },
    disabled: !!user, // Do not show if user is already logged in
  });
  
  // Show loading spinner while restoring session
  if (isLoading) {
      return (
          <div className="flex items-center justify-center h-screen bg-[#0a0a0a]">
              <div className="w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
          </div>
      );
  }
  
  // Determine if the current page renders its own background (like a blurred hero image).
  // We exclude the event admin pages (containing '/admin/') so they use the standard dark background.
  const isDetailsPage = 
    (location.pathname.startsWith('/event/') && !location.pathname.includes('/admin/')) || 
    location.pathname.startsWith('/host/') || 
    location.pathname.startsWith('/profile/') ||
    location.pathname === '/';
  
  // System admin route has its own layout structure
  const isSystemAdminRoute = location.pathname.startsWith('/system-admin');
  
  // Should we show maintenance banner?
  // Hide if: Not maintenance mode OR User is on System Admin Route OR User is a System Admin
  const showMaintenanceBanner = isMaintenanceMode && !isSystemAdminRoute && !user?.isSystemAdmin;

  // For the event/host/profile details pages, the background is transparent to allow their custom blurred background to show.
  // For all other pages, a default dark background is applied.
  const backgroundClass = (isDetailsPage || isPublicForm) ? '' : 'bg-[#0a0a0a]';

  return (
    <div className={`min-h-screen w-full ${backgroundClass}`}>
      {showMaintenanceBanner && (
          <div className="fixed top-0 left-0 right-0 h-10 bg-yellow-500 text-black z-[100] flex items-center justify-center font-bold text-sm px-4">
              <ShieldIcon className="w-4 h-4 mr-2" />
              Maintenance Mode Active - Some features may be unavailable.
          </div>
      )}
      
      {!isSystemAdminRoute && !isPublicForm && (
          <div className={showMaintenanceBanner ? "pt-10" : ""}>
              <Header />
          </div>
      )}
      
      <main className={(!isSystemAdminRoute && !isPublicForm) ? "pt-20" : ""}>
        <Routes>
          <Route path="/" element={<Home />} />
          <Route path="/event/:id/admin/:tab" element={<EventAdmin />} />
          <Route path="/event/:id" element={<EventDetails />} />
          <Route path="/host/:id" element={<HostPage />} />
          <Route path="/profile/:id" element={<ProfilePage />} />
          <Route path="/form/:id" element={<PublicFormPage />} />
          <Route path="/my-tickets" element={<UserPortal />} />
          <Route path="/events" element={<HostPortal />} />
          <Route path="/promotions" element={<PromoterPortal />} />
          <Route path="/settings" element={<Settings />} />
          <Route 
            path="/system-admin/*" 
            element={
              <Suspense fallback={<div className="flex items-center justify-center h-screen bg-[#050505] text-white">Loading System Admin...</div>}>
                <SystemAdmin />
              </Suspense>
            } 
          />
        </Routes>
      </main>
    </div>
  );
};


const App: React.FC = () => {
  return (
    <AuthProvider>
      <BrowserRouter>
        <AppContent />
      </BrowserRouter>
    </AuthProvider>
  );
};

export default App;

--- END OF FILE ./App.tsx ---




--- START OF FILE ./backend_order_fix.md ---

# ðŸš¨ CRITICAL BACKEND BUG: Orders Stuck in 'Pending'

## Analysis of Logs (Req-7y)
**Timestamp:** `15:50:44`
**Endpoint:** `GET /eventsta/orders/mine`
**Response Payload:**
```json
[
  {
    "orderId": "f7e796a6-3f1f-42d1-8c6a-1bdd81870165",
    "status": "Pending", 
    "totalPaid": 11.94,
    ...
  },
  {
    "orderId": "7b1b122c-b98b-48c5-95b2-5bcafbedcc2f",
    "status": "Pending",
    "totalPaid": 11.94,
    ...
  }
]
```

## Issue
Orders are being created successfully (`200 OK` response) but remain in the `Pending` state indefinitely. 
This indicates the payment confirmation logic (Webhook or Post-Payment processing) is not firing or failing to update the `Order` table status to `Completed`.

The frontend treats `Pending` orders as "Processing", which prevents the user from accessing their QR code.

## Required Fixes

### 1. Fix Status Transition
Ensure that when a payment is successful (Stripe `payment_intent.succeeded`), the database record for that Order is updated:
`UPDATE orders SET status = 'Completed' WHERE order_id = ...`

### 2. Check Webhooks
Verify that your local or staging environment is receiving Stripe webhooks. If not, the status will never update.

### 3. (Optional) Manual Finalize Endpoint
If webhooks are unreliable in this environment, expose an endpoint `POST /orders/:id/finalize` that checks the Stripe status on-demand and updates the database. The frontend can call this immediately after the client-side checkout flow completes.
--- END OF FILE ./backend_order_fix.md ---




--- START OF FILE ./contexts/AuthContext.tsx ---


import React, { createContext, useState, useContext, ReactNode, useEffect } from 'react';
import { User } from '../types';
import * as api from '../services/api';

interface AuthContextType {
  user: User | null;
  isAuthenticated: boolean;
  login: (provider: string, credentials?: string, userInfo?: { name?: string; email?: string }) => Promise<User | null>;
  logout: () => void;
  isLoading: boolean;
  refreshUser: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState<boolean>(true);

  // Restore session on mount
  useEffect(() => {
    const restoreSession = async () => {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        setIsLoading(false);
        return;
      }

      try {
        const userData = await api.getUserProfile();
        setUser(userData);
      } catch (error) {
        console.warn("Failed to restore session:", error);
        localStorage.removeItem('auth_token');
        setUser(null);
      } finally {
        setIsLoading(false);
      }
    };

    restoreSession();
  }, []);

  const login = async (provider: string, credentials?: string, userInfo?: { name?: string; email?: string }): Promise<User | null> => {
    setIsLoading(true);
    try {
      const userData = await api.signIn(provider, credentials, userInfo);
      setUser(userData);
      return userData;
    } catch (error) {
      console.error("Login failed", error);
      setUser(null);
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  const logout = () => {
    localStorage.removeItem('auth_token');
    setUser(null);
  };
  
  const refreshUser = async () => {
      if (user) {
          try {
            const updatedUser = await api.getUserProfile();
            setUser(updatedUser);
          } catch(e) {
              console.error("Failed to refresh user", e);
          }
      }
  }

  return (
    <AuthContext.Provider value={{ user, isAuthenticated: !!user, login, logout, isLoading, refreshUser }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = (): AuthContextType => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

--- END OF FILE ./contexts/AuthContext.tsx ---




--- START OF FILE ./api_url_migration.md ---

# Backend API Migration: URL Structure Update

## ðŸš¨ Action Required

This document outlines a critical change to the API's base URL structure. The backend routing and any services that generate absolute URLs (e.g., file uploads, email links) must be updated to reflect this new standard.

## 1. URL Structure Change

The API endpoint structure has been migrated to a versioned path on the main domain, removing the non-standard port.

### Old URL Structure
- **Base Path:** `https://api.eventsta.com:8181/eventsta`
- **Example:** `https://api.eventsta.com:8181/eventsta/events/some-event-id`

### New URL Structure
- **Base Path:** `https://eventsta.com/api/v1`
- **Example:** `https://eventsta.com/api/v1/events/some-event-id`

## 2. Required Server-Side Changes

### a. API Gateway / Router Configuration
- The primary API router or gateway must be reconfigured to listen on the path `/api/v1` on the `eventsta.com` domain.
- Inbound traffic on port `8181` can be deprecated and eventually removed.
- Ensure your reverse proxy (e.g., Nginx, Apache) correctly routes requests from `https://eventsta.com/api/v1/*` to the application server.

### b. Absolute URL Generation
Any part of the backend that generates and returns a full, absolute URL must be updated. This is especially important for:

- **File Uploads (`/upload`):** The response from the file upload endpoint **must** return the complete, publicly accessible URL of the uploaded file, reflecting the new domain structure.
    - **Old Response (Incorrect):** `{ "url": "/uploads/image.jpg" }` or `{ "url": "https://api.eventsta.com/uploads/image.jpg" }`
    - **New Response (Correct):** `{ "url": "https://eventsta.com/uploads/image.jpg" }` (Assuming `/uploads` is the correct public path for assets).
        
- **Email Templates:** Any links in transactional or marketing emails (e.g., password reset links, "View Ticket" buttons) must be generated using the new base URL `https://eventsta.com`.

### c. CORS Configuration
- The `Access-Control-Allow-Origin` header must be updated to allow requests from the frontend's origin if it has changed.
- Ensure `OPTIONS` pre-flight requests are handled correctly for the new `/api/v1` path.

## Summary
All frontend requests will now target `https://eventsta.com/api/v1`. The backend must be updated to serve all API routes from this new base path.

--- END OF FILE ./api_url_migration.md ---




--- START OF FILE ./api_fixes_required.md ---

[ Skipped binary file ]

--- END OF FILE ./api_fixes_required.md ---




--- START OF FILE ./backend_fixes.md ---


# ðŸš¨ CRITICAL BACKEND BUGS: Data Persistence & Duplication

## 1. Ticket Inventory Persistence Failure
**Impact:** Tickets are not being saved or updated correctly. When a user updates tickets, the response echoes the changes, but subsequent GET requests show missing data or old data.

**Diagnosis:**
The backend `PATCH /events/:id` endpoint for `inventory` seems to rely on the presence of an `id` field to trigger an UPDATE.
*   The frontend was previously generating temporary UUIDs for new tickets, which the backend likely tried to UPDATE (finding no match) instead of INSERT.
*   **The frontend has been fixed** to send `id` ONLY if it matches an existing backend record. New tickets will have no `id`.

**Required Backend Logic (Inventory):**
*   **Iterate** through the incoming `inventory` array.
*   **If `id` is present:** Execute `UPDATE inventory SET ... WHERE id = ?`.
*   **If `id` is missing/null:** Execute `INSERT INTO inventory ...`.
*   **Handle Deletions:** If the incoming list is the "full source of truth", identify IDs present in DB but missing from payload, and DELETE or archive them.

## 2. Add-On Duplication
**Impact:** Editing an event duplicates its Add-Ons instead of updating them.

**Diagnosis:**
Similar to tickets, the backend was treating every add-on in the payload as a new item because the frontend was stripping IDs.
*   **The frontend has been fixed** to preserve IDs for existing add-ons.

**Required Backend Logic (AddOns):**
*   Same logic as Inventory: Update if ID exists, Insert if not.
*   Ensure `category` is set to 'ADD_ON' (or however your schema distinguishes them).
*   Map `min_donation` correctly.

## 3. Host Visibility (Drafts)
**Impact:** Draft events are not returned for hosts.
**Fix:** Ensure `GET /events?host_id=X&include_drafts=true` correctly bypasses the `status='PUBLISHED'` filter.

## 4. Promo Code Updates
**Impact:** Changing a promo code might break existing links.
**Recommendation:** Implement an alias system where the old code remains valid for tracking/redemption, but the new code becomes the primary display code.

--- END OF FILE ./backend_fixes.md ---




--- START OF FILE ./metadata.json ---

{
  "name": "Eventsta 4",
  "description": "A next-generation event discovery and hosting platform with a sleek, modern interface. Browse upcoming events, purchase tickets, host your own events, and manage promotions all in one place.",
  "requestFramePermissions": [
    "camera"
  ]
}
--- END OF FILE ./metadata.json ---




--- START OF FILE ./utils/url.ts ---


/**
 * Creates a URL-friendly slug combining the title and ID.
 * Example: "TidalRave Long Beach", "e1" -> "tidalrave-long-beach-e1"
 */
export const createEventSlug = (title: string, id: string): string => {
    if (!title) return id;
    
    const slug = title
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-') // Replace non-alphanumeric chars with hyphens
        .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
        
    return `${slug}-${id}`;
};

/**
 * Extracts the ID from a slug string.
 * Supports standard UUIDs (which contain hyphens).
 * Example UUID: "tidalrave-369fc337-7496-48f5-8fa4-7f122b17ebad" -> "369fc337-7496-48f5-8fa4-7f122b17ebad"
 */
export const extractEventId = (slugParam: string | undefined): string => {
    if (!slugParam) return '';
    
    // Check for UUID at the end of the string (8-4-4-4-12 hex chars)
    const uuidRegex = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
    const match = slugParam.match(uuidRegex);
    
    if (match) {
        return match[0];
    }
    
    // Strict fallback: Split by hyphen and take the last part, assuming backend always provides ID at end.
    const parts = slugParam.split('-');
    return parts[parts.length - 1];
};

--- END OF FILE ./utils/url.ts ---




--- START OF FILE ./backend_email_fix.md ---

# Backend API Change: Fix System Email Sender Name

## Issue
System emails are being sent with an `undefined` sender name.

**Example "From" Header:**
`From: undefined <noreply@eventsta.com>`

This appears unprofessional and can affect email deliverability.

## Root Cause
The backend service responsible for sending transactional emails is not correctly sourcing the `platformName` from the system settings when constructing the "From" header.

## Required Fix
The logic for sending emails must be updated to:
1.  Fetch the current system settings, specifically the `platformName` value.
2.  Use this value as the sender's name.
3.  Provide a safe fallback (e.g., "Eventsta") if the setting is somehow missing, to prevent sending `undefined`.

### Pseudo-code Example (Node.js with a generic email library)

```javascript
// Inside your email sending function...
async function sendTransactionalEmail(trigger, recipientEmail, variables) {
    // 1. Fetch System Settings
    // This could be from a cached config or a direct database/API call.
    const settings = await getSystemSettings(); // Assume this function exists

    // 2. Determine Sender Name with a Fallback
    const senderName = settings.platformName || "Eventsta"; 

    // Fetch and render the email template...
    const { subject, body } = await renderEmailTemplate(trigger, variables, settings);

    // 3. Construct the "From" header correctly
    const fromHeader = `"${senderName}" <noreply@eventsta.com>`;

    // 4. Send the email using your email provider (e.g., SendGrid, Mailgun)
    await emailProvider.send({
        to: recipientEmail,
        from: fromHeader, // Use the constructed header
        subject: subject,
        html: body
    });

    console.log(`Email sent. From: ${fromHeader}`);
}
```

## Verification
After deploying this change, trigger a system email (e.g., by creating a new account or resetting a password) and inspect the "From" field in the received email. It should now correctly display the platform name, for example: `From: Eventsta <noreply@eventsta.com>`.

--- END OF FILE ./backend_email_fix.md ---




--- START OF FILE ./README.md ---

<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/17R_ANpjHOyat60vNtl90lKoUPZkzl_Dd

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`

--- END OF FILE ./README.md ---




--- START OF FILE ./fix_backend_api.md ---

# ðŸš¨ CRITICAL BACKEND BUG REPORT: Draft Events Unreachable

## Severity: High
**Impact:** Hosts cannot see their own events in the dashboard if they are in 'DRAFT' status. This effectively breaks the event creation/publishing flow.

## The Issue
The frontend is correctly sending the query parameter `include_drafts=true` when fetching events for a host, but the API continues to return an empty array `[]`. This indicates the API is enforcing a `status = 'PUBLISHED'` filter regardless of the query parameter.

## Evidence from Logs
**Request:**
```http
GET /eventsta/events?host_id=4a96015a-6930-4b21-bc9c-5c55c59f87c8&include_drafts=true
```
**Response:**
```json
[]
```
*(The host `4a96015a...` has created events, but they are stuck in DRAFT status and thus invisible).*

## Required Fixes (For Backend Team)

Please update the `GET /events` endpoint handler immediately:

1.  **Parse Query Parameter:**
    Ensure you are checking `req.query.include_drafts`.
    *   *Note:* Query parameters are strings. Ensure your check handles `"true"` (string) and not just `true` (boolean).

2.  **Fix Filtering Logic:**
    The SQL/Database query logic must conditionally remove the status filter.
    
    *Current (Suspected) Logic:*
    ```sql
    SELECT * FROM events WHERE host_id = $1 AND status = 'PUBLISHED'
    ```

    *Required Logic:*
    ```javascript
    // Pseudo-code
    const { host_id, include_drafts } = req.query;
    
    let query = "SELECT * FROM events WHERE host_id = $1";
    const params = [host_id];

    // ONLY apply status filter if we are NOT explicitly asking for drafts
    if (include_drafts !== 'true') {
        query += " AND status = 'PUBLISHED'";
    }
    
    // execute(query, params)...
    ```

3.  **Verify Data Integrity:**
    Double check that `POST /events` is correctly saving the `host_id`. If `host_id` is null in the database, even the correct query will return nothing.

## Verification Steps
1.  Create an event via `POST /events`.
2.  Call `GET /events?host_id={...}&include_drafts=true`.
3.  **Success:** The API returns a JSON array containing the new draft event.

--- END OF FILE ./fix_backend_api.md ---




--- START OF FILE ./types.ts ---

// FIX: Removed self-import which caused declaration conflicts with local type definitions.

export interface Review {
  rating: number;
  comment: string;
  author: string;
  date: string;
}

export interface Host {
  id: string;
  name: string;
  ownerUserId: string;
  eventIds: string[];
  reviews: Review[];
  description?: string;
  imageUrl?: string;
  coverImageUrl?: string;
  isDefault?: boolean;
  reviewsEnabled?: boolean;
}

export interface TicketOption {
  id?: string; // Backend inventory ID
  type: string;
  price: number; // For ticketed events: fixed price. For fundraisers: recommended donation.
  minimumDonation?: number; // For fundraiser events: minimum donation required.
  description?: string;
  quantity?: number; // Total tickets available
  sold?: number; // Total tickets sold
  saleEndDate?: string; // Specific cutoff date for this ticket
  category?: 'TICKET' | 'ADD_ON'; // NEW: Unified inventory category
}

export interface AddOn {
  id?: string; // Backend ID
  name: string;
  price: number; // For ticketed events: fixed price. For fundraisers: recommended donation.
  minimumDonation?: number; // For fundraiser events: minimum donation required.
  description?: string;
  category?: 'TICKET' | 'ADD_ON'; // NEW: Unified inventory category
}

// NEW: Section type for artist profile pages
export interface ProfileSection {
  id: string;
  type: 'TEXT' | 'GALLERY' | 'SOUNDCLOUD' | 'YOUTUBE';
  // Using 'any' for simplicity, but could be a discriminated union
  // e.g. { title: string; body: string } for TEXT, { images: string[] } for GALLERY
  content: any; 
}

// UPDATED: Expanded artist profile to support a full public page
export interface ArtistProfile {
    bio?: string;
    genres?: string[];
    displayName?: string;
    profileImageUrl?: string;
    headerImageUrl?: string;
    sections?: ProfileSection[];
}


// NEW: Venue areas for scheduling (e.g., stages), now called "Sections"
export interface VenueArea {
    id: string;
    name: string;
}

// NEW: Schedule items for the event lineup
export interface ScheduleItem {
    id: string;
    areaId: string;
    title: string;
    startTime: string; // ISO format
    endTime: string; // ISO format
}

// --- NEW FORM BUILDER TYPES ---
export type FormElementType = 'SHORT_TEXT' | 'LONG_TEXT' | 'SINGLE_CHOICE' | 'MULTIPLE_CHOICE' | 'HEADER';

export interface FormElementOption {
    id: string;
    label: string;
}

export interface FormElement {
    id: string;
    type: FormElementType;
    label: string;
    placeholder?: string;
    required: boolean;
    options?: FormElementOption[]; // For choice types
    helpText?: string;
}

export interface CompetitionForm {
    id: string;
    title: string;
    description: string; // Rich text or plain text intro
    headerImageUrl?: string; // Used for parallax background
    elements: FormElement[];
    isActive: boolean;
    responsesCount: number;
    lastUpdated: string;
    linkedCompetitionId?: string; // NEW: Link to a competition
}
// ------------------------------

// UPDATED: Competition definition to support different types, statuses, and outcomes.
export interface Competition {
    id: string;
    type: 'DJ_TICKET_SALES';
    status: 'SETUP' | 'ACTIVE' | 'COMPLETED' | 'CANCELLED';
    name: string;
    description?: string;
    sectionIds: string[]; // Link to one or more VenueArea IDs
    competitorIds: string[]; // List of User IDs
    startDate: string; // ISO format
    cutoffDate: string; // ISO format
    promoDiscountPercent?: number; // Discount for the buyer
    commissionPercent?: number;    // NEW: Commission % for the competitor (Overrides event default)
    winnerIds?: string[]; // Array of user IDs, ordered by rank
    forms?: CompetitionForm[]; // DEPRECATED: Forms are now on Event level, kept for type safety during migration
}


export interface Event {
  id: string;
  status: 'DRAFT' | 'PUBLISHED'; // NEW: Visibility control
  title: string;
  hostId: string;
  hostName: string;
  date: string;
  endDate?: string;
  location: string;
  imageUrls: string[];
  description: string;
  commission: number; // The % the promoter earns
  defaultPromoDiscount: number; // The % discount the end user gets
  rating?: number;
  reviewCount?: number;
  // UPDATED/NEW Fields
  type: 'ticketed' | 'fundraiser';
  tickets: TicketOption[]; // For both 'ticketed' and 'fundraiser' events
  addOns?: AddOn[]; // For both 'ticketed' and 'fundraiser' events
  venueAreas?: VenueArea[]; // For sections/stages
  schedule?: ScheduleItem[];
  competitions?: Competition[]; // Replaces the old isCompetition flag
  forms?: CompetitionForm[]; // NEW: Forms are now managed at the event level
  checkIns?: Record<string, string>; // Map of ticketID -> timestamp
}

export interface PurchasedTicket {
  id: string;
  orderId: string; // Required for QR code validation
  eventId: string;
  eventName: string;
  ticketType: string;
  inventoryId?: string; // Helper to link back to the TicketOption
  qty: number;
  purchaseDate: string;
}

export interface PromoStat {
  eventId: string;
  eventName: string;
  promoLink: string;
  clicks: number;
  sales: number;
  commissionPct: number;
  earned: number;
  status: 'active' | 'past';
}

export interface Payout {
    id:string;
    date: string;
    amount: number;
    status: 'Completed' | 'Pending';
}

// NEW: Payout Request for Admin
export interface PayoutRequest {
    id: string;
    userId: string;
    userName: string;
    userEmail: string;
    amount: number;
    requestedDate: string;
    status: 'pending' | 'approved' | 'rejected';
}

export interface TeamMember {
    id:string;
    name: string;
    email: string;
    role: 'Admin' | 'Manager';
}

export interface NotificationPreferences {
    marketingEmails: boolean;
    transactionalEmails: boolean;
    promoterAlerts: boolean;
}

export interface User {
  id: string;
  name: string;
  email: string;
  managedHostIds: string[];
  purchasedTickets: PurchasedTicket[];
  promoStats: PromoStat[];
  payouts: Payout[];
  team?: TeamMember[];
  isArtist?: boolean;
  artistProfile?: ArtistProfile;
  // System Admin Fields
  isSystemAdmin?: boolean;
  isDisabled?: boolean;
  // Stripe Connect Fields
  stripeConnected?: boolean;
  stripeAccountId?: string | null;
  // Settings
  notificationPreferences?: NotificationPreferences;
}

export interface CheckoutCart {
  [itemName: string]: {
      quantity: number;
      donationAmount?: number; // For fundraisers
  };
}

export interface OrderLineItem {
    ticketType: string;
    quantity: number;
    pricePerTicket: number; // For tickets, this is fixed. For donations, this is the user's chosen amount.
    recipientUserId?: string; // The artist/competitor this donation/sale is for.
}

export interface Order {
    orderId: string;
    eventId: string;
    userId?: string; // The authenticated user ID of the purchaser (used to fetch details if name/email missing)
    purchaserName: string;
    purchaserEmail: string;
    purchaseDate: string;
    items: OrderLineItem[];
    totalPaid: number;
    status: 'Completed' | 'Refunded' | 'Pending';
    promoCode?: string;
    recipientUserId?: string;
    recipientUserName?: string; // NEW: The resolved name of the promoter/affiliate
    fees?: {
        mandatory: number;
        donation: number;
    };
}


export interface SalesByTicketType {
    type: string;
    quantitySold: number;
    grossSales: number;
}

export interface PromoterReport {
    userId: string;
    promoterName: string;
    artistName?: string; // Optional artist name
    isCompetitor: boolean;
    clicks: number;
    sales: number;
    earned: number;
    promoLink: string;
}

export interface PromoCode {
    id: string;
    eventId: string;
    code: string;
    discountPercent: number;
    uses: number;
    maxUses: number | null; // null for unlimited
    isActive: boolean;
    ownerUserId?: string;
    ownerName?: string; // NEW: For displaying "Supporting [Name]"
}

export interface ReportData {
    event: Event;
    kpis: {
        grossSales: number;
        ticketsSold: number;
        pageViews: number; // mocked
        promoterSales: number;
    };
    salesByTicketType: SalesByTicketType[];
    promotions: PromoterReport[];
}

// NEW: For the competition leaderboard
export interface LeaderboardEntry {
    userId: string;
    userName: string;
    salesCount: number;
    salesValue: number;
    lastSaleDate?: string;
}

// NEW: Email Manager Types
export type TargetRole = 'All Users' | 'Hosts' | 'Promoters' | 'Artists' | 'Admins';

export interface EmailDraft {
    id: string;
    name: string; // Internal name
    subject: string;
    body: string; // HTML content
    targetRole: TargetRole;
    lastModified: string;
}

export interface EmailCampaign {
    id: string;
    draftId: string;
    subject: string;
    body: string; // Snapshot of the email body at send time
    targetRole: TargetRole;
    status: 'PENDING' | 'SENDING' | 'COMPLETED' | 'CANCELLED' | 'FAILED';
    progress: number; // Number of emails sent
    total: number; // Total recipients
    startTime: string;
    endTime?: string;
    errors?: string[];
}

// NEW: System Email Types (Transactional)
export type SystemEmailTrigger = 
    | 'WELCOME_NEW_USER'
    | 'PASSWORD_RESET'
    | 'ORDER_CONFIRMATION'
    | 'PAYOUT_PROCESSED'
    | 'EVENT_REMINDER'
    | 'EVENT_CANCELLED'
    | 'NEW_LOGIN_ALERT'
    | 'TICKET_TRANSFER_RECEIVED';

export interface SystemEmailTemplate {
    trigger: SystemEmailTrigger;
    name: string;
    subject: string;
    body: string; // HTML content
    variables: string[]; // List of available variables for this template
}

// NEW: Host Financials
export interface HostFinancials {
    grossVolume: number;
    platformFees: number;
    netRevenue: number;
    pendingBalance: number;
    totalPayouts: number;
    payouts: Payout[];
}

// NEW: Global System Settings
export interface SystemSettings {
    platformName: string;
    supportEmail: string;
    platformFeePercent: number;
    platformFeeFixed: number;
    maintenanceMode: boolean;
    disableRegistration: boolean;
}

// NEW: Ledger Entry
export interface LedgerEntry {
    id: string;
    userId: string;
    type: 'COMMISSION' | 'PAYOUT' | 'CLAWBACK';
    amount: number;
    referenceId: string;
    description: string;
    status: 'CLEARED' | 'PENDING';
    createdAt: string;
}
--- END OF FILE ./types.ts ---




--- START OF FILE ./components/RatingDisplay.tsx ---

import React from 'react';
import { StarIcon } from './Icons';

export const RatingDisplay: React.FC<{ rating: number, reviewCount: number, size?: 'sm' | 'md' }> = ({ rating, reviewCount, size = 'md' }) => {
    const iconSize = size === 'sm' ? 'w-4 h-4' : 'w-5 h-5';
    
    return (
        <div className="flex items-center space-x-2">
            <div className="flex items-center">
                {[...Array(5)].map((_, i) => (
                    <StarIcon key={i} className={`${iconSize} ${i < Math.round(rating) ? 'text-yellow-400' : 'text-neutral-600'}`} />
                ))}
            </div>
            <span className={`font-semibold ${size === 'sm' ? 'text-sm' : 'text-base'} text-neutral-300`}>{rating.toFixed(1)}</span>
            <span className={`text-neutral-400 ${size === 'sm' ? 'text-xs' : 'text-sm'}`}>({reviewCount} reviews)</span>
        </div>
    );
};

--- END OF FILE ./components/RatingDisplay.tsx ---




--- START OF FILE ./components/TicketEditor.tsx ---

import React, { useState, useEffect, useRef } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { TicketOption } from '../types';
import { TrashIcon, PlusIcon, GripVerticalIcon, ChevronDownIcon } from './Icons';

interface Wrapper {
    data: TicketOption;
    uiKey: string;
}

interface TicketEditorProps {
    tickets: TicketOption[];
    onTicketsChange: (tickets: TicketOption[]) => void;
    isFundraiser?: boolean;
}

const EditableTicketItem: React.FC<{
    ticket: TicketOption,
    uiKey: string,
    isExpanded: boolean,
    onToggle: () => void,
    onUpdate: (key: string, field: keyof TicketOption, value: any) => void,
    onDelete: () => void,
    isFundraiser: boolean,
    // Drag props
    index: number;
    onDragStart: (index: number) => void;
    onDragEnter: (index: number) => void;
    onDragEnd: () => void;
    isDragging: boolean;
}> = ({ ticket, uiKey, isExpanded, onToggle, onUpdate, onDelete, isFundraiser, index, onDragStart, onDragEnter, onDragEnd, isDragging }) => {
    
    const soldCount = ticket.sold || 0;
    const maxCount = ticket.quantity;
    const hasCapacity = maxCount !== undefined && maxCount !== null;
    const percentage = hasCapacity && maxCount > 0 ? Math.min((soldCount / maxCount) * 100, 100) : 0;
    const isSoldOut = hasCapacity && soldCount >= maxCount;

    const formatDateForInput = (isoString?: string) => {
        if (!isoString) return '';
        const date = new Date(isoString);
        date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
        return date.toISOString().slice(0, 16);
    };

    return (
        <div 
            draggable
            onDragStart={() => onDragStart(index)}
            onDragEnter={() => onDragEnter(index)}
            onDragEnd={onDragEnd}
            onDragOver={(e) => e.preventDefault()}
            className={`bg-neutral-900 border rounded-2xl transition-all duration-300 group ${isExpanded ? 'border-purple-500 shadow-lg shadow-purple-500/10' : 'border-neutral-800 hover:border-neutral-700'} ${isDragging ? 'opacity-50 scale-105 shadow-2xl shadow-purple-500/20' : 'opacity-100'}`}>
            {/* --- Summary View (Header) --- */}
            <div 
                className="flex items-center p-4 cursor-pointer"
                onClick={onToggle}
            >
                <div className="text-neutral-500 cursor-grab p-2 -ml-2"><GripVerticalIcon className="w-5 h-5"/></div>
                
                <div className="flex-grow mx-4">
                    <div className="flex items-center gap-3">
                        <h4 className="font-bold text-white truncate">{ticket.type || 'Untitled Ticket'}</h4>
                        {isSoldOut && <span className="text-[10px] uppercase font-bold tracking-wider px-2 py-1 rounded-full border bg-red-500/10 text-red-400 border-red-500/20">Sold Out</span>}
                        {!isSoldOut && ticket.id && <span className="text-[10px] uppercase font-bold tracking-wider px-2 py-1 rounded-full border bg-green-500/10 text-green-400 border-green-500/20">Active</span>}
                    </div>
                    <div className="flex items-center gap-4 text-xs text-neutral-400 mt-2">
                        <span>{isFundraiser ? 'Suggested: ' : ''}<span className="font-mono font-semibold">${(ticket.price || 0).toFixed(2)}</span></span>
                        {hasCapacity && <span>Capacity: <span className="font-mono font-semibold">{maxCount}</span></span>}
                        {hasCapacity && (
                            <div className="flex items-center gap-2">
                                <span>Sales:</span>
                                <div className="w-16 h-1 bg-neutral-700 rounded-full overflow-hidden">
                                    <div className={`h-full ${isSoldOut ? 'bg-red-500' : 'bg-purple-500'}`} style={{width: `${percentage}%`}}></div>
                                </div>
                                <span className="font-mono text-neutral-500">{soldCount}</span>
                            </div>
                        )}
                    </div>
                </div>

                <div className="flex items-center">
                    <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="p-2 text-neutral-500 hover:text-red-400 rounded-lg hover:bg-neutral-800 opacity-0 group-hover:opacity-100 transition-opacity">
                        <TrashIcon className="w-5 h-5"/>
                    </button>
                    <ChevronDownIcon className={`w-6 h-6 text-neutral-500 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                </div>
            </div>

            {/* --- Expanded Form View --- */}
            <div className={`grid transition-all duration-300 ease-in-out ${isExpanded ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
                <div className="overflow-hidden">
                    <div className="border-t border-neutral-800 p-6 space-y-5">
                        {/* The full form from the original file */}
                        <div>
                            <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">
                                {isFundraiser ? 'Tier Name' : 'Ticket Name'}
                            </label>
                            <input type="text" value={ticket.type} onChange={e => onUpdate(uiKey, 'type', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 px-4 text-white font-medium" />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                             {isFundraiser ? (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Suggested Amount</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">$</span>
                                            <input type="number" value={ticket.price || ''} onChange={e => onUpdate(uiKey, 'price', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 pl-8 pr-4 text-white font-medium" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Minimum Amount</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">$</span>
                                            <input type="number" value={ticket.minimumDonation || ''} onChange={e => onUpdate(uiKey, 'minimumDonation', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 pl-8 pr-4 text-white font-medium" />
                                        </div>
                                    </div>
                                </>
                             ) : (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Price</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">$</span>
                                            <input type="number" value={ticket.price || ''} onChange={e => onUpdate(uiKey, 'price', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 pl-8 pr-4 text-white font-medium" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Capacity (Total Tickets)</label>
                                        <input type="number" placeholder="Unlimited" value={ticket.quantity || ''} onChange={e => onUpdate(uiKey, 'quantity', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 px-4 text-white font-medium" />
                                    </div>
                                </>
                             )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                             {isFundraiser && (
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Capacity (Total Donations)</label>
                                    <input type="number" placeholder="Unlimited" value={ticket.quantity || ''} onChange={e => onUpdate(uiKey, 'quantity', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 px-4 text-white font-medium" />
                                </div>
                            )}
                            <div className={!isFundraiser ? "md:col-span-2" : ""}>
                                <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Sales End Date (Optional)</label>
                                <input type="datetime-local" value={formatDateForInput(ticket.saleEndDate)} onChange={e => onUpdate(uiKey, 'saleEndDate', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 px-4 text-white font-medium" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Description</label>
                            <textarea placeholder="Includes skip-the-line access, free drink, etc..." value={ticket.description || ''} onChange={e => onUpdate(uiKey, 'description', e.target.value)} rows={2} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 px-4 text-white font-medium resize-none" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

const TicketEditor: React.FC<TicketEditorProps> = ({ tickets, onTicketsChange, isFundraiser = false }) => {
    const [wrappers, setWrappers] = useState<Wrapper[]>([]);
    const [expandedUiKey, setExpandedUiKey] = useState<string | null>(null);
    const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
    const dragItem = useRef<number | null>(null);
    const dragOverItem = useRef<number | null>(null);

    useEffect(() => {
        setWrappers(currentWrappers => {
            return tickets.map((ticket, index) => {
                // Find existing wrapper: 1. by stable ID, 2. by index for new items.
                let existing = ticket.id ? currentWrappers.find(w => w.data.id === ticket.id) : undefined;
                if (!existing && !ticket.id && currentWrappers[index] && !currentWrappers[index].data.id) {
                    existing = currentWrappers[index];
                }

                return {
                    data: ticket,
                    uiKey: existing?.uiKey || uuidv4() // Reuse uiKey if found, else generate new one
                };
            });
        });
    }, [tickets]);
    
    const updateParent = (newWrappers: Wrapper[]) => {
        const domainTickets = newWrappers.map(w => w.data);
        onTicketsChange(domainTickets);
    };

    const handleDragStart = (index: number) => {
        dragItem.current = index;
        setDraggingIndex(index);
    };

    const handleDragEnter = (index: number) => {
        dragOverItem.current = index;
    };
    
    const handleDragEnd = () => {
        if (dragItem.current !== null && dragOverItem.current !== null && dragItem.current !== dragOverItem.current) {
            const newWrappers = [...wrappers];
            const draggedItemContent = newWrappers.splice(dragItem.current, 1)[0];
            newWrappers.splice(dragOverItem.current, 0, draggedItemContent);
            updateParent(newWrappers);
        }
        setDraggingIndex(null);
        dragItem.current = null;
        dragOverItem.current = null;
    };

    const handleTicketChange = (key: string, field: keyof TicketOption, value: any) => {
        const newWrappers = wrappers.map(w => {
            if (w.uiKey === key) {
                const isNumericField = field === 'price' || field === 'minimumDonation' || field === 'quantity';
                let updatedValue = value;
                if (isNumericField && value !== '') {
                    updatedValue = parseFloat(value) || 0;
                } else if (isNumericField && value === '') {
                    updatedValue = undefined;
                }
                return { ...w, data: { ...w.data, [field]: updatedValue } };
            }
            return w;
        });
        updateParent(newWrappers);
    };

    const addTicket = () => {
        const newTicket: TicketOption = { 
            type: '', price: 0.00, description: '', 
            minimumDonation: 0, quantity: 100 
        };
        const newWrapper = { data: newTicket, uiKey: uuidv4() };
        updateParent([...wrappers, newWrapper]);
        setExpandedUiKey(newWrapper.uiKey);
    };

    const removeTicket = (keyToRemove: string) => {
        const newWrappers = wrappers.filter(w => w.uiKey !== keyToRemove);
        updateParent(newWrappers);
    };

    return (
        <div className="space-y-4">
            {wrappers.map((wrapper, index) => (
                <EditableTicketItem 
                    key={wrapper.uiKey}
                    ticket={wrapper.data}
                    uiKey={wrapper.uiKey}
                    isExpanded={expandedUiKey === wrapper.uiKey}
                    onToggle={() => setExpandedUiKey(expandedUiKey === wrapper.uiKey ? null : wrapper.uiKey)}
                    onUpdate={handleTicketChange}
                    onDelete={() => removeTicket(wrapper.uiKey)}
                    isFundraiser={isFundraiser}
                    index={index}
                    onDragStart={handleDragStart}
                    onDragEnter={handleDragEnter}
                    onDragEnd={handleDragEnd}
                    isDragging={draggingIndex === index}
                />
            ))}
            
            <button 
                onClick={addTicket} 
                className="w-full py-4 border-2 border-dashed border-neutral-800 hover:border-purple-500/50 rounded-2xl text-neutral-400 hover:text-purple-400 font-semibold transition-all duration-300 flex items-center justify-center gap-2 group"
            >
                <div className="bg-neutral-800 group-hover:bg-purple-500/20 p-1.5 rounded-full transition-colors">
                    <PlusIcon className="w-4 h-4" />
                </div>
                <span>Add {isFundraiser ? 'Donation Tier' : 'Ticket Type'}</span>
            </button>
        </div>
    );
};

export default TicketEditor;
--- END OF FILE ./components/TicketEditor.tsx ---




--- START OF FILE ./components/SEOHead.tsx ---


import React from 'react';

interface SEOHeadProps {
  title: string;
  description?: string;
  image?: string;
  url?: string;
  type?: 'website' | 'article' | 'event' | 'profile';
}

const SEOHead: React.FC<SEOHeadProps> = ({ 
  title, 
  description = "A next-generation event discovery and hosting platform.", 
  image = "https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=1200&auto=format&fit=crop",
  url,
  type = 'website'
}) => {
  const siteTitle = "Eventsta";
  const fullTitle = `${title} | ${siteTitle}`;
  const effectiveUrl = url || (typeof window !== 'undefined' ? window.location.href : '');

  // In React 19, <title> and <meta> tags rendered in components are automatically hoisted to the <head>.
  return (
    <>
      <title>{fullTitle}</title>
      <meta name="description" content={description} />

      {/* Open Graph / Facebook */}
      <meta property="og:type" content={type} />
      <meta property="og:url" content={effectiveUrl} />
      <meta property="og:title" content={fullTitle} />
      <meta property="og:description" content={description} />
      <meta property="og:image" content={image} />

      {/* Twitter */}
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:url" content={effectiveUrl} />
      <meta name="twitter:title" content={fullTitle} />
      <meta name="twitter:description" content={description} />
      <meta name="twitter:image" content={image} />
    </>
  );
};

export default SEOHead;

--- END OF FILE ./components/SEOHead.tsx ---




--- START OF FILE ./components/TicketViewModal.tsx ---


import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { Event as EventType } from '../types';
import { CalendarIcon, UserIcon, XIcon, MapPinIcon } from './Icons';
import QRCode from "qrcode";

interface TicketViewModalProps {
  isOpen: boolean;
  onClose: () => void;
  // We pass the specific ticket details now
  ticketData: {
      id: string;
      type: string;
      name: string;
      holderName: string;
  } | null;
  eventData?: EventType | null;
}

const TicketViewModal: React.FC<TicketViewModalProps> = ({ isOpen, onClose, ticketData, eventData }) => {
  const [qrCodeUrl, setQrCodeUrl] = useState<string>('');

  // Generate QR
  useEffect(() => {
      if (ticketData && isOpen) {
          const qrValue = ticketData.id; 
          QRCode.toDataURL(qrValue, { 
              width: 600,
              margin: 2,
              color: {
                  dark: '#000000',
                  light: '#ffffff'
              },
              errorCorrectionLevel: 'M'
          })
          .then((url) => {
              setQrCodeUrl(url);
          })
          .catch((err) => {
              console.error("Error generating QR code", err);
          });
      }
  }, [ticketData, isOpen]);

  if (!isOpen || !ticketData || !eventData) return null;

  return (
    <div 
        className="fixed inset-0 z-[100] flex items-center justify-center p-4 animate-in fade-in duration-300"
        role="dialog"
        aria-modal="true"
    >
        {/* Heavy Blur Backdrop */}
        <div 
            className="absolute inset-0 bg-black/80 backdrop-blur-xl transition-opacity"
            onClick={onClose}
        ></div>

        {/* The White Ticket Card - No Image Header, Rounded Corners */}
        <div 
            className="relative z-10 w-full max-w-sm bg-white text-black rounded-3xl overflow-hidden shadow-2xl transform transition-all scale-100 animate-in zoom-in-95 duration-300 max-h-[85vh] overflow-y-auto my-8"
            style={{ 
                boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255,255,255,0.1)'
            }}
        >
            {/* Close Button */}
            <button 
                onClick={onClose}
                className="absolute top-4 right-4 z-20 p-2 bg-neutral-100 hover:bg-neutral-200 rounded-full text-neutral-500 transition-colors"
            >
                <XIcon className="w-5 h-5" />
            </button>

            {/* QR Code Section & Details */}
            <div className="px-8 py-10 flex flex-col items-center text-center bg-white">
                
                {/* Header Info */}
                <h2 className="text-2xl font-black text-neutral-900 mb-2 leading-tight">{eventData.title}</h2>
                <div className="flex items-center gap-2 text-sm font-medium text-neutral-500 mb-6">
                    <CalendarIcon className="w-4 h-4" />
                    <span>{new Date(eventData.date).toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' })}</span>
                </div>

                {/* Ticket Type Pill */}
                <div className="mb-6">
                    <span className="inline-block px-4 py-1.5 bg-black text-white text-xs font-bold tracking-widest uppercase rounded-full shadow-lg">
                        {ticketData.name}
                    </span>
                </div>
                
                {/* QR Code */}
                <div className="mb-8 p-3 bg-white rounded-2xl border-2 border-neutral-100 shadow-sm w-64 h-64 flex items-center justify-center">
                    {qrCodeUrl ? (
                        <img src={qrCodeUrl} alt="QR Code" className="w-full h-full object-contain mix-blend-multiply" />
                    ) : (
                        <div className="animate-pulse w-full h-full bg-neutral-100 rounded-lg"></div>
                    )}
                </div>

                {/* Tear Line Visual */}
                <div className="w-full border-t-2 border-dashed border-neutral-200 mb-6 relative">
                    <div className="absolute -left-10 -top-3 w-6 h-6 bg-black/80 rounded-full"></div> {/* Matching bg color of modal backdrop approx */}
                    <div className="absolute -right-10 -top-3 w-6 h-6 bg-black/80 rounded-full"></div>
                </div>

                {/* Footer Details */}
                <div className="w-full">
                    <div className="flex flex-col items-center gap-1 text-neutral-900">
                        <UserIcon className="w-5 h-5 text-neutral-400 mb-1" />
                        <span className="font-bold text-lg">{ticketData.holderName}</span>
                    </div>
                    <div className="text-neutral-400 font-mono text-[10px] mt-2 uppercase tracking-wider">
                        ID: {ticketData.id.split('-').slice(-2).join('-')}
                    </div>
                </div>
            </div>
            
            {/* Scan Prompt Bar */}
            <div className="bg-neutral-50 py-3 text-center border-t border-neutral-100">
                <p className="text-[10px] text-neutral-400 uppercase tracking-widest font-semibold flex items-center justify-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    Ready to Scan
                </p>
            </div>
        </div>
    </div>
  );
};

export default TicketViewModal;

--- END OF FILE ./components/TicketViewModal.tsx ---




--- START OF FILE ./components/PortalHeader.tsx ---


import React from 'react';

interface PortalHeaderProps {
  title: string;
  subtitle: string;
  children?: React.ReactNode; // For action buttons
}

const PortalHeader: React.FC<PortalHeaderProps> = ({ title, subtitle, children }) => (
  <div className="flex flex-col md:flex-row justify-between md:items-center mb-12">
    <div>
        <h1 className="text-4xl font-bold tracking-tight text-white mb-4">{title}</h1>
        <p className="text-neutral-400">{subtitle}</p>
    </div>
    {children && <div className="mt-6 md:mt-0">{children}</div>}
  </div>
);

export default PortalHeader;

--- END OF FILE ./components/PortalHeader.tsx ---




--- START OF FILE ./components/admin/OrdersTab.tsx ---


import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Order } from '../../types';
import { DownloadIcon, TicketIcon, CheckCircleIcon, XCircleIcon } from '../Icons';
import Modal from '../Modal';

const OrdersTab: React.FC<{ eventId: string }> = ({ eventId }) => {
    const [selectedOrderId, setSelectedOrderId] = useState<string | null>(null);
    const [orders, setOrders] = useState<Order[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    const fetchOrders = useCallback(async () => {
        if (!eventId) return;
        setIsLoading(true);
        try {
            const data = await api.getOrdersForEvent(eventId);
            setOrders(data);
        } catch (err) {
            setError("Failed to load orders.");
        } finally {
            setIsLoading(false);
        }
    }, [eventId]);

    useEffect(() => {
        fetchOrders();
    }, [fetchOrders]);

    const handleOrderUpdate = (updatedOrder: Order) => {
        setOrders(prevOrders => prevOrders.map(o => o.orderId === updatedOrder.orderId ? updatedOrder : o));
    };

    const selectedOrder = useMemo(() => orders.find(o => o.orderId === selectedOrderId), [orders, selectedOrderId]);

    return (
        <>
            <OrderListView 
                orders={orders}
                isLoading={isLoading}
                error={error}
                onOrderSelect={setSelectedOrderId}
            />
            <Modal isOpen={!!selectedOrder} onClose={() => setSelectedOrderId(null)}>
                {selectedOrder && (
                    <OrderDetailView 
                        order={selectedOrder} 
                        onOrderUpdate={handleOrderUpdate}
                    />
                )}
            </Modal>
        </>
    );
};

const OrderListView: React.FC<{
    orders: Order[];
    isLoading: boolean;
    error: string | null;
    onOrderSelect: (orderId: string) => void;
}> = ({ orders, isLoading, error, onOrderSelect }) => {
    
    const [currentPage, setCurrentPage] = useState(1);
    const ITEMS_PER_PAGE = 10;

    const totalPages = Math.ceil(orders.length / ITEMS_PER_PAGE);
    const paginatedOrders = orders.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

    if (isLoading) return <div className="text-center py-20 text-neutral-400">Loading orders...</div>;
    if (error) return <div className="text-center py-20 text-red-400">{error}</div>;

    return (
        <div className="space-y-8">
            <h1 className="text-3xl font-bold tracking-tight text-white">Orders</h1>
            {orders.length === 0 ? (
                <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-8 text-center text-neutral-500">No orders found for this event.</div>
            ) : (
                <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-neutral-300">
                            <thead className="text-xs text-neutral-400 uppercase bg-neutral-900">
                                <tr>
                                    <th scope="col" className="px-6 py-3">Purchaser</th>
                                    <th scope="col" className="px-6 py-3">Date</th>
                                    <th scope="col" className="px-6 py-3 text-center">Items</th>
                                    <th scope="col" className="px-6 py-3 text-center">Affiliate</th>
                                    <th scope="col" className="px-6 py-3 text-center">Status</th>
                                    <th scope="col" className="px-6 py-3 text-right">Total Paid</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginatedOrders.map(order => (
                                    <tr key={order.orderId} onClick={() => onOrderSelect(order.orderId)} className="border-b border-neutral-800 hover:bg-neutral-800/50 cursor-pointer">
                                        <td className="px-6 py-4">
                                            <div className="flex flex-col">
                                                <span className="font-medium text-white whitespace-nowrap">{order.purchaserName}</span>
                                                <span className="text-xs text-neutral-500">{order.purchaserEmail}</span>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 text-xs text-neutral-400">{new Date(order.purchaseDate).toLocaleDateString()}</td>
                                        <td className="px-6 py-4 text-center">{order.items.reduce((sum, item) => sum + item.quantity, 0)}</td>
                                        <td className="px-6 py-4 text-center text-purple-400 font-medium">
                                            {order.recipientUserName ? order.recipientUserName : (order.promoCode ? order.promoCode : '-')}
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${order.status === 'Completed' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`}>
                                                {order.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-right font-semibold text-white">${order.totalPaid.toFixed(2)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {totalPages > 1 && (
                        <div className="flex justify-between items-center p-4 bg-neutral-900">
                            <span className="text-sm text-neutral-400">Page {currentPage} of {totalPages}</span>
                            <div className="flex space-x-2">
                                <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="px-3 py-1 text-sm font-semibold rounded-lg bg-neutral-800 hover:bg-neutral-700 disabled:opacity-50">Prev</button>
                                <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className="px-3 py-1 text-sm font-semibold rounded-lg bg-neutral-800 hover:bg-neutral-700 disabled:opacity-50">Next</button>
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};

const OrderDetailView: React.FC<{ order: Order, onOrderUpdate: (order: Order) => void }> = ({ order: initialOrder, onOrderUpdate }) => {
    const { user } = useAuth();
    const [order, setOrder] = useState<Order>(initialOrder);
    const [isRefunding, setIsRefunding] = useState(false);
    const [isConfirmModalOpen, setConfirmModalOpen] = useState(false);
    
    useEffect(() => {
        setOrder(initialOrder);
    }, [initialOrder]);

    const handleRefund = async () => {
        if (!user || order.status === 'Refunded') return;
        setIsRefunding(true);
        try {
            const updatedOrder = await api.refundOrder(user.id, order.orderId);
            setOrder(updatedOrder);
            onOrderUpdate(updatedOrder);
        } catch (error) {
            console.error("Failed to refund order:", error);
            alert("Refund failed. Please try again.");
        } finally {
            setIsRefunding(false);
            setConfirmModalOpen(false);
        }
    };

    return (
        <div className="w-full max-w-lg md:max-w-4xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl flex flex-col max-h-[85vh]">
            <div className="p-6 border-b border-neutral-800 bg-neutral-900 sticky top-0 z-10 rounded-t-2xl flex justify-between items-start">
                 <div>
                    <h2 className="text-2xl font-bold text-white">Order Details</h2>
                    <p className="text-sm text-neutral-500 font-mono mt-1">{order.orderId}</p>
                 </div>
                 <div className="mt-8">
                    <span className={`px-3 py-1 text-xs font-bold rounded-full border ${order.status === 'Completed' ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'}`}>
                        {order.status}
                    </span>
                </div>
            </div>
            
            <div className="p-6 overflow-y-auto custom-scrollbar">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                    {/* Left Column: Purchaser Info */}
                    <div className="space-y-8">
                        <div>
                            <h4 className="text-xs text-neutral-500 uppercase tracking-wider font-bold mb-3">Purchaser</h4>
                            <div className="bg-neutral-800/30 p-5 rounded-xl border border-neutral-800/50">
                                <div className="flex items-center gap-4 mb-4">
                                    <div className="h-12 w-12 rounded-full bg-neutral-700 flex items-center justify-center text-white font-bold text-lg">
                                        {order.purchaserName.charAt(0)}
                                    </div>
                                    <div>
                                        <p className="text-xl font-bold text-white leading-tight">{order.purchaserName}</p>
                                        <p className="text-sm text-neutral-400">{order.purchaserEmail}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 className="text-xs text-neutral-500 uppercase tracking-wider font-bold mb-3">Order Information</h4>
                            <div className="space-y-3 bg-neutral-800/30 p-5 rounded-xl border border-neutral-800/50">
                                <div className="flex justify-between items-center border-b border-neutral-800 pb-2">
                                    <span className="text-neutral-400 text-sm">Date</span>
                                    <span className="text-white font-medium text-sm">{new Date(order.purchaseDate).toLocaleString()}</span>
                                </div>
                                <div className="flex justify-between items-center border-b border-neutral-800 pb-2">
                                    <span className="text-neutral-400 text-sm">Promo Code</span>
                                    <span className="text-white font-medium text-sm">{order.promoCode || '-'}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-neutral-400 text-sm">Affiliate</span>
                                    <span className="text-white font-medium text-sm">{order.recipientUserName || order.recipientUserId || '-'}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Right Column: Items & Financials */}
                    <div>
                        <h4 className="text-xs text-neutral-500 uppercase tracking-wider font-bold mb-3">Items & Summary</h4>
                        <div className="bg-neutral-800/30 rounded-xl border border-neutral-800/50 overflow-hidden">
                            <div className="divide-y divide-neutral-800">
                                {order.items.map((item, index) => (
                                    <div key={index} className="flex justify-between items-center p-4 hover:bg-neutral-800/30 transition-colors">
                                        <div>
                                            <p className="font-semibold text-white">{item.ticketType}</p>
                                            <p className="text-xs text-neutral-400 mt-0.5">{item.quantity} x ${item.pricePerTicket.toFixed(2)}</p>
                                        </div>
                                        <p className="font-bold text-white">${(item.quantity * item.pricePerTicket).toFixed(2)}</p>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-neutral-900/80 p-5 border-t border-neutral-800 flex justify-between items-center">
                                <span className="text-neutral-300 font-medium">Total Paid</span>
                                <span className="text-3xl font-bold text-white tracking-tight">${order.totalPaid.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div className="p-5 border-t border-neutral-800 bg-neutral-900 sticky bottom-0 z-10 rounded-b-2xl flex justify-end">
                <button onClick={() => setConfirmModalOpen(true)} disabled={order.status === 'Refunded' || isRefunding} className="px-6 py-2.5 text-sm font-semibold rounded-full bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto">
                    {isRefunding ? 'Refunding...' : 'Refund Order'}
                </button>
            </div>
            
             <Modal isOpen={isConfirmModalOpen} onClose={() => setConfirmModalOpen(false)}>
                <div className="w-full max-w-sm bg-neutral-900 border border-neutral-700 rounded-2xl p-8 text-center">
                    <h3 className="text-xl font-bold text-white mb-2">Confirm Refund</h3>
                    <p className="text-neutral-400 mb-6">Are you sure you want to refund this order for <span className="font-bold text-white">${order.totalPaid.toFixed(2)}</span>? This action is permanent.</p>
                    <div className="flex justify-center space-x-4">
                        <button onClick={() => setConfirmModalOpen(false)} className="px-6 py-2 text-sm font-semibold text-neutral-300 bg-neutral-800 hover:bg-neutral-700 rounded-full transition-colors">Cancel</button>
                        <button onClick={handleRefund} className="px-6 py-2 text-sm font-semibold text-white bg-red-600 hover:bg-red-500 rounded-full transition-colors">Confirm Refund</button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

export default OrdersTab;

--- END OF FILE ./components/admin/OrdersTab.tsx ---




--- START OF FILE ./components/admin/FormsTab.tsx ---


import React, { useState, useEffect } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { Link } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType, CompetitionForm } from '../../types';
import { PlusIcon, EyeIcon, EditIcon, LinkIcon, CheckCircleIcon, BarChartIcon, FileText, SettingsIcon } from '../Icons';
import FormBuilder from '../FormBuilder';
import FormResponsesView from './FormResponsesView';
import Modal from '../Modal';

const FormsTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const { user } = useAuth();
    const [view, setView] = useState<'list' | 'builder' | 'responses'>('list');
    const [selectedFormId, setSelectedFormId] = useState<string | null>(null);
    const [copiedFormId, setCopiedFormId] = useState<string | null>(null);
    const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
    const [settingsForm, setSettingsForm] = useState<CompetitionForm | null>(null);
    
    // State to hold verified counts fetched directly from the responses endpoint
    const [realtimeCounts, setRealtimeCounts] = useState<Record<string, number>>({});

    const forms = event.forms || [];

    // Fetch verified counts on mount or when forms change
    useEffect(() => {
        let isMounted = true;
        const fetchCounts = async () => {
            if (forms.length === 0) return;
            
            await Promise.all(forms.map(async (form) => {
                try {
                    // Fetch actual responses to get accurate count
                    const responses = await api.getFormResponses(form.id);
                    if (isMounted) {
                        setRealtimeCounts(prev => ({
                            ...prev,
                            [form.id]: responses.length
                        }));
                    }
                } catch (e) {
                    console.warn(`Failed to fetch count for form ${form.id}`, e);
                }
            }));
        };

        fetchCounts();
        return () => { isMounted = false; };
    }, [forms]);

    const handleSaveForm = async (form: CompetitionForm) => {
        if (!user) return;
        const formIndex = forms.findIndex(f => f.id === form.id);
        let newForms;
        if (formIndex > -1) {
            newForms = forms.map(f => f.id === form.id ? form : f);
        } else {
            newForms = [...forms, form];
        }
        try {
            await api.updateEvent(user.id, event.id, { forms: newForms });
            onEventUpdate();
            setView('list');
        } catch (error) {
            console.error("Failed to save form", error);
        }
    };

    const handleCreateForm = () => {
        setSelectedFormId(null);
        setView('builder');
    };

    const handleEditForm = (id: string) => {
        setSelectedFormId(id);
        setView('builder');
    };

    const handleViewResponses = (id: string) => {
        setSelectedFormId(id);
        setView('responses');
    };

    const handleCopyLink = (formId: string) => {
        const url = `${window.location.origin}/#/form/${formId}`;
        navigator.clipboard.writeText(url);
        setCopiedFormId(formId);
        setTimeout(() => setCopiedFormId(null), 2000);
    };

    const handleOpenSettings = (form: CompetitionForm) => {
        setSettingsForm(form);
        setIsSettingsModalOpen(true);
    };

    const handleSaveSettings = async (updatedForm: CompetitionForm) => {
        await handleSaveForm(updatedForm);
        setIsSettingsModalOpen(false);
    };

    if (view === 'builder') {
        const formToEdit = forms.find(f => f.id === selectedFormId) || {
            id: uuidv4(),
            title: 'New Form',
            description: 'Description here...',
            elements: [],
            isActive: true,
            responsesCount: 0,
            lastUpdated: new Date().toISOString(),
            linkedCompetitionId: undefined
        } as CompetitionForm;

        return (
            <FormBuilder 
                form={formToEdit} 
                onSave={handleSaveForm} 
                onCancel={() => setView('list')} 
            />
        );
    }

    if (view === 'responses' && selectedFormId) {
        const form = forms.find(f => f.id === selectedFormId);
        if (!form) return <div>Form not found</div>;
        return <FormResponsesView form={form} onBack={() => setView('list')} />;
    }

    return (
        <div className="space-y-8">
            <div className="flex justify-between items-center">
                <div className="flex flex-col">
                    <h2 className="text-2xl font-bold text-white">Marketing Forms</h2>
                    <p className="text-sm text-neutral-400">Create forms for competition signups, surveys, or newsletters.</p>
                </div>
                <button onClick={handleCreateForm} className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 flex items-center gap-2">
                    <PlusIcon className="w-4 h-4" /> Create Form
                </button>
            </div>

            {forms.length === 0 ? (
                <div className="text-center py-16 bg-neutral-900/50 border-2 border-dashed border-neutral-800 rounded-2xl">
                    <FileText className="w-12 h-12 mx-auto text-neutral-600 mb-4" />
                    <h3 className="text-xl font-bold text-white">No Forms Created</h3>
                    <p className="text-neutral-500 mt-2 mb-6">Start collecting data from your audience.</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {forms.map(form => (
                        <div key={form.id} className="bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden group hover:border-purple-500/50 transition-all flex flex-col">
                            <div 
                                className="h-32 bg-neutral-800 relative flex-shrink-0 cursor-pointer" 
                                onClick={() => handleEditForm(form.id)}
                            >
                                {form.headerImageUrl && (
                                    <img src={form.headerImageUrl} alt="" className="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity" />
                                )}
                                <div className="absolute top-3 right-3 pointer-events-none">
                                    <span className={`px-2 py-1 rounded text-xs font-bold bg-black/50 backdrop-blur-md text-white`}>
                                        {form.isActive ? 'Active' : 'Draft'}
                                    </span>
                                </div>
                            </div>
                            <div className="p-5 flex-grow flex flex-col">
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-bold text-white text-lg truncate cursor-pointer hover:text-purple-400 transition-colors" onClick={() => handleEditForm(form.id)} title={form.title}>{form.title}</h4>
                                    <button onClick={() => handleOpenSettings(form)} className="text-neutral-500 hover:text-white p-1 rounded hover:bg-neutral-800 transition-colors">
                                        <SettingsIcon className="w-4 h-4" />
                                    </button>
                                </div>
                                <p className="text-xs text-neutral-400 mb-4">Updated {new Date(form.lastUpdated).toLocaleDateString()}</p>
                                
                                {form.linkedCompetitionId && (
                                    <div className="mb-4">
                                        <span className="text-[10px] uppercase font-bold text-purple-400 tracking-wider block mb-1">Linked Competition</span>
                                        <span className="text-xs text-neutral-300 bg-purple-900/30 px-2 py-1 rounded border border-purple-500/20 block truncate">
                                            {event.competitions?.find(c => c.id === form.linkedCompetitionId)?.name || 'Unknown Competition'}
                                        </span>
                                    </div>
                                )}

                                <div className="mt-auto pt-3 border-t border-neutral-800 flex justify-between items-center">
                                    <button onClick={() => handleViewResponses(form.id)} className="flex items-center gap-1.5 text-sm text-neutral-300 hover:text-white transition-colors">
                                        <BarChartIcon className="w-4 h-4 text-neutral-500" />
                                        {/* Use realtime count if available, otherwise fallback to stored count */}
                                        <span>{realtimeCounts[form.id] !== undefined ? realtimeCounts[form.id] : form.responsesCount} Responses</span>
                                    </button>
                                </div>
                            </div>
                            <div className="bg-neutral-950 p-2 grid grid-cols-3 gap-1 border-t border-neutral-800">
                                <button 
                                    onClick={() => handleEditForm(form.id)} 
                                    className="flex items-center justify-center gap-2 py-2 text-xs font-medium text-neutral-400 hover:text-white hover:bg-neutral-800 rounded transition-colors"
                                >
                                    <EditIcon className="w-3.5 h-3.5" />
                                    <span>Edit</span>
                                </button>
                                <Link 
                                    to={`/form/${form.id}`} 
                                    className="flex items-center justify-center gap-2 py-2 text-xs font-medium text-neutral-400 hover:text-white hover:bg-neutral-800 rounded transition-colors"
                                >
                                    <EyeIcon className="w-3.5 h-3.5" />
                                    <span>View</span>
                                </Link>
                                <button 
                                    onClick={() => handleCopyLink(form.id)} 
                                    className={`flex items-center justify-center gap-2 py-2 text-xs font-medium rounded transition-colors ${copiedFormId === form.id ? 'text-green-400 bg-green-500/10' : 'text-neutral-400 hover:text-white hover:bg-neutral-800'}`}
                                >
                                    {copiedFormId === form.id ? <CheckCircleIcon className="w-3.5 h-3.5" /> : <LinkIcon className="w-3.5 h-3.5" />}
                                    <span>{copiedFormId === form.id ? 'Copied' : 'Copy Link'}</span>
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {settingsForm && (
                <FormSettingsModal 
                    isOpen={isSettingsModalOpen} 
                    onClose={() => setIsSettingsModalOpen(false)} 
                    form={settingsForm} 
                    event={event}
                    onSave={handleSaveSettings}
                />
            )}
        </div>
    );
};

const FormSettingsModal: React.FC<{ 
    isOpen: boolean, 
    onClose: () => void, 
    form: CompetitionForm, 
    event: EventType,
    onSave: (form: CompetitionForm) => void
}> = ({ isOpen, onClose, form, event, onSave }) => {
    const [settings, setSettings] = useState({
        title: form.title,
        isActive: form.isActive,
        linkedCompetitionId: form.linkedCompetitionId || ''
    });

    const handleSave = () => {
        onSave({
            ...form,
            title: settings.title,
            isActive: settings.isActive,
            linkedCompetitionId: settings.linkedCompetitionId || undefined
        });
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose}>
            <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl p-6">
                <h3 className="text-xl font-bold text-white mb-6">Form Settings</h3>
                
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-neutral-300 mb-2">Form Title</label>
                        <input 
                            type="text" 
                            value={settings.title} 
                            onChange={e => setSettings({...settings, title: e.target.value})}
                            className="w-full h-10 px-3 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:border-purple-500 outline-none"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-neutral-300 mb-2">Link to Competition</label>
                        <p className="text-xs text-neutral-500 mb-2">If selected, form submissions will automatically join the user to this competition.</p>
                        <select 
                            value={settings.linkedCompetitionId} 
                            onChange={e => setSettings({...settings, linkedCompetitionId: e.target.value})}
                            className="w-full h-10 px-3 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:border-purple-500 outline-none"
                        >
                            <option value="">-- No Competition (Info Only) --</option>
                            {event.competitions?.map(comp => (
                                <option key={comp.id} value={comp.id}>{comp.name}</option>
                            ))}
                        </select>
                    </div>

                    <div className="flex items-center justify-between pt-2">
                        <span className="text-sm font-medium text-neutral-300">Form Status</span>
                        <button 
                            onClick={() => setSettings({...settings, isActive: !settings.isActive})}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${settings.isActive ? 'bg-green-500' : 'bg-neutral-700'}`}
                        >
                            <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${settings.isActive ? 'translate-x-6' : 'translate-x-1'}`} />
                        </button>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 text-sm text-neutral-300 hover:text-white">Cancel</button>
                    <button onClick={handleSave} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold rounded-lg">Save Settings</button>
                </div>
            </div>
        </Modal>
    );
};

export default FormsTab;

--- END OF FILE ./components/admin/FormsTab.tsx ---




--- START OF FILE ./components/admin/FormResponsesView.tsx ---


import React, { useState, useEffect } from 'react';
import { CompetitionForm } from '../../types';
import * as api from '../../services/api';
import { ArrowLeftIcon, DownloadIcon } from '../Icons';

interface FormResponsesViewProps {
    form: CompetitionForm;
    onBack: () => void;
}

const FormResponsesView: React.FC<FormResponsesViewProps> = ({ form, onBack }) => {
    const [responses, setResponses] = useState<any[]>([]);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            setIsLoading(true);
            try {
                const data = await api.getFormResponses(form.id);
                setResponses(data);
            } catch (e) {
                console.error("Failed to load responses", e);
            } finally {
                setIsLoading(false);
            }
        };
        fetchData();
    }, [form.id]);

    const exportCSV = () => {
        if (responses.length === 0) return;

        // Define headers
        const headers = ['Submission Date', 'Email', ...form.elements.map(el => el.label)];
        
        // Create rows
        const rows = responses.map(response => {
            const rowData = [
                new Date(response.submissionDate).toLocaleString(),
                `"${response.email || ''}"`,
                ...form.elements.map(el => {
                    const val = response[el.id];
                    if (Array.isArray(val)) return `"${val.join(', ')}"`; // CSV escape for arrays (checkboxes)
                    return `"${val || ''}"`; // CSV escape strings
                })
            ];
            return rowData.join(',');
        });

        const csvContent = "data:text/csv;charset=utf-8," 
            + headers.join(',') + "\n" 
            + rows.join('\n');

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `${form.title.replace(/\s+/g, '_')}_responses.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        <div className="space-y-6 h-full flex flex-col">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 flex-shrink-0">
                <div>
                    <button onClick={onBack} className="flex items-center text-sm text-neutral-400 hover:text-white mb-2">
                        <ArrowLeftIcon className="w-4 h-4 mr-2" /> Back to Forms
                    </button>
                    <h2 className="text-2xl font-bold text-white">{form.title} <span className="text-neutral-500 text-lg font-normal">/ Responses</span></h2>
                </div>
                <button 
                    onClick={exportCSV} 
                    disabled={responses.length === 0}
                    className="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 disabled:opacity-50 transition-colors"
                >
                    <DownloadIcon className="w-4 h-4" /> Export CSV
                </button>
            </div>

            <div className="flex-grow bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden flex flex-col min-h-[400px]">
                {isLoading ? (
                    <div className="flex items-center justify-center h-full text-neutral-500">Loading responses...</div>
                ) : responses.length === 0 ? (
                    <div className="flex items-center justify-center h-full text-neutral-500">No responses yet.</div>
                ) : (
                    <div className="overflow-auto custom-scrollbar flex-grow">
                        <table className="w-full text-sm text-left text-neutral-300 whitespace-nowrap">
                            <thead className="text-xs text-neutral-400 uppercase bg-neutral-950 border-b border-neutral-800 sticky top-0 z-10">
                                <tr>
                                    <th className="px-6 py-3 font-bold min-w-[180px]">Submission Date</th>
                                    <th className="px-6 py-3 font-bold min-w-[250px]">Email</th>
                                    {form.elements.map(el => (
                                        <th key={el.id} className="px-6 py-3 font-bold min-w-[200px]">
                                            {el.label}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-neutral-800 bg-neutral-900">
                                {responses.map((response, idx) => (
                                    <tr key={idx} className="hover:bg-neutral-800/50">
                                        <td className="px-6 py-4 font-mono text-xs text-neutral-500">
                                            {new Date(response.submissionDate).toLocaleString()}
                                        </td>
                                        <td className="px-6 py-4 text-white">
                                            {response.email || '-'}
                                        </td>
                                        {form.elements.map(el => {
                                            const value = response[el.id];
                                            return (
                                                <td key={el.id} className="px-6 py-4 text-white truncate max-w-[300px]" title={Array.isArray(value) ? value.join(', ') : value}>
                                                    {Array.isArray(value) ? value.join(', ') : (value || '-')}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );
};

export default FormResponsesView;

--- END OF FILE ./components/admin/FormResponsesView.tsx ---




--- START OF FILE ./components/admin/DetailsTab.tsx ---







import React, { useState } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType } from '../../types';
import ImageGalleryEditor from '../ImageGalleryEditor';
import { EyeIcon } from '../Icons';

const DetailsTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const { user } = useAuth();
    const [formData, setFormData] = useState<Partial<EventType>>({
        title: event.title,
        description: event.description,
        date: event.date,
        endDate: event.endDate,
        location: event.location,
        imageUrls: event.imageUrls,
        commission: event.commission,
        defaultPromoDiscount: event.defaultPromoDiscount,
        status: event.status || 'DRAFT'
    });
    const [isSaving, setIsSaving] = useState(false);

    const isFundraiser = event.type === 'fundraiser';

    const handleSave = async () => {
        if (!user) return;
        setIsSaving(true);
        try {
            await api.updateEvent(user.id, event.id, formData);
            onEventUpdate();
            alert("Event details updated!");
        } catch (e) {
            console.error(e);
            alert("Failed to update details.");
        } finally {
            setIsSaving(false);
        }
    };

    const toggleStatus = () => {
        setFormData(prev => ({ ...prev, status: prev.status === 'PUBLISHED' ? 'DRAFT' : 'PUBLISHED' }));
    };

    return (
        <div className="space-y-6 max-w-3xl">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold tracking-tight text-white">Event Details</h1>
                <button onClick={handleSave} disabled={isSaving} className="bg-purple-600 text-white px-6 py-2 rounded-full font-semibold disabled:opacity-50 shadow-lg shadow-purple-600/20 hover:bg-purple-500 transition-colors">
                    {isSaving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
            
            {/* Status Card */}
            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${formData.status === 'PUBLISHED' ? 'bg-green-500/10 text-green-400' : 'bg-neutral-800 text-neutral-400'}`}>
                        <EyeIcon className="w-6 h-6" />
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-white">Event Visibility</h3>
                        <p className="text-sm text-neutral-400">
                            {formData.status === 'PUBLISHED' 
                                ? 'This event is live and visible to the public.' 
                                : 'This event is currently a draft and hidden from the public.'}
                        </p>
                    </div>
                </div>
                <div className="flex items-center">
                    <button 
                        onClick={toggleStatus}
                        className={`relative inline-flex h-8 w-14 items-center rounded-full transition-colors ${formData.status === 'PUBLISHED' ? 'bg-green-600' : 'bg-neutral-700'}`}
                    >
                        <span className={`inline-block h-6 w-6 transform rounded-full bg-white transition-transform ${formData.status === 'PUBLISHED' ? 'translate-x-7' : 'translate-x-1'}`} />
                    </button>
                    <span className={`ml-3 text-sm font-bold ${formData.status === 'PUBLISHED' ? 'text-green-400' : 'text-neutral-500'}`}>
                        {formData.status === 'PUBLISHED' ? 'PUBLISHED' : 'DRAFT'}
                    </span>
                </div>
            </div>

            <div className="space-y-6">
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 space-y-4">
                    <h3 className="text-lg font-bold text-white mb-4">Basic Info</h3>
                    <div>
                        <label className="block text-sm font-medium text-neutral-400 mb-1">Title</label>
                        <input 
                            type="text" 
                            value={formData.title} 
                            onChange={e => setFormData({...formData, title: e.target.value})}
                            className="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500"
                        />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-neutral-400 mb-1">Start Date</label>
                            <input 
                                type="datetime-local" 
                                value={formData.date} 
                                onChange={e => setFormData({...formData, date: e.target.value})}
                                className="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-neutral-400 mb-1">End Date</label>
                            <input 
                                type="datetime-local" 
                                value={formData.endDate} 
                                onChange={e => setFormData({...formData, endDate: e.target.value})}
                                className="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500"
                            />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-neutral-400 mb-1">Location</label>
                        <input 
                            type="text" 
                            value={formData.location} 
                            onChange={e => setFormData({...formData, location: e.target.value})}
                            className="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-neutral-400 mb-1">Description</label>
                        <textarea 
                            rows={5}
                            value={formData.description} 
                            onChange={e => setFormData({...formData, description: e.target.value})}
                            className="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500"
                        />
                    </div>
                </div>

                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4">Promotions</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-neutral-400 mb-1">Promoter Commission (%)</label>
                            <div className="relative">
                                <input 
                                    type="number" 
                                    value={formData.commission} 
                                    onChange={e => setFormData({...formData, commission: parseFloat(e.target.value)})}
                                    className="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500"
                                    min="0"
                                    max="100"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-neutral-500">%</span>
                            </div>
                            <p className="text-xs text-neutral-500 mt-1">Percentage of ticket sales (excluding add-ons) that promoters earn.</p>
                        </div>
                        {!isFundraiser && (
                            <div>
                                <label className="block text-sm font-medium text-neutral-400 mb-1">Customer Discount (%)</label>
                                <div className="relative">
                                    <input 
                                        type="number" 
                                        value={formData.defaultPromoDiscount} 
                                        onChange={e => setFormData({...formData, defaultPromoDiscount: parseFloat(e.target.value)})}
                                        className="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500"
                                        min="0"
                                        max="100"
                                    />
                                    <span className="absolute right-4 top-1/2 -translate-y-1/2 text-neutral-500">%</span>
                                </div>
                                <p className="text-xs text-neutral-500 mt-1">Percentage discount applied to tickets when using a promoter's link.</p>
                            </div>
                        )}
                    </div>
                </div>

                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4">Media</h3>
                    <div>
                        <label className="block text-sm font-medium text-neutral-400 mb-1">Images</label>
                        <ImageGalleryEditor 
                            images={formData.imageUrls || []} 
                            onImagesChange={imgs => setFormData({...formData, imageUrls: imgs})}
                        />
                    </div>
                </div>
            </div>
        </div>
    );
};

export default DetailsTab;

--- END OF FILE ./components/admin/DetailsTab.tsx ---




--- START OF FILE ./components/admin/AdminSidebar.tsx ---




import React from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { 
    ArrowLeftIcon, ArrowRightIcon, BarChartIcon, ScanIcon, SettingsIcon, 
    TicketIcon, PackageIcon, LayoutGridIcon, MegaphoneIcon, CalendarIcon, 
    DollarSignIcon, UsersIcon 
} from '../Icons';
import { Event as EventType, User } from '../../types';
import { createEventSlug } from '../../utils/url';

interface AdminSidebarProps {
    event: EventType;
    activeTab: string;
    user: User | null;
}

const AdminSidebar: React.FC<AdminSidebarProps> = ({ event, activeTab, user }) => {
    const navigate = useNavigate();
    const navItems = [
        { id: 'reports', label: 'Reports', icon: BarChartIcon },
        { id: 'checkin', label: 'Check-in', icon: ScanIcon },
        { id: 'details', label: 'Details', icon: SettingsIcon },
        { id: 'ticketing', label: 'Ticketing', icon: TicketIcon },
        { id: 'marketing', label: 'Marketing', icon: MegaphoneIcon },
        { id: 'sections', label: 'Sections', icon: LayoutGridIcon },
        { id: 'schedule', label: 'Schedule', icon: CalendarIcon },
        { id: 'orders', label: 'Orders', icon: UsersIcon },
    ];
    
    return (
        <aside className="w-full md:w-1/4 lg:w-1/5 flex-shrink-0">
            <Link 
                to={user?.isSystemAdmin ? "/system-admin" : "/events"} 
                state={user?.isSystemAdmin ? { activeTab: 'events' } : undefined}
                className="flex items-center space-x-2 text-sm font-semibold text-purple-400 hover:text-purple-300 transition-colors mb-6"
            >
                <ArrowLeftIcon className="w-4 h-4" />
                <span>Back to Events List</span>
            </Link>
            <div className="p-4 bg-neutral-900 border border-neutral-800 rounded-2xl mb-6">
                 <h2 className="text-lg font-bold text-white truncate">{event.title}</h2>
                 <Link to={`/event/${createEventSlug(event.title, event.id)}`} className="text-xs text-purple-400 hover:text-purple-300 transition-colors flex items-center">
                    View Event Page <ArrowRightIcon className="w-3 h-3 ml-1" />
                </Link>
            </div>
            <nav className="flex flex-row md:flex-col gap-1 overflow-x-auto md:overflow-visible">
                {navItems.map(item => (
                    <button
                        key={item.id}
                        onClick={() => navigate(`/event/${event.id}/admin/${item.id}`)}
                        className={`flex items-center justify-center md:justify-start w-full px-4 py-3 rounded-lg text-sm font-semibold transition-colors whitespace-nowrap md:whitespace-normal ${
                            activeTab === item.id
                                ? 'bg-neutral-800 text-white'
                                : 'text-neutral-400 hover:bg-neutral-800/50 hover:text-white'
                        }`}
                    >
                        <item.icon className="w-5 h-5 md:mr-3" />
                        <span className="hidden md:inline">{item.label}</span>
                    </button>
                ))}
            </nav>
        </aside>
    );
};

export default AdminSidebar;
--- END OF FILE ./components/admin/AdminSidebar.tsx ---




--- START OF FILE ./components/admin/CompetitionsTab.tsx ---


import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { Link } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType, Competition, User, LeaderboardEntry } from '../../types';
import { PlusIcon, MegaphoneIcon, TrashIcon, ArrowLeftIcon, UsersIcon, StopCircleIcon, ShieldIcon, EditIcon, RefreshCwIcon } from '../Icons';
import Modal from '../Modal';

const CompetitionsTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const { user } = useAuth();
    const [view, setView] = useState<'list' | 'dashboard'>('list');
    const [selectedCompetitionId, setSelectedCompetitionId] = useState<string | null>(null);
    const [isEditorOpen, setIsEditorOpen] = useState(false);
    const [editingCompetition, setEditingCompetition] = useState<Competition | null>(null);

    const competitions = event.competitions || [];
    const sections = event.venueAreas || [];

    const handleSaveCompetition = async (competitionData: Competition) => {
        if (!user) return;
        const index = competitions.findIndex(c => c.id === competitionData.id);
        let newCompetitions;
        if (index > -1) {
            newCompetitions = competitions.map(c => c.id === competitionData.id ? competitionData : c);
        } else {
            newCompetitions = [...competitions, competitionData];
        }
        try {
            await api.updateEvent(user.id, event.id, { competitions: newCompetitions });
            onEventUpdate();
            setIsEditorOpen(false);
            setEditingCompetition(null);
        } catch (error) {
            console.error("Failed to save competition", error);
        }
    };

    const handleFinalizeCompetition = async (compId: string) => {
        if (!user) return;
        try {
            await api.finalizeCompetition(user.id, event.id, compId);
            onEventUpdate();
        } catch (error) {
            console.error("Failed to finalize", error);
            alert("Failed to finalize competition.");
        }
    };

    const openCreateModal = () => {
        setEditingCompetition(null);
        setIsEditorOpen(true);
    };

    const openEditModal = (comp: Competition) => {
        setEditingCompetition(comp);
        setIsEditorOpen(true);
    };

    const renderContent = () => {
        if (view === 'dashboard' && selectedCompetitionId) {
            const comp = competitions.find(c => c.id === selectedCompetitionId);
            if (!comp) return <div className="text-white">Competition not found.</div>;
    
            return (
                <CompetitionDashboard 
                    competition={comp} 
                    event={event}
                    onBack={() => setView('list')}
                    onFinalize={handleFinalizeCompetition}
                    onEdit={() => openEditModal(comp)}
                />
            );
        }

        return (
            <div className="space-y-8">
                <div className="flex justify-between items-center">
                    <div className="flex flex-col">
                        <h2 className="text-2xl font-bold text-white">Competitions</h2>
                        <p className="text-sm text-neutral-400">Create ticket sales competitions for DJs and Promoters.</p>
                    </div>
                    <button onClick={openCreateModal} className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 flex items-center gap-2">
                        <PlusIcon className="w-4 h-4" /> Create Competition
                    </button>
                </div>
    
                {competitions.length === 0 ? (
                    <div className="text-center py-16 bg-neutral-900/50 border-2 border-dashed border-neutral-800 rounded-2xl">
                        <MegaphoneIcon className="w-12 h-12 mx-auto text-neutral-600 mb-4" />
                        <h3 className="text-xl font-bold text-white">No Competitions Yet</h3>
                        <p className="text-neutral-500 mt-2 mb-6">Create a competition to drive engagement and ticket sales.</p>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 gap-4">
                        {competitions.map(comp => (
                            <div key={comp.id} className="bg-neutral-900 border border-neutral-800 rounded-xl p-6 flex items-center justify-between group hover:border-purple-500/50 transition-colors">
                                <div>
                                    <h3 className="text-xl font-bold text-white mb-1">{comp.name}</h3>
                                    <div className="flex items-center gap-3 text-sm text-neutral-400">
                                        <span className={`px-2 py-0.5 rounded-full text-xs font-bold uppercase tracking-wider ${
                                            comp.status === 'ACTIVE' ? 'bg-green-900/30 text-green-400' : 'bg-neutral-800 text-neutral-500'
                                        }`}>{comp.status}</span>
                                        <span>{comp.competitorIds.length} Competitors</span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => openEditModal(comp)} className="p-2 text-neutral-400 hover:text-white bg-neutral-800 hover:bg-neutral-700 rounded-lg transition-colors" title="Edit Details">
                                        <EditIcon className="w-4 h-4" />
                                    </button>
                                    <button onClick={() => { setSelectedCompetitionId(comp.id); setView('dashboard'); }} className="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg text-sm font-medium transition-colors">
                                        Manage
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    return (
        <>
            {renderContent()}
            <CompetitionEditorModal 
                isOpen={isEditorOpen}
                onClose={() => setIsEditorOpen(false)}
                onSave={handleSaveCompetition}
                event={event}
                competition={editingCompetition}
                defaultSectionId={sections[0]?.id || null}
            />
        </>
    );
};

const CompetitionDashboard: React.FC<{ 
    competition: Competition, 
    event: EventType, 
    onBack: () => void,
    onFinalize: (id: string) => void,
    onEdit: () => void
}> = ({ competition, event, onBack, onFinalize, onEdit }) => {
    const [isFinalizeModalOpen, setIsFinalizeModalOpen] = useState(false);

    const confirmFinalize = () => {
        onFinalize(competition.id);
        setIsFinalizeModalOpen(false);
    };

    return (
        <div className="space-y-6 animate-fade-in">
            <button onClick={onBack} className="flex items-center text-sm text-neutral-400 hover:text-white mb-4">
                <ArrowLeftIcon className="w-4 h-4 mr-2" /> Back to List
            </button>

            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h2 className="text-3xl font-bold text-white">{competition.name} <span className="text-neutral-500 text-lg font-normal">/ Dashboard</span></h2>
                
                <div className="flex items-center gap-4">
                    <button 
                        onClick={onEdit}
                        className="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-white rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors"
                    >
                        <EditIcon className="w-4 h-4" /> Edit Details
                    </button>

                    {competition.status === 'ACTIVE' && (
                        <button 
                            onClick={() => setIsFinalizeModalOpen(true)} 
                            className="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg text-sm font-semibold flex items-center gap-2 transition-colors"
                        >
                            <StopCircleIcon className="w-4 h-4" />
                            End Competition
                        </button>
                    )}
                </div>
            </div>

            <div className="space-y-8">
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-8">
                    <h3 className="text-xl font-bold text-white mb-4">Competition Settings</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-neutral-300">
                        <div>
                            <p className="text-xs text-neutral-500 uppercase mb-1">Description</p>
                            <p>{competition.description}</p>
                        </div>
                        <div>
                            <p className="text-xs text-neutral-500 uppercase mb-1">Status</p>
                            <span className={`px-2 py-1 rounded text-white text-sm font-bold uppercase tracking-wide ${
                                competition.status === 'ACTIVE' ? 'bg-green-600/20 text-green-400' : 
                                competition.status === 'COMPLETED' ? 'bg-blue-600/20 text-blue-400' : 
                                'bg-neutral-800 text-neutral-400'
                            }`}>{competition.status}</span>
                        </div>
                    </div>
                </div>
                
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-8">
                    <ApplicantsListView competition={competition} eventId={event.id} />
                </div>
            </div>

            <Modal isOpen={isFinalizeModalOpen} onClose={() => setIsFinalizeModalOpen(false)}>
                <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl p-8 text-center">
                    <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20">
                        <ShieldIcon className="w-8 h-8 text-red-500" />
                    </div>
                    <h3 className="text-2xl font-bold text-white mb-3">End Competition?</h3>
                    <p className="text-neutral-400 text-sm mb-6 leading-relaxed">
                        Are you sure you want to end this competition? <br/><br/>
                        <span className="text-red-400 font-bold">This action is irreversible.</span>
                        <br/>
                        The current leaderboard standings will be finalized, winners will be permanently recorded, and the event schedule will be automatically updated with the winning acts.
                    </p>
                    <div className="flex gap-4 justify-center">
                        <button 
                            onClick={() => setIsFinalizeModalOpen(false)}
                            className="px-6 py-3 text-sm font-semibold text-neutral-300 bg-neutral-800 hover:bg-neutral-700 rounded-full transition-colors"
                        >
                            Cancel
                        </button>
                        <button 
                            onClick={confirmFinalize}
                            className="px-6 py-3 bg-red-600 hover:bg-red-500 text-white text-sm font-bold rounded-full shadow-lg shadow-red-900/20 transition-colors"
                        >
                            Confirm & End
                        </button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

// --- Component for Applicants / Competitors ---
const ApplicantsListView: React.FC<{ competition: Competition, eventId: string }> = ({ competition, eventId }) => {
    const [applicants, setApplicants] = useState<User[]>([]);
    const [loading, setLoading] = useState(true);
    const [leaderboardData, setLeaderboardData] = useState<Record<string, LeaderboardEntry>>({});

    const fetchData = useCallback(async () => {
        setLoading(true);
        try {
            // 1. Fetch Leaderboard Stats first (they contain all necessary competitor info)
            const stats = await api.getCompetitionLeaderboard(eventId);
            const statsMap: Record<string, LeaderboardEntry> = {};
            const leaderboardUserIds: string[] = [];
            stats.forEach(entry => {
                statsMap[entry.userId] = entry;
                leaderboardUserIds.push(entry.userId);
            });
            setLeaderboardData(statsMap);

            // 2. Fetch Users based on a union of the official competitor list AND anyone who shows up in the leaderboard
            // This handles cases where data might be out of sync (e.g. user in leaderboard but not in competitor list)
            // Use Set to remove duplicates
            const idsToFetch = Array.from(new Set([
                ...(competition.competitorIds || []), 
                ...leaderboardUserIds
            ]));

            if (idsToFetch.length > 0) {
                const users = await api.getUsersByIds(idsToFetch);
                setApplicants(users);
            } else {
                setApplicants([]);
            }

        } catch (e) {
            console.error("Failed to load applicants", e);
        } finally {
            setLoading(false);
        }
    }, [competition.competitorIds, eventId]);

    useEffect(() => {
        fetchData();
    }, [fetchData]);

    const sortedApplicants = useMemo(() => {
        return [...applicants].sort((a, b) => {
            const salesA = leaderboardData[a.id]?.salesValue || 0;
            const salesB = leaderboardData[b.id]?.salesValue || 0;
            return salesB - salesA; // Descending order
        });
    }, [applicants, leaderboardData]);

    return (
        <div className="overflow-hidden">
            <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold text-white">Competitor Leaderboard</h3>
                <button 
                    onClick={fetchData} 
                    className="p-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-white rounded-lg transition-colors"
                    title="Refresh List"
                >
                    <RefreshCwIcon className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                </button>
            </div>

            {loading ? (
                <div className="text-center py-12 text-neutral-500">Loading competitors...</div>
            ) : applicants.length === 0 ? (
                <div className="text-center py-16">
                    <UsersIcon className="w-12 h-12 mx-auto text-neutral-600 mb-4" />
                    <h3 className="text-xl font-bold text-white">No Competitors Yet</h3>
                    <p className="text-neutral-500 mt-2">Share your form link to start getting submissions.</p>
                </div>
            ) : (
                <table className="w-full text-sm text-left text-neutral-300">
                    <thead className="text-xs text-neutral-400 uppercase bg-neutral-950/30 border-b border-neutral-800">
                        <tr>
                            <th className="px-6 py-4 text-center">Referrals</th>
                            <th className="px-6 py-4">Competitor</th>
                            <th className="hidden md:table-cell px-6 py-4 text-right">Sales</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-800">
                        {sortedApplicants.map((applicant, index) => {
                            const stats = leaderboardData[applicant.id];
                            const rank = index + 1;
                            return (
                                <tr key={applicant.id} className="hover:bg-neutral-800/30">
                                    <td className="px-6 py-4 text-center">
                                        {stats ? stats.salesCount : 0}
                                    </td>
                                    <td className="px-6 py-4 font-medium text-white flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${
                                            rank === 1 ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' : 
                                            rank === 2 ? 'bg-gray-400/20 text-gray-300 border border-gray-400/30' :
                                            rank === 3 ? 'bg-orange-500/20 text-orange-400 border border-orange-500/30' :
                                            'bg-neutral-800 text-neutral-500'
                                        }`}>
                                            {applicant.name.charAt(0)}
                                        </div>
                                        {applicant.name}
                                    </td>
                                    <td className="hidden md:table-cell px-6 py-4 text-right font-mono text-purple-400 font-bold">
                                        ${stats ? stats.salesValue.toFixed(2) : '0.00'}
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            )}
        </div>
    );
};

const CompetitionEditorModal: React.FC<{
    isOpen: boolean;
    onClose: () => void;
    onSave: (competition: Competition) => void;
    event: EventType;
    competition: Competition | null;
    defaultSectionId: string | null;
}> = ({ isOpen, onClose, onSave, event, competition, defaultSectionId }) => {

    const isFundraiser = event.type === 'fundraiser';

    const getInitialState = useCallback(() => ({
        id: competition?.id || `comp-${uuidv4()}`,
        type: 'DJ_TICKET_SALES' as const,
        status: competition?.status || 'SETUP',
        name: competition?.name || '',
        description: competition?.description || '',
        startDate: competition?.startDate || new Date().toISOString(),
        cutoffDate: competition?.cutoffDate || event.date,
        promoDiscountPercent: competition?.promoDiscountPercent ?? (isFundraiser ? 0 : 10),
        commissionPercent: competition?.commissionPercent ?? 10, // NEW
        sectionIds: competition?.sectionIds || (defaultSectionId ? [defaultSectionId] : []),
        competitorIds: competition?.competitorIds || [],
    }), [competition, event.date, defaultSectionId, isFundraiser]);
    
    const [compData, setCompData] = useState<Omit<Competition, 'winnerIds' | 'forms'>>(getInitialState);

    useEffect(() => {
        if (isOpen) {
            setCompData(getInitialState());
        }
    }, [isOpen, getInitialState]);

    const handleSave = () => {
        onSave(compData as Competition);
    };
    
    const handleSectionToggle = (sectionId: string) => {
        setCompData(prev => {
            const newSectionIds = prev.sectionIds.includes(sectionId)
                ? prev.sectionIds.filter(id => id !== sectionId)
                : [...prev.sectionIds, sectionId];
            return { ...prev, sectionIds: newSectionIds };
        });
    };

    const dateTimeLocalValue = (dateString: string) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
        return date.toISOString().slice(0, 16);
    }
    
    return (
        <Modal isOpen={isOpen} onClose={onClose}>
            <div className="w-full max-w-2xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl max-h-[90vh] flex flex-col">
                <div className="p-8 border-b border-neutral-800">
                    <h2 className="text-2xl font-bold text-white">{competition ? 'Edit Competition' : 'Create Competition'}</h2>
                    <p className="text-neutral-400">Configure the competition details for your event.</p>
                </div>

                <div className="p-8 space-y-6 overflow-y-auto">
                    <div>
                        <label className="block text-sm font-medium text-neutral-300 mb-2">Competition Name</label>
                        <input type="text" value={compData.name} onChange={e => setCompData({...compData, name: e.target.value})} placeholder="e.g., Main Stage DJ Battle" className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-neutral-300 mb-2">Description</label>
                        <textarea value={compData.description} onChange={e => setCompData({...compData, description: e.target.value})} rows={3} className="w-full p-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white resize-none" />
                    </div>
                     <div>
                        <label className="block text-sm font-medium text-neutral-300 mb-2">Sales Tracking Cutoff</label>
                        <input type="datetime-local" value={dateTimeLocalValue(compData.cutoffDate)} onChange={e => setCompData({...compData, cutoffDate: e.target.value})} className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white" />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {!isFundraiser && (
                            <div>
                                <label className="block text-sm font-medium text-neutral-300 mb-2">Buyer Discount (%)</label>
                                <input type="number" value={compData.promoDiscountPercent} onChange={e => setCompData({...compData, promoDiscountPercent: parseInt(e.target.value) || 0})} min="0" max="100" className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white" />
                                <p className="text-[10px] text-neutral-500 mt-1">Discount applied to fans using the link.</p>
                            </div>
                        )}
                        <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Competitor Commission (%)</label>
                            <input type="number" value={compData.commissionPercent} onChange={e => setCompData({...compData, commissionPercent: parseInt(e.target.value) || 0})} min="0" max="100" className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white" />
                            <p className="text-[10px] text-neutral-500 mt-1">Overrides the default event commission.</p>
                        </div>
                    </div>

                     <div>
                        <label className="block text-sm font-medium text-neutral-300 mb-2">Competition Sections</label>
                        <p className="text-xs text-neutral-500 mb-3">Select which venue sections this competition applies to.</p>
                        <div className="space-y-3 p-4 bg-neutral-800 rounded-lg">
                            {(event.venueAreas && event.venueAreas.length > 0) ? event.venueAreas.map(area => (
                                <label key={area.id} className="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" checked={compData.sectionIds.includes(area.id)} onChange={() => handleSectionToggle(area.id)} className="h-4 w-4 rounded bg-neutral-700 border-neutral-600 text-purple-600 focus:ring-purple-500" />
                                    <span className="text-white font-medium">{area.name}</span>
                                </label>
                            )) : <p className="text-neutral-500 text-sm text-center">No venue sections defined. Please add sections first.</p>}
                        </div>
                    </div>
                </div>

                <div className="p-4 bg-neutral-900/50 border-t border-neutral-800 flex justify-end gap-4">
                     <button onClick={onClose} className="px-5 py-2 text-sm font-semibold text-neutral-300 bg-neutral-800 hover:bg-neutral-700 rounded-full transition-colors">Cancel</button>
                    <button onClick={handleSave} className="px-5 py-2 text-sm font-semibold rounded-full bg-purple-600 text-white hover:bg-purple-500">Save Competition</button>
                </div>
            </div>
        </Modal>
    )
}

export default CompetitionsTab;

--- END OF FILE ./components/admin/CompetitionsTab.tsx ---




--- START OF FILE ./components/admin/MarketingTab.tsx ---


import React, { useState, useEffect } from 'react';
import { Event as EventType } from '../../types';
import CompetitionsTab from './CompetitionsTab';
import PromoCodesTab from './PromoCodesTab';
import FormsTab from './FormsTab';

const MarketingTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const [activeSubTab, setActiveSubTab] = useState<'competitions' | 'promocodes' | 'forms'>('competitions');

    // If the current event is a fundraiser, and the user somehow landed on the 'promocodes' tab,
    // redirect them to the first available tab.
    useEffect(() => {
        if (event.type === 'fundraiser' && activeSubTab === 'promocodes') {
            setActiveSubTab('competitions');
        }
    }, [event.type, activeSubTab]);

    return (
        <div className="space-y-6">
            <h1 className="text-3xl font-bold tracking-tight text-white">Marketing</h1>
            
            <div className="border-b border-neutral-800">
                <nav className="flex -mb-px space-x-8">
                    <button 
                        onClick={() => setActiveSubTab('competitions')} 
                        className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                            activeSubTab === 'competitions' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'
                        }`}
                    >
                        Competitions
                    </button>
                    {event.type !== 'fundraiser' && (
                        <button 
                            onClick={() => setActiveSubTab('promocodes')} 
                            className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                                activeSubTab === 'promocodes' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'
                            }`}
                        >
                            Promo Codes
                        </button>
                    )}
                    <button 
                        onClick={() => setActiveSubTab('forms')} 
                        className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                            activeSubTab === 'forms' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'
                        }`}
                    >
                        Forms
                    </button>
                </nav>
            </div>

            <div>
                {activeSubTab === 'competitions' && (
                    <div className="animate-fade-in">
                       <CompetitionsTab event={event} onEventUpdate={onEventUpdate} />
                    </div>
                )}
                {activeSubTab === 'promocodes' && event.type !== 'fundraiser' && (
                    <div className="animate-fade-in">
                        <PromoCodesTab event={event} />
                    </div>
                )}
                {activeSubTab === 'forms' && (
                    <div className="animate-fade-in">
                        <FormsTab event={event} onEventUpdate={onEventUpdate} />
                    </div>
                )}
            </div>
        </div>
    );
};

export default MarketingTab;
--- END OF FILE ./components/admin/MarketingTab.tsx ---




--- START OF FILE ./components/admin/SectionsTab.tsx ---


import React, { useState } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType, VenueArea } from '../../types';
import { TrashIcon } from '../Icons';

const SectionsTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const { user } = useAuth();
    const [sections, setSections] = useState<VenueArea[]>(event.venueAreas || []);
    const [isSaving, setIsSaving] = useState(false);

    const handleSave = async () => {
        if (!user) return;
        setIsSaving(true);
        try {
            await api.updateEvent(user.id, event.id, { venueAreas: sections });
            onEventUpdate();
            alert("Sections updated!");
        } catch (e) {
            console.error(e);
            alert("Failed to update sections.");
        } finally {
            setIsSaving(false);
        }
    };

    const handleAdd = () => {
        setSections([...sections, { id: uuidv4(), name: 'New Section' }]);
    };

    const handleRemove = (id: string) => {
        setSections(sections.filter(s => s.id !== id));
    };

    const handleUpdate = (id: string, name: string) => {
        setSections(sections.map(s => s.id === id ? { ...s, name } : s));
    };

    return (
        <div className="space-y-6 max-w-3xl">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold tracking-tight text-white">Venue Sections</h1>
                <button onClick={handleSave} disabled={isSaving} className="bg-purple-600 text-white px-6 py-2 rounded-full font-semibold disabled:opacity-50">
                    {isSaving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
            
            <div className="space-y-4">
                {sections.map(section => (
                    <div key={section.id} className="bg-neutral-800 p-4 rounded-lg flex gap-4 items-center">
                        <input 
                            type="text" 
                            value={section.name} 
                            onChange={e => handleUpdate(section.id, e.target.value)}
                            className="flex-1 bg-neutral-700 border border-neutral-600 rounded px-3 py-2 text-white"
                            placeholder="Section Name"
                        />
                        <button onClick={() => handleRemove(section.id)} className="text-red-400 hover:text-red-300">
                            <TrashIcon className="w-5 h-5" />
                        </button>
                    </div>
                ))}
                <button onClick={handleAdd} className="w-full py-3 border-2 border-dashed border-neutral-700 rounded-lg text-neutral-400 hover:text-white hover:border-purple-500 transition-colors">
                    + Add Section
                </button>
            </div>
        </div>
    );
};

export default SectionsTab;

--- END OF FILE ./components/admin/SectionsTab.tsx ---




--- START OF FILE ./components/admin/ReportsTab.tsx ---


import React, { useState, useEffect } from 'react';
import * as api from '../../services/api';
import { ReportData, Order } from '../../types';
import { DownloadIcon, SearchIcon } from '../Icons';

const ReportsTab: React.FC<{ eventId: string }> = ({ eventId }) => {
    const [reportData, setReportData] = useState<ReportData | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [activeTab, setActiveTab] = useState('sales');

    useEffect(() => {
        const fetchReport = async () => {
            if (!eventId) return;
            setIsLoading(true);
            try {
                const data = await api.getReportData(eventId);
                setReportData(data);
            } catch (err) {
                setError("Failed to load report data.");
            } finally {
                setIsLoading(false);
            }
        };
        fetchReport();
    }, [eventId]);

    if (isLoading) return <div className="text-center py-20 text-neutral-400">Generating reports...</div>;
    if (error) return <div className="text-center py-20 text-red-400">{error}</div>;
    if (!reportData) return <div className="text-center py-20 text-neutral-400">No report data available.</div>;

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                 <h1 className="text-3xl font-bold tracking-tight text-white">Reports</h1>
            </div>
            
            <div className="border-b border-neutral-800">
                <nav className="flex -mb-px space-x-8">
                    <button onClick={() => setActiveTab('sales')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${activeTab === 'sales' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}>
                        Overview
                    </button>
                    <button onClick={() => setActiveTab('promotions')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${activeTab === 'promotions' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}>
                        Promoters ({reportData.promotions.filter(p => !(p.promoterName === 'Unknown User' && p.sales === 0)).length})
                    </button>
                    <button onClick={() => setActiveTab('detailed')} className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${activeTab === 'detailed' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}>
                        Detailed Orders
                    </button>
                </nav>
            </div>

            <div>
                {activeTab === 'sales' && <SalesReportTab data={reportData} />}
                {activeTab === 'promotions' && <PromotionsReportTab data={reportData} />}
                {activeTab === 'detailed' && <DetailedOrdersReportTab eventId={eventId} />}
            </div>
        </div>
    );
};

const SalesReportTab: React.FC<{ data: ReportData }> = ({ data }) => {
    // Calculate affiliate sales count from the promotions list to ensure accuracy
    const totalAffiliateSalesCount = data.promotions.reduce((sum, p) => sum + p.sales, 0);

    return (
        <div className="space-y-6">
            <div className="flex flex-wrap gap-4">
                <div className="flex-auto min-w-[160px] bg-neutral-900 border border-neutral-800 rounded-xl p-4">
                    <p className="text-xs text-neutral-400 uppercase mb-1">Gross Sales</p>
                    <p className="text-2xl font-bold text-white whitespace-nowrap">${data.kpis.grossSales.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                </div>
                <div className="flex-auto min-w-[160px] bg-neutral-900 border border-neutral-800 rounded-xl p-4">
                    <p className="text-xs text-neutral-400 uppercase mb-1">Tickets Sold</p>
                    <p className="text-2xl font-bold text-white">{data.kpis.ticketsSold.toLocaleString()}</p>
                </div>
                <div className="flex-auto min-w-[160px] bg-neutral-900 border border-neutral-800 rounded-xl p-4">
                    <p className="text-xs text-neutral-400 uppercase mb-1">Page Views</p>
                    <p className="text-2xl font-bold text-white">{data.kpis.pageViews.toLocaleString()}</p>
                </div>
                <div className="flex-auto min-w-[160px] bg-neutral-900 border border-neutral-800 rounded-xl p-4">
                    <p className="text-xs text-neutral-400 uppercase mb-1">Affiliate Sales</p>
                    <p className="text-2xl font-bold text-purple-400">{totalAffiliateSalesCount.toLocaleString()}</p>
                </div>
            </div>

            {data.salesByTicketType.length > 0 && (
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4">Sales by Ticket Type</h3>
                    <div className="space-y-4">
                        {data.salesByTicketType.map((item) => (
                            <div key={item.type} className="flex items-center justify-between">
                                <div>
                                    <p className="text-white font-medium">{item.type}</p>
                                    <p className="text-sm text-neutral-400">{item.quantitySold} sold</p>
                                </div>
                                <p className="text-white font-bold">${item.grossSales.toFixed(2)}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};

const PromotionsReportTab: React.FC<{ data: ReportData }> = ({ data }) => {
    const [search, setSearch] = useState('');

    const filteredPromotions = data.promotions.filter(p => {
        // FILTER: Hide "Unknown User" entries that have no activity.
        // This cleans up ghost entries returned by the API during data inconsistencies.
        if (p.promoterName === 'Unknown User' && p.sales === 0 && p.clicks === 0 && p.earned === 0) {
            return false;
        }

        const lowerSearch = search.toLowerCase();
        return (
            p.promoterName.toLowerCase().includes(lowerSearch) ||
            (p.artistName && p.artistName.toLowerCase().includes(lowerSearch))
        );
    });

    return (
        <div className="space-y-6">
            <div className="relative">
                <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500" />
                <input
                    type="text"
                    placeholder="Search promoters by name or artist name..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full max-w-md pl-10 pr-4 py-2 bg-neutral-900 border border-neutral-800 rounded-lg text-sm text-white focus:outline-none focus:border-purple-500 transition-colors"
                />
            </div>

            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden">
                <table className="w-full text-sm text-left text-neutral-300">
                    <thead className="text-xs text-neutral-400 uppercase bg-neutral-950 border-b border-neutral-800">
                        <tr>
                            <th className="px-6 py-3">Promoter</th>
                            <th className="px-6 py-3 text-center">Role</th>
                            <th className="px-6 py-3 text-center">Clicks</th>
                            <th className="px-6 py-3 text-center">Sales</th>
                            <th className="px-6 py-3 text-right">Commission Earned</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-800">
                        {filteredPromotions.map((promo, idx) => {
                            // FIX: Calculate commission client-side if backend returns 0 but sales > 0.
                            let displayEarned = promo.earned;
                            
                            // If backend reporting is lagging (ledger empty), calculate it from volume
                            if (displayEarned === 0 && promo.sales > 0 && data.event.commission > 0) {
                                // Prefer explicit salesVolume if available, otherwise fallback to estimated volume
                                const volume = (promo as any).salesVolume || 0;
                                if (volume > 0) {
                                    displayEarned = volume * (data.event.commission / 100);
                                }
                            }

                            return (
                                <tr key={`${promo.promoterName}-${idx}`} className="hover:bg-neutral-800/30">
                                    <td className="px-6 py-4">
                                        <span className="font-medium text-white block">{promo.promoterName}</span>
                                        {promo.artistName && <span className="text-xs text-neutral-500 block">({promo.artistName})</span>}
                                    </td>
                                    <td className="px-6 py-4 text-center">
                                        {promo.isCompetitor ? (
                                            <span className="inline-block px-2 py-1 rounded-full bg-purple-500/20 text-purple-300 border border-purple-500/30 text-xs font-bold">
                                                Competitor
                                            </span>
                                        ) : (
                                            <span className="inline-block px-2 py-1 rounded-full bg-blue-500/10 text-blue-400 border border-blue-500/20 text-xs font-bold">
                                                Promoter
                                            </span>
                                        )}
                                    </td>
                                    <td className="px-6 py-4 text-center">{promo.clicks}</td>
                                    <td className="px-6 py-4 text-center">{promo.sales}</td>
                                    <td className="px-6 py-4 text-right text-green-400 font-mono font-bold">
                                        ${displayEarned.toFixed(2)}
                                    </td>
                                </tr>
                            );
                        })}
                        {filteredPromotions.length === 0 && (
                            <tr><td colSpan={5} className="text-center py-8 text-neutral-500">No promoters found.</td></tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const DetailedOrdersReportTab: React.FC<{ eventId: string }> = ({ eventId }) => {
    const [orders, setOrders] = useState<Order[]>([]);
    const [checkIns, setCheckIns] = useState<Record<string, string>>({});
    const [isLoading, setIsLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState(1);
    const ITEMS_PER_PAGE = 20;

    useEffect(() => {
        setIsLoading(true);
        Promise.all([
            api.getOrdersForEvent(eventId),
            api.getEventDetails(eventId)
        ]).then(async ([ordersData, eventData]) => {
            setOrders(ordersData);
            setCheckIns(eventData.checkIns || {});
        }).finally(() => setIsLoading(false));
    }, [eventId]);

    // Flatten orders into individual tickets
    const rows = React.useMemo(() => {
        const r: any[] = [];
        orders.forEach(order => {
             let purchaserName = order.purchaserName;
             let purchaserEmail = order.purchaserEmail;

             const buyerParts = purchaserName.trim().split(/\s+/);
             const buyerFirst = buyerParts[0] || '';
             const buyerLast = buyerParts.slice(1).join(' ') || '';
             
             let grossTotal = 0;
             const items = order.items || []; 
             
             items.forEach(item => grossTotal += item.pricePerTicket * item.quantity);
             const discountTotal = Math.max(0, grossTotal - order.totalPaid);
             const discountRatio = grossTotal > 0 ? discountTotal / grossTotal : 0;

             let ticketIndexCounter = 0;

             items.forEach(item => {
                const unitPrice = item.pricePerTicket;
                const unitDiscount = unitPrice * discountRatio;
                const unitPaid = Math.max(0, unitPrice - unitDiscount);
                
                const discountText = unitDiscount > 0 
                    ? `$${unitDiscount.toFixed(2)}${order.promoCode ? ' (' + order.promoCode + ')' : ''}`
                    : '-';
                
                const affiliateName = order.recipientUserName 
                    ? order.recipientUserName 
                    : (order.promoCode ? `${order.promoCode} (Code)` : '-');

                for (let i = 0; i < item.quantity; i++) {
                    const ticketId = `${order.orderId}-${ticketIndexCounter}`;
                    const isCheckedIn = !!checkIns[ticketId];

                    r.push({
                        uniqueRowId: `${ticketId}`, 
                        orderId: order.orderId,
                        ticketType: item.ticketType,
                        quantity: 1,
                        discount: discountText,
                        affiliate: affiliateName,
                        buyerFirst,
                        buyerLast,
                        email: purchaserEmail,
                        date: new Date(order.purchaseDate).toLocaleString('en-US', { 
                            year: 'numeric', 
                            month: 'numeric', 
                            day: 'numeric', 
                            hour: 'numeric', 
                            minute: 'numeric',
                            hour12: true 
                        }),
                        totalPaid: unitPaid.toFixed(2), 
                        checkInStatus: isCheckedIn ? 'Yes' : 'No',
                        isCheckedIn: isCheckedIn
                    });
                    
                    ticketIndexCounter++;
                }
             });
        });
        return r;
    }, [orders, checkIns]);

    const totalPages = Math.ceil(rows.length / ITEMS_PER_PAGE);
    const paginatedRows = rows.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

    if (isLoading) return <div className="text-center py-20 text-neutral-400">Loading orders...</div>;

    return (
        <div className="space-y-4">
             <div className="flex justify-between items-center">
                <h3 className="text-xl font-bold text-white">Detailed Orders (Per Ticket)</h3>
                <button className="px-4 py-2 bg-neutral-900 border border-neutral-800 rounded-lg text-sm text-neutral-400 hover:text-white transition-colors flex items-center gap-2">
                    <DownloadIcon className="w-4 h-4"/> Export CSV
                </button>
            </div>
            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-neutral-300 whitespace-nowrap">
                        <thead className="text-xs text-neutral-400 uppercase bg-neutral-950 border-b border-neutral-800">
                            <tr>
                                <th className="px-6 py-3">Order ID</th>
                                <th className="px-6 py-3">First Name</th>
                                <th className="px-6 py-3">Last Name</th>
                                <th className="px-6 py-3">Email</th>
                                <th className="px-6 py-3">Ticket Type</th>
                                <th className="px-6 py-3 text-center">Qty</th>
                                <th className="px-6 py-3 text-center">Checked In</th>
                                <th className="px-6 py-3 text-right">Paid</th>
                                <th className="px-6 py-3">Discount/Promo</th>
                                <th className="px-6 py-3">Affiliate</th>
                                <th className="px-6 py-3">Date & Time</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-800">
                            {paginatedRows.map((row, idx) => (
                                <tr key={`${row.uniqueRowId}-${idx}`} className="hover:bg-neutral-800/30">
                                    <td className="px-6 py-4 font-mono text-xs text-neutral-500">{row.orderId}</td>
                                    <td className="px-6 py-4 text-white">{row.buyerFirst}</td>
                                    <td className="px-6 py-4 text-white">{row.buyerLast}</td>
                                    <td className="px-6 py-4 text-neutral-400">{row.email}</td>
                                    <td className="px-6 py-4">{row.ticketType}</td>
                                    <td className="px-6 py-4 text-center">{row.quantity}</td>
                                    <td className="px-6 py-4 text-center">
                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${row.isCheckedIn ? 'bg-green-500/10 text-green-400' : 'bg-neutral-800 text-neutral-500'}`}>
                                            {row.checkInStatus}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 text-right font-medium text-white">${row.totalPaid}</td>
                                    <td className="px-6 py-4 text-neutral-400">{row.discount}</td>
                                    <td className="px-6 py-4 text-purple-400 font-medium">{row.affiliate}</td>
                                    <td className="px-6 py-4 text-neutral-500">{row.date}</td>
                                </tr>
                            ))}
                            {paginatedRows.length === 0 && (
                                <tr><td colSpan={11} className="text-center py-8 text-neutral-500">No orders found.</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
                 {totalPages > 1 && (
                    <div className="flex justify-between items-center p-4 bg-neutral-900 border-t border-neutral-800">
                        <span className="text-sm text-neutral-400">Page {currentPage} of {totalPages}</span>
                        <div className="flex space-x-2">
                            <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="px-3 py-1 text-sm font-semibold rounded-lg bg-neutral-800 hover:bg-neutral-700 disabled:opacity-50">Prev</button>
                            <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className="px-3 py-1 text-sm font-semibold rounded-lg bg-neutral-800 hover:bg-neutral-700 disabled:opacity-50">Next</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

export default ReportsTab;

--- END OF FILE ./components/admin/ReportsTab.tsx ---




--- START OF FILE ./components/admin/ScheduleTab.tsx ---


import React, { useState, useEffect, useMemo, useRef } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType, ScheduleItem } from '../../types';
import { GripVerticalIcon, LayoutGridIcon, TrashIcon } from '../Icons';

const formatTimeForInput = (isoString: string): string => {
    if (!isoString) return '';
    const date = new Date(isoString);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
};

const updateIsoWithTime = (originalIso: string, newTime: string): string => {
    const date = new Date(originalIso);
    const [hours, minutes] = newTime.split(':').map(Number);
    if (!isNaN(hours) && !isNaN(minutes)) {
        date.setHours(hours, minutes, 0, 0);
    }
    return date.toISOString();
};

const ScheduleTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const { user } = useAuth();
    const [schedule, setSchedule] = useState<ScheduleItem[]>(event.schedule || []);
    const [isSaving, setIsSaving] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    const sections = useMemo(() => {
        if (event.venueAreas && event.venueAreas.length > 0) {
            return event.venueAreas;
        }
        return [{ id: 'default-area', name: 'Main Venue' }];
    }, [event.venueAreas]);

    const [activeSectionId, setActiveSectionId] = useState<string>(sections[0].id);

    useEffect(() => {
        setSchedule(event.schedule || []);
    }, [event.schedule]);
    
    useEffect(() => {
        if (!sections.find(s => s.id === activeSectionId)) {
            setActiveSectionId(sections[0]?.id);
        }
    }, [sections, activeSectionId]);

    const handleSave = async () => {
        if (!user) return;
        setIsSaving(true);
        setSaveSuccess(false);
        try {
            await api.updateEvent(user.id, event.id, { schedule });
            setSaveSuccess(true);
            onEventUpdate();
            setTimeout(() => setSaveSuccess(false), 2000);
        } catch (error) {
            console.error("Failed to save schedule:", error);
            alert("Failed to save changes.");
        } finally {
            setIsSaving(false);
        }
    };

    const handleSectionScheduleChange = (sectionId: string, newItems: ScheduleItem[]) => {
        const otherItems = schedule.filter(item => item.areaId !== sectionId);
        setSchedule([...otherItems, ...newItems].sort((a,b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime()));
    };

    return (
        <div className="space-y-8">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold tracking-tight text-white">Schedule</h1>
                <button onClick={handleSave} disabled={isSaving || saveSuccess} className="px-6 py-3 text-sm font-semibold rounded-full min-w-[140px] text-center bg-purple-600 text-white hover:bg-purple-500 disabled:bg-neutral-700 disabled:text-neutral-500">
                    {isSaving ? 'Saving...' : saveSuccess ? 'Saved!' : 'Save Schedule'}
                </button>
            </div>
            
            <div className="border-b border-neutral-800">
                <nav className="flex -mb-px space-x-6 overflow-x-auto">
                    {sections.map(section => (
                        <button key={section.id} onClick={() => setActiveSectionId(section.id)} className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-all ${activeSectionId === section.id ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}>
                            {section.name}
                        </button>
                    ))}
                </nav>
            </div>

            <SectionScheduleView
                key={activeSectionId}
                event={event}
                sectionId={activeSectionId}
                items={schedule.filter(item => item.areaId === activeSectionId).sort((a,b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime())}
                onItemsChange={(newItems) => handleSectionScheduleChange(activeSectionId, newItems)}
            />
        </div>
    );
};

const SectionScheduleView: React.FC<{
    event: EventType;
    sectionId: string;
    items: ScheduleItem[];
    onItemsChange: (items: ScheduleItem[]) => void;
}> = ({ event, sectionId, items, onItemsChange }) => {
    const dragItem = useRef<number | null>(null);
    const dragOverItem = useRef<number | null>(null);

    useEffect(() => {
        if (items.length === 0 && event.date && event.endDate) {
            const defaultItem: ScheduleItem = {
                id: uuidv4(),
                areaId: sectionId,
                title: 'Event Duration',
                startTime: event.date,
                endTime: event.endDate,
            };
            onItemsChange([defaultItem]);
        }
    }, [items.length, event.date, event.endDate, sectionId, onItemsChange]);

    const handleUpdate = (updatedItem: ScheduleItem, index: number) => {
        const newItems = [...items];
        newItems[index] = updatedItem;

        const changedStartTime = newItems[index].startTime !== items[index].startTime;
        const changedEndTime = newItems[index].endTime !== items[index].endTime;

        if (changedStartTime && newItems[index - 1]) {
            newItems[index - 1].endTime = updatedItem.startTime;
        }
        if (changedEndTime && newItems[index + 1]) {
            newItems[index + 1].startTime = updatedItem.endTime;
        }

        onItemsChange(newItems);
    };

    const handleSplit = (index: number) => {
        const itemToSplit = items[index];
        const start = new Date(itemToSplit.startTime).getTime();
        const end = new Date(itemToSplit.endTime).getTime();
        const midTime = start + (end - start) / 2;
        
        if (midTime <= start) return;
        
        const mid = new Date(midTime).toISOString();

        const newItem1: ScheduleItem = { ...itemToSplit, endTime: mid };
        const newItem2: ScheduleItem = {
            id: uuidv4(),
            areaId: sectionId,
            title: itemToSplit.title,
            startTime: mid,
            endTime: itemToSplit.endTime,
        };

        const newItems = [...items];
        newItems.splice(index, 1, newItem1, newItem2);
        onItemsChange(newItems);
    };

    const handleDelete = (id: string) => {
        onItemsChange(items.filter(item => item.id !== id));
    };
    
    const handleDragSort = () => {
        if (dragItem.current === null || dragOverItem.current === null || dragItem.current === dragOverItem.current) return;

        let newItems = [...items];
        const draggedItemContent = newItems.splice(dragItem.current, 1)[0];
        newItems.splice(dragOverItem.current, 0, draggedItemContent);
        
        let lastEndTime = event.date; 
        newItems = newItems.map((item, index) => {
            const startTime = index === 0 ? new Date(event.date) : new Date(lastEndTime);
            const duration = new Date(item.endTime).getTime() - new Date(item.startTime).getTime();
            const endTime = new Date(startTime.getTime() + duration);
            
            lastEndTime = endTime.toISOString();
            
            return {
                ...item,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
            };
        });
        
        dragItem.current = null;
        dragOverItem.current = null;
        onItemsChange(newItems);
    };


    if (!event.date || !event.endDate) {
        return <div className="text-center text-neutral-500 p-8 bg-neutral-900 rounded-lg">Please set a start and end date for the event in the 'Details' tab to manage the schedule.</div>;
    }

    return (
        <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
            <div className="space-y-2">
                {items.map((item, index) => (
                    <div 
                        key={item.id}
                        draggable
                        onDragStart={() => dragItem.current = index}
                        onDragEnter={() => dragOverItem.current = index}
                        onDragEnd={handleDragSort}
                        onDragOver={(e) => e.preventDefault()}
                        className="cursor-pointer"
                    >
                        <TimeBlockEditor 
                            item={item}
                            onUpdate={(updated) => handleUpdate(updated, index)}
                            onDelete={() => handleDelete(item.id)}
                            onSplit={() => handleSplit(index)}
                        />
                    </div>
                ))}
            </div>
             {items.length === 0 && (
                <div className="text-center py-10 border-2 border-dashed border-neutral-800 rounded-lg">
                    <p className="text-neutral-500">No schedule items for this section.</p>
                </div>
            )}
        </div>
    );
};

const TimeBlockEditor: React.FC<{
    item: ScheduleItem;
    onUpdate: (item: ScheduleItem) => void;
    onDelete: () => void;
    onSplit: () => void;
}> = ({ item, onUpdate, onDelete, onSplit }) => {
    
    const handleTitleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        onUpdate({ ...item, title: e.target.value });
    };

    const handleTimeChange = (type: 'start' | 'end', timeValue: string) => {
        const field = type === 'start' ? 'startTime' : 'endTime';
        const dateToUpdate = item[field];
        onUpdate({ ...item, [field]: updateIsoWithTime(dateToUpdate, timeValue) });
    };

    return (
        <div className="bg-neutral-800 p-4 rounded-lg border border-neutral-700 flex flex-col sm:flex-row items-center gap-4">
            <div className="cursor-grab text-neutral-500 p-2"><GripVerticalIcon className="w-5 h-5"/></div>
            <input
                type="text"
                value={item.title}
                onChange={handleTitleChange}
                placeholder="Artist or Set Name"
                className="flex-grow w-full sm:w-auto h-10 px-3 bg-neutral-700 rounded-md text-white border-transparent focus:border-purple-500 focus:ring-purple-500"
            />
            <div className="flex items-center gap-2">
                <input type="time" value={formatTimeForInput(item.startTime)} onChange={e => handleTimeChange('start', e.target.value)} step="60" className="w-28 h-10 px-2 bg-neutral-700 rounded-md text-white border-transparent focus:border-purple-500 focus:ring-purple-500"/>
                <span className="text-neutral-500">-</span>
                <input type="time" value={formatTimeForInput(item.endTime)} onChange={e => handleTimeChange('end', e.target.value)} step="60" className="w-28 h-10 px-2 bg-neutral-700 rounded-md text-white border-transparent focus:border-purple-500 focus:ring-purple-500"/>
            </div>
            <div className="flex items-center gap-2">
                <button onClick={onSplit} className="p-2 text-neutral-400 hover:text-white transition-colors" title="Split block"><LayoutGridIcon className="w-5 h-5"/></button>
                <button onClick={onDelete} className="p-2 text-neutral-400 hover:text-red-400 transition-colors" title="Delete block"><TrashIcon className="w-5 h-5"/></button>
            </div>
        </div>
    );
};

export default ScheduleTab;

--- END OF FILE ./components/admin/ScheduleTab.tsx ---




--- START OF FILE ./components/admin/PromoCodesTab.tsx ---


import React, { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType, PromoCode } from '../../types';
import { PlusIcon, TrashIcon } from '../Icons';
import Modal from '../Modal';

const PromoCodesTab: React.FC<{ event: EventType }> = ({ event }) => {
    const [codes, setCodes] = useState<PromoCode[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const { user } = useAuth();

    const fetchCodes = useCallback(async () => {
        setIsLoading(true);
        try {
            const promoCodes = await api.getPromoCodesForEvent(event.id);
            setCodes(promoCodes);
        } catch (err) {
            console.error(err);
        } finally {
            setIsLoading(false);
        }
    }, [event.id]);

    useEffect(() => {
        fetchCodes();
    }, [fetchCodes]);

    const handleCodeCreated = (newCode: PromoCode) => {
        setCodes(prev => [...prev, newCode]);
        setIsModalOpen(false);
    };

    const handleDeleteCode = async (codeId: string) => {
        if (!user) return;
        try {
            const result = await api.deletePromoCode(user.id, event.id, codeId);
            if (result.success) {
                fetchCodes(); // Re-fetch the codes from the server to update the list
            } else {
                alert("Failed to delete promo code.");
            }
        } catch (error) {
            console.error(error);
            alert("An error occurred while deleting the promo code.");
        }
    };

    return (
        <div className="space-y-8">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold tracking-tight text-white">Promo Codes</h1>
                <button onClick={() => setIsModalOpen(true)} className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 flex items-center justify-center space-x-2">
                    <PlusIcon className="w-4 h-4" /><span>Create Code</span>
                </button>
            </div>

            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-neutral-300">
                        <thead className="text-xs text-neutral-400 uppercase bg-neutral-800/50">
                            <tr>
                                <th scope="col" className="px-6 py-3">Code</th>
                                <th scope="col" className="px-6 py-3 text-center">Discount</th>
                                <th scope="col" className="px-6 py-3 text-center">Uses</th>
                                <th scope="col" className="px-6 py-3 text-center">Status</th>
                                <th scope="col" className="px-6 py-3"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {isLoading ? (
                                <tr><td colSpan={5} className="text-center py-8 text-neutral-500">Loading codes...</td></tr>
                            ) : codes.length > 0 ? (
                                codes.map(code => (
                                    <tr key={code.id} className="border-b border-neutral-800">
                                        <td className="px-6 py-4 font-mono font-medium text-white">{code.code}</td>
                                        <td className="px-6 py-4 text-center">{code.discountPercent}%</td>
                                        <td className="px-6 py-4 text-center">{code.uses ?? 0} / {code.maxUses ?? 'âˆž'}</td>
                                        <td className="px-6 py-4 text-center">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${code.isActive ? 'bg-green-500/10 text-green-400' : 'bg-neutral-700 text-neutral-400'}`}>
                                                {code.isActive ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            <button onClick={() => handleDeleteCode(code.id)} className="text-neutral-500 hover:text-red-400 transition-colors"><TrashIcon className="w-5 h-5"/></button>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr><td colSpan={5} className="text-center py-8 text-neutral-500">No promo codes created yet.</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            <CreatePromoCodeModal
                isOpen={isModalOpen}
                onClose={() => setIsModalOpen(false)}
                onCreated={handleCodeCreated}
                eventId={event.id}
                existingCodes={codes}
                isFundraiser={event.type === 'fundraiser'}
            />
        </div>
    );
};

const CreatePromoCodeModal: React.FC<{ 
    isOpen: boolean, 
    onClose: () => void, 
    onCreated: (code: PromoCode) => void, 
    eventId: string, 
    existingCodes: PromoCode[],
    isFundraiser: boolean
}> = ({ isOpen, onClose, onCreated, eventId, existingCodes, isFundraiser }) => {
    const { user } = useAuth();
    const [code, setCode] = useState('');
    const [discount, setDiscount] = useState(isFundraiser ? 0 : 10);
    const [maxUses, setMaxUses] = useState<number | ''>('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        if (isOpen) {
            setCode('');
            setDiscount(isFundraiser ? 0 : 10);
            setMaxUses('');
            setError('');
        }
    }, [isOpen, isFundraiser]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        if (!user || !code.trim()) return;

        const normalizedCode = code.trim().toUpperCase();

        // CHECK 1: Client-side duplication check
        if (existingCodes.some(c => c.code === normalizedCode)) {
            setError('Promo code already exists. Please use a unique name.');
            return;
        }

        setIsLoading(true);
        const newCodeData = {
            code: normalizedCode,
            discountPercent: discount,
            maxUses: maxUses === '' ? null : Number(maxUses)
        };
        try {
            const createdCode = await api.createPromoCode(user.id, eventId, newCodeData);
            onCreated(createdCode);
        } catch (error: any) {
            console.error(error);
            // Handle backend duplication error if it slips through client check
            if (error.message && error.message.toLowerCase().includes('exists')) {
                setError('Promo code already exists.');
            } else {
                setError(error.message || "Failed to create code.");
            }
        } finally {
            setIsLoading(false);
        }
    }
    
    return (
        <Modal isOpen={isOpen} onClose={onClose}>
            <form onSubmit={handleSubmit} className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl">
                <div className="p-8">
                    <h2 className="text-xl font-bold text-white mb-6">Create Promo Code</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Code</label>
                            <input 
                                type="text" 
                                value={code} 
                                onChange={e => {
                                    setCode(e.target.value);
                                    setError('');
                                }} 
                                placeholder="e.g., EARLYBIRD20" 
                                className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white font-mono uppercase" 
                                required 
                            />
                        </div>
                        {!isFundraiser && (
                             <div>
                                <label className="block text-sm font-medium text-neutral-300 mb-2">Discount (%)</label>
                                <input type="number" value={discount} onChange={e => setDiscount(Number(e.target.value))} min="0" max="100" className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white" required />
                            </div>
                        )}
                         <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Max Uses (optional)</label>
                            <input type="number" value={maxUses} onChange={e => setMaxUses(e.target.value === '' ? '' : Number(e.target.value))} min="1" placeholder="Leave blank for unlimited" className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white" />
                        </div>
                        {error && <p className="text-red-400 text-sm mt-2 p-2 bg-red-500/10 rounded border border-red-500/20">{error}</p>}
                    </div>
                </div>
                <div className="p-4 bg-neutral-900/50 border-t border-neutral-800 flex justify-end">
                    <button type="submit" disabled={isLoading} className="px-5 py-2 text-sm font-semibold rounded-full bg-purple-600 text-white hover:bg-purple-500 disabled:opacity-50 transition-colors">
                        {isLoading ? 'Creating...' : 'Create Code'}
                    </button>
                </div>
            </form>
        </Modal>
    );
};

export default PromoCodesTab;

--- END OF FILE ./components/admin/PromoCodesTab.tsx ---




--- START OF FILE ./components/admin/TicketsTab.tsx ---



import React, { useState } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType, TicketOption } from '../../types';
import TicketEditor from '../TicketEditor';

const TicketsTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const { user } = useAuth();
    const [tickets, setTickets] = useState<TicketOption[]>(event.tickets);
    const [isSaving, setIsSaving] = useState(false);

    const handleSave = async () => {
        if (!user) return;
        setIsSaving(true);
        try {
            // Include both tickets and addOns to prevent deletion of the other category in unified inventory
            await api.updateEvent(user.id, event.id, { tickets, addOns: event.addOns });
            onEventUpdate();
            alert("Tickets updated!");
        } catch (e) {
            console.error(e);
            alert("Failed to update tickets.");
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="space-y-6 max-w-3xl">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold tracking-tight text-white">{event.type === 'fundraiser' ? 'Donation Tiers' : 'Tickets'}</h1>
                <button onClick={handleSave} disabled={isSaving} className="bg-purple-600 text-white px-6 py-2 rounded-full font-semibold disabled:opacity-50">
                    {isSaving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
            <TicketEditor tickets={tickets} onTicketsChange={setTickets} isFundraiser={event.type === 'fundraiser'} />
        </div>
    );
};

export default TicketsTab;
--- END OF FILE ./components/admin/TicketsTab.tsx ---




--- START OF FILE ./components/admin/CheckInTab.tsx ---


import React, { useState, useEffect, useCallback, useMemo } from 'react';
import * as api from '../../services/api';
import { Order } from '../../types';
import { CheckCircleIcon, CameraIcon, UsersIcon, SearchIcon, XCircleIcon, TicketIcon, PackageIcon } from '../Icons';
import QRScanner from '../QRScanner';
import Modal from '../Modal';

interface CheckInTicketItem {
    uniqueId: string;
    orderId: string;
    purchaserName: string;
    purchaserEmail: string;
    type: string;
    status: 'Checked In' | 'Delivered' | 'Out';
    checkInTime?: string;
    ticketNumber: number;
    isAddOn: boolean;
}

const CheckInTab: React.FC<{ eventId: string }> = ({ eventId }) => {
    const [mode, setMode] = useState<'scanner' | 'list'>('list');
    const [scanResult, setScanResult] = useState<{ valid: boolean; message: string; ticket?: any } | null>(null);
    const [isScanning, setIsScanning] = useState(true);
    const [manualCode, setManualCode] = useState('');
    
    // List Mode State
    const [tickets, setTickets] = useState<CheckInTicketItem[]>([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [isLoadingList, setIsLoadingList] = useState(false);
    const [stats, setStats] = useState({ checkedIn: 0, total: 0 });
    const [addOnTypes, setAddOnTypes] = useState<Set<string>>(new Set());
    
    // Modal State
    const [selectedTicketForModal, setSelectedTicketForModal] = useState<CheckInTicketItem | null>(null);

    const fetchTickets = useCallback(async () => {
        setIsLoadingList(true);
        try {
            const [orders, event] = await Promise.all([
                api.getOrdersForEvent(eventId),
                api.getEventDetails(eventId)
            ]);

            const checkIns = event.checkIns || {};
            const flatTickets: CheckInTicketItem[] = [];

            // Identify add-ons
            const addOnNames = new Set((event.addOns || []).map(a => a.name));
            setAddOnTypes(addOnNames);

            orders.forEach(order => {
                if (order.status.toUpperCase() !== 'COMPLETED') return;
                
                let ticketIndex = 0;
                order.items.forEach(item => {
                    const isAddOn = addOnNames.has(item.ticketType);

                    for (let i = 0; i < item.quantity; i++) {
                        const uniqueId = `${order.orderId}-${ticketIndex}`;
                        const isCheckedIn = !!checkIns[uniqueId];
                        
                        flatTickets.push({
                            uniqueId,
                            orderId: order.orderId,
                            purchaserName: order.purchaserName,
                            purchaserEmail: order.purchaserEmail,
                            type: item.ticketType,
                            status: isCheckedIn ? (isAddOn ? 'Delivered' : 'Checked In') : 'Out',
                            checkInTime: isCheckedIn ? checkIns[uniqueId] : undefined,
                            ticketNumber: ticketIndex + 1,
                            isAddOn: isAddOn
                        });
                        ticketIndex++;
                    }
                });
            });

            setTickets(flatTickets);
            setStats({
                checkedIn: flatTickets.filter(t => t.status === 'Checked In' || t.status === 'Delivered').length,
                total: flatTickets.length
            });

        } catch (e) {
            console.error("Error fetching check-in data", e);
        } finally {
            setIsLoadingList(false);
        }
    }, [eventId]);

    useEffect(() => {
        fetchTickets();
    }, [fetchTickets]);

    // Filter logic
    const filteredTickets = useMemo(() => {
        if (!searchTerm) return tickets;
        const lowerSearch = searchTerm.toLowerCase();
        return tickets.filter(t => 
            t.purchaserName.toLowerCase().includes(lowerSearch) ||
            t.uniqueId.toLowerCase().includes(lowerSearch) ||
            t.purchaserEmail.toLowerCase().includes(lowerSearch) ||
            t.type.toLowerCase().includes(lowerSearch)
        );
    }, [tickets, searchTerm]);

    // Scanner Logic
    const handleScan = async (data: string) => {
        if (!isScanning) return;
        setIsScanning(false);
        try {
            const result = await api.validateTicket(eventId, data);
            setScanResult(result);
            // Refresh list data silently to keep sync
            fetchTickets();
        } catch (e) {
            console.error(e);
            setScanResult({ valid: false, message: 'Error validating ticket' });
        }
    };

    const handleCheckIn = async (ticketId: string, isAddOn: boolean, e?: React.MouseEvent) => {
        if (e) e.stopPropagation();
        try {
            await api.checkInTicket(eventId, ticketId);
            const now = new Date().toISOString();
            const newStatus = isAddOn ? 'Delivered' : 'Checked In';

            // Update local state immediately for responsiveness
            setTickets(prev => prev.map(t => t.uniqueId === ticketId ? { ...t, status: newStatus, checkInTime: now } : t));
            setStats(prev => ({ ...prev, checkedIn: prev.checkedIn + 1 }));
            
            // Update modal state if open
            if (selectedTicketForModal?.uniqueId === ticketId) {
                setSelectedTicketForModal(prev => prev ? { ...prev, status: newStatus, checkInTime: now } : null);
            }

            // If scanning, update scan result
            if (mode === 'scanner' && scanResult?.ticket?.id === ticketId) {
               setScanResult(prev => prev ? { ...prev, ticket: { ...prev.ticket, checkedIn: true } } : null);
            }
        } catch (e) {
            alert("Failed to check in");
        }
    };

    const handleUndoCheckIn = async (ticketId: string, e?: React.MouseEvent) => {
        if (e) e.stopPropagation();
        try {
            await api.undoCheckIn(eventId, ticketId);
            setTickets(prev => prev.map(t => t.uniqueId === ticketId ? { ...t, status: 'Out', checkInTime: undefined } : t));
            setStats(prev => ({ ...prev, checkedIn: prev.checkedIn - 1 }));
            
            // Update modal state if open
            if (selectedTicketForModal?.uniqueId === ticketId) {
                setSelectedTicketForModal(prev => prev ? { ...prev, status: 'Out', checkInTime: undefined } : null);
            }

             if (mode === 'scanner' && scanResult?.ticket?.id === ticketId) {
               setScanResult(prev => prev ? { ...prev, ticket: { ...prev.ticket, checkedIn: false } } : null);
            }
        } catch (e) {
            console.error(e);
            alert("Failed to undo check-in");
        }
    };

    const resetScan = () => {
        setScanResult(null);
        setIsScanning(true);
    };

    // Helper to check scanned ticket type
    const scannedIsAddOn = scanResult?.ticket ? addOnTypes.has(scanResult.ticket.type) : false;

    return (
        <div className="space-y-6">
            {/* Header Area */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-8">
                <div>
                    <h1 className="text-4xl font-bold tracking-tight text-white flex items-center gap-3">
                        <CheckCircleIcon className="w-8 h-8 text-white" /> Check-in
                    </h1>
                </div>
                
                {/* Toggle Control */}
                <div className="bg-neutral-900 p-1 rounded-lg border border-neutral-800 flex items-center">
                    <button 
                        onClick={() => setMode('scanner')}
                        className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${mode === 'scanner' ? 'bg-neutral-800 text-white shadow-sm' : 'text-neutral-400 hover:text-white'}`}
                    >
                        <CameraIcon className="w-4 h-4" /> Live Scanner
                    </button>
                    <button 
                        onClick={() => setMode('list')}
                        className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${mode === 'list' ? 'bg-neutral-800 text-white shadow-sm' : 'text-neutral-400 hover:text-white'}`}
                    >
                        <UsersIcon className="w-4 h-4" /> Attendee List
                    </button>
                </div>
            </div>

            {mode === 'list' ? (
                <div className="animate-fade-in">
                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                            <div>
                                <h3 className="text-xl font-bold text-white">Attendee List</h3>
                                <p className="text-neutral-400 text-sm mt-1">{stats.checkedIn} / {stats.total} Checked In</p>
                            </div>
                            <div className="relative w-full md:w-80">
                                <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500" />
                                <input 
                                    type="text" 
                                    placeholder="Search name, email, or ticket ID" 
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    className="w-full pl-10 pr-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500 transition-colors text-sm"
                                />
                            </div>
                        </div>

                        <div className="overflow-x-auto -mx-6 md:mx-0">
                            <table className="w-full text-sm text-left text-neutral-300 min-w-full">
                                <thead className="text-xs text-neutral-500 uppercase bg-neutral-900/50 border-b border-neutral-800">
                                    <tr>
                                        <th className="px-6 py-4 font-medium">Attendee</th>
                                        <th className="hidden md:table-cell px-6 py-4 font-medium">Type</th>
                                        <th className="px-6 py-4 font-medium text-center">Status</th>
                                        <th className="px-6 py-4 font-medium text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-neutral-800">
                                    {isLoadingList ? (
                                        <tr><td colSpan={4} className="px-6 py-8 text-center text-neutral-500">Loading list...</td></tr>
                                    ) : filteredTickets.length === 0 ? (
                                        <tr><td colSpan={4} className="px-6 py-8 text-center text-neutral-500">No attendees found matching your search.</td></tr>
                                    ) : filteredTickets.map((ticket) => (
                                        <tr 
                                            key={ticket.uniqueId} 
                                            onClick={() => setSelectedTicketForModal(ticket)}
                                            className="hover:bg-neutral-800/30 transition-colors group cursor-pointer"
                                        >
                                            <td className="px-6 py-4 align-middle">
                                                <div className="flex flex-col">
                                                    <span className="text-white font-medium">
                                                        {ticket.purchaserName}
                                                        <sub className="text-neutral-500 ml-1 font-normal">[{ticket.ticketNumber}]</sub>
                                                    </span>
                                                    <span className="text-xs text-neutral-500">{ticket.purchaserEmail}</span>
                                                </div>
                                            </td>
                                            <td className="hidden md:table-cell px-6 py-4 align-middle">
                                                <span className={`inline-block px-2 py-1 rounded border text-xs whitespace-nowrap ${
                                                    ticket.isAddOn 
                                                    ? 'bg-purple-500/10 text-purple-300 border-purple-500/20' 
                                                    : 'bg-neutral-800 border-neutral-700 text-neutral-300'
                                                }`}>
                                                    {ticket.type}
                                                    {ticket.isAddOn && <span className="ml-1 text-[10px] uppercase font-bold text-purple-400">Add-on</span>}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-center align-middle">
                                                 <span className={`inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${
                                                    ticket.status === 'Checked In' 
                                                    ? 'bg-green-500/10 text-green-400 border-green-500/20' 
                                                    : ticket.status === 'Delivered'
                                                    ? 'bg-blue-500/10 text-blue-400 border-blue-500/20'
                                                    : 'bg-neutral-800 text-neutral-500 border-neutral-700'
                                                }`}>
                                                    {ticket.status}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-right align-middle whitespace-nowrap">
                                                {ticket.status === 'Out' ? (
                                                    <button 
                                                        onClick={(e) => handleCheckIn(ticket.uniqueId, ticket.isAddOn, e)}
                                                        className={`inline-flex items-center justify-center px-4 py-2 text-white text-xs font-bold rounded-lg transition-colors shadow-lg ${
                                                            ticket.isAddOn 
                                                            ? 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/20' 
                                                            : 'bg-green-600 hover:bg-green-500 shadow-green-900/20'
                                                        }`}
                                                    >
                                                        {ticket.isAddOn ? 'Deliver' : 'Check In'}
                                                    </button>
                                                ) : (
                                                    <button 
                                                        onClick={(e) => handleUndoCheckIn(ticket.uniqueId, e)}
                                                        className="inline-flex items-center justify-center px-4 py-2 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 text-neutral-300 hover:text-white text-xs font-bold rounded-lg transition-colors"
                                                    >
                                                        Undo
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="max-w-xl mx-auto animate-fade-in">
                    {isScanning ? (
                        <div className="space-y-6">
                            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-1 shadow-2xl">
                                <QRScanner onScan={handleScan} />
                            </div>
                            <div className="flex gap-3">
                                <input 
                                    type="text" 
                                    placeholder="Enter ticket ID manually" 
                                    value={manualCode}
                                    onChange={e => setManualCode(e.target.value)}
                                    className="flex-1 bg-neutral-900 border border-neutral-800 rounded-xl px-5 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-neutral-600"
                                />
                                <button onClick={() => handleScan(manualCode)} className="bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 text-white px-6 py-3 rounded-xl font-semibold transition-colors">Check</button>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-10 text-center shadow-2xl">
                            <div className={`w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 ${scanResult?.valid ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'}`}>
                                {scanResult?.valid ? <CheckCircleIcon className="w-12 h-12" /> : <XCircleIcon className="w-12 h-12" />}
                            </div>
                            <h3 className="text-3xl font-bold text-white mb-2">{scanResult?.message}</h3>
                            {scanResult?.ticket && (
                                <div className="bg-neutral-800/50 rounded-xl p-6 mb-8 border border-neutral-800 mt-6">
                                    <p className="text-xl text-white font-bold mb-1">{scanResult.ticket.holder}</p>
                                    <p className="text-purple-400 font-medium">{scanResult.ticket.type}</p>
                                    <p className="text-xs text-neutral-500 font-mono mt-4">ID: {scanResult.ticket.id}</p>
                                    {scanResult.ticket.checkedIn && <div className="mt-4 inline-block px-3 py-1 bg-green-500/10 text-green-500 text-xs font-bold rounded-full border border-green-500/20">Checked In</div>}
                                </div>
                            )}
                            <div className="flex gap-4 justify-center mt-8">
                                <button onClick={resetScan} className="px-8 py-3 rounded-full border border-neutral-700 text-neutral-300 hover:bg-neutral-800 hover:text-white font-semibold transition-colors">Scan Next</button>
                                {scanResult?.valid && !scanResult.ticket.checkedIn && (
                                    <button 
                                        onClick={() => handleCheckIn(scanResult!.ticket.id, scannedIsAddOn)} 
                                        className={`px-8 py-3 rounded-full text-white font-bold shadow-lg transition-colors ${scannedIsAddOn ? 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/20' : 'bg-green-600 hover:bg-green-500 shadow-green-900/20'}`}
                                    >
                                        {scannedIsAddOn ? 'Deliver Item' : 'Check In Now'}
                                    </button>
                                )}
                                 {scanResult?.valid && scanResult.ticket.checkedIn && (
                                    <button onClick={() => handleUndoCheckIn(scanResult!.ticket.id)} className="px-8 py-3 rounded-full bg-neutral-800 text-neutral-300 hover:text-white hover:bg-neutral-700 border border-neutral-700 font-bold transition-colors">Undo Check In</button>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            )}

            {/* Ticket Detail Modal */}
            <Modal isOpen={!!selectedTicketForModal} onClose={() => setSelectedTicketForModal(null)}>
                {selectedTicketForModal && (
                    <TicketDetailModalContent 
                        ticket={selectedTicketForModal} 
                        onCheckIn={(id) => handleCheckIn(id, selectedTicketForModal.isAddOn)}
                        onUndo={(id) => handleUndoCheckIn(id)}
                    />
                )}
            </Modal>
        </div>
    );
};

const TicketDetailModalContent: React.FC<{ 
    ticket: CheckInTicketItem, 
    onCheckIn: (id: string) => void, 
    onUndo: (id: string) => void 
}> = ({ ticket, onCheckIn, onUndo }) => {
    const [order, setOrder] = useState<Order | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        api.getOrderDetails(ticket.orderId)
            .then(setOrder)
            .catch(err => console.error("Failed to load order", err))
            .finally(() => setLoading(false));
    }, [ticket.orderId]);

    const orderItem = order?.items.find(i => i.ticketType === ticket.type);
    const pricePaid = orderItem ? orderItem.pricePerTicket : 0;

    return (
        <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden flex flex-col">
             {/* Header */}
            <div className="bg-neutral-950/50 px-6 py-4 border-b border-neutral-800 flex justify-between items-center">
                <div className="flex items-center gap-3">
                    <div className="h-10 w-10 rounded-full bg-neutral-800 flex items-center justify-center border border-neutral-700">
                        {ticket.isAddOn ? <PackageIcon className="w-5 h-5 text-blue-400" /> : <TicketIcon className="w-5 h-5 text-purple-400" />}
                    </div>
                    <div>
                        <h3 className="text-xl font-bold text-white">Details</h3>
                        <p className="text-neutral-500 text-xs font-mono">{ticket.uniqueId}</p>
                    </div>
                </div>
            </div>

            <div className="p-6 space-y-6">
                {/* Attendee Info - Compact Header */}
                <div className="flex items-center gap-4">
                    <div className="h-14 w-14 rounded-full bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-purple-500/20">
                        {ticket.purchaserName.charAt(0)}
                    </div>
                    <div>
                        <p className="text-xl font-bold text-white leading-tight">{ticket.purchaserName}</p>
                        <p className="text-sm text-neutral-400">{ticket.purchaserEmail}</p>
                    </div>
                </div>

                {/* Consolidated Details Grid */}
                <div className="grid grid-cols-2 gap-x-4 gap-y-6 bg-neutral-800/30 p-4 rounded-xl border border-neutral-800/50">
                    <div>
                        <p className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Type</p>
                        <p className="text-white font-semibold text-sm">{ticket.type}</p>
                        {ticket.isAddOn && <span className="text-[10px] text-purple-400 font-bold uppercase">Add-on</span>}
                    </div>
                    
                    <div>
                        <p className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Purchase Date</p>
                        {loading ? (
                            <div className="h-4 w-16 bg-neutral-800 rounded animate-pulse"/>
                        ) : (
                            <p className="text-white font-semibold text-sm">
                                {order ? new Date(order.purchaseDate).toLocaleDateString() : '-'}
                            </p>
                        )}
                    </div>

                    <div>
                        <p className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Price Paid</p>
                        {loading ? (
                            <div className="h-4 w-12 bg-neutral-800 rounded animate-pulse"/>
                        ) : (
                            <p className="text-white font-semibold text-sm">${pricePaid.toFixed(2)}</p>
                        )}
                    </div>

                    <div>
                        <p className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Promo</p>
                        {loading ? (
                            <div className="h-4 w-12 bg-neutral-800 rounded animate-pulse"/>
                        ) : order?.promoCode ? (
                            <span className="inline-block px-2 py-0.5 bg-purple-500/20 text-purple-300 text-[10px] font-bold rounded border border-purple-500/30">
                                {order.promoCode}
                            </span>
                        ) : (
                            <p className="text-neutral-600 text-sm">-</p>
                        )}
                    </div>

                    <div className="col-span-2 pt-2 border-t border-neutral-700/50">
                        <p className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Status</p>
                        {ticket.checkInTime ? (
                             <p className={`${ticket.isAddOn ? 'text-blue-400' : 'text-green-400'} font-mono text-sm`}>
                                 {ticket.status} at {new Date(ticket.checkInTime).toLocaleString()}
                             </p>
                        ) : (
                             <p className="text-neutral-400 font-mono text-sm italic">
                                 Awaiting {ticket.isAddOn ? 'Delivery' : 'Checkin'}
                             </p>
                        )}
                    </div>
                </div>
            </div>

            {/* Actions */}
            <div className="p-4 bg-neutral-950/50 border-t border-neutral-800">
                {ticket.status === 'Out' ? (
                    <button 
                        onClick={() => onCheckIn(ticket.uniqueId)}
                        className={`w-full h-12 text-white font-bold rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 ${
                            ticket.isAddOn 
                            ? 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/20' 
                            : 'bg-green-600 hover:bg-green-500 shadow-green-900/20'
                        }`}
                    >
                        {ticket.isAddOn ? <PackageIcon className="w-5 h-5"/> : <CheckCircleIcon className="w-5 h-5" />}
                        {ticket.isAddOn ? 'Deliver Item' : 'Check In'}
                    </button>
                ) : (
                    <button 
                        onClick={() => onUndo(ticket.uniqueId)}
                        className="w-full h-12 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 text-neutral-300 hover:text-white font-bold rounded-xl transition-all"
                    >
                        Undo {ticket.isAddOn ? 'Delivery' : 'Check In'}
                    </button>
                )}
            </div>
        </div>
    );
};

export default CheckInTab;

--- END OF FILE ./components/admin/CheckInTab.tsx ---




--- START OF FILE ./components/admin/AddOnsTab.tsx ---



import React, { useState } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import * as api from '../../services/api';
import { Event as EventType, AddOn } from '../../types';
import AddOnEditor from '../AddOnEditor';

const AddOnsTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const { user } = useAuth();
    const [addOns, setAddOns] = useState<AddOn[]>(event.addOns || []);
    const [isSaving, setIsSaving] = useState(false);

    const handleSave = async () => {
        if (!user) return;
        setIsSaving(true);
        try {
            // Include both addOns and tickets to prevent deletion of the other category in unified inventory
            await api.updateEvent(user.id, event.id, { addOns, tickets: event.tickets });
            onEventUpdate();
            alert("Add-ons updated!");
        } catch (e) {
            console.error(e);
            alert("Failed to update add-ons.");
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="space-y-6 max-w-3xl">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold tracking-tight text-white">Add-ons</h1>
                <button onClick={handleSave} disabled={isSaving} className="bg-purple-600 text-white px-6 py-2 rounded-full font-semibold disabled:opacity-50">
                    {isSaving ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
            <AddOnEditor addOns={addOns} onAddOnsChange={setAddOns} isFundraiser={event.type === 'fundraiser'} />
        </div>
    );
};

export default AddOnsTab;
--- END OF FILE ./components/admin/AddOnsTab.tsx ---




--- START OF FILE ./components/admin/TicketingTab.tsx ---

import React, { useState } from 'react';
import { Event as EventType } from '../../types';
import TicketsTab from './TicketsTab';
import AddOnsTab from './AddOnsTab';

const TicketingTab: React.FC<{ event: EventType, onEventUpdate: () => void }> = ({ event, onEventUpdate }) => {
    const [activeSubTab, setActiveSubTab] = useState<'tickets' | 'addons'>('tickets');

    return (
        <div className="space-y-6">
            <h1 className="text-3xl font-bold tracking-tight text-white">Ticketing</h1>
            
            <div className="border-b border-neutral-800">
                <nav className="flex -mb-px space-x-8">
                    <button 
                        onClick={() => setActiveSubTab('tickets')} 
                        className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                            activeSubTab === 'tickets' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'
                        }`}
                    >
                        {event.type === 'fundraiser' ? 'Donation Tiers' : 'Tickets'}
                    </button>
                    <button 
                        onClick={() => setActiveSubTab('addons')} 
                        className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                            activeSubTab === 'addons' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'
                        }`}
                    >
                        Add-ons
                    </button>
                </nav>
            </div>

            <div>
                {activeSubTab === 'tickets' && (
                    <div className="animate-fade-in">
                        {/* Render existing component but hide its internal header since we have a main one now? 
                            Actually, the existing components have their own Save button aligned with header. 
                            Let's modify the layout via CSS or wrapper to hide duplicate H1 if needed, 
                            or just accept nested structure. Since TicketsTab has a full header row with button, 
                            we might want to just render it. 
                            Currently TicketsTab has: <h1>Tickets</h1> <button>Save</button>
                            We can keep it, but maybe hide the 'Ticketing' h1 above if we want cleaner look.
                            Or we can refactor TicketsTab to take a 'hideHeader' prop. 
                            For now, let's just render the content.
                        */}
                       <TicketsTab event={event} onEventUpdate={onEventUpdate} />
                    </div>
                )}
                {activeSubTab === 'addons' && (
                    <div className="animate-fade-in">
                        <AddOnsTab event={event} onEventUpdate={onEventUpdate} />
                    </div>
                )}
            </div>
        </div>
    );
};

export default TicketingTab;
--- END OF FILE ./components/admin/TicketingTab.tsx ---




--- START OF FILE ./components/SectionEditor.tsx ---



import React from 'react';
import { ProfileSection } from '../types';
import { TrashIcon, GripVerticalIcon } from './Icons';
import ImageGalleryEditor from './ImageGalleryEditor';

interface SectionEditorProps {
    section: ProfileSection;
    onUpdate: (section: ProfileSection) => void;
    onDelete: (id: string) => void;
}

const SectionEditor: React.FC<SectionEditorProps> = ({ section, onUpdate, onDelete }) => {
    
    const handleContentChange = (field: string, value: any) => {
        onUpdate({
            ...section,
            content: {
                ...section.content,
                [field]: value
            }
        });
    };
    
    const renderEditorContent = () => {
        switch (section.type) {
            case 'TEXT':
                return (
                    <div className="space-y-4">
                        <input
                            type="text"
                            value={section.content.title || ''}
                            onChange={(e) => handleContentChange('title', e.target.value)}
                            placeholder="Section Title"
                            className="w-full text-xl font-bold bg-transparent text-white focus:outline-none"
                        />
                        <textarea
                            value={section.content.body || ''}
                            onChange={(e) => handleContentChange('body', e.target.value)}
                            placeholder="Tell your story..."
                            rows={6}
                            className="w-full bg-transparent text-neutral-300 focus:outline-none resize-none"
                        />
                    </div>
                );
            case 'GALLERY':
                return (
                     <ImageGalleryEditor
                        images={section.content.images || []}
                        onImagesChange={(newImages) => handleContentChange('images', newImages)}
                    />
                );
            case 'SOUNDCLOUD':
            case 'YOUTUBE':
                 return (
                    <div className="space-y-2">
                        <label className="text-sm font-medium text-neutral-400">
                           {section.type === 'SOUNDCLOUD' ? 'SoundCloud Embed URL' : 'YouTube Video URL'}
                        </label>
                        <input
                            type="text"
                            value={section.content.url || ''}
                            onChange={(e) => handleContentChange('url', e.target.value)}
                            placeholder={section.type === 'YOUTUBE' ? 'e.g., https://www.youtube.com/embed/VIDEO_ID' : 'e.g., https://w.soundcloud.com/player/?url=...'}
                            className="w-full h-10 px-3 bg-neutral-700 border border-neutral-600 rounded-md text-white"
                        />
                         <p className="text-xs text-neutral-500">
                           {section.type === 'YOUTUBE' ? 'Please use the embed URL from YouTube\'s "Share" option.' : 'Please use the embed code URL from SoundCloud\'s "Share" option.'}
                        </p>
                    </div>
                );
            default:
                return null;
        }
    };
    
    return (
        <div className="bg-neutral-900 border border-neutral-800 rounded-2xl flex gap-4 transition-colors hover:border-neutral-700">
            <div className="p-4 cursor-grab text-neutral-500 hover:text-white transition-colors flex-shrink-0">
                <GripVerticalIcon className="w-6 h-6"/>
            </div>
            <div className="flex-grow p-6">
                 {renderEditorContent()}
            </div>
             <div className="p-4 flex-shrink-0">
                <button onClick={() => onDelete(section.id)} className="p-2 text-neutral-500 hover:text-red-400 transition-colors" title="Delete Section">
                    <TrashIcon className="w-5 h-5"/>
                </button>
            </div>
        </div>
    );
};

export default SectionEditor;
--- END OF FILE ./components/SectionEditor.tsx ---




--- START OF FILE ./components/QuantitySelector.tsx ---

import React, { useState, useEffect } from 'react';
import { PlusIcon, MinusIcon } from './Icons';

interface QuantitySelectorProps {
  initialQuantity?: number;
  ticketType: string;
  onChange: (ticketType: string, quantity: number) => void;
  disabled?: boolean;
}

const QuantitySelector: React.FC<QuantitySelectorProps> = ({ ticketType, onChange, initialQuantity = 0, disabled = false }) => {
  const [quantity, setQuantity] = useState(initialQuantity);

  const handleIncrease = () => {
    setQuantity(prev => prev + 1);
  };

  const handleDecrease = () => {
    setQuantity(prev => Math.max(0, prev - 1));
  };
  
  useEffect(() => {
    onChange(ticketType, quantity);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [quantity]);

  useEffect(() => {
    setQuantity(initialQuantity);
  }, [initialQuantity])

  return (
    <div className="flex-shrink-0">
      <div className="flex items-center border border-neutral-700 rounded-full p-1">
        <button
          onClick={handleDecrease}
          disabled={quantity === 0 || disabled}
          className="w-10 h-10 rounded-full bg-neutral-800 hover:bg-neutral-700 text-neutral-400 transition-colors disabled:opacity-50"
        >
          <MinusIcon className="w-5 h-5 mx-auto" />
        </button>
        <input
          type="number"
          readOnly
          value={quantity}
          className="qty-input w-16 h-10 bg-transparent text-white text-center font-bold text-lg outline-none border-none focus:ring-0"
        />
        <button
          onClick={handleIncrease}
          disabled={disabled}
          className="w-10 h-10 rounded-full bg-neutral-800 hover:bg-neutral-700 text-neutral-200 transition-colors disabled:opacity-50"
        >
          <PlusIcon className="w-5 h-5 mx-auto" />
        </button>
      </div>
    </div>
  );
};

export default QuantitySelector;
--- END OF FILE ./components/QuantitySelector.tsx ---




--- START OF FILE ./components/ProfileHeaderEditor.tsx ---


// This component is no longer used. Its functionality has been
// integrated directly into the ProfilePage component for a more
// intuitive "what you see is what you get" editing experience.

--- END OF FILE ./components/ProfileHeaderEditor.tsx ---




--- START OF FILE ./components/HostFinancialsDashboard.tsx ---


import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { HostFinancials, User } from '../types';
import * as api from '../services/api';
import { DollarSignIcon, BarChartIcon, CreditCardIcon, CheckCircleIcon, ClockIcon, ArrowRightIcon } from './Icons';
import Modal from './Modal';

interface HostFinancialsDashboardProps {
    user: User;
    onPayoutRequest?: () => void;
}

const HostFinancialsDashboard: React.FC<HostFinancialsDashboardProps> = ({ user }) => {
    const [financials, setFinancials] = useState<HostFinancials | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [showPayoutModal, setShowPayoutModal] = useState(false);
    const navigate = useNavigate();

    useEffect(() => {
        const fetchData = async () => {
            setIsLoading(true);
            try {
                const data = await api.getHostFinancials(user.id);
                setFinancials(data);
            } catch (e) {
                console.error("Error loading financials", e);
            } finally {
                setIsLoading(false);
            }
        };
        fetchData();
    }, [user.id]);

    if (isLoading) {
        return <div className="text-center py-12 text-neutral-500">Loading financial data...</div>;
    }

    if (!financials) return null;

    return (
        <div className="space-y-8 animate-fade-in">
            
            {/* Account Status Banner */}
            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 flex flex-col md:flex-row justify-between items-center gap-6">
                <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${user.stripeConnected ? 'bg-green-500/10 text-green-400' : 'bg-yellow-500/10 text-yellow-400'}`}>
                        <CreditCardIcon className="w-6 h-6" />
                    </div>
                    <div>
                        <h3 className="font-bold text-white text-lg">Payout Account</h3>
                        <p className="text-sm text-neutral-400">
                            {user.stripeConnected 
                                ? `Connected via Stripe (${user.stripeAccountId})` 
                                : "Connect a bank account to receive payouts."}
                        </p>
                    </div>
                </div>
                {user.stripeConnected ? (
                    <div className="flex items-center gap-2 px-4 py-2 bg-green-900/20 border border-green-900/50 rounded-full text-green-400 text-sm font-medium">
                        <CheckCircleIcon className="w-4 h-4" /> Active & Ready
                    </div>
                ) : (
                    <button 
                        onClick={() => navigate('/settings', { state: { defaultTab: 'payouts' } })}
                        className="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-full transition-colors"
                    >
                        Go To Settings
                    </button>
                )}
            </div>

            {/* KPI Cards */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <p className="text-sm text-neutral-400 font-medium uppercase mb-2">Pending Balance</p>
                    <h2 className="text-4xl font-bold text-white text-glow">${financials.pendingBalance.toFixed(2)}</h2>
                    <button 
                        onClick={() => setShowPayoutModal(true)}
                        disabled={financials.pendingBalance <= 0 || !user.stripeConnected}
                        className="mt-4 w-full py-2.5 rounded-lg bg-green-600/10 text-green-400 hover:bg-green-600/20 border border-green-600/20 font-semibold text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Request Payout <ArrowRightIcon className="w-4 h-4" />
                    </button>
                </div>
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <p className="text-sm text-neutral-400 font-medium uppercase mb-2">Net Revenue</p>
                    <h2 className="text-3xl font-bold text-white">${financials.netRevenue.toFixed(2)}</h2>
                    <p className="text-xs text-neutral-500 mt-2">Total earnings after fees & commissions.</p>
                </div>
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <p className="text-sm text-neutral-400 font-medium uppercase mb-2">Gross Volume</p>
                    <h2 className="text-3xl font-bold text-white">${financials.grossVolume.toFixed(2)}</h2>
                    <p className="text-xs text-neutral-500 mt-2">Total value of tickets sold.</p>
                </div>
            </div>

            {/* Detailed Breakdown */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* Revenue Chart / Breakdown */}
                <div className="lg:col-span-2 bg-neutral-900 border border-neutral-800 rounded-2xl p-8">
                    <h3 className="text-xl font-bold text-white mb-6 flex items-center">
                        <BarChartIcon className="w-5 h-5 mr-3 text-purple-400" /> Revenue Breakdown
                    </h3>
                    
                    <div className="space-y-4">
                        <div className="bg-neutral-800/50 rounded-xl p-4 border border-neutral-800">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-neutral-300 font-medium">Gross Ticket Sales</span>
                                <span className="text-white font-bold">${financials.grossVolume.toFixed(2)}</span>
                            </div>
                            <div className="w-full bg-neutral-700 h-2 rounded-full overflow-hidden">
                                <div className="bg-purple-500 h-full w-full"></div>
                            </div>
                        </div>

                        <div className="bg-neutral-800/50 rounded-xl p-4 border border-neutral-800">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-neutral-300 font-medium">Platform & Processing Fees</span>
                                <span className="text-white font-bold">-${financials.platformFees.toFixed(2)}</span>
                            </div>
                            <div className="w-full bg-neutral-700 h-2 rounded-full overflow-hidden">
                                <div className="bg-red-400 h-full" style={{ width: `${(financials.platformFees / financials.grossVolume) * 100}%` }}></div>
                            </div>
                            <p className="text-xs text-neutral-500 mt-2">Includes credit card processing and platform service fees.</p>
                        </div>

                        <div className="bg-neutral-800/50 rounded-xl p-4 border border-neutral-800">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-neutral-300 font-medium">Net Earnings</span>
                                <span className="text-green-400 font-bold">${financials.netRevenue.toFixed(2)}</span>
                            </div>
                            <div className="w-full bg-neutral-700 h-2 rounded-full overflow-hidden">
                                <div className="bg-green-500 h-full" style={{ width: `${(financials.netRevenue / financials.grossVolume) * 100}%` }}></div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Recent Payouts */}
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-8 flex flex-col">
                    <h3 className="text-xl font-bold text-white mb-6 flex items-center">
                        <DollarSignIcon className="w-5 h-5 mr-3 text-green-400" /> Recent Payouts
                    </h3>
                    
                    <div className="flex-grow overflow-y-auto custom-scrollbar pr-2 space-y-4 max-h-[300px]">
                        {financials.payouts.length === 0 ? (
                            <p className="text-neutral-500 text-center py-8 text-sm">No payouts yet.</p>
                        ) : (
                            financials.payouts.map(payout => (
                                <div key={payout.id} className="flex items-center justify-between p-3 rounded-lg hover:bg-neutral-800/50 transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${payout.status === 'Completed' ? 'bg-green-500/10 text-green-400' : 'bg-yellow-500/10 text-yellow-400'}`}>
                                            {payout.status === 'Completed' ? <CheckCircleIcon className="w-4 h-4" /> : <ClockIcon className="w-4 h-4" />}
                                        </div>
                                        <div>
                                            <p className="text-sm font-bold text-white">${payout.amount.toFixed(2)}</p>
                                            <p className="text-xs text-neutral-500">{new Date(payout.date).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <span className={`text-xs font-bold px-2 py-1 rounded-md ${payout.status === 'Completed' ? 'text-green-500 bg-green-900/20' : 'text-yellow-500 bg-yellow-900/20'}`}>
                                        {payout.status}
                                    </span>
                                </div>
                            ))
                        )}
                    </div>
                    {financials.payouts.length > 0 && (
                        <div className="mt-4 pt-4 border-t border-neutral-800 text-center">
                            <p className="text-sm text-neutral-400">Total Payouts: <span className="text-white font-bold">${financials.totalPayouts.toFixed(2)}</span></p>
                        </div>
                    )}
                </div>
            </div>

            <Modal isOpen={showPayoutModal} onClose={() => setShowPayoutModal(false)}>
                <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl p-8 shadow-2xl text-center">
                    <div className="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-500/20">
                        <DollarSignIcon className="w-8 h-8 text-green-400" />
                    </div>
                    <h3 className="text-2xl font-bold text-white mb-2">Request Payout</h3>
                    <p className="text-neutral-400 mb-6">
                        You are requesting a payout of <span className="text-white font-bold">${financials.pendingBalance.toFixed(2)}</span>. 
                        Funds typically arrive in 1-2 business days.
                    </p>
                    <div className="flex gap-3 justify-center">
                        <button 
                            onClick={() => setShowPayoutModal(false)}
                            className="px-6 py-2 rounded-full text-neutral-300 hover:text-white hover:bg-neutral-800 transition-colors"
                        >
                            Cancel
                        </button>
                        <button 
                            onClick={() => {
                                alert("Payout requested successfully!");
                                setShowPayoutModal(false);
                            }}
                            className="px-6 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-full shadow-lg shadow-green-900/20 transition-colors"
                        >
                            Confirm Payout
                        </button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

export default HostFinancialsDashboard;

--- END OF FILE ./components/HostFinancialsDashboard.tsx ---




--- START OF FILE ./components/CompetitionLeaderboard.tsx ---

import React, { useState, useEffect } from 'react';
import * as api from '../services/api';
import { LeaderboardEntry } from '../types';
import { TrophyIcon } from './Icons';

interface CompetitionLeaderboardProps {
  eventId: string;
  userId: string;
}

const CompetitionLeaderboard: React.FC<CompetitionLeaderboardProps> = ({ eventId, userId }) => {
    const [leaderboard, setLeaderboard] = useState<LeaderboardEntry[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        const fetchLeaderboard = async () => {
            try {
                setIsLoading(true);
                const data = await api.getCompetitionLeaderboard(eventId);
                setLeaderboard(data);
            } catch (err) {
                setError("Could not load leaderboard.");
                console.error(err);
            } finally {
                setIsLoading(false);
            }
        };
        fetchLeaderboard();
    }, [eventId]);

    if (isLoading) {
        return <div className="text-center text-sm text-neutral-400 py-4">Loading leaderboard...</div>;
    }

    if (error) {
        return <div className="text-center text-sm text-red-400 py-4">{error}</div>;
    }

    const currentUserIndex = leaderboard.findIndex(entry => entry.userId === userId);
    const currentUserEntry = currentUserIndex !== -1 ? leaderboard[currentUserIndex] : null;
    const topEntries = leaderboard.slice(0, 3);
    const isUserInTop = currentUserIndex !== -1 && currentUserIndex < 3;

    const rankColors = [
        'text-yellow-400', // 1st
        'text-neutral-300', // 2nd
        'text-orange-400'  // 3rd
    ];

    const LeaderboardRow: React.FC<{ entry: LeaderboardEntry, rank: number, isCurrentUser: boolean }> = ({ entry, rank, isCurrentUser }) => (
        <div className={`flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-purple-500/10' : ''}`}>
            <div className="flex items-center">
                <span className={`w-6 text-center font-bold text-sm ${rank <= 3 ? rankColors[rank - 1] : 'text-neutral-400'}`}>
                    {rank}
                </span>
                <span className={`ml-3 font-medium ${isCurrentUser ? 'text-white' : 'text-neutral-300'}`}>{entry.userName}</span>
            </div>
            <span className={`font-semibold ${isCurrentUser ? 'text-white' : 'text-neutral-300'}`}>${entry.salesValue.toFixed(2)}</span>
        </div>
    );

    return (
        <div className="border-t border-neutral-800 mt-6 pt-4">
            <h5 className="text-sm font-bold text-white mb-3 flex items-center">
                <TrophyIcon className="w-4 h-4 mr-2 text-purple-400"/>
                Competition Leaderboard
            </h5>
            <div className="space-y-1">
                {topEntries.map((entry, index) => (
                    <LeaderboardRow key={entry.userId} entry={entry} rank={index + 1} isCurrentUser={entry.userId === userId} />
                ))}

                {!isUserInTop && currentUserEntry && (
                    <>
                        <div className="text-center text-neutral-600 font-bold tracking-widest py-1">...</div>
                        <LeaderboardRow entry={currentUserEntry} rank={currentUserIndex + 1} isCurrentUser={true} />
                    </>
                )}
            </div>
        </div>
    );
};

export default CompetitionLeaderboard;
--- END OF FILE ./components/CompetitionLeaderboard.tsx ---




--- START OF FILE ./components/SettingsSidebar.tsx ---


import React from 'react';
import { UserIcon, CalendarPlusIcon, UsersIcon, DollarSignIcon } from './Icons';

interface SettingsSidebarProps {
  activeTab: string;
  setActiveTab: (tab: string) => void;
}

const SettingsSidebar: React.FC<SettingsSidebarProps> = ({ activeTab, setActiveTab }) => {
  const navItems = [
    { id: 'profile', label: 'Profile', icon: UserIcon },
    { id: 'hosts', label: 'Hosts', icon: CalendarPlusIcon },
    { id: 'team', label: 'Team', icon: UsersIcon },
    { id: 'payouts', label: 'Payouts', icon: DollarSignIcon },
  ];

  return (
    <aside className="w-full md:w-1/4 lg:w-1/5">
      <nav className="flex flex-row md:flex-col gap-1 p-2">
        {navItems.map(item => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex items-center w-full px-4 py-3 rounded-lg text-sm font-semibold transition-colors ${
              activeTab === item.id
                ? 'bg-neutral-800 text-white'
                : 'text-neutral-400 hover:bg-neutral-800/50 hover:text-white'
            }`}
          >
            <item.icon className="w-5 h-5 mr-3" />
            <span className="hidden md:inline">{item.label}</span>
          </button>
        ))}
      </nav>
    </aside>
  );
};

export default SettingsSidebar;

--- END OF FILE ./components/SettingsSidebar.tsx ---




--- START OF FILE ./components/SignInModal.tsx ---


import React, { useState, useEffect } from 'react';
import Modal from './Modal';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate, useLocation } from 'react-router-dom';
import { GoogleIcon, ArrowLeftIcon, MailIcon, XIcon } from './Icons';
import { User } from '../types';
import * as api from '../services/api';
import { useGoogleLogin } from '@react-oauth/google';


interface SignInModalProps {
  isOpen: boolean;
  onClose: () => void;
  context?: 'default' | 'application'; // New prop
}

const determineRedirectPath = async (user: User, currentPath: string): Promise<string | null> => {
    // 1. Check if there is a pending checkout return path (Highest Priority)
    // This happens if a user clicked "Checkout" and was forced to login.
    const pendingEventId = sessionStorage.getItem('pendingCheckoutEventId');
    if (pendingEventId) {
        // FIX: Re-attach promo code to the URL if it exists, ensuring attribution persists
        const pendingPromo = sessionStorage.getItem('pendingCheckoutPromoCode');
        if (pendingPromo) {
            return `/event/${pendingEventId}?promo=${pendingPromo}`;
        }
        return `/event/${pendingEventId}`;
    }

    // 2. Context Preservation
    // If the user is currently on an event page or a form, we generally want to keep them there
    // so they can continue their journey (viewing event, using promo code, filling form).
    if (currentPath.startsWith('/event/') || currentPath.startsWith('/form/')) {
        return null; // Stay on current page
    }

    // 3. Role-based Routing (Only for users logging in from generic pages like Home)
    
    // Check for System Admin
    if (user.isSystemAdmin) {
        return '/system-admin';
    }

    // Check for active hosting (upcoming events)
    if (user.managedHostIds && user.managedHostIds.length > 0) {
        const hosts = await api.getHostsByIds(user.managedHostIds);
        const allEventIds = hosts.flatMap(h => h.eventIds);
        if (allEventIds.length > 0) {
            const events = await api.getEventsByIds(allEventIds);
            const hasUpcomingEvents = events.some(e => new Date(e.date) > new Date());
            if (hasUpcomingEvents) {
                return '/events';
            }
        }
    }

    // Check for active promotions
    if (user.promoStats && user.promoStats.some(p => p.status === 'active')) {
        return '/promotions';
    }

    // Check for purchased tickets
    if (user.purchasedTickets && user.purchasedTickets.length > 0) {
        return '/my-tickets';
    }

    // 4. Default: Stay on current page (Important for new users)
    return null;
};


const SignInModal: React.FC<SignInModalProps> = ({ isOpen, onClose, context = 'default' }) => {
  const { login, isLoading, refreshUser } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  
  // Flow State
  const [view, setView] = useState<'main' | 'email' | 'name_input' | 'forgot_password'>('main');
  
  // Form State
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [error, setError] = useState('');
  const [forgotPasswordSuccess, setForgotPasswordSuccess] = useState(false);
  const [isCheckingUser, setIsCheckingUser] = useState(false);

  const isApplication = context === 'application';

  // Reset state when modal opens/closes
  useEffect(() => {
      if (isOpen) {
          setView('main');
          setEmail('');
          setPassword('');
          setName('');
          setError('');
          setForgotPasswordSuccess(false);
          setIsCheckingUser(false);
      }
  }, [isOpen]);

  const handleGoogleLogin = async (token: string, email: string, name: string) => {
      try {
          // Attempt to login with Google token directly, passing extra info
          const user = await login('google-one-tap', token, { name, email });
          
          if (user) {
              // FIX: Ensure actual user info is saved if backend used placeholders
              const isPlaceholder = 
                  user.name === 'Google User' || 
                  user.email.includes('placeholder') ||
                  user.email.includes('fake');
              
              const mismatch = user.email !== email || (user.name !== name && name);

              if (isPlaceholder || mismatch) {
                  try {
                      console.log("Updating user profile with Google data...");
                      await api.updateUser(user.id, { name, email });
                      await refreshUser();
                  } catch (updateErr) {
                      console.warn("Failed to auto-update user details after Google login", updateErr);
                  }
              }

              onClose();
              if (context === 'default') {
                  const destination = await determineRedirectPath(user, location.pathname);
                  if (destination) navigate(destination);
              }
          }
      } catch (error) {
          // If login fails (throws), it implies user might not exist or token invalid.
          // We assume it's a new user needing registration.
          console.warn("Google login failed, attempting auto-registration:", error);
          
          try {
              // Automatically register as 'attendee' (creates host profile anyway)
              await api.registerUser(email, name, 'attendee');
              const user = await login('google-one-tap', token, { name, email });
              
              onClose();
              if (user && context === 'default') {
                  const destination = await determineRedirectPath(user, location.pathname);
                  if (destination) navigate(destination);
              }
          } catch (regError: any) {
              setError(regError.message || "Registration failed.");
          }
      }
  };

  const loginToGoogle = useGoogleLogin({
    onSuccess: async (tokenResponse) => {
        // We need user details if registration is required, fetch them
        try {
            const userInfoResponse = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { Authorization: `Bearer ${tokenResponse.access_token}` },
            });
            const userInfo = await userInfoResponse.json();
            // Use access_token as the credential for our API
            handleGoogleLogin(tokenResponse.access_token, userInfo.email, userInfo.name);
        } catch (error) {
            console.error("Failed to fetch user info", error);
            setError('Failed to get user info from Google.');
        }
    },
    onError: () => setError('Google Login Failed'),
  });

  const handleEmailSubmit = async (e: React.FormEvent) => {
      e.preventDefault();
      setError('');
      if (!email || !password) {
          setError('Please enter both email and password.');
          return;
      }

      setIsCheckingUser(true);

      try {
          // 1. Check if user exists
          let userExists = false;
          try {
              userExists = await api.checkUserExists(email);
          } catch (checkErr: any) {
              // If we get a 404, it might strictly mean user not found depending on API implementation
              // If we get network error, we default to trying login to be safe (let login endpoint handle auth)
              console.warn("Check user failed", checkErr);
              userExists = true; 
          }

          if (!userExists) {
              setIsCheckingUser(false);
              // Go to registration flow
              setView('name_input');
              return;
          }

          // 2. Try Login - pass full credentials to context login which calls api.signIn
          const user = await login('email', `${email}|${password}`); 
          
          if (user) {
              onClose();
              if (context === 'default') {
                  const destination = await determineRedirectPath(user, location.pathname);
                  if (destination) navigate(destination);
              }
          }
      } catch (err: any) {
          // If login fails
          const msg = err.message || '';
          if (msg.includes('not found') || msg.includes('No user')) {
               setView('name_input');
          } else {
               // This handles the "Invalid credentials" error from API
               setError('Incorrect email or password. Please try again.');
          }
      } finally {
          setIsCheckingUser(false);
      }
  };

  const handleNameSubmit = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!name.trim()) {
          setError('Please enter your full name.');
          return;
      }
      
      try {
          // Auto-register with default 'attendee' role
          await api.registerUser(email, name, 'attendee', password);
          // Ensure we pass credentials to login so api.signIn sends the correct password
          const user = await login('email', `${email}|${password}`);
          
          onClose();
          if (user && context === 'default') {
              const destination = await determineRedirectPath(user, location.pathname);
              if (destination) navigate(destination);
          }
      } catch (regError: any) {
          setError(regError.message || "Registration failed.");
      }
  };

  const handleForgotPassword = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!email) {
          setError("Please enter your email address.");
          return;
      }
      try {
          await api.requestPasswordReset(email);
          setForgotPasswordSuccess(true);
      } catch (err) {
          setError("Failed to send reset email.");
      }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} showCloseButton={false}>
      <div className="relative w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl shadow-purple-500/10">
        <button
            onClick={onClose}
            className="absolute top-4 right-4 text-neutral-500 hover:text-white p-2 rounded-full hover:bg-neutral-800 transition-colors z-10"
            aria-label="Close"
        >
            <XIcon className="w-5 h-5" />
        </button>
        <div className="p-8">
            {view === 'main' && (
                <>
                    <h2 className="text-2xl font-bold text-center text-white mb-2">
                        {isApplication ? 'Verify your email to apply' : 'Sign In'}
                    </h2>
                    <p className="text-neutral-400 text-center mb-8">
                        {isApplication ? 'Log in with Google to confirm your submission.' : 'to continue to Eventsta'}
                    </p>
                    
                    {error && <p className="text-red-400 text-sm text-center mb-6 bg-red-900/20 p-3 rounded-lg border border-red-900/50">{error}</p>}

                    <div className="space-y-6">
                        <button
                            onClick={() => loginToGoogle()}
                            disabled={isLoading}
                            className="social-login-btn w-full h-12 px-6 bg-white text-black rounded-full flex items-center justify-center text-sm font-bold hover:bg-neutral-200 transition-colors disabled:opacity-50"
                        >
                            <GoogleIcon className="w-5 h-5 mr-3" />
                            Continue with Google
                        </button>

                        <div className="text-center pt-2">
                            <button 
                                onClick={() => setView('email')}
                                className="text-sm text-neutral-400 hover:text-white font-medium transition-colors underline underline-offset-4 decoration-neutral-700 hover:decoration-white"
                            >
                                User email / password
                            </button>
                        </div>
                    </div>
                </>
            )}

            {view === 'email' && (
                <form onSubmit={handleEmailSubmit}>
                    <button 
                        type="button" 
                        onClick={() => setView('main')} 
                        className="mb-6 text-neutral-400 hover:text-white transition-colors flex items-center text-sm"
                    >
                        <ArrowLeftIcon className="w-4 h-4 mr-1" /> Back
                    </button>
                    
                    <h2 className="text-2xl font-bold text-white mb-6">
                        {isApplication ? 'Verify Email' : 'Sign In / Create Account'}
                    </h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-medium text-neutral-400 mb-1">Email Address</label>
                            <input 
                                type="email" 
                                value={email}
                                onChange={e => setEmail(e.target.value)}
                                className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500 transition-colors"
                                placeholder="name@example.com"
                                required
                            />
                        </div>
                        <div>
                            <div className="flex justify-between mb-1">
                                <label className="block text-xs font-medium text-neutral-400">Password</label>
                                <button type="button" onClick={() => setView('forgot_password')} className="text-xs font-medium text-purple-400 hover:text-purple-300">Forgot Password?</button>
                            </div>
                            <input 
                                type="password" 
                                value={password}
                                onChange={e => setPassword(e.target.value)}
                                className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500 transition-colors"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                required
                            />
                        </div>
                        
                        {error && <p className="text-red-400 text-sm">{error}</p>}

                        <button
                            type="submit"
                            disabled={isLoading || isCheckingUser}
                            className="w-full h-12 bg-purple-600 hover:bg-purple-500 text-white rounded-full font-bold text-sm transition-colors disabled:opacity-50 shadow-lg shadow-purple-600/20"
                        >
                            {isLoading || isCheckingUser ? 'Processing...' : 'Continue'}
                        </button>
                    </div>
                </form>
            )}

            {view === 'name_input' && (
                <form onSubmit={handleNameSubmit}>
                    <button 
                        type="button" 
                        onClick={() => setView('email')} 
                        className="mb-6 text-neutral-400 hover:text-white transition-colors flex items-center text-sm"
                    >
                        <ArrowLeftIcon className="w-4 h-4 mr-1" /> Back
                    </button>

                    <h2 className="text-2xl font-bold text-white mb-2">Nice to meet you!</h2>
                    <p className="text-neutral-400 text-sm mb-6">It looks like you're new here. Please enter your name to create your account.</p>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-medium text-neutral-400 mb-1">Full Name</label>
                            <input 
                                type="text" 
                                value={name}
                                onChange={e => setName(e.target.value)}
                                className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500 transition-colors"
                                placeholder="e.g. Alex Smith"
                                autoFocus
                                required
                            />
                        </div>

                        {error && <p className="text-red-400 text-sm">{error}</p>}

                        <button
                            type="submit"
                            className="w-full h-12 bg-purple-600 hover:bg-purple-500 text-white rounded-full font-bold text-sm transition-colors shadow-lg shadow-purple-600/20"
                        >
                            {isApplication ? 'Verify & Submit' : 'Create Account'}
                        </button>
                    </div>
                </form>
            )}

            {view === 'forgot_password' && (
                <form onSubmit={handleForgotPassword}>
                    <button 
                        type="button" 
                        onClick={() => setView('email')} 
                        className="mb-6 text-neutral-400 hover:text-white transition-colors flex items-center text-sm"
                    >
                        <ArrowLeftIcon className="w-4 h-4 mr-1" /> Back
                    </button>

                    <h2 className="text-2xl font-bold text-white mb-2">Reset Password</h2>
                    
                    {forgotPasswordSuccess ? (
                        <div className="text-center py-6">
                            <div className="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <MailIcon className="w-8 h-8 text-green-400" />
                            </div>
                            <p className="text-green-400 font-medium">Reset link sent!</p>
                            <p className="text-neutral-400 text-sm mt-2 mb-6">Check your email inbox for instructions.</p>
                            <button 
                                type="button"
                                onClick={() => setView('email')}
                                className="w-full h-12 bg-neutral-800 hover:bg-neutral-700 text-white rounded-full font-bold text-sm transition-colors"
                            >
                                Back to Login
                            </button>
                        </div>
                    ) : (
                        <>
                            <p className="text-neutral-400 text-sm mb-6">Enter your email address and we'll send you a link to reset your password.</p>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-medium text-neutral-400 mb-1">Email Address</label>
                                    <input 
                                        type="email" 
                                        value={email}
                                        onChange={e => setEmail(e.target.value)}
                                        className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500 transition-colors"
                                        placeholder="name@example.com"
                                        required
                                        autoFocus
                                    />
                                </div>

                                {error && <p className="text-red-400 text-sm">{error}</p>}

                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="w-full h-12 bg-purple-600 hover:bg-purple-500 text-white rounded-full font-bold text-sm transition-colors disabled:opacity-50"
                                >
                                    Send Reset Link
                                </button>
                            </div>
                        </>
                    )}
                </form>
            )}
        </div>
      </div>
    </Modal>
  );
};

export default SignInModal;

--- END OF FILE ./components/SignInModal.tsx ---




--- START OF FILE ./components/CheckoutModal.tsx ---


import React, { useState, useMemo, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import Modal from './Modal';
import { useAuth } from '../contexts/AuthContext';
import { Event, CheckoutCart } from '../types';
import * as api from '../services/api';
import { CheckCircleIcon, ShieldCheckIcon, UsersIcon } from './Icons';
import { loadStripe } from '@stripe/stripe-js';
import { Elements, PaymentElement, LinkAuthenticationElement, useStripe, useElements } from '@stripe/react-stripe-js';

// Use the provided Sandbox Key
const stripePromise = loadStripe('pk_test_51SLBunRAyVvF9E7vr7yuREQGiXex8blRmLwL40tUIfqbtDrSg6alTAjl5vtQXFuCLW8CzwOPHqt7L9qI1Uj20RVy00iPsBrVtO');

interface CheckoutModalProps {
  isOpen: boolean;
  onClose: () => void;
  cart: CheckoutCart;
  event: Event;
  recipientUserId?: string; // For competitions/fundraisers
  promoCode?: string;
  appliedDiscountPercent?: number;
  promoOwnerName?: string; // NEW: To display "Supporting [Name]"
}

type View = 'checkout' | 'payment_form' | 'success' | 'loading' | 'error';

const PaymentForm: React.FC<{ 
    total: number, 
    userEmail: string,
    onSuccess: () => void, 
    onError: (msg: string) => void 
}> = ({ total, userEmail, onSuccess, onError }) => {
    const stripe = useStripe();
    const elements = useElements();
    const [isLoading, setIsLoading] = useState(false);
    
    // Track element readiness
    const [isLinkReady, setIsLinkReady] = useState(false);
    const [isPaymentReady, setIsPaymentReady] = useState(false);

    const isFormReady = stripe && elements && isLinkReady && isPaymentReady;

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!stripe || !elements) return;

        setIsLoading(true);

        // Step 2: Process Payment on Client
        console.log("[Checkout] Processing payment with Stripe...");
        const { error, paymentIntent } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: window.location.href, // Redirect URL (not always used for 1-click)
            },
            redirect: 'if_required' 
        });

        if (error) {
            console.error("[Checkout] Stripe Error:", error);
            onError(error.message || "Payment failed. Please check your details.");
            setIsLoading(false);
        } else if (paymentIntent && paymentIntent.status === 'succeeded') {
            console.log("[Checkout] Payment Succeeded. Finalizing...");
            onSuccess();
        } else {
            // Unexpected status, maybe requiring action, treat as waiting/error for now
            onError("Payment processing incomplete. Please try again.");
            setIsLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-6 animate-fade-in p-6 md:p-8">
            <h2 className="text-2xl font-bold text-white mb-4">Secure Payment</h2>
            
            {/* 
                LinkAuthenticationElement:
                Prefilled with the logged-in user's email to ensure the email field 
                is populated by our system state, as required.
            */}
            <LinkAuthenticationElement 
                id="link-authentication-element"
                options={{ 
                    defaultValues: { email: userEmail }
                }}
                onReady={() => setIsLinkReady(true)}
            />
            
            <PaymentElement 
                id="payment-element" 
                options={{ 
                    layout: "tabs",
                    paymentMethodOrder: ['card', 'apple_pay', 'google_pay']
                }}
                onReady={() => setIsPaymentReady(true)}
            />
            
            <button 
                type="submit"
                disabled={isLoading || !isFormReady} 
                className="w-full h-14 mt-4 bg-purple-600 hover:bg-purple-500 text-white text-lg font-bold rounded-xl shadow-lg shadow-purple-600/20 transition-all flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                {isLoading ? (
                    <div className="flex items-center gap-2">
                        <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        <span>Processing...</span>
                    </div>
                ) : !isFormReady ? (
                    <div className="flex items-center gap-2 text-white/70">
                        <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        <span className="text-sm">Loading Secure Form...</span>
                    </div>
                ) : (
                    <>
                        <ShieldCheckIcon className="w-5 h-5" />
                        <span>Pay ${total.toFixed(2)}</span>
                    </>
                )}
            </button>
        </form>
    );
};

const CheckoutModal: React.FC<CheckoutModalProps> = ({ isOpen, onClose, cart, event, recipientUserId, promoCode, appliedDiscountPercent, promoOwnerName }) => {
  const { user, refreshUser } = useAuth();
  const navigate = useNavigate();
  const [view, setView] = useState<View>('checkout');
  const [errorMessage, setErrorMessage] = useState('');
  const [platformDonation, setPlatformDonation] = useState(0);
  const [feesConfig, setFeesConfig] = useState({ percent: 5.9, fixed: 0.35 });
  const [clientSecret, setClientSecret] = useState<string | null>(null);
  const [currentOrderId, setCurrentOrderId] = useState<string | null>(null); // NEW: Track ID for confirmation

  // Internal Promo State to allow changes within modal
  const [activePromoCode, setActivePromoCode] = useState(promoCode || '');
  const [activeDiscountPercent, setActiveDiscountPercent] = useState(appliedDiscountPercent || 0);
  const [activeOwnerName, setActiveOwnerName] = useState(promoOwnerName || '');
  
  const [promoInput, setPromoInput] = useState('');
  const [validatingPromo, setValidatingPromo] = useState(false);
  const [promoMessage, setPromoMessage] = useState<{type: 'success'|'error', text: string} | null>(null);

  // Initialize state from props when modal opens
  useEffect(() => {
      if (isOpen) {
          setView('checkout');
          setErrorMessage('');
          setActivePromoCode(promoCode || '');
          setPromoInput(promoCode || '');
          setActiveDiscountPercent(appliedDiscountPercent || 0);
          setActiveOwnerName(promoOwnerName || '');
          setPromoMessage(null);
          setClientSecret(null);
          setCurrentOrderId(null);

          api.getSystemSettings().then(settings => {
              let percent = 5.9;
              let fixed = 0.35;

              if (typeof settings.platformFeePercent === 'number' && !isNaN(settings.platformFeePercent)) {
                  percent = settings.platformFeePercent;
              }
              if (typeof settings.platformFeeFixed === 'number' && !isNaN(settings.platformFeeFixed)) {
                  fixed = settings.platformFeeFixed;
              }
              
              setFeesConfig({ percent, fixed });
          }).catch(err => {
              // Defaults are already set in useState
          });
      }
  }, [isOpen, promoCode, appliedDiscountPercent, promoOwnerName]);

  const handleApplyPromo = async () => {
      if (!promoInput.trim()) {
          // Clear promo if input is empty
          setActivePromoCode('');
          setActiveDiscountPercent(0);
          setActiveOwnerName('');
          setPromoMessage(null);
          return;
      }

      setValidatingPromo(true);
      setPromoMessage(null);

      try {
          const result = await api.validatePromoCode(event.id, promoInput.trim());
          if (result.valid) {
              setActivePromoCode(result.code);
              setActiveDiscountPercent(result.discountPercent);
              setActiveOwnerName(result.ownerName || '');
              
              let msg = "Code Applied!";
              if (result.discountPercent > 0) msg += ` ${result.discountPercent}% Off`;
              setPromoMessage({ type: 'success', text: msg });
          } else {
              setPromoMessage({ type: 'error', text: "Invalid Code" });
          }
      } catch (e) {
          setPromoMessage({ type: 'error', text: "Validation Failed" });
      } finally {
          setValidatingPromo(false);
      }
  };

  const { items, subtotal, discount, mandatoryFees, finalTotal } = useMemo(() => {
    const isFundraiser = event.type === 'fundraiser';
    const cartItems = Object.keys(cart).map((itemType) => {
      const details = cart[itemType];
      let price = 0;
      let itemSubtotal = 0;
      let isTicket = false;

      if (isFundraiser) {
        // Find the item definition to check minimum
        const ticketOption = event.tickets.find(t => t.type === itemType);
        const addOnOption = event.addOns?.find(a => a.name === itemType);
        const minDonation = ticketOption?.minimumDonation || addOnOption?.minimumDonation || 0;

        // Enforce minimum donation validation
        price = Math.max(details.donationAmount || 0, minDonation);
        itemSubtotal = price * details.quantity;
        
        if (ticketOption) isTicket = true;
      } else {
        const ticketOption = event.tickets.find(t => t.type === itemType);
        if (ticketOption) {
            price = ticketOption.price;
            isTicket = true; // Identify as a ticket
        } else {
            const addOnOption = event.addOns?.find(a => a.name === itemType);
            if (addOnOption) {
                price = addOnOption.price;
            }
        }
        itemSubtotal = price * details.quantity;
      }
      return {
        type: itemType,
        quantity: details.quantity,
        price,
        subtotal: itemSubtotal,
        isTicket // Passed for discount logic
      };
    });
    
    const calculatedSubtotal = cartItems.reduce((sum, item) => sum + item.subtotal, 0);
    
    let discountAmount = 0;
    if (activeDiscountPercent && event.type === 'ticketed') {
        // Apply discount ONLY to tickets, NOT add-ons
        const ticketSubtotal = cartItems
            .filter(item => item.isTicket)
            .reduce((sum, item) => sum + item.subtotal, 0);
            
        discountAmount = ticketSubtotal * (activeDiscountPercent / 100);
    }
    
    const subtotalAfterDiscount = calculatedSubtotal - discountAmount;

    // Mandatory Fees: System Configured % + Fixed Fee
    const calculatedFees = subtotalAfterDiscount > 0 ? (subtotalAfterDiscount * (feesConfig.percent / 100)) + feesConfig.fixed : 0;

    // Final Total including donation (handled in component state)
    const totalToPay = subtotalAfterDiscount + calculatedFees + (platformDonation || 0);

    return { 
        items: cartItems, 
        subtotal: calculatedSubtotal, 
        discount: discountAmount, 
        mandatoryFees: calculatedFees,
        finalTotal: totalToPay 
    };
  }, [cart, event, activeDiscountPercent, platformDonation, feesConfig]);

  // Initialize default donation when modal opens or subtotal changes significantly
  useEffect(() => {
      if (isOpen && subtotal > 0 && view === 'checkout') {
          // Default donation: 10% of subtotal, rounded UP to nearest dollar
          const defaultDonation = Math.ceil((subtotal - discount) * 0.10);
          setPlatformDonation(defaultDonation);
      }
  }, [isOpen, subtotal, discount, view]);

  const handleInitiatePayment = async () => {
    if (!user) return;
    setView('loading');
    setErrorMessage('');
    
    try {
      // Step 1: Initiate Checkout (Create Order & PaymentIntent)
      console.log("[Checkout] Initiating order...");
      const response = await api.purchaseTicket(
          user.id, 
          event.id, 
          cart, 
          recipientUserId, 
          activePromoCode, // Use the active/validated code
          { mandatory: mandatoryFees, donation: platformDonation }
      );
      
      if (response && response.clientSecret) {
          setClientSecret(response.clientSecret);
          setCurrentOrderId(response.orderId); // Capture Order ID for manual confirmation
          setView('payment_form');
      } else {
          throw new Error("Failed to initialize payment gateway.");
      }
      
    } catch (error: any) {
      console.error("Payment init failed", error);
      setErrorMessage(error.message || "An unexpected error occurred.");
      setView('error');
    }
  };

  const handlePaymentSuccess = async () => {
      // Payment confirmed by Stripe Client Side
      try {
          // Step 3: Confirm & Finalize
          if (currentOrderId) {
              console.log(`[Checkout] Confirming order ${currentOrderId} with backend...`);
              await api.confirmOrderPayment(currentOrderId);
              console.log("[Checkout] Backend confirmation successful.");
          } else {
              console.warn("[Checkout] No currentOrderId found during success handler.");
          }
          await refreshUser(); // Fetch newly purchased tickets
          setView('success');
      } catch (e) {
          console.warn("[Checkout] User refresh or confirmation failed after payment", e);
          // Even if confirmation fails (e.g. timeout), the payment is done.
          // The backend should eventually reconcile via webhook, or user can refresh.
          setView('success'); 
      }
  }

  const handleClose = () => {
      onClose();
      // Reset view for next time modal opens
      setTimeout(() => {
          setView('checkout');
          setErrorMessage('');
          setClientSecret(null);
          setCurrentOrderId(null);
      }, 300);
  }

  const handleViewTickets = () => {
      handleClose();
      navigate('/my-tickets');
  };

  // Helper to determine what text to show for attribution
  const attributionText = useMemo(() => {
      if (activeOwnerName) return activeOwnerName;
      if (activePromoCode) return activePromoCode;
      return null;
  }, [activeOwnerName, activePromoCode]);

  return (
    <Modal isOpen={isOpen} onClose={handleClose} preventCloseOnOutsideClick={true}>
        {/* 
            Container constraints:
            max-h-[calc(100vh-64px)] ensures top and bottom margins (about 32px each) are always visible 
            so the modal doesn't touch screen edges vertically.
            Removed min-h to let it shrink to fit content perfectly.
        */}
        <div className="w-full max-w-lg bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl shadow-purple-500/10 overflow-hidden flex flex-col max-h-[calc(100vh-64px)]">
            {view === 'checkout' && (
                <div className="flex flex-col overflow-hidden w-full">
                    <div className="p-6 md:p-8 overflow-y-auto custom-scrollbar flex-1 min-h-0">
                        <h2 className="text-2xl font-bold text-white mb-6">Checkout Summary</h2>
                        <div className="space-y-4 mb-8 border-b border-neutral-800 pb-6">
                            {items.map(item => (
                                <div key={item.type} className="flex justify-between items-center">
                                    <div>
                                        <p className="text-lg font-medium text-white">{item.type} (x{item.quantity})</p>
                                        <p className="text-sm text-neutral-400">${item.price.toFixed(2)} {event.type === 'fundraiser' ? 'donation' : 'each'}</p>
                                    </div>
                                    <span className="text-lg font-semibold text-white">${item.subtotal.toFixed(2)}</span>
                                </div>
                            ))}
                        </div>
                        
                        <div className="space-y-3">
                            {/* Promo Code Input */}
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Promo Code</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={promoInput}
                                        onChange={(e) => {
                                            setPromoInput(e.target.value.toUpperCase());
                                            // Reset message on type
                                            if (promoMessage) setPromoMessage(null);
                                        }}
                                        placeholder="Enter Code"
                                        className="flex-grow h-10 px-3 bg-neutral-800 border border-neutral-700 rounded-lg text-white text-sm focus:outline-none focus:border-purple-500"
                                    />
                                    <button 
                                        onClick={handleApplyPromo}
                                        disabled={validatingPromo || !promoInput}
                                        className="px-4 h-10 bg-neutral-800 hover:bg-neutral-700 text-white text-xs font-bold rounded-lg transition-colors border border-neutral-700 disabled:opacity-50"
                                    >
                                        {validatingPromo ? '...' : 'Apply'}
                                    </button>
                                </div>
                                {promoMessage && (
                                    <p className={`text-xs mt-1 ${promoMessage.type === 'success' ? 'text-green-400' : 'text-red-400'}`}>
                                        {promoMessage.text}
                                    </p>
                                )}
                            </div>

                            {/* Attribution Badge for Fundraisers */}
                            {event.type === 'fundraiser' && attributionText && (
                                <div className="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3 flex items-center justify-between">
                                    <div className="flex items-center text-purple-300 text-sm font-medium">
                                        <UsersIcon className="w-4 h-4 mr-2" />
                                        Supporting: <span className="text-white ml-1 font-bold">{attributionText}</span>
                                    </div>
                                </div>
                            )}

                            <div className="flex justify-between items-center text-neutral-300">
                                <p>Subtotal</p>
                                <span>${subtotal.toFixed(2)}</span>
                            </div>
                            
                            {/* Discount Logic for Ticketed Events */}
                            {discount > 0 && event.type === 'ticketed' && (
                                <div className="flex justify-between items-center text-green-400">
                                    <p>Discount ({activeDiscountPercent}%)</p>
                                    <span>-${discount.toFixed(2)}</span>
                                </div>
                            )}
                            
                            <div className="flex justify-between items-center text-neutral-300">
                                <p>Processing & Taxes</p>
                                <span>${mandatoryFees.toFixed(2)}</span>
                            </div>
                            
                            <div className="bg-neutral-800/50 p-4 rounded-xl border border-neutral-800 mt-4">
                                <div className="flex justify-between items-center mb-2">
                                    <label htmlFor="donation-input" className="text-sm font-medium text-purple-300">
                                        Platform Donation
                                    </label>
                                    <div className="relative w-24">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">$</span>
                                        <input 
                                            id="donation-input"
                                            type="number" 
                                            min="0"
                                            step="1"
                                            value={platformDonation}
                                            onChange={(e) => setPlatformDonation(Math.max(0, parseFloat(e.target.value) || 0))}
                                            className="w-full bg-neutral-900 border border-neutral-700 rounded-lg py-1.5 pl-6 pr-2 text-right text-white focus:border-purple-500 outline-none transition-colors"
                                        />
                                    </div>
                                </div>
                                <p className="text-xs text-neutral-500">
                                    â¤ï¸ Evensta is a non-profit event management platform. Your donation is optional and supports our operations.
                                </p>
                            </div>
                        </div>

                        <div className="border-t-2 border-neutral-700 mt-6 pt-4 flex justify-between items-center">
                            <span className="text-lg font-semibold text-neutral-300">Total</span>
                            <span className="text-3xl font-bold text-white">${finalTotal.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div className="flex-shrink-0 bg-neutral-900 border-t border-neutral-800 rounded-b-2xl">
                         <button onClick={handleInitiatePayment} className="w-full h-16 md:h-20 px-6 bg-purple-600 text-white text-lg font-semibold hover:bg-purple-500 transition-all duration-300 flex items-center justify-center space-x-3 rounded-b-2xl">
                            <ShieldCheckIcon className="w-5 h-5" />
                            <span>Proceed to Payment</span>
                        </button>
                    </div>
                </div>
            )}

            {view === 'loading' && (
                 <div className="flex flex-col justify-center items-center p-12">
                    <div className="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-neutral-300 text-lg font-medium">Securing Checkout...</p>
                    <p className="text-neutral-500 text-sm mt-2">Preparing secure payment channel.</p>
                </div>
            )}

            {view === 'payment_form' && clientSecret && (
                <div className="flex flex-col overflow-hidden w-full">
                    {/* The Stripe Elements container must scroll independently if needed */}
                    <div className="overflow-y-auto custom-scrollbar flex-1 bg-neutral-900 min-h-0">
                        <Elements 
                            stripe={stripePromise} 
                            options={{ 
                                clientSecret, 
                                appearance: { 
                                    theme: 'night', 
                                    variables: { 
                                        colorPrimary: '#a855f7', 
                                        colorBackground: '#171717', 
                                        colorText: '#ffffff', 
                                        borderRadius: '12px' 
                                    } 
                                } 
                            }}
                        >
                            <PaymentForm 
                                total={finalTotal} 
                                userEmail={user?.email || ''} // Pass authenticated user email
                                onSuccess={handlePaymentSuccess} 
                                onError={(msg) => { setErrorMessage(msg); setView('error'); }} 
                            />
                        </Elements>
                    </div>
                </div>
            )}

            {view === 'error' && (
                <div className="flex flex-col w-full">
                    <div className="p-12 text-center flex-grow flex flex-col justify-center items-center overflow-y-auto flex-1">
                        <div className="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                            <span className="text-4xl">âš ï¸</span>
                        </div>
                        <h2 className="text-2xl font-bold text-white mb-3">Payment Failed</h2>
                        <p className="text-red-400 mb-8 bg-red-900/20 p-4 rounded-lg border border-red-900/50 text-sm">
                            {errorMessage}
                        </p>
                    </div>
                     <div className="flex flex-shrink-0">
                        <button onClick={handleClose} className="w-1/2 h-16 px-6 bg-neutral-800 text-neutral-300 font-semibold hover:bg-neutral-700 transition-all border-t border-neutral-700 rounded-bl-2xl">
                            Cancel
                        </button>
                        <button onClick={() => setView('checkout')} className="w-1/2 h-16 px-6 bg-purple-600 text-white font-semibold hover:bg-purple-500 transition-all rounded-br-2xl">
                            Try Again
                        </button>
                     </div>
                </div>
            )}

            {view === 'success' && (
                <div className="flex flex-col w-full animate-in zoom-in duration-300">
                    <div className="flex-grow flex flex-col justify-center items-center p-8 md:p-12 text-center overflow-y-auto flex-1">
                        <div className="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6 relative flex-shrink-0">
                            <CheckCircleIcon className="w-16 h-16 text-green-400 relative z-10" />
                            <div className="absolute inset-0 rounded-full border-4 border-green-500/30 animate-ping"></div>
                        </div>
                        <h2 className="text-3xl font-black text-white mb-2 tracking-tight">Ticket Confirmed!</h2>
                        <p className="text-neutral-400 text-lg">Your order was successful. You will receive an email confirmation shortly.</p>
                    </div>
                    <div className="flex-shrink-0 w-full">
                         <button onClick={handleViewTickets} className="w-full h-20 px-6 bg-green-600 hover:bg-green-500 text-white text-lg font-bold transition-all duration-300 flex items-center justify-center shadow-[0_0_30px_rgba(22,163,74,0.3)] rounded-b-2xl">
                            View Tickets
                        </button>
                    </div>
                </div>
            )}
        </div>
    </Modal>
  );
};

export default CheckoutModal;

--- END OF FILE ./components/CheckoutModal.tsx ---




--- START OF FILE ./components/AddOnEditor.tsx ---

import React, { useState, useEffect, useRef } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { AddOn } from '../types';
import { TrashIcon, PlusIcon, GripVerticalIcon, ChevronDownIcon } from './Icons';

interface Wrapper {
    data: AddOn;
    uiKey: string;
}

interface AddOnEditorProps {
    addOns: AddOn[];
    onAddOnsChange: (addOns: AddOn[]) => void;
    isFundraiser?: boolean;
}

const EditableAddOnItem: React.FC<{
    addOn: AddOn,
    uiKey: string,
    isExpanded: boolean,
    onToggle: () => void,
    onUpdate: (key: string, field: keyof AddOn, value: any) => void,
    onDelete: () => void,
    isFundraiser: boolean,
    index: number;
    onDragStart: (index: number) => void;
    onDragEnter: (index: number) => void;
    onDragEnd: () => void;
    isDragging: boolean;
}> = ({ addOn, uiKey, isExpanded, onToggle, onUpdate, onDelete, isFundraiser, index, onDragStart, onDragEnter, onDragEnd, isDragging }) => {
    
    return (
        <div 
            draggable
            onDragStart={() => onDragStart(index)}
            onDragEnter={() => onDragEnter(index)}
            onDragEnd={onDragEnd}
            onDragOver={(e) => e.preventDefault()}
            className={`bg-neutral-900 border rounded-2xl transition-all duration-300 group ${isExpanded ? 'border-purple-500 shadow-lg shadow-purple-500/10' : 'border-neutral-800 hover:border-neutral-700'} ${isDragging ? 'opacity-50 scale-105 shadow-2xl shadow-purple-500/20' : 'opacity-100'}`}>
            {/* --- Summary View (Header) --- */}
            <div 
                className="flex items-center p-4 cursor-pointer"
                onClick={onToggle}
            >
                <div className="text-neutral-500 cursor-grab p-2 -ml-2"><GripVerticalIcon className="w-5 h-5"/></div>
                
                <div className="flex-grow mx-4">
                    <h4 className="font-bold text-white truncate">{addOn.name || 'Untitled Add-on'}</h4>
                    <div className="flex items-center gap-4 text-xs text-neutral-400 mt-1">
                        <span>{isFundraiser ? 'Suggested: ' : 'Price: '}<span className="font-mono font-semibold">${(addOn.price || 0).toFixed(2)}</span></span>
                        {isFundraiser && <span>Min: <span className="font-mono font-semibold">${(addOn.minimumDonation || 0).toFixed(2)}</span></span>}
                    </div>
                </div>

                <div className="flex items-center">
                    <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="p-2 text-neutral-500 hover:text-red-400 rounded-lg hover:bg-neutral-800 opacity-0 group-hover:opacity-100 transition-opacity">
                        <TrashIcon className="w-5 h-5"/>
                    </button>
                    <ChevronDownIcon className={`w-6 h-6 text-neutral-500 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                </div>
            </div>

            {/* --- Expanded Form View --- */}
            <div className={`grid transition-all duration-300 ease-in-out ${isExpanded ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
                <div className="overflow-hidden">
                    <div className="border-t border-neutral-800 p-6 space-y-5">
                        <div>
                            <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Add-on Name</label>
                            <input type="text" value={addOn.name} onChange={e => onUpdate(uiKey, 'name', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 px-4 text-white font-medium" />
                        </div>
                        {isFundraiser ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Recommended Amount</label>
                                    <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">$</span><input type="number" value={addOn.price} onChange={e => onUpdate(uiKey, 'price', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 pl-8 pr-4 text-white font-medium" /></div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Minimum Required</label>
                                    <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">$</span><input type="number" value={addOn.minimumDonation || ''} onChange={e => onUpdate(uiKey, 'minimumDonation', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 pl-8 pr-4 text-white font-medium" /></div>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Price</label>
                                <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">$</span><input type="number" value={addOn.price} onChange={e => onUpdate(uiKey, 'price', e.target.value)} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 pl-8 pr-4 text-white font-medium" /></div>
                            </div>
                        )}
                        <div>
                            <label className="block text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Description (Optional)</label>
                            <textarea value={addOn.description || ''} onChange={e => onUpdate(uiKey, 'description', e.target.value)} rows={2} className="w-full bg-neutral-950 border border-neutral-700 rounded-lg py-3 px-4 text-white font-medium resize-none" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

const AddOnEditor: React.FC<AddOnEditorProps> = ({ addOns, onAddOnsChange, isFundraiser = false }) => {
    const [wrappers, setWrappers] = useState<Wrapper[]>([]);
    const [expandedUiKey, setExpandedUiKey] = useState<string | null>(null);
    const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
    const dragItem = useRef<number | null>(null);
    const dragOverItem = useRef<number | null>(null);

    useEffect(() => {
        setWrappers(currentWrappers => {
            return (addOns || []).map((addOn, index) => {
                // Find existing wrapper: 1. by stable ID, 2. by index for new items.
                let existing = addOn.id ? currentWrappers.find(w => w.data.id === addOn.id) : undefined;
                if (!existing && !addOn.id && currentWrappers[index] && !currentWrappers[index].data.id) {
                    existing = currentWrappers[index];
                }

                return {
                    data: addOn,
                    uiKey: existing?.uiKey || uuidv4() // Reuse uiKey if found, else generate new one
                };
            });
        });
    }, [addOns]);
    
    const updateParent = (newWrappers: Wrapper[]) => {
        const domainAddOns = newWrappers.map(w => w.data);
        onAddOnsChange(domainAddOns);
    };

    const handleDragStart = (index: number) => {
        dragItem.current = index;
        setDraggingIndex(index);
    };

    const handleDragEnter = (index: number) => {
        dragOverItem.current = index;
    };
    
    const handleDragEnd = () => {
        if (dragItem.current !== null && dragOverItem.current !== null && dragItem.current !== dragOverItem.current) {
            const newWrappers = [...wrappers];
            const draggedItemContent = newWrappers.splice(dragItem.current, 1)[0];
            newWrappers.splice(dragOverItem.current, 0, draggedItemContent);
            updateParent(newWrappers);
        }
        setDraggingIndex(null);
        dragItem.current = null;
        dragOverItem.current = null;
    };

    const handleAddOnChange = (key: string, field: keyof AddOn, value: any) => {
        const newWrappers = wrappers.map(w => {
            if (w.uiKey === key) {
                const isNumericField = field === 'price' || field === 'minimumDonation';
                let updatedValue = value;
                if (isNumericField && value !== '') {
                    updatedValue = parseFloat(value) || 0;
                } else if (isNumericField && value === '') {
                    updatedValue = undefined;
                }
                return { ...w, data: { ...w.data, [field]: updatedValue } };
            }
            return w;
        });
        updateParent(newWrappers);
    };

    const addAddOn = () => {
        const newAddOn: AddOn = { name: '', price: 0.00, description: '', minimumDonation: 0 };
        const newWrapper = { data: newAddOn, uiKey: uuidv4() };
        updateParent([...wrappers, newWrapper]);
        setExpandedUiKey(newWrapper.uiKey);
    };

    const removeAddOn = (keyToRemove: string) => {
        const newWrappers = wrappers.filter(w => w.uiKey !== keyToRemove);
        updateParent(newWrappers);
    };

    return (
        <div className="space-y-4">
            {wrappers.map((wrapper, index) => (
                <EditableAddOnItem
                    key={wrapper.uiKey}
                    addOn={wrapper.data}
                    uiKey={wrapper.uiKey}
                    isExpanded={expandedUiKey === wrapper.uiKey}
                    onToggle={() => setExpandedUiKey(expandedUiKey === wrapper.uiKey ? null : wrapper.uiKey)}
                    onUpdate={handleAddOnChange}
                    onDelete={() => removeAddOn(wrapper.uiKey)}
                    isFundraiser={isFundraiser}
                    index={index}
                    onDragStart={handleDragStart}
                    onDragEnter={handleDragEnter}
                    onDragEnd={handleDragEnd}
                    isDragging={draggingIndex === index}
                />
            ))}
            
            <button 
                onClick={addAddOn} 
                className="w-full py-4 border-2 border-dashed border-neutral-800 hover:border-purple-500/50 rounded-2xl text-neutral-400 hover:text-purple-400 font-semibold transition-all duration-300 flex items-center justify-center gap-2 group"
            >
                <div className="bg-neutral-800 group-hover:bg-purple-500/20 p-1.5 rounded-full transition-colors">
                    <PlusIcon className="w-4 h-4" />
                </div>
                <span>Add Add-on</span>
            </button>
        </div>
    );
};

export default AddOnEditor;
--- END OF FILE ./components/AddOnEditor.tsx ---




--- START OF FILE ./components/RoleSelectionModal.tsx ---


import React from 'react';
import Modal from './Modal';
import { CalendarPlusIcon, TicketIcon } from './Icons';

interface RoleSelectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSelectRole: (role: 'attendee' | 'host') => void;
  userName: string;
}

const RoleSelectionModal: React.FC<RoleSelectionModalProps> = ({ isOpen, onClose, onSelectRole, userName }) => {
  return (
    <Modal isOpen={isOpen} onClose={onClose} showCloseButton={false}>
      <div className="w-full max-w-lg bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl p-8">
        <h2 className="text-3xl font-bold text-white text-center mb-2">Welcome, {userName}!</h2>
        <p className="text-neutral-400 text-center mb-8">How do you plan to use Eventsta?</p>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button
            onClick={() => onSelectRole('attendee')}
            className="flex flex-col items-center justify-center p-6 bg-neutral-800 hover:bg-neutral-700 border-2 border-transparent hover:border-purple-500 rounded-xl transition-all group"
          >
            <div className="w-16 h-16 bg-neutral-900 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
              <TicketIcon className="w-8 h-8 text-purple-400" />
            </div>
            <h3 className="text-lg font-bold text-white mb-1">Discover Events</h3>
            <p className="text-sm text-neutral-400 text-center">I want to buy tickets and find parties.</p>
          </button>

          <button
            onClick={() => onSelectRole('host')}
            className="flex flex-col items-center justify-center p-6 bg-neutral-800 hover:bg-neutral-700 border-2 border-transparent hover:border-purple-500 rounded-xl transition-all group"
          >
            <div className="w-16 h-16 bg-neutral-900 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
              <CalendarPlusIcon className="w-8 h-8 text-purple-400" />
            </div>
            <h3 className="text-lg font-bold text-white mb-1">Host & Promote</h3>
            <p className="text-sm text-neutral-400 text-center">I want to organize events or earn by promoting.</p>
          </button>
        </div>
      </div>
    </Modal>
  );
};

export default RoleSelectionModal;

--- END OF FILE ./components/RoleSelectionModal.tsx ---




--- START OF FILE ./components/AddEventModal.tsx ---

[ Skipped binary file ]

--- END OF FILE ./components/AddEventModal.tsx ---




--- START OF FILE ./components/FloatingTicketButton.tsx ---


import React, { useState, useEffect, useMemo } from 'react';
import { TicketIcon, PackageIcon, ShieldCheckIcon } from './Icons';
import { Event, CheckoutCart, PromoCode } from '../types';
import QuantitySelector from './QuantitySelector';
import DonationItemSelector from './DonationItemSelector';

interface FloatingTicketButtonProps {
  ticketSectionRef: React.RefObject<HTMLElement>;
  isVisible: boolean;
  // New Props for Drawer Functionality
  event?: Event;
  cart?: CheckoutCart;
  onQuantityChange?: (itemType: string, quantity: number, donationAmount?: number) => void;
  onCheckout?: () => void;
  appliedPromoCode?: PromoCode | null;
}

const FloatingTicketButton: React.FC<FloatingTicketButtonProps> = ({ 
    ticketSectionRef, 
    isVisible,
    event,
    cart,
    onQuantityChange,
    onCheckout,
    appliedPromoCode
}) => {
  const [isOpen, setIsOpen] = useState(false);

  // Check if event is ended
  const isEventEnded = event ? new Date(event.endDate || event.date) < new Date() : false;

  // Auto-close if the static section becomes visible on scroll
  useEffect(() => {
      if (!isVisible && isOpen) {
          setIsOpen(false);
      }
  }, [isVisible, isOpen]);

  // Calculate total from cart for the drawer footer
  const drawerTotal = useMemo(() => {
      if (!event || !cart) return 0;
      return Object.keys(cart).reduce((total, itemType) => {
          const details = cart[itemType];
          let price = 0;
          
          if (event.type === 'ticketed') {
              const ticketOption = event.tickets.find(t => t.type === itemType);
              const addOnOption = event.addOns?.find(a => a.name === itemType);
              
              if (ticketOption) {
                  price = ticketOption.price;
                  // Apply discount if available
                  if (appliedPromoCode) {
                      price = price * (1 - appliedPromoCode.discountPercent / 100);
                  }
              } else if (addOnOption) {
                  price = addOnOption.price;
              }
          } else {
              price = details.donationAmount || 0;
          }
          return total + (price * details.quantity);
      }, 0);
  }, [cart, event, appliedPromoCode]);

  const handleToggle = () => {
      if (!event) {
          // Fallback for pages that don't pass event data (legacy support)
          ticketSectionRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          return;
      }
      setIsOpen(!isOpen);
  };

  // Calculate total tickets for add-on logic
  const totalTicketsInCart = useMemo(() => {
    if (!event || !cart) return 0;
    return Object.keys(cart).reduce((total, itemType) => {
        const isTicket = event.tickets.some(t => t.type === itemType);
        if (isTicket) {
            return total + cart[itemType].quantity;
        }
        return total;
    }, 0);
  }, [cart, event]);

  // If event is ended, do not render the button
  if (isEventEnded) return null;

  return (
    <>
        {/* Backdrop for Focus */}
        <div 
            className={`fixed inset-0 bg-black/60 backdrop-blur-sm z-40 transition-opacity duration-500 ease-in-out ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
            onClick={() => setIsOpen(false)}
        />

        {/* Drawer Container */}
        <div 
            className={`fixed bottom-0 left-0 right-0 z-50 w-full
                        transition-transform duration-500 cubic-bezier(0.16, 1, 0.3, 1)
                        ${isOpen ? 'translate-y-0' : 'translate-y-[calc(100%-0px)]'} 
                        ${!isVisible && !isOpen ? 'translate-y-[200%]' : ''}
            `}
        >
            {/* Drawer Body */}
            <div className="relative w-full max-w-3xl mx-auto">
                
                {/* The "Handle" Button - Positioned absolutely on top of the drawer content */}
                {/* Adjusted to -56px to sit nicely on top and match border alignment */}
                <div className="absolute -top-[56px] left-1/2 -translate-x-1/2 pointer-events-auto z-30">
                    <button
                        onClick={handleToggle}
                        aria-label={isOpen ? "Close tickets" : "Select tickets"}
                        className={`group relative
                                    w-32 h-16
                                    ${isOpen ? 'bg-neutral-900' : 'bg-[#13031C]/95'} 
                                    backdrop-blur-xl
                                    border-t border-l border-r border-purple-500/30
                                    rounded-t-full
                                    flex items-center justify-center
                                    text-white
                                    transition-all duration-300
                                    hover:bg-[#1f052e] hover:border-purple-500/60
                                    focus:outline-none
                                    ${isOpen ? 'border-b-0' : 'radar-animated'}
                        `}
                    >
                        <TicketIcon 
                            className={`w-10 h-10 text-white/60 transition-all duration-300 ease-in-out group-hover:text-white group-hover:scale-105 translate-y-2 ${isOpen ? 'text-purple-400' : ''}`} 
                            style={{ textShadow: '0 -1px 1px rgba(0,0,0,0.6), 0 1px 1px rgba(255,255,255,0.1)' }}
                        />
                    </button>
                </div>

                {/* Actual Drawer Content Area */}
                <div className="relative bg-neutral-900/95 backdrop-blur-xl border-t border-l border-r border-purple-500/30 rounded-t-3xl max-h-[75vh] flex flex-col">
                    
                    {/* Masking Patch to hide border seam under handle */}
                    {isOpen && (
                        <div className="absolute -top-[2px] left-1/2 -translate-x-1/2 w-[7.8rem] h-[4px] bg-neutral-900 z-20"></div>
                    )}

                    {/* Header */}
                    <div className="px-6 py-4 border-b border-white/5 flex justify-between items-center">
                        <h3 className="text-xl font-bold text-white">Select Tickets</h3>
                        <button onClick={() => setIsOpen(false)} className="text-neutral-400 hover:text-white text-sm">Close</button>
                    </div>

                    {/* Scrollable List */}
                    <div className="p-6 overflow-y-auto custom-scrollbar space-y-4 flex-grow">
                        {event && event.tickets.map((ticket, idx) => {
                            const hasDiscount = appliedPromoCode && event.type === 'ticketed';
                            const discountPct = hasDiscount ? appliedPromoCode.discountPercent : 0;
                            const discountedPrice = ticket.price * (1 - discountPct / 100);
                            
                            // Check availability
                            const now = new Date();
                            const isSalesEnded = ticket.saleEndDate ? new Date(ticket.saleEndDate) < now : false;
                            const isSoldOut = (ticket.quantity !== undefined && (ticket.sold || 0) >= ticket.quantity);
                            const isUnavailable = isSalesEnded || isSoldOut;

                            return event.type === 'ticketed' ? (
                                <div key={ticket.id || ticket.type || idx} className={`bg-neutral-800/50 border border-white/10 rounded-xl p-4 flex items-center justify-between gap-4 ${isUnavailable ? 'opacity-50 grayscale' : ''}`}>
                                    <div>
                                        <h4 className="font-bold text-white">{ticket.type}</h4>
                                        <p className="text-xs text-neutral-400">{ticket.description}</p>
                                        {hasDiscount && !isUnavailable ? (
                                            <div className="flex items-center gap-2 mt-1">
                                                <span className="text-xs text-neutral-500 line-through">${ticket.price.toFixed(2)}</span>
                                                <span className="text-purple-400 font-bold">${discountedPrice.toFixed(2)}</span>
                                            </div>
                                        ) : (
                                            <span className="text-purple-400 font-bold">${ticket.price.toFixed(2)}</span>
                                        )}
                                        {isSoldOut && <p className="text-red-500 text-[10px] font-bold mt-1 uppercase">Sold Out</p>}
                                    </div>
                                    {isUnavailable ? (
                                        <button disabled className="px-3 py-1.5 bg-neutral-800 text-neutral-500 text-xs font-bold rounded cursor-not-allowed">Unavailable</button>
                                    ) : (
                                        <QuantitySelector 
                                            initialQuantity={cart?.[ticket.type]?.quantity} 
                                            ticketType={ticket.type} 
                                            onChange={onQuantityChange || (() => {})} 
                                        />
                                    )}
                                </div>
                            ) : (
                                <DonationItemSelector 
                                    key={ticket.id || ticket.type || idx} 
                                    item={ticket} 
                                    onChange={onQuantityChange || (() => {})} 
                                    cartItem={cart?.[ticket.type]} 
                                />
                            );
                        })}

                        {event && event.addOns && event.addOns.length > 0 && (
                            <div className={`pt-4 border-t border-white/10 ${totalTicketsInCart === 0 ? 'opacity-50 pointer-events-none' : ''}`}>
                                <h4 className="text-sm font-bold text-neutral-400 mb-3 uppercase tracking-wider flex items-center gap-2">
                                    <PackageIcon className="w-4 h-4" /> Add-ons
                                </h4>
                                <div className="space-y-3">
                                    {event.addOns.map(addOn => (
                                        event.type === 'ticketed' ? (
                                            <div key={addOn.name} className="bg-neutral-800/50 border border-white/10 rounded-xl p-4 flex items-center justify-between gap-4">
                                                <div>
                                                    <h4 className="font-semibold text-white">{addOn.name}</h4>
                                                    <p className="text-xs text-neutral-400">{addOn.description}</p>
                                                    <span className="text-purple-400 font-bold text-sm">${addOn.price.toFixed(2)}</span>
                                                </div>
                                                <QuantitySelector 
                                                    disabled={totalTicketsInCart === 0} 
                                                    initialQuantity={cart?.[addOn.name]?.quantity} 
                                                    ticketType={addOn.name} 
                                                    onChange={onQuantityChange || (() => {})} 
                                                />
                                            </div>
                                        ) : (
                                            <DonationItemSelector 
                                                key={addOn.name} 
                                                item={addOn} 
                                                onChange={onQuantityChange || (() => {})} 
                                                cartItem={cart?.[addOn.name]} 
                                            />
                                        )
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer Action */}
                    <div className="p-6 border-t border-white/10 bg-black/20">
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-neutral-400">Total</span>
                            <span className="text-2xl font-bold text-white">${drawerTotal.toFixed(2)}</span>
                        </div>
                        <button 
                            onClick={() => { setIsOpen(false); onCheckout?.(); }}
                            disabled={drawerTotal === 0}
                            className="w-full h-14 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl shadow-lg shadow-purple-600/20 transition-all flex items-center justify-center gap-3 disabled:bg-neutral-800 disabled:text-neutral-500 disabled:shadow-none"
                        >
                            <ShieldCheckIcon className="w-5 h-5" />
                            {event?.type === 'fundraiser' ? 'Donate Now' : 'Checkout'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </>
  );
};

// Add keyframes for radar pulse
const radarStyle = document.createElement('style');
radarStyle.innerHTML = `
  @keyframes radar-pulse {
    0% {
      box-shadow: 0 0 0 0px rgba(168, 85, 247, 0.7);
    }
    100% {
      box-shadow: 0 0 0 25px rgba(168, 85, 247, 0);
    }
  }
  .radar-animated {
    animation: radar-pulse 2s infinite;
  }
`;
document.head.appendChild(radarStyle);

export default FloatingTicketButton;

--- END OF FILE ./components/FloatingTicketButton.tsx ---




--- START OF FILE ./components/Icons.tsx ---

import React from 'react';

// FIX: Added style property to allow for custom styling of icons.
interface IconProps {
  className?: string;
  style?: React.CSSProperties;
}

// FIX: Pass style prop to the SVG element.
export const UserIcon: React.FC<IconProps> = ({ className, style }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
);

// ... (keep all existing icons) ...

// FIX: Pass style prop to the SVG element.
export const UsersIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
);

export const BellIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
);

export const CreditCardIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
);

export const TicketIcon: React.FC<IconProps> = ({ className, style }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
    <path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/>
    <path d="M9 12h6"/>
  </svg>
);

export const CalendarPlusIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M8 2v4"/><path d="M16 2v4"/><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M3 10h18"/><path d="M16 19h6"/><path d="M19 16v6"/></svg>
);

export const MegaphoneIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>
);

export const SettingsIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.12l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73-.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0 2.12l.15.1a2 2 0 0 0 .73 2.73l.22.38a2 2 0 0 0 2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
);

export const LogOutIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
);

export const MapPinIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
);

export const ArrowRightIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
);

export const ArrowLeftIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><line x1="19" x2="5" y1="12" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
);

export const XIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
);

export const ChromeIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="21.17" x2="12" y1="8" y2="8"/><line x1="3.95" x2="8.54" y1="6.06" y2="14"/><line x1="10.88" x2="15.46" y1="21.94" y2="14"/></svg>
);

// NEW: Added missing icons
export const FacebookIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
);
export const TwitterIcon: React.FC<IconProps> = ({ className, style }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" className={className} style={style}><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" /></svg>
);
export const LinkedInIcon: React.FC<IconProps> = ({ className, style }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" className={className} style={style}><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" /><rect width="4" height="12" x="2" y="9" /><circle cx="4" cy="4" r="2" /></svg>
);
export const AppleIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"/><path d="M10 2c1 .5 2 2 2 5"/></svg>
);
export const GoogleIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .533 5.347.533 12S5.867 24 12.48 24c3.44 0 6.013-1.133 8.053-3.24 2.08-2.16 2.72-5.2 2.72-7.76 0-.8-.08-1.48-.24-2.08h-10.53z"/></svg>
);
export const CalendarIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
);
export const ClipboardIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>
);
export const MinusIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" x2="19" y1="12" y2="12"/></svg>
);
export const PlusIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
);
export const PackageIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16.5 9.4a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z"/><path d="M22 9h-4.5a4.5 4.5 0 0 0-4.5 4.5v1a4.5 4.5 0 0 1-4.5 4.5H2"/><path d="M22 13.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14.5"/></svg>
);
export const QRCodeIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21h-1"/></svg>
);
export const CheckCircleIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
);
export const ShieldCheckIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
);
export const StarIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
);
export const WandSparklesIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m5 3-3 3 3 3 3-3-3-3zM19 13l-3 3 3 3 3-3-3-3zM3 19l3-3 3 3-3 3-3-3zM13 5l3-3 3 3-3 3-3-3zM10 14l-1.5 1.5-3-3L7 11l3 3zm7-7l-1.5 1.5-3-3L14 4l3 3z"/></svg>
);
export const TrashIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
);
export const DollarSignIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
);
export const UploadCloudIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
);
export const BarChartIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
);
export const LayoutGridIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
);
export const EditIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
);
export const GripVerticalIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
);
export const TrophyIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
);
export const EyeIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
);
export const FileText: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
);
export const ImageIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
);
export const MusicIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
);
export const YoutubeIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2.5 17a24.12 24.12 0 0 1 0-10C2.5 6 7.5 4 12 4s9.5 2 9.5 3a24.12 24.12 0 0 1 0 10c0 1-5 3-9.5 3s-9.5-2-9.5-3Z"/><path d="m10 15 5-3-5-3z"/></svg>
);
export const SaveIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
);
export const DownloadIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
);

// NEW: Camera/Scan Icons
export const CameraIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
);
export const ScanIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="10" rx="1"/></svg>
);
export const XCircleIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
);

// SYSTEM ADMIN ICONS
export const ShieldIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
);
export const LockIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></svg>
);
export const ActivityIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></svg>
);
export const ServerIcon: React.FC<IconProps> = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></svg>
);
export const BanIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>
);
export const SearchIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
);
export const MenuIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
);
export const PlayCircleIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
);
export const ClockIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
);
export const TerminalIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 17 10 11 4 5" /><line x1="12" x2="20" y1="19" y2="19" /></svg>
);

// EMAIL MANAGER ICONS
export const MailIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
);
export const SendIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
);
export const BoldIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 12a4 4 0 0 0 0-8H6v8"/><path d="M15 20a4 4 0 0 0 0-8H6v8Z"/></svg>
);
export const ItalicIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
);
export const AlignLeftIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></svg>
);
export const AlignCenterIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="21" x2="3" y1="6" y2="6"/><line x1="17" x2="7" y1="12" y2="12"/><line x1="19" x2="5" y1="18" y2="18"/></svg>
);
export const AlignRightIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="21" x2="3" y1="6" y2="6"/><line x1="21" x2="9" y1="12" y2="12"/><line x1="21" x2="7" y1="18" y2="18"/></svg>
);
export const LinkIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
);
export const StopCircleIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></svg>
);
export const RefreshCwIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
);

// --- FORM BUILDER ICONS ---
export const TypeIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7" /><line x1="9" x2="15" y1="20" y2="20" /><line x1="12" x2="12" y1="4" y2="20" /></svg>
);
export const ListIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></svg>
);
export const ImagePlusIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7" /><line x1="16" x2="22" y1="5" y2="5" /><line x1="19" x2="19" y1="2" y2="8" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></svg>
);
export const GripHorizontalIcon: React.FC<IconProps> = ({ className }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="9" r="1" /><circle cx="19" cy="9" r="1" /><circle cx="5" cy="9" r="1" /><circle cx="12" cy="15" r="1" /><circle cx="19" cy="15" r="1" /><circle cx="5" cy="15" r="1" /></svg>
);

// NEW: Chevron Icons
export const ChevronDownIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="m6 9 6 6 6-6"/></svg>
);
export const ChevronUpIcon: React.FC<IconProps> = ({ className, style }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}><path d="m18 15-6-6-6 6"/></svg>
);

--- END OF FILE ./components/Icons.tsx ---




--- START OF FILE ./components/RichTextEditor.tsx ---


import React, { useRef, useEffect, useState } from 'react';
import { BoldIcon, ItalicIcon, AlignLeftIcon, AlignCenterIcon, AlignRightIcon, LinkIcon, ImageIcon, PlusIcon } from './Icons';

interface RichTextEditorProps {
  value: string;
  onChange: (html: string) => void;
  className?: string;
  autoHeight?: boolean;
}

const RichTextEditor: React.FC<RichTextEditorProps> = ({ value, onChange, className, autoHeight = false }) => {
  const contentRef = useRef<HTMLDivElement>(null);
  const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);
  const [linkUrl, setLinkUrl] = useState('');
  const [isTagDropdownOpen, setTagDropdownOpen] = useState(false);

  // Sync external value to contentEditable
  useEffect(() => {
    if (contentRef.current) {
        // Prevent update if the content is practically the same to avoid cursor jumping
        // or if the element is currently focused (user is typing)
        if (document.activeElement === contentRef.current) {
            return;
        }
        
        if (contentRef.current.innerHTML !== value) {
             // Handle empty case to prevent accumulation of <br> tags sometimes inserted by browsers
            if (value === '' && (contentRef.current.innerHTML === '<br>' || contentRef.current.innerHTML === '<br/>')) return;
            contentRef.current.innerHTML = value;
        }
    }
  }, [value]);

  const handleInput = () => {
    if (contentRef.current) {
      const html = contentRef.current.innerHTML;
      if (html !== value) {
        onChange(html);
      }
    }
  };

  const execCommand = (command: string, value?: string) => {
    document.execCommand(command, false, value);
    contentRef.current?.focus();
  };

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const url = event.target?.result as string;
        execCommand('insertImage', url);
      };
      reader.readAsDataURL(file);
    }
  };

  const handlePaste = (e: React.ClipboardEvent) => {
    // Intercept paste to handle images or strip rich text if desired
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        e.preventDefault();
        const blob = items[i].getAsFile();
        if(blob) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const url = event.target?.result as string;
                execCommand('insertImage', url);
            };
            reader.readAsDataURL(blob);
        }
        return;
      }
    }
  };

  const insertLink = () => {
    if (linkUrl) {
        execCommand('createLink', linkUrl);
        setLinkUrl('');
        setIsLinkModalOpen(false);
    }
  };

  const insertTag = (tag: string) => {
      // Focus first to ensure insertion happens at cursor
      contentRef.current?.focus();
      execCommand('insertText', tag);
      setTagDropdownOpen(false);
  }

  const ToolbarButton: React.FC<{ icon: any, onClick: () => void, active?: boolean, title?: string }> = ({ icon: Icon, onClick, active, title }) => (
    <button
      type="button"
      onMouseDown={(e) => { e.preventDefault(); onClick(); }}
      className={`p-2 rounded hover:bg-neutral-200 transition-colors ${active ? 'bg-neutral-300 text-black' : 'text-neutral-600'}`}
      title={title}
    >
      <Icon className="w-4 h-4" />
    </button>
  );

  return (
    <div className={`border border-neutral-200 rounded-lg overflow-hidden flex flex-col bg-white shadow-inner ${autoHeight ? 'h-auto' : 'h-full'} ${className || ''}`}>
      {/* Toolbar */}
      <div className="bg-neutral-50 border-b border-neutral-200 p-2 flex flex-wrap gap-1 items-center shrink-0">
        <ToolbarButton icon={BoldIcon} onClick={() => execCommand('bold')} title="Bold" />
        <ToolbarButton icon={ItalicIcon} onClick={() => execCommand('italic')} title="Italic" />
        <div className="w-px h-6 bg-neutral-300 mx-1"></div>
        <ToolbarButton icon={AlignLeftIcon} onClick={() => execCommand('justifyLeft')} title="Align Left" />
        <ToolbarButton icon={AlignCenterIcon} onClick={() => execCommand('justifyCenter')} title="Align Center" />
        <ToolbarButton icon={AlignRightIcon} onClick={() => execCommand('justifyRight')} title="Align Right" />
        <div className="w-px h-6 bg-neutral-300 mx-1"></div>
        <ToolbarButton icon={LinkIcon} onClick={() => setIsLinkModalOpen(true)} title="Insert Link" />
        <label className="p-2 rounded hover:bg-neutral-200 transition-colors text-neutral-600 cursor-pointer" title="Insert Image">
            <ImageIcon className="w-4 h-4" />
            <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
        </label>
        
        <div className="ml-auto relative">
            <button 
                type="button"
                onClick={() => setTagDropdownOpen(!isTagDropdownOpen)}
                className="flex items-center px-3 py-1.5 text-xs font-bold bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition-colors"
            >
                <PlusIcon className="w-3 h-3 mr-1"/> Insert Variable
            </button>
            {isTagDropdownOpen && (
                <div className="absolute right-0 top-full mt-2 w-48 bg-white border border-neutral-200 shadow-xl rounded-lg py-1 z-50">
                    <button onClick={() => insertTag('{{user_name}}')} className="block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50">User Name</button>
                    <button onClick={() => insertTag('{{event_name}}')} className="block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50">Event Name</button>
                    <button onClick={() => insertTag('{{user_email}}')} className="block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50">User Email</button>
                    <button onClick={() => insertTag('{{ticket_link}}')} className="block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50">Ticket Link</button>
                </div>
            )}
        </div>
      </div>

      {/* Link Modal */}
      {isLinkModalOpen && (
          <div className="absolute top-14 left-2 z-10 bg-white border border-neutral-300 shadow-lg rounded p-2 flex gap-2">
              <input 
                type="text" 
                value={linkUrl} 
                onChange={e => setLinkUrl(e.target.value)} 
                placeholder="https://..." 
                className="border border-neutral-300 rounded px-2 py-1 text-sm outline-none focus:border-purple-500 text-black"
                autoFocus
              />
              <button onClick={insertLink} className="px-2 py-1 bg-purple-600 text-white rounded text-sm font-medium hover:bg-purple-500">Add</button>
              <button onClick={() => setIsLinkModalOpen(false)} className="px-2 py-1 text-neutral-500 hover:bg-neutral-100 rounded">Close</button>
          </div>
      )}

      {/* Editor Area */}
      <div
        ref={contentRef}
        contentEditable
        onInput={handleInput}
        onPaste={handlePaste}
        className={`p-6 outline-none text-neutral-900 prose prose-sm max-w-none ${
            autoHeight 
            ? 'min-h-[300px] overflow-y-hidden' 
            : 'flex-grow overflow-y-auto min-h-[300px]'
        }`}
        style={{ fontFamily: 'ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif', lineHeight: '1.6' }}
      />
    </div>
  );
};

export default RichTextEditor;

--- END OF FILE ./components/RichTextEditor.tsx ---




--- START OF FILE ./components/Header.tsx ---


import React, { useState, useEffect, useRef } from 'react';
import { Link, useNavigate, useLocation } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { UserIcon, TicketIcon, CalendarPlusIcon, MegaphoneIcon, SettingsIcon, LogOutIcon, ShieldIcon } from './Icons';
import SignInModal from './SignInModal';

const Header: React.FC = () => {
  const { isAuthenticated, user, logout } = useAuth();
  const [isDropdownOpen, setDropdownOpen] = useState(false);
  const [isSignInModalOpen, setSignInModalOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const navigate = useNavigate();
  const location = useLocation();

  const toggleDropdown = () => setDropdownOpen(!isDropdownOpen);
  
  const handleSignOut = () => {
    logout();
    setDropdownOpen(false);
    navigate('/');
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setDropdownOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);
  
  useEffect(() => {
      setDropdownOpen(false);
  }, [location.pathname]);

  const handleNavigation = (path: string) => {
    if (isAuthenticated) {
        navigate(path);
    } else {
        setSignInModalOpen(true);
    }
    setDropdownOpen(false);
  };

  return (
    <>
      <header className="fixed top-0 left-0 right-0 z-50 h-20 flex items-center bg-black/50 backdrop-blur-lg border-b border-neutral-800/50">
        <nav className="w-full flex items-center justify-between">
          <div className="flex items-center container mx-auto max-w-7xl px-6">
            <Link to="/" className="text-3xl font-black tracking-tighter text-white text-glow mr-10">
              Eventsta<span className="text-purple-500">.</span>
            </Link>
            <div className="hidden md:flex items-center space-x-8">
              <Link to="/" className="text-neutral-400 hover:text-white transition-colors duration-200">Discover</Link>
              <button onClick={() => handleNavigation('/events')} className="text-neutral-400 hover:text-white transition-colors duration-200">Host</button>
              <button onClick={() => handleNavigation('/promotions')} className="text-neutral-400 hover:text-white transition-colors duration-200">Promote</button>
            </div>
          </div>

          <div id="auth-container" className="relative" ref={dropdownRef}>
            {isAuthenticated ? (
              <button onClick={toggleDropdown} className={`h-10 w-10 rounded-full flex items-center justify-center border transition-all mr-6 ${user?.isSystemAdmin ? 'bg-purple-900/50 border-purple-500 text-purple-200' : 'bg-neutral-800 border-neutral-700 text-neutral-400 hover:border-purple-500'}`}>
                {user?.isSystemAdmin ? <ShieldIcon className="w-5 h-5" /> : <UserIcon className="w-5 h-5" />}
              </button>
            ) : (
              <button onClick={() => setSignInModalOpen(true)} className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-l-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 whitespace-nowrap">
                Sign In
              </button>
            )}

            {isDropdownOpen && (
              <div 
                className="absolute top-full right-6 mt-4 w-56 bg-neutral-900 border border-neutral-700 rounded-xl shadow-2xl shadow-black/50 origin-top-right transition-all duration-200 ease-in-out"
                style={{ transform: 'scale(1)', opacity: 1 }}
              >
                <div className="p-2">
                  {user?.isSystemAdmin && (
                     <button onClick={() => handleNavigation('/system-admin')} className="flex items-center w-full px-4 py-2 rounded-lg text-sm text-purple-300 bg-purple-500/10 hover:bg-purple-500/20 transition-colors mb-2 border border-purple-500/20">
                      <ShieldIcon className="w-4 h-4 mr-3" /> Master Admin Panel
                    </button>
                  )}
                  {user?.isArtist && (
                    <button onClick={() => handleNavigation(`/profile/${user.id}`)} className="flex items-center w-full px-4 py-2 rounded-lg text-sm text-neutral-300 hover:bg-neutral-800 hover:text-white transition-colors">
                      <UserIcon className="w-4 h-4 mr-3" /> My Public Profile
                    </button>
                  )}
                  <button onClick={() => handleNavigation('/my-tickets')} className="flex items-center w-full px-4 py-2 rounded-lg text-sm text-neutral-300 hover:bg-neutral-800 hover:text-white transition-colors">
                    <TicketIcon className="w-4 h-4 mr-3" /> My Tickets
                  </button>
                  <button onClick={() => handleNavigation('/events')} className="flex items-center w-full px-4 py-2 rounded-lg text-sm text-neutral-300 hover:bg-neutral-800 hover:text-white transition-colors">
                    <CalendarPlusIcon className="w-4 h-4 mr-3" /> Host Dashboard
                  </button>
                  <button onClick={() => handleNavigation('/promotions')} className="flex items-center w-full px-4 py-2 rounded-lg text-sm text-neutral-300 hover:bg-neutral-800 hover:text-white transition-colors">
                    <MegaphoneIcon className="w-4 h-4 mr-3" /> Promotions
                  </button>
                </div>
                <div className="border-t border-neutral-700/50 p-2">
                  <Link to="/settings" className="flex items-center w-full px-4 py-2 rounded-lg text-sm text-neutral-300 hover:bg-neutral-800 hover:text-white transition-colors">
                    <SettingsIcon className="w-4 h-4 mr-3" /> Settings
                  </Link>
                </div>
                <div className="border-t border-neutral-700/50 p-2">
                  <button onClick={handleSignOut} className="flex items-center w-full px-4 py-2 rounded-lg text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors">
                    <LogOutIcon className="w-4 h-4 mr-3" /> Sign Out
                  </button>
                </div>
              </div>
            )}
          </div>
        </nav>
      </header>
      <SignInModal isOpen={isSignInModalOpen} onClose={() => setSignInModalOpen(false)} />
    </>
  );
};

export default Header;

--- END OF FILE ./components/Header.tsx ---




--- START OF FILE ./components/HostEventFlow.tsx ---


import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { v4 as uuidv4 } from 'uuid';
import Modal from './Modal';
import { useAuth } from '../contexts/AuthContext';
import * as api from '../services/api';
import { WandSparklesIcon, TrashIcon, CheckCircleIcon, ArrowRightIcon, TicketIcon, DollarSignIcon, XIcon, SaveIcon, ShieldCheckIcon, UploadCloudIcon } from './Icons';
import { Event, TicketOption, Host } from '../types';

interface HostEventFlowProps {
  isOpen: boolean;
  onClose: () => void;
  onEventCreated: (newEvent: Event) => void;
  host: Host | null;
}

const STEPS = [
  { id: 1, name: 'Type' },
  { id: 2, name: 'Details' },
  { id: 3, name: 'Location' },
  { id: 4, name: 'Pricing' },
  { id: 5, name: 'Imagery' },
];

const initialEventData = {
  type: 'ticketed' as 'ticketed' | 'fundraiser',
  title: '',
  description: '',
  location: '',
  date: '',
  endDate: '',
  tickets: [{ id: uuidv4(), type: 'General Admission', price: 10.00, quantity: 100, description: '', minimumDonation: 5 }],
  imageUrls: [''],
  commission: 10,
  defaultPromoDiscount: 5,
};

const HostEventFlow: React.FC<HostEventFlowProps> = ({ isOpen, onClose, onEventCreated, host }) => {
  const { user } = useAuth();
  const [currentStep, setCurrentStep] = useState(1);
  const [eventData, setEventData] = useState(initialEventData);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Removed isGeneratingImage state, will manage upload state within Step5Image

  const handleClose = () => {
    onClose();
    setTimeout(() => {
        setCurrentStep(1);
        setEventData(initialEventData);
    }, 300); // Reset after modal close animation
  };

  const handleDataChange = (field: string, value: any) => {
    setEventData(prev => ({ ...prev, [field]: value }));
  };

  const handleNext = () => {
    if (currentStep < STEPS.length) {
      setCurrentStep(prev => prev + 1);
    }
  };

  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep(prev => prev - 1);
    }
  };
  
  const isStepValid = useMemo(() => {
    switch (currentStep) {
      case 1: return eventData.type === 'ticketed' || eventData.type === 'fundraiser';
      case 2: return eventData.title.trim() !== '' && eventData.date !== '' && eventData.endDate !== '' && new Date(eventData.endDate) > new Date(eventData.date);
      case 3: return eventData.location.trim() !== '';
      case 4:
        if (eventData.tickets.length === 0) return false;
        if (eventData.type === 'ticketed') {
            return eventData.tickets.every(t => t.type.trim() !== '' && t.price >= 0);
        }
        return eventData.tickets.every(d => d.type.trim() !== '' && d.price >= (d.minimumDonation ?? 0) && (d.minimumDonation ?? 0) >= 0);
      case 5:
        return eventData.imageUrls[0] !== '';
      default:
        return false;
    }
  }, [currentStep, eventData]);

  const handleSubmit = async (targetStatus: 'DRAFT' | 'PUBLISHED') => {
    if (!user || !host || !isStepValid) return;
    setIsSubmitting(true);
    
    // Construct the partial event object for the API
    const finalEventData: Partial<Event> = {
      title: eventData.title,
      description: eventData.description,
      location: eventData.location,
      date: eventData.date,
      endDate: eventData.endDate,
      imageUrls: eventData.imageUrls,
      commission: eventData.commission,
      defaultPromoDiscount: eventData.defaultPromoDiscount,
      hostId: host.id,
      hostName: host.name,
      type: eventData.type,
      tickets: eventData.tickets.map(({ id, ...rest }) => rest),
      addOns: [], 
      // Note: We don't send status here because api.createEvent now handles mapping
      // and the backend enforces DRAFT on creation anyway.
    };
    
    try {
      // 1. Create the event (Server always creates as DRAFT)
      const newEvent = await api.createEvent(user.id, host.id, finalEventData);
      
      // 2. If user wanted to publish immediately, we must update the status now
      if (targetStatus === 'PUBLISHED') {
          try {
              await api.updateEvent(user.id, newEvent.id, { status: 'PUBLISHED' });
              newEvent.status = 'PUBLISHED'; // Update local object for UI
          } catch (pubError) {
              console.error("Created event but failed to publish:", pubError);
              alert("Event created but failed to publish. It is saved as a Draft.");
          }
      }

      onEventCreated(newEvent);
      handleClose();
    } catch (error) {
      console.error("Failed to create event", error);
      alert((error as Error).message);
    } finally {
      setIsSubmitting(false);
    }
  };

  const renderContent = () => {
      switch (currentStep) {
          case 1: return <Step1Type data={eventData} onChange={handleDataChange} />;
          case 2: return <Step2Details data={eventData} onChange={handleDataChange} />;
          case 3: return <Step3Location data={eventData} onChange={handleDataChange} />;
          case 4: return <Step4Pricing data={eventData} onChange={handleDataChange} />;
          case 5: return <Step5Image data={eventData} onChange={handleDataChange} />;
          default: return null;
      }
  };
  
  return (
    <Modal isOpen={isOpen} onClose={handleClose} showCloseButton={false}>
        <div className="w-full md:w-[42rem] bg-neutral-900 border border-neutral-800 rounded-xl md:rounded-2xl shadow-2xl shadow-purple-500/10 flex flex-col max-h-[90vh] h-full md:h-auto">
            <div className="p-6 md:p-8 border-b border-neutral-800 flex flex-col gap-4 flex-shrink-0">
                <div className="flex justify-between items-start">
                    <div>
                        <h2 className="text-xl md:text-2xl font-bold text-white">Host a New Event</h2>
                        {host && <p className="text-sm text-neutral-400">for <span className="font-semibold text-purple-400">{host.name}</span></p>}
                    </div>
                    <button onClick={handleClose} className="text-neutral-400 hover:text-white p-2 bg-neutral-800 rounded-full"><XIcon className="w-5 h-5" /></button>
                </div>
                
                <div className="flex items-center space-x-2 overflow-x-auto no-scrollbar pb-1">
                {STEPS.map((step, index) => (
                    <React.Fragment key={step.id}>
                    <div className="flex items-center flex-shrink-0">
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold transition-colors duration-300 ${currentStep >= step.id ? 'bg-purple-600 text-white' : 'bg-neutral-700 text-neutral-400'}`}>
                        {currentStep > step.id ? <CheckCircleIcon className="w-4 h-4" /> : step.id}
                        </div>
                        <p className={`ml-2 text-xs md:text-sm font-medium whitespace-nowrap ${currentStep >= step.id ? 'text-white' : 'text-neutral-500'}`}>{step.name}</p>
                    </div>
                    {index < STEPS.length - 1 && <div className="w-4 md:w-8 h-0.5 bg-neutral-800 mx-2 flex-shrink-0"></div>}
                    </React.Fragment>
                ))}
                </div>
            </div>
            
            <div className="p-6 md:p-8 overflow-y-auto custom-scrollbar flex-grow">
                {renderContent()}
            </div>

            <div className="p-4 md:p-6 bg-neutral-900/50 border-t border-neutral-800 flex justify-between items-center flex-shrink-0">
                <div>
                    {currentStep > 1 && (
                        <button onClick={handleBack} className="px-4 py-2 text-sm font-semibold text-neutral-300 hover:text-white transition-colors">Back</button>
                    )}
                </div>
                <div>
                    {currentStep < STEPS.length ? (
                        <button onClick={handleNext} disabled={!isStepValid} className="px-6 py-3 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 disabled:bg-neutral-700 disabled:text-neutral-500 disabled:shadow-none flex items-center">
                            Next <ArrowRightIcon className="w-4 h-4 ml-2" />
                        </button>
                    ) : (
                        <div className="flex gap-3">
                            <button 
                                onClick={() => handleSubmit('DRAFT')} 
                                disabled={!isStepValid || isSubmitting} 
                                className="px-6 py-3 bg-neutral-800 border border-neutral-700 text-white text-sm font-semibold rounded-full hover:bg-neutral-700 transition-all duration-300 flex items-center gap-2 disabled:opacity-50"
                            >
                                <SaveIcon className="w-4 h-4" />
                                Save as Draft
                            </button>
                            <button 
                                onClick={() => handleSubmit('PUBLISHED')} 
                                disabled={!isStepValid || isSubmitting} 
                                className="px-6 py-3 bg-green-600 text-white text-sm font-semibold rounded-full hover:bg-green-500 transition-all duration-300 shadow-lg shadow-green-500/20 flex items-center gap-2 disabled:bg-neutral-700 disabled:text-neutral-500 disabled:shadow-none"
                            >
                                {isSubmitting ? 'Publishing...' : 'Publish Event'}
                                {!isSubmitting && <ShieldCheckIcon className="w-4 h-4" />}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    </Modal>
  );
};

const Step1Type = ({ data, onChange }: any) => (
    <div className="space-y-4">
        <button 
            onClick={() => {
                onChange('type', 'ticketed');
                onChange('defaultPromoDiscount', 5); // Default 5% for ticketed
            }} 
            className={`w-full p-4 md:p-6 text-left border rounded-xl transition-all ${data.type === 'ticketed' ? 'border-purple-500 bg-purple-500/10' : 'border-neutral-700 hover:border-neutral-600 bg-neutral-800/30'}`}
        >
            <div className="flex items-center">
                <div className="p-3 bg-neutral-800 rounded-lg mr-4">
                    <TicketIcon className="w-6 h-6 text-purple-400" />
                </div>
                <div>
                    <h4 className="font-bold text-white text-lg">Ticketed Event</h4>
                    <p className="text-sm text-neutral-400 mt-1">Sell tickets at fixed prices. Perfect for concerts, parties, and shows.</p>
                </div>
            </div>
        </button>
        <button 
            onClick={() => {
                onChange('type', 'fundraiser');
                onChange('defaultPromoDiscount', 0); // 0% for fundraisers
            }} 
            className={`w-full p-4 md:p-6 text-left border rounded-xl transition-all ${data.type === 'fundraiser' ? 'border-green-500 bg-green-500/10' : 'border-neutral-700 hover:border-neutral-600 bg-neutral-800/30'}`}
        >
            <div className="flex items-center">
                <div className="p-3 bg-neutral-800 rounded-lg mr-4">
                    <DollarSignIcon className="w-6 h-6 text-green-400" />
                </div>
                 <div>
                    <h4 className="font-bold text-white text-lg">Fundraiser Event</h4>
                    <p className="text-sm text-neutral-400 mt-1">Collect donations. Guests choose their contribution amount.</p>
                </div>
            </div>
        </button>
    </div>
);


// Step 2 Component
const Step2Details = ({ data, onChange }: any) => (
    <div className="space-y-6">
        <div>
            <label htmlFor="event-title" className="block text-sm font-medium text-neutral-300 mb-2">Event Title</label>
            <input type="text" id="event-title" value={data.title} onChange={e => onChange('title', e.target.value)} className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-neutral-600" placeholder="e.g. Summer Rooftop Party" required />
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             <div>
                <label htmlFor="event-date" className="block text-sm font-medium text-neutral-300 mb-2">Start</label>
                <input type="datetime-local" id="event-date" value={data.date} onChange={e => onChange('date', e.target.value)} className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none" required />
            </div>
            <div>
                <label htmlFor="event-end-date" className="block text-sm font-medium text-neutral-300 mb-2">End</label>
                <input type="datetime-local" id="event-end-date" value={data.endDate} onChange={e => onChange('endDate', e.target.value)} className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none" required />
            </div>
        </div>
        <div>
            <label htmlFor="event-desc" className="block text-sm font-medium text-neutral-300 mb-2">Description</label>
            <textarea id="event-desc" value={data.description} onChange={e => onChange('description', e.target.value)} rows={4} className="w-full p-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none placeholder-neutral-600" placeholder="Tell people what makes your event special..." />
        </div>
    </div>
);

// Step 3 Component
const Step3Location = ({ data, onChange }: any) => {
    const [locations, setLocations] = useState<string[]>([]);
    const [query, setQuery] = useState('');

    useEffect(() => {
        api.getMockLocations().then(setLocations);
    }, []);

    const filteredLocations = query ? locations.filter(loc => loc.toLowerCase().includes(query.toLowerCase())) : [];
    
    return (
        <div className="space-y-6">
            <div className="relative">
                <label htmlFor="event-location" className="block text-sm font-medium text-neutral-300 mb-2">Event Location</label>
                <input type="text" id="event-location" value={data.location} onChange={e => { onChange('location', e.target.value); setQuery(e.target.value); }} autoComplete="off" className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g. 123 Main St, Los Angeles, CA" required />
                 {filteredLocations.length > 0 && query && (
                    <ul className="absolute z-10 w-full mt-1 bg-neutral-800 border border-neutral-700 rounded-lg shadow-lg max-h-40 overflow-y-auto custom-scrollbar">
                        {filteredLocations.map(loc => (
                            <li key={loc} onClick={() => { onChange('location', loc); setQuery(''); }} className="px-4 py-3 text-white hover:bg-purple-600 cursor-pointer border-b border-neutral-700 last:border-0">{loc}</li>
                        ))}
                    </ul>
                )}
            </div>
            <div className="bg-neutral-800/30 p-4 rounded-lg border border-neutral-800">
                <p className="text-sm text-neutral-400 flex gap-2">
                    <span className="text-purple-400">ðŸ’¡</span> 
                    Tip: Be specific. Use the full address so attendees can find it on maps easily.
                </p>
            </div>
        </div>
    );
}

// Step 4 Component (Pricing for Tickets/Donations)
const Step4Pricing = ({ data, onChange }: any) => {
    const isFundraiser = data.type === 'fundraiser';
    
    const handleTicketChange = (id: string, field: keyof TicketOption, value: any) => {
        const newTickets = data.tickets.map((ticket: any) => {
            if (ticket.id === id) {
                const isNumericField = field === 'price' || field === 'minimumDonation' || field === 'quantity';
                const updatedValue = isNumericField ? (parseFloat(value) || 0) : value;
                return { ...ticket, [field]: updatedValue };
            }
            return ticket;
        });
        onChange('tickets', newTickets);
    };

    const addTicket = () => {
        const newTicket = { id: uuidv4(), type: '', price: 0, quantity: 100, description: '', minimumDonation: 0 };
        onChange('tickets', [...data.tickets, newTicket]);
    };

    const removeTicket = (id: string) => {
        onChange('tickets', data.tickets.filter((ticket: any) => ticket.id !== id));
    };

    return (
        <div className="space-y-6">
            <div>
                <h4 className="text-lg font-bold text-white mb-4">{isFundraiser ? 'Donation Tiers' : 'Ticket Options'}</h4>
                <div className="hidden md:flex gap-4 px-2 text-xs font-bold text-neutral-500 uppercase tracking-wider">
                    <div className="flex-grow pl-1">Ticket Name</div>
                    <div className="w-24">{isFundraiser ? 'Suggested' : 'Price'}</div>
                    <div className="w-20">Qty</div>
                    {isFundraiser && <div className="w-24">Min. Amt</div>}
                    <div className="w-8"></div>
                </div>

                <div className="space-y-3">
                    {data.tickets.map((ticket: any, index: number) => (
                        <div key={ticket.id} className="bg-neutral-800 p-4 md:p-3 rounded-lg border border-neutral-700">
                            <div className="flex flex-col md:flex-row gap-4 md:items-start mb-3">
                                <div className="flex-grow">
                                    <label className="md:hidden text-xs font-bold text-neutral-500 uppercase mb-1.5 block">Ticket Name</label>
                                    <input 
                                        type="text" 
                                        placeholder={isFundraiser ? 'e.g. Art Patron' : 'e.g. General Admission'}
                                        value={ticket.type} 
                                        onChange={e => handleTicketChange(ticket.id, 'type', e.target.value)} 
                                        className="w-full h-10 px-3 bg-neutral-700 border border-neutral-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500" 
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <div className={`relative ${isFundraiser ? 'w-1/3 md:w-24' : 'w-1/2 md:w-24'}`}>
                                        <label className="md:hidden text-xs font-bold text-neutral-500 uppercase mb-1.5 block">{isFundraiser ? 'Suggested' : 'Price'}</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">$</span>
                                            <input 
                                                type="number" 
                                                value={ticket.price} 
                                                onChange={e => handleTicketChange(ticket.id, 'price', e.target.value)} 
                                                className="w-full h-10 pl-6 pr-2 bg-neutral-700 border border-neutral-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-right"
                                                step="0.01" min="0"
                                            />
                                        </div>
                                    </div>
                                    <div className={`relative ${isFundraiser ? 'w-1/3 md:w-20' : 'w-1/2 md:w-20'}`}>
                                        <label className="md:hidden text-xs font-bold text-neutral-500 uppercase mb-1.5 block">Qty</label>
                                        <input 
                                            type="number" 
                                            value={ticket.quantity || ''} 
                                            onChange={e => handleTicketChange(ticket.id, 'quantity', e.target.value)} 
                                            className="w-full h-10 px-2 bg-neutral-700 border border-neutral-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-center"
                                            min="0"
                                            placeholder="âˆž"
                                        />
                                    </div>
                                    {isFundraiser && (
                                        <div className="w-1/3 md:w-24">
                                            <label className="md:hidden text-xs font-bold text-neutral-500 uppercase mb-1.5 block">Min Amt</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">$</span>
                                                <input 
                                                    type="number" 
                                                    value={ticket.minimumDonation || ''}
                                                    onChange={e => handleTicketChange(ticket.id, 'minimumDonation', e.target.value)} 
                                                    className="w-full h-10 pl-6 pr-2 bg-neutral-700 border border-neutral-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-right"
                                                    step="0.01" min="0"
                                                />
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="flex justify-end md:block">
                                    <button onClick={() => removeTicket(ticket.id)} className="w-10 h-10 flex items-center justify-center text-neutral-500 hover:text-red-400 bg-neutral-700/50 md:bg-transparent rounded-md md:rounded-none md:mt-0" disabled={data.tickets.length <= 1}>
                                        <TrashIcon className="w-5 h-5"/>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label className="md:hidden text-xs font-bold text-neutral-500 uppercase mb-1.5 block">Description (Optional)</label>
                                <input
                                    type="text"
                                    placeholder="Includes skip-the-line access..."
                                    value={ticket.description} 
                                    onChange={e => handleTicketChange(ticket.id, 'description', e.target.value)} 
                                    className="w-full h-10 px-3 bg-neutral-700 border border-neutral-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm placeholder-neutral-500" 
                                />
                            </div>
                        </div>
                    ))}
                </div>
                
                <button onClick={addTicket} className="w-full mt-3 px-5 py-3 text-sm font-semibold text-purple-400 hover:text-white transition-colors bg-purple-500/10 hover:bg-purple-500/20 rounded-lg flex items-center justify-center gap-2">
                    <ArrowRightIcon className="w-4 h-4" />
                    Add {isFundraiser ? 'Donation Tier' : 'Ticket Type'}
                </button>
            </div>

            <div className="border-t border-neutral-800 pt-6">
                <h4 className="text-lg font-bold text-white mb-4">Promotion Settings</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 bg-neutral-800/30 p-4 rounded-lg border border-neutral-800">
                    <div>
                        <label className="block text-sm font-medium text-neutral-300 mb-2">Promoter Commission (%)</label>
                        <div className="relative">
                            <input 
                                type="number" 
                                value={data.commission} 
                                onChange={e => onChange('commission', parseFloat(e.target.value))}
                                className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                min="0" max="100"
                            />
                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-neutral-500">%</span>
                        </div>
                        <p className="text-xs text-neutral-500 mt-1">Percentage of ticket sales earned by promoters.</p>
                    </div>
                    {!isFundraiser && (
                        <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Customer Discount (%)</label>
                            <div className="relative">
                                <input 
                                    type="number" 
                                    value={data.defaultPromoDiscount} 
                                    onChange={e => onChange('defaultPromoDiscount', parseFloat(e.target.value))}
                                    className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    min="0" max="100"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-neutral-500">%</span>
                            </div>
                            <p className="text-xs text-neutral-500 mt-1">Discount for buyers using a promoter link.</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

// Step 5 Component
const Step5Image = ({ data, onChange }: any) => {
    const fileInputRef = useRef<HTMLInputElement>(null);
    const [isUploading, setIsUploading] = useState(false);

    const handleUploadFile = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setIsUploading(true);
        
        try {
            const url = await api.uploadFile(file);
            onChange('imageUrls', [url]);
        } catch (error) {
            console.error("Upload failed", error);
            alert("Failed to upload image. Please try again.");
        } finally {
            setIsUploading(false);
            if (fileInputRef.current) fileInputRef.current.value = ''; // Reset input
        }
    };
    
    return (
        <div>
             <p className="text-neutral-400 text-center mb-4 text-sm">Upload a compelling image for your event poster. This will be the main visual.</p>
            <div 
                onClick={() => !isUploading && fileInputRef.current?.click()} 
                className="relative aspect-video w-full bg-neutral-800 rounded-lg overflow-hidden cursor-pointer group border-2 border-dashed border-neutral-700 hover:border-purple-500 transition-colors"
            >
                {isUploading ? (
                    <div className="flex items-center justify-center h-full">
                        <div className="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        <p className="ml-4 text-white">
                            Uploading Image...
                        </p>
                    </div>
                ) : (
                    data.imageUrls[0] ? (
                        <img 
                            src={data.imageUrls[0]} 
                            alt="Event Preview" 
                            className="w-full h-full object-cover"
                            onError={(e) => {
                                // Provide visual feedback if image fails to load
                                e.currentTarget.src = "https://placehold.co/600x400/262626/666?text=Image+Load+Error";
                                console.error("Failed to load image at:", data.imageUrls[0]);
                            }}
                        />
                    ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-neutral-500 group-hover:text-neutral-300 transition-colors">
                            <UploadCloudIcon className="w-12 h-12 mb-2 opacity-50" />
                            <span className="text-lg font-medium">Click to Upload Image</span>
                        </div>
                    )
                )}
                 <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <p className="text-white font-bold flex items-center gap-2"><UploadCloudIcon className="w-5 h-5"/> Upload Custom Image</p>
                </div>
                <input 
                    type="file" 
                    ref={fileInputRef} 
                    className="hidden" 
                    accept="image/*" 
                    onChange={handleUploadFile} 
                />
            </div>
            {/* Removed AI re-generate button */}
        </div>
    );
};

export default HostEventFlow;

--- END OF FILE ./components/HostEventFlow.tsx ---




--- START OF FILE ./components/DonationItemSelector.tsx ---


import React, { useState, useEffect } from 'react';
import { TicketOption, AddOn, CheckoutCart } from '../types';
import { MinusIcon, PlusIcon } from './Icons';

interface DonationItemSelectorProps {
    item: TicketOption | AddOn;
    onChange: (itemType: string, quantity: number, donationAmount?: number) => void;
    cartItem?: CheckoutCart[string];
}

const DonationItemSelector: React.FC<DonationItemSelectorProps> = ({ item, onChange, cartItem }) => {
    const recommendedDonation = item.price;
    const minimumDonation = item.minimumDonation ?? 0;
    
    const [quantity, setQuantity] = useState(cartItem?.quantity || 0);
    
    // Use string | number to allow empty input while typing
    const [amount, setAmount] = useState<string | number>(cartItem?.donationAmount || recommendedDonation);
    
    // The 'name' property is on AddOn, 'type' is on TicketOption.
    const itemName = 'name' in item ? item.name : item.type;

    useEffect(() => {
        // Ensure we pass a valid number to the parent
        const numericAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
        const validAmount = isNaN(numericAmount) ? 0 : numericAmount;
        onChange(itemName, quantity, validAmount);
    }, [quantity, amount, itemName, onChange]);

    const handleAmountChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const val = e.target.value;
        if (val === '') {
            setAmount('');
            return;
        }
        const parsed = parseFloat(val);
        if (!isNaN(parsed)) {
            setAmount(parsed);
        }
    };
    
    const handleAmountBlur = () => {
        const numericAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
        const validAmount = isNaN(numericAmount) ? 0 : numericAmount;

        if (validAmount < minimumDonation) {
            setAmount(minimumDonation);
        } else {
            // Just to clean up if it was a string like "20."
            setAmount(validAmount);
        }
    }

    return (
        <div className="bg-neutral-900 border border-neutral-800 rounded-xl p-5 flex flex-col gap-4">
            <div>
                <h4 className="text-lg font-semibold text-white">{itemName}</h4>
                <p className="text-neutral-400 text-sm mb-2">{item.description || ''}</p>
                <span className="text-sm text-neutral-400">Min: ${minimumDonation.toFixed(2)} | Rec: ${recommendedDonation.toFixed(2)}</span>
            </div>
            <div className="flex items-center justify-between gap-4">
                <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">$</span>
                    <input 
                        type="number"
                        value={amount}
                        onChange={handleAmountChange}
                        onBlur={handleAmountBlur}
                        className="w-32 h-12 pl-7 pr-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white font-bold text-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        step="1"
                    />
                </div>
                <div className="flex items-center border border-neutral-700 rounded-full p-1">
                    <button onClick={() => setQuantity(q => Math.max(0, q - 1))} className="w-10 h-10 rounded-full bg-neutral-800 hover:bg-neutral-700 disabled:opacity-50" disabled={quantity === 0}><MinusIcon className="w-5 h-5 mx-auto text-neutral-400" /></button>
                    <span className="w-10 text-center font-bold text-lg text-white">{quantity}</span>
                    <button onClick={() => setQuantity(q => q + 1)} className="w-10 h-10 rounded-full bg-neutral-800 hover:bg-neutral-700"><PlusIcon className="w-5 h-5 mx-auto text-neutral-200" /></button>
                </div>
            </div>
        </div>
    );
};

export default DonationItemSelector;

--- END OF FILE ./components/DonationItemSelector.tsx ---




--- START OF FILE ./components/SocialShareButtons.tsx ---


import React, { useState } from 'react';
import { FacebookIcon, TwitterIcon, LinkedInIcon, MailIcon, LinkIcon, CheckCircleIcon } from './Icons';

interface SocialShareButtonsProps {
  url: string;
  title: string;
}

const SocialShareButtons: React.FC<SocialShareButtonsProps> = ({ url, title }) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(url);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const shareLinks = [
    {
      name: 'Facebook',
      icon: FacebookIcon,
      href: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
      className: 'hover:text-[#1877F2] hover:bg-[#1877F2]/10',
    },
    {
      name: 'X (Twitter)',
      icon: TwitterIcon,
      href: `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`,
      className: 'hover:text-white hover:bg-neutral-800',
    },
    {
      name: 'LinkedIn',
      icon: LinkedInIcon,
      href: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`,
      className: 'hover:text-[#0A66C2] hover:bg-[#0A66C2]/10',
    },
    {
      name: 'Email',
      icon: MailIcon,
      href: `mailto:?subject=${encodeURIComponent(title)}&body=Check out this event: ${encodeURIComponent(url)}`,
      className: 'hover:text-purple-400 hover:bg-purple-500/10',
    }
  ];

  return (
    <div className="flex items-center gap-1 mt-4 animate-fade-in">
      {shareLinks.map((link) => (
        <a
          key={link.name}
          href={link.href}
          target="_blank"
          rel="noopener noreferrer"
          aria-label={`Share on ${link.name}`}
          className={`w-9 h-9 rounded-full flex items-center justify-center text-neutral-400 transition-all duration-300 hover:scale-110 ${link.className}`}
        >
          <link.icon className="w-4 h-4" />
        </a>
      ))}
      
      <button
        onClick={handleCopy}
        aria-label="Copy Link"
        className={`w-9 h-9 rounded-full flex items-center justify-center text-neutral-400 transition-all duration-300 hover:scale-110 hover:text-white hover:bg-white/10 relative group`}
      >
        {copied ? <CheckCircleIcon className="w-4 h-4 text-green-400" /> : <LinkIcon className="w-4 h-4" />}
        
        {/* Tooltip */}
        <span className={`absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-black text-white text-[10px] font-medium rounded opacity-0 transition-opacity ${copied ? 'opacity-100' : 'group-hover:opacity-100'} pointer-events-none`}>
            {copied ? 'Copied!' : 'Copy Link'}
        </span>
      </button>
    </div>
  );
};

export default SocialShareButtons;

--- END OF FILE ./components/SocialShareButtons.tsx ---




--- START OF FILE ./components/FormBuilder.tsx ---


import React, { useState, useRef, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { v4 as uuidv4 } from 'uuid';
import { CompetitionForm, FormElement, FormElementType } from '../types';
import * as api from '../services/api';
import { 
    TypeIcon, ListIcon, ImagePlusIcon, EyeIcon, 
    GripHorizontalIcon, TrashIcon, CheckCircleIcon, PlusIcon,
    FileText, UploadCloudIcon, LinkIcon, ArrowRightIcon
} from './Icons';

interface FormBuilderProps {
    form: CompetitionForm;
    onSave: (form: CompetitionForm) => void;
    onCancel: () => void;
}

const FormBuilder: React.FC<FormBuilderProps> = ({ form: initialForm, onSave, onCancel }) => {
    const [form, setForm] = useState<CompetitionForm>(initialForm);
    const [activeElementId, setActiveElementId] = useState<string | null>(null);
    const [headerImagePreview, setHeaderImagePreview] = useState<string | null>(initialForm.headerImageUrl || null);
    const [isSaving, setIsSaving] = useState(false);
    const [isHeaderUploading, setIsHeaderUploading] = useState(false);
    const headerInputRef = useRef<HTMLInputElement>(null);
    const [copySuccess, setCopySuccess] = useState(false);

    // Editable Refs
    const titleRef = useRef<HTMLHeadingElement>(null);
    const descRef = useRef<HTMLDivElement>(null);

    // Refs for Drag and Drop
    const dragItem = useRef<number | null>(null);
    const dragOverItem = useRef<number | null>(null);

    const handleHeaderUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // 1. Instant Preview with Object URL
        const objectUrl = URL.createObjectURL(file);
        setHeaderImagePreview(objectUrl);
        setIsHeaderUploading(true);

        try {
            // 2. Upload in background
            const uploadedUrl = await api.uploadFile(file);
            
            // 3. Update form state with remote URL
            setForm(prev => ({ ...prev, headerImageUrl: uploadedUrl }));
        } catch (error) {
            console.error("Header image upload failed", error);
            alert("Failed to upload image. Please try again.");
        } finally {
            setIsHeaderUploading(false);
            // Reset input so same file can be selected again if needed
            if (headerInputRef.current) {
                headerInputRef.current.value = '';
            }
        }
    };

    const addElement = (type: FormElementType) => {
        const newElement: FormElement = {
            id: uuidv4(),
            type,
            label: type === 'SHORT_TEXT' ? 'Short Answer' : 
                   type === 'LONG_TEXT' ? 'Paragraph' : 
                   type === 'SINGLE_CHOICE' ? 'Multiple Choice' : 'Checkboxes',
            required: false,
            options: (type === 'SINGLE_CHOICE' || type === 'MULTIPLE_CHOICE') 
                ? [{ id: uuidv4(), label: 'Option 1' }, { id: uuidv4(), label: 'Option 2' }] 
                : undefined
        };
        setForm(prev => ({ ...prev, elements: [...prev.elements, newElement] }));
        setActiveElementId(newElement.id);
        
        // Scroll to bottom of form container
        setTimeout(() => {
            const container = document.getElementById('form-elements-container');
            if (container) container.scrollTop = container.scrollHeight;
        }, 100);
    };

    const updateElement = (id: string, updates: Partial<FormElement>) => {
        setForm(prev => ({
            ...prev,
            elements: prev.elements.map(el => el.id === id ? { ...el, ...updates } : el)
        }));
    };

    const deleteElement = (id: string) => {
        setForm(prev => ({
            ...prev,
            elements: prev.elements.filter(el => el.id !== id)
        }));
        if (activeElementId === id) setActiveElementId(null);
    };

    const handleDragStart = (index: number) => {
        dragItem.current = index;
    };

    const handleDragEnter = (index: number) => {
        dragOverItem.current = index;
    };

    const handleDragEnd = () => {
        if (dragItem.current === null || dragOverItem.current === null) return;
        const newElements = [...form.elements];
        const draggedItem = newElements.splice(dragItem.current, 1)[0];
        newElements.splice(dragOverItem.current, 0, draggedItem);
        setForm(prev => ({ ...prev, elements: newElements }));
        dragItem.current = null;
        dragOverItem.current = null;
    };

    const handleSave = async () => {
        if (isHeaderUploading) {
            alert("Please wait for image upload to complete.");
            return;
        }

        setIsSaving(true);
        
        // Capture content from refs safely using optional chaining.
        const currentTitle = titleRef.current?.innerText ?? form.title;
        const currentDesc = descRef.current?.innerHTML ?? form.description;
        
        const finalForm = {
            ...form,
            title: currentTitle,
            description: currentDesc
        };

        // Simulate API delay
        await new Promise(resolve => setTimeout(resolve, 500));
        onSave(finalForm);
        
        // Only update state if component is still mounted (implied by ref presence)
        if (titleRef.current) {
            setIsSaving(false);
        }
    };

    const copyPublicLink = () => {
        const url = `${window.location.origin}/form/${form.id}`;
        navigator.clipboard.writeText(url);
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
    };

    return (
        <div className="fixed inset-0 z-[100] flex flex-col bg-black text-white animate-fade-in">
            {/* Header Toolbar */}
            <div className="h-16 bg-neutral-900 border-b border-neutral-800 flex items-center justify-between px-6 flex-shrink-0 z-50 relative shadow-lg">
                <div className="flex items-center gap-4">
                    <button onClick={onCancel} className="text-neutral-400 hover:text-white text-sm font-medium transition-colors px-2 py-1 rounded hover:bg-neutral-800">
                        &larr; Exit Builder
                    </button>
                    <div className="h-6 w-px bg-neutral-700 hidden md:block"></div>
                    <span className="text-white font-bold text-lg hidden md:block">Form Studio</span>
                    {form.id && (
                        <>
                            <button onClick={copyPublicLink} className="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-neutral-800 hover:bg-neutral-700 text-xs font-medium text-neutral-300 transition-colors border border-neutral-700">
                                {copySuccess ? <CheckCircleIcon className="w-3 h-3 text-green-400" /> : <LinkIcon className="w-3 h-3" />}
                                {copySuccess ? 'Link Copied' : 'Copy Link'}
                            </button>
                            <Link 
                                to={`/form/${form.id}`} 
                                className="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-neutral-800 hover:bg-neutral-700 text-xs font-medium text-neutral-300 transition-colors border border-neutral-700"
                            >
                                <EyeIcon className="w-3 h-3" />
                                View Public
                            </Link>
                        </>
                    )}
                </div>
                <div className="flex items-center gap-3">
                    <div className="hidden lg:flex items-center text-xs text-neutral-500 mr-4">
                        <EyeIcon className="w-3 h-3 mr-1.5" /> Changes auto-save to draft
                    </div>
                    <button 
                        onClick={handleSave} 
                        disabled={isSaving || isHeaderUploading}
                        className="bg-white hover:bg-neutral-200 text-black px-6 py-2 rounded-full text-sm font-bold transition-colors flex items-center gap-2 disabled:opacity-50 shadow-[0_0_15px_rgba(255,255,255,0.2)]"
                    >
                        {isSaving ? 'Saving...' : isHeaderUploading ? 'Uploading...' : 'Save & Close'}
                    </button>
                </div>
            </div>

            <div className="flex flex-col flex-grow overflow-hidden relative">
                {/* Main Canvas (Top Section) */}
                <div className="flex-grow relative overflow-hidden bg-neutral-950 flex flex-col items-center">
                    {/* Scrollable Form Area */}
                    <div id="form-elements-container" className="w-full h-full overflow-y-auto custom-scrollbar relative">
                        
                        {/* Parallax Background Layer */}
                        <div className="absolute top-0 left-0 w-full h-[500px] z-0 pointer-events-none overflow-hidden">
                            {headerImagePreview && (
                                <div 
                                    className="absolute inset-0 bg-cover bg-center opacity-40 blur-3xl scale-110"
                                    style={{ backgroundImage: `url(${headerImagePreview})` }}
                                ></div>
                            )}
                            <div className="absolute inset-0 bg-gradient-to-b from-transparent to-neutral-950"></div>
                        </div>

                        <div className="relative z-10 max-w-3xl mx-auto py-8 md:py-12 px-4 md:px-8 min-h-full flex flex-col">
                            
                            {/* Form Card */}
                            <div className="bg-neutral-900/80 backdrop-blur-xl border border-white/10 rounded-3xl shadow-2xl overflow-hidden transition-all duration-500 mb-20">
                                
                                {/* Header Image Area */}
                                <div 
                                    className="relative w-full aspect-[3/1] bg-neutral-800/50 border-b border-white/5 overflow-hidden group cursor-pointer"
                                    onClick={() => headerInputRef.current?.click()}
                                >
                                    {headerImagePreview ? (
                                        <img src={headerImagePreview} alt="Header" className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                                    ) : (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center text-neutral-500 group-hover:text-neutral-300 transition-colors">
                                            <ImagePlusIcon className="w-12 h-12 mb-2 opacity-50" />
                                            <span className="text-sm font-medium">Add Cover Image</span>
                                        </div>
                                    )}
                                    
                                    {/* Uploading Overlay */}
                                    {isHeaderUploading && (
                                        <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center z-20">
                                            <div className="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin mb-2"></div>
                                            <span className="text-white text-xs font-bold uppercase tracking-wider">Uploading...</span>
                                        </div>
                                    )}

                                    {/* Hover Overlay (only when not uploading) */}
                                    {!isHeaderUploading && (
                                        <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-10">
                                            <span className="text-white font-medium flex items-center gap-2 px-4 py-2 bg-black/50 rounded-full backdrop-blur-md border border-white/10">
                                                <UploadCloudIcon className="w-5 h-5"/> Change Cover
                                            </span>
                                        </div>
                                    )}
                                    <input type="file" ref={headerInputRef} className="hidden" accept="image/*" onChange={handleHeaderUpload} />
                                </div>

                                <div className="p-6 md:p-12">
                                    {/* Editable Intro */}
                                    <div className="mb-12 text-center md:text-left border-b border-white/5 pb-8">
                                        <h1
                                            ref={titleRef}
                                            contentEditable
                                            suppressContentEditableWarning
                                            onBlur={(e) => {
                                                const newTitle = e.currentTarget.innerText;
                                                setForm(prev => ({ ...prev, title: newTitle }));
                                            }}
                                            className="text-3xl md:text-5xl font-black text-white mb-4 tracking-tight leading-tight outline-none border-b border-transparent hover:border-white/20 transition-colors empty:before:content-['Click_to_edit_title'] empty:before:text-neutral-600"
                                        >
                                            {form.title}
                                        </h1>
                                        <div
                                            ref={descRef}
                                            contentEditable
                                            suppressContentEditableWarning
                                            onBlur={(e) => {
                                                const newDesc = e.currentTarget.innerHTML;
                                                setForm(prev => ({ ...prev, description: newDesc }));
                                            }}
                                            className="text-base md:text-lg text-neutral-300 leading-relaxed outline-none border-b border-transparent hover:border-white/20 transition-colors min-h-[28px] empty:before:content-['Click_to_add_description...'] empty:before:text-neutral-600"
                                            dangerouslySetInnerHTML={{ __html: form.description }}
                                        />
                                    </div>

                                    {/* Elements List */}
                                    <div className="space-y-6 min-h-[100px]">
                                        {form.elements.length === 0 && (
                                            <div className="text-center py-12 border-2 border-dashed border-neutral-800 rounded-2xl bg-neutral-900/50">
                                                <p className="text-neutral-500">Your form is empty. Add fields from the toolbar below.</p>
                                            </div>
                                        )}
                                        {form.elements.map((element, index) => (
                                            <div 
                                                key={element.id}
                                                draggable
                                                onDragStart={() => handleDragStart(index)}
                                                onDragEnter={() => handleDragEnter(index)}
                                                onDragEnd={handleDragEnd}
                                                onDragOver={(e) => e.preventDefault()}
                                                onClick={() => setActiveElementId(element.id)}
                                                className={`relative p-6 rounded-2xl border-2 transition-all duration-200 cursor-pointer group ${
                                                    activeElementId === element.id 
                                                    ? 'bg-neutral-800 border-purple-500 shadow-lg shadow-purple-500/10 scale-[1.01]' 
                                                    : 'bg-neutral-800/30 border-transparent hover:border-neutral-700 hover:bg-neutral-800/50'
                                                }`}
                                            >
                                                <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 flex gap-2 transition-opacity bg-neutral-900/80 p-1 rounded-lg backdrop-blur-sm border border-white/10 z-10">
                                                    <div className="cursor-grab p-1.5 text-neutral-400 hover:text-white rounded"><GripHorizontalIcon className="w-4 h-4" /></div>
                                                    <button onClick={(e) => { e.stopPropagation(); deleteElement(element.id); }} className="p-1.5 text-neutral-400 hover:text-red-400 rounded"><TrashIcon className="w-4 h-4" /></button>
                                                </div>

                                                {/* Element Content */}
                                                <div className="pr-8">
                                                    {activeElementId === element.id ? (
                                                        <input 
                                                            type="text" 
                                                            value={element.label} 
                                                            onChange={(e) => updateElement(element.id, { label: e.target.value })}
                                                            className="w-full bg-transparent text-white font-bold text-lg border-b border-purple-500/50 focus:border-purple-500 focus:outline-none mb-4 pb-1"
                                                            autoFocus
                                                            placeholder="Question Label"
                                                        />
                                                    ) : (
                                                        <label className="block text-lg font-medium text-white mb-3">
                                                            {element.label} {element.required && <span className="text-purple-500">*</span>}
                                                        </label>
                                                    )}

                                                    {/* Input Preview */}
                                                    {element.type === 'SHORT_TEXT' && (
                                                        <div className="h-12 bg-neutral-900/50 rounded-xl border border-neutral-700 w-full px-4 flex items-center text-neutral-600 text-sm">Short Answer Text</div>
                                                    )}
                                                    {element.type === 'LONG_TEXT' && (
                                                        <div className="h-24 bg-neutral-900/50 rounded-xl border border-neutral-700 w-full p-4 text-neutral-600 text-sm">Long Answer Text</div>
                                                    )}
                                                    {(element.type === 'SINGLE_CHOICE' || element.type === 'MULTIPLE_CHOICE') && (
                                                        <div className="space-y-3">
                                                            {element.options?.map((opt, optIdx) => (
                                                                <div key={opt.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-neutral-900/50 transition-colors">
                                                                    <div className={`w-5 h-5 flex-shrink-0 ${element.type === 'SINGLE_CHOICE' ? 'rounded-full' : 'rounded'} border-2 border-neutral-600`}></div>
                                                                    {activeElementId === element.id ? (
                                                                        <input 
                                                                            type="text" 
                                                                            value={opt.label} 
                                                                            onChange={(e) => {
                                                                                const newOpts = [...(element.options || [])];
                                                                                newOpts[optIdx].label = e.target.value;
                                                                                updateElement(element.id, { options: newOpts });
                                                                            }}
                                                                            className="flex-grow bg-transparent text-neutral-300 text-sm focus:outline-none border-b border-transparent focus:border-neutral-500"
                                                                        />
                                                                    ) : (
                                                                        <span className="text-neutral-300 text-sm">{opt.label}</span>
                                                                    )}
                                                                    {activeElementId === element.id && (
                                                                        <button 
                                                                            onClick={() => {
                                                                                const newOpts = element.options?.filter((_, i) => i !== optIdx);
                                                                                updateElement(element.id, { options: newOpts });
                                                                            }}
                                                                            className="text-neutral-600 hover:text-red-400 ml-2 opacity-0 group-hover:opacity-100 transition-opacity"
                                                                        >
                                                                            <TrashIcon className="w-3 h-3" />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            ))}
                                                            {activeElementId === element.id && (
                                                                <button 
                                                                    onClick={() => updateElement(element.id, { options: [...(element.options || []), { id: uuidv4(), label: `Option ${(element.options?.length || 0) + 1}` }] })}
                                                                    className="text-xs text-purple-400 hover:text-purple-300 font-bold mt-2 flex items-center gap-1 px-2 py-1 rounded hover:bg-purple-500/10 transition-colors w-fit"
                                                                >
                                                                    <PlusIcon className="w-3 h-3" /> Add Option
                                                                </button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {activeElementId === element.id && (
                                                    <div className="mt-6 pt-4 border-t border-white/5 flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={element.required} 
                                                                    onChange={(e) => updateElement(element.id, { required: e.target.checked })}
                                                                    className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 checked:border-purple-600"
                                                                    id={`req-${element.id}`}
                                                                    style={{ right: element.required ? '0' : 'auto', left: element.required ? 'auto' : '0' }}
                                                                />
                                                                <label 
                                                                    htmlFor={`req-${element.id}`} 
                                                                    className={`toggle-label block overflow-hidden h-5 rounded-full cursor-pointer ${element.required ? 'bg-purple-600' : 'bg-neutral-700'}`}
                                                                ></label>
                                                            </div>
                                                            <span className="text-xs font-medium text-neutral-400 uppercase tracking-wider">Required Field</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>

                                    {/* Visual Submit Button */}
                                    <div className="mt-12 pt-8 border-t border-white/10">
                                        <button disabled className="w-full h-16 bg-purple-600 opacity-50 text-white text-lg font-bold rounded-2xl flex items-center justify-center gap-3 cursor-not-allowed">
                                            Submit Application <ArrowRightIcon className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Bottom Toolbar (Icons Only) */}
                <div className="h-20 bg-neutral-950 border-t border-neutral-800 flex items-center justify-center gap-6 px-6 z-20 shrink-0 shadow-[0_-10px_20px_rgba(0,0,0,0.5)]">
                    <ToolButton label="Short Answer" icon={TypeIcon} onClick={() => addElement('SHORT_TEXT')} />
                    <ToolButton label="Paragraph" icon={FileText} onClick={() => addElement('LONG_TEXT')} />
                    <ToolButton label="Multiple Choice" icon={ListIcon} onClick={() => addElement('SINGLE_CHOICE')} />
                    <ToolButton label="Checkboxes" icon={CheckCircleIcon} onClick={() => addElement('MULTIPLE_CHOICE')} />
                </div>
            </div>
        </div>
    );
};

const ToolButton: React.FC<{ label: string, icon: React.FC<any>, onClick: () => void }> = ({ label, icon: Icon, onClick }) => (
    <button 
        onClick={onClick}
        className="relative group p-4 rounded-2xl bg-neutral-900 hover:bg-neutral-800 border border-neutral-800 hover:border-neutral-700 text-neutral-400 hover:text-purple-400 transition-all duration-200 active:scale-95"
        title={label}
    >
        <Icon className="w-6 h-6" />
        {/* Tooltip */}
        <span className="absolute bottom-full mb-3 left-1/2 -translate-x-1/2 px-2 py-1 bg-neutral-800 text-white text-xs font-medium rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap shadow-lg border border-neutral-700">
            {label}
            <span className="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-neutral-800"></span>
        </span>
    </button>
);

export default FormBuilder;

--- END OF FILE ./components/FormBuilder.tsx ---




--- START OF FILE ./components/Modal.tsx ---


import React, { ReactNode, useEffect } from 'react';
import { XIcon } from './Icons';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: ReactNode;
  showCloseButton?: boolean;
  preventCloseOnOutsideClick?: boolean;
}

const Modal: React.FC<ModalProps> = ({ 
    isOpen, 
    onClose, 
    children, 
    showCloseButton = true, 
    preventCloseOnOutsideClick = false 
}) => {
  useEffect(() => {
    const handleEsc = (event: KeyboardEvent) => {
      if (event.key === 'Escape') {
        if (!preventCloseOnOutsideClick) {
            onClose();
        }
      }
    };
    window.addEventListener('keydown', handleEsc);

    return () => {
      window.removeEventListener('keydown', handleEsc);
    };
  }, [onClose, preventCloseOnOutsideClick]);

  if (!isOpen) return null;

  const handleBackdropClick = () => {
      if (!preventCloseOnOutsideClick) {
          onClose();
      }
  };

  return (
    <div
      className="fixed inset-0 z-[100] flex items-center justify-center p-4 md:p-6 animate-modal-fade-in"
      style={{ animation: 'modal-fade-in 0.3s cubic-bezier(0.16, 1, 0.3, 1)' }}
    >
      <div
        className="fixed inset-0 bg-black/80 backdrop-blur-sm"
        onClick={handleBackdropClick}
      ></div>
      <div className="relative z-10 w-full max-w-full flex justify-center my-4 md:my-8 pointer-events-none">
        <div className="pointer-events-auto w-full max-w-fit relative">
            {showCloseButton && (
            <button
                onClick={onClose}
                className="absolute top-4 right-4 text-neutral-400 hover:text-white transition-colors z-50 p-2 rounded-full hover:bg-neutral-800 bg-black/20 backdrop-blur-md"
                aria-label="Close"
            >
                <XIcon className="w-5 h-5" />
            </button>
            )}
            {children}
        </div>
      </div>
    </div>
  );
};

// Add keyframes to a style tag in the head for animation
const style = document.createElement('style');
style.innerHTML = `
  @keyframes modal-fade-in {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
  }
`;
document.head.appendChild(style);


export default Modal;

--- END OF FILE ./components/Modal.tsx ---




--- START OF FILE ./components/AddHostModal.tsx ---

import React, { useState } from 'react';
import Modal from './Modal';
import { useAuth } from '../contexts/AuthContext';
import * as api from '../services/api';
import { Host } from '../types';

interface AddHostModalProps {
  isOpen: boolean;
  onClose: () => void;
  onHostCreated: (newHost: Host) => void;
}

const AddHostModal: React.FC<AddHostModalProps> = ({ isOpen, onClose, onHostCreated }) => {
  const { user } = useAuth();
  const [hostName, setHostName] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !hostName.trim()) return;

    setIsLoading(true);
    try {
      const newHost = await api.createHost(user.id, hostName);
      onHostCreated(newHost);
      setHostName('');
    } catch (error) {
      console.error("Failed to create host", error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl shadow-purple-500/10">
        <form onSubmit={handleSubmit}>
          <div className="p-8">
            <h2 className="text-2xl font-bold text-center text-white mb-2">Create New Host</h2>
            <p className="text-neutral-400 text-center mb-8">Create a new profile to host events under.</p>
            <div>
              <label htmlFor="host-name" className="block text-sm font-medium text-neutral-300 mb-2">Host Name</label>
              <input
                type="text"
                id="host-name"
                value={hostName}
                onChange={e => setHostName(e.target.value)}
                placeholder="e.g., Underground Collective"
                className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                required
              />
            </div>
          </div>
          <div className="p-4 bg-neutral-900/50 border-t border-neutral-800">
             <button
                type="submit"
                disabled={isLoading || !hostName.trim()}
                className="w-full h-12 px-6 bg-purple-600 text-white text-base font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 disabled:bg-neutral-700 disabled:text-neutral-500 disabled:shadow-none flex items-center justify-center"
            >
              {isLoading ? 'Creating...' : 'Create Host'}
            </button>
          </div>
        </form>
      </div>
    </Modal>
  );
};

export default AddHostModal;

--- END OF FILE ./components/AddHostModal.tsx ---




--- START OF FILE ./components/AddSectionBar.tsx ---


import React from 'react';
import { FileText, ImageIcon, MusicIcon, YoutubeIcon } from './Icons';
import { ProfileSection } from '../types';

interface AddSectionBarProps {
  onAddSection: (type: ProfileSection['type']) => void;
}

const AddSectionBar: React.FC<AddSectionBarProps> = ({ onAddSection }) => {
  const buttonClasses = "flex flex-col items-center justify-center h-20 w-20 rounded-xl bg-neutral-800/80 backdrop-blur-sm text-neutral-300 hover:bg-purple-600 hover:text-white transition-all duration-200";

  return (
    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
      <div className="flex items-center space-x-4 p-2 bg-neutral-900/50 border border-neutral-700 rounded-2xl shadow-2xl shadow-black/50">
        <button onClick={() => onAddSection('TEXT')} className={buttonClasses} title="Add Text Section">
          <FileText className="w-6 h-6 mb-1" />
          <span className="text-xs font-semibold">Text</span>
        </button>
        <button onClick={() => onAddSection('GALLERY')} className={buttonClasses} title="Add Image Gallery">
          <ImageIcon className="w-6 h-6 mb-1" />
          <span className="text-xs font-semibold">Gallery</span>
        </button>
        <button onClick={() => onAddSection('SOUNDCLOUD')} className={buttonClasses} title="Add SoundCloud Embed">
          <MusicIcon className="w-6 h-6 mb-1" />
          <span className="text-xs font-semibold">SoundCloud</span>
        </button>
        <button onClick={() => onAddSection('YOUTUBE')} className={buttonClasses} title="Add YouTube Video">
          <YoutubeIcon className="w-6 h-6 mb-1" />
          <span className="text-xs font-semibold">YouTube</span>
        </button>
      </div>
    </div>
  );
};

export default AddSectionBar;

--- END OF FILE ./components/AddSectionBar.tsx ---




--- START OF FILE ./components/EventSchedule.tsx ---

import React, { useState, useMemo } from 'react';
import { Event as EventType, ScheduleItem, VenueArea } from '../types';
import { CalendarIcon } from './Icons';

// A helper to format time nicely (e.g., 9:00 PM)
const formatTime = (isoString: string) => {
    if (!isoString) return '';
    return new Date(isoString).toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
    });
};

const EventSchedule: React.FC<{ event: EventType }> = ({ event }) => {
    // Return null if there's no schedule data to display
    if (!event.schedule || event.schedule.length === 0) {
        return null;
    }

    // Determine the sections based on event data.
    const sections = useMemo<VenueArea[]>(() => {
        if (event.venueAreas && event.venueAreas.length > 0) {
            // Filter out sections that have no scheduled items
            const scheduledAreaIds = new Set(event.schedule?.map(item => item.areaId));
            return event.venueAreas.filter(area => scheduledAreaIds.has(area.id));
        }
        // If there are schedule items but no defined areas, create a default "Schedule" section.
        if (event.schedule && event.schedule.length > 0) {
            return [{ id: 'default-area', name: 'Schedule' }];
        }
        return [];
    }, [event.venueAreas, event.schedule]);

    // Group schedule items by their area ID for easy access.
    const scheduleBySection = useMemo(() => {
        const grouped: { [key: string]: ScheduleItem[] } = {};
        const hasDefinedAreas = event.venueAreas && event.venueAreas.length > 0;

        for (const item of event.schedule!) {
            const areaId = hasDefinedAreas && item.areaId ? item.areaId : 'default-area';
            if (!grouped[areaId]) {
                grouped[areaId] = [];
            }
            grouped[areaId].push(item);
        }

        // Sort items within each group by start time
        for (const areaId in grouped) {
            grouped[areaId].sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime());
        }

        return grouped;
    }, [event.schedule, event.venueAreas]);


    // If after all logic, there are no sections to display, render nothing.
    if (sections.length === 0) {
        return null;
    }
    
    // Set the initial active tab to the first section.
    const [activeSectionId, setActiveSectionId] = useState<string>(sections[0].id);

    const activeScheduleItems = scheduleBySection[activeSectionId] || [];

    return (
        <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-8 backdrop-blur-md mt-8">
            <h2 className="text-2xl font-bold text-white mb-6 flex items-center">
                <CalendarIcon className="w-6 h-6 mr-3 text-purple-400" />
                Schedule
            </h2>

            {/* Render tabs only if there's more than one section */}
            {sections.length > 1 && (
                <div className="border-b border-neutral-800 mb-8">
                    <nav className="flex -mb-px space-x-6 overflow-x-auto">
                        {sections.map(section => (
                            <button
                                key={section.id}
                                onClick={() => setActiveSectionId(section.id)}
                                className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-all ${
                                    activeSectionId === section.id
                                        ? 'border-purple-500 text-white'
                                        : 'border-transparent text-neutral-400 hover:text-white'
                                }`}
                            >
                                {section.name}
                            </button>
                        ))}
                    </nav>
                </div>
            )}
            
            <div className="relative pt-4">
                {/* The timeline bar - positioned to start and end at the center of the first and last dots respectively. */}
                <div className="absolute left-3 top-7 bottom-7 w-px bg-neutral-700"></div>

                <div className="space-y-8 pl-10">
                    {activeScheduleItems.map(item => (
                        <div key={item.id} className="relative">
                            {/* The timeline dot */}
                            <div className="absolute -left-9 top-1.5 w-4 h-4 bg-purple-500 rounded-full shadow-[0_0_0_4px_rgba(168,85,247,0.2)]">
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <div className="w-2 h-2 bg-purple-300 rounded-full"></div>
                                </div>
                            </div>
                            
                            {/* Content */}
                            <p className="text-sm text-purple-300">
                                {formatTime(item.startTime)} &ndash; {formatTime(item.endTime)}
                            </p>
                            <h3 className="font-bold text-lg text-white mt-1">{item.title}</h3>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

export default EventSchedule;

--- END OF FILE ./components/EventSchedule.tsx ---




--- START OF FILE ./components/QRScanner.tsx ---


import React, { useEffect, useRef, useState } from 'react';
import jsQR from 'jsqr';

interface QRScannerProps {
    onScan: (data: string) => void;
}

const QRScanner: React.FC<QRScannerProps> = ({ onScan }) => {
    const videoRef = useRef<HTMLVideoElement>(null);
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const [error, setError] = useState<string | null>(null);
    
    // Use a ref for the callback to prevent effect re-runs when the handler changes
    const onScanRef = useRef(onScan);
    useEffect(() => {
        onScanRef.current = onScan;
    }, [onScan]);

    useEffect(() => {
        let animationFrameId: number;
        let stream: MediaStream | null = null;
        let mounted = true;

        const startCamera = async () => {
            try {
                const mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } // Prefer back camera
                });
                
                if (!mounted) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    return;
                }

                stream = mediaStream;
                
                if (videoRef.current) {
                    videoRef.current.srcObject = stream;
                    videoRef.current.setAttribute("playsinline", "true"); 
                    
                    // Handle play promise to prevent "interrupted by new load request" errors
                    const playPromise = videoRef.current.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            if (error.name !== 'AbortError' && error.name !== 'NotAllowedError') {
                                console.error("Error playing video:", error);
                            }
                        });
                    }
                    
                    requestAnimationFrame(tick);
                }
            } catch (err) {
                if (mounted) {
                    console.error("Error accessing camera:", err);
                    setError("Could not access camera. Please check permissions.");
                }
            }
        };

        const tick = () => {
            if (!mounted || !videoRef.current || !canvasRef.current) return;
            
            const video = videoRef.current;
            const canvas = canvasRef.current;
            const context = canvas.getContext('2d', { willReadFrequently: true });

            if (video.readyState === video.HAVE_ENOUGH_DATA && context) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                try {
                    // jsQR can throw on certain inputs (like empty images or bad RS blocks), so we must catch
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
    
                    if (code && code.data) {
                        onScanRef.current(code.data);
                    }
                } catch (e) {
                    // Catch RS block errors or other decoding issues without crashing the loop
                    // console.debug("QR Decode error", e); 
                }
            }
            
            animationFrameId = requestAnimationFrame(tick);
        };

        startCamera();

        return () => {
            mounted = false;
            cancelAnimationFrame(animationFrameId);
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (videoRef.current) {
                videoRef.current.srcObject = null;
            }
        };
    }, []); // Empty dependency array ensures camera setup runs only once

    if (error) {
        return (
            <div className="h-64 w-full bg-neutral-900 rounded-2xl flex items-center justify-center text-red-400 p-4 text-center border border-neutral-800">
                <p>{error}</p>
            </div>
        );
    }

    return (
        <div className="relative w-full overflow-hidden rounded-2xl shadow-2xl bg-black aspect-[4/3] md:aspect-video">
            <video 
                ref={videoRef} 
                className="absolute inset-0 w-full h-full object-cover" 
                muted
                playsInline
            />
            <canvas ref={canvasRef} className="hidden" />
            
            {/* Overlay UI */}
            <div className="absolute inset-0 border-[40px] border-black/50 z-10 pointer-events-none">
                <div className="relative w-full h-full border-2 border-purple-500/50 rounded-lg overflow-hidden">
                    {/* Scanning Line Animation */}
                    <div className="absolute top-0 left-0 w-full h-1 bg-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.8)] animate-scan"></div>
                </div>
            </div>
            <div className="absolute bottom-4 left-0 right-0 text-center z-20">
                <span className="inline-block px-3 py-1 bg-black/60 backdrop-blur-md text-white text-xs rounded-full">
                    Searching for QR Code...
                </span>
            </div>
            
            {/* Styles for animation */}
            <style>{`
                @keyframes scan {
                    0% { top: 0%; opacity: 0; }
                    10% { opacity: 1; }
                    90% { opacity: 1; }
                    100% { top: 100%; opacity: 0; }
                }
                .animate-scan {
                    animation: scan 2s linear infinite;
                }
            `}</style>
        </div>
    );
};

export default QRScanner;

--- END OF FILE ./components/QRScanner.tsx ---




--- START OF FILE ./components/HostLink.tsx ---

import React from 'react';
import { Link, useLocation } from 'react-router-dom';

interface HostLinkProps {
  hostId: string;
  hostName: string;
  className?: string;
}

const HostLink: React.FC<HostLinkProps> = ({ hostId, hostName, className }) => {
  const location = useLocation();
  return (
    <Link 
      to={`/host/${hostId}`} 
      state={{ from: location }}
      className={`hover:underline transition-colors ${className}`}
      onClick={(e) => e.stopPropagation()} // Prevent parent card clicks
    >
      {hostName}
    </Link>
  );
};

export default HostLink;
--- END OF FILE ./components/HostLink.tsx ---




--- START OF FILE ./components/EventCard.tsx ---


import React from 'react';
import { Link } from 'react-router-dom';
import { Event } from '../types';
import { MapPinIcon, ArrowRightIcon } from './Icons';
import { createEventSlug } from '../utils/url';

export const EventCard: React.FC<{ event: Event }> = ({ event }) => {
  return (
    <Link 
      to={`/event/${createEventSlug(event.title, event.id)}`} 
      className="event-card group bg-black/20 backdrop-blur-3xl rounded-2xl overflow-hidden flex flex-row shadow-2xl cursor-pointer transition-all duration-500 ease-[cubic-bezier(0.16,1,0.3,1)] border border-white/10 hover:border-purple-500/50 hover:shadow-purple-500/20 hover:-translate-y-1 hover:bg-black/40"
    >
      <div className="relative w-32 md:w-40 flex-shrink-0 overflow-hidden">
        <img 
          src={event.imageUrls[0]} 
          alt={event.title} 
          className="w-full h-36 object-cover transition-transform duration-700 ease-in-out group-hover:scale-110" 
        />
        <div className="absolute inset-0 bg-gradient-to-r from-black/40 to-transparent"></div>
      </div>
      <div className="p-5 md:p-6 flex-grow flex flex-col justify-center overflow-hidden relative">
        {/* Subtle internal glow for depth */}
        <div className="absolute -top-10 -right-10 w-24 h-24 bg-purple-500/10 blur-3xl rounded-full pointer-events-none group-hover:bg-purple-500/20 transition-colors"></div>

        <span className="text-sm font-bold text-purple-400 mb-1 block tracking-wide relative z-10">
          {new Date(event.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
        </span>
        <h3 className="text-lg md:text-xl font-bold text-white mb-2 truncate relative z-10 group-hover:text-purple-100 transition-colors">
          {event.title}
        </h3>
        <p className="text-neutral-300 text-sm flex items-center gap-2 truncate relative z-10 group-hover:text-white transition-colors">
          <MapPinIcon className="w-4 h-4 text-neutral-400 flex-shrink-0" />
          <span className="truncate">{event.location}</span>
        </p>
      </div>
      <div className="flex-shrink-0 flex items-center justify-center w-16 md:w-20 bg-white/5 border-l border-white/5 group-hover:bg-purple-600/80 text-neutral-400 group-hover:text-white transition-all duration-300 backdrop-blur-md">
        <ArrowRightIcon className="w-6 h-6 transform group-hover:translate-x-1 transition-transform" />
      </div>
    </Link>
  );
};

--- END OF FILE ./components/EventCard.tsx ---




--- START OF FILE ./components/HeroSlider.tsx ---


import React, { useState, useEffect, useCallback } from 'react';
import { Link } from 'react-router-dom';
import { Event } from '../types';
import HostLink from './HostLink';
import { createEventSlug } from '../utils/url';

interface HeroSliderProps {
  events: Event[];
}

const MAIN_SLIDER_DURATION = 8000;
const INNER_SLIDER_DURATION = 4000;

const InnerImageSlider: React.FC<{ images: string[], title: string, activeImageIndex: number, isActive: boolean }> = ({ images, title, activeImageIndex, isActive }) => {
    return (
        <div className="absolute inset-0 w-full h-full">
            {images.map((url, imgIndex) => {
                const animClass = `anim-${(imgIndex % 3) + 1}`;
                return (
                    <img 
                        key={imgIndex} 
                        src={url} 
                        alt={`${title} image ${imgIndex + 1}`} 
                        className={`absolute inset-0 w-full h-full object-cover transition-opacity duration-[2500ms] ease-in-out ${animClass}`}
                        style={{ opacity: isActive && activeImageIndex === imgIndex ? 1 : 0 }}
                    />
                );
            })}
        </div>
    );
};

const HeroSlider: React.FC<HeroSliderProps> = ({ events }) => {
  const [mainIndex, setMainIndex] = useState(0);
  const [subIndex, setSubIndex] = useState(0);
  
  const switchMainSlide = useCallback((index: number) => {
    setMainIndex(index);
    setSubIndex(0); // Reset inner slide on main slide change
  }, []);

  // Main Slider Timer
  useEffect(() => {
    if (events.length > 1) {
      const timer = setTimeout(() => {
        switchMainSlide((mainIndex + 1) % events.length);
      }, MAIN_SLIDER_DURATION);
      return () => clearTimeout(timer);
    }
  }, [mainIndex, events.length, switchMainSlide]);

  // Inner Slider Timer (Background & Image Rotation)
  useEffect(() => {
      const currentEvent = events[mainIndex];
      if (currentEvent && currentEvent.imageUrls.length > 1) {
          const timer = setTimeout(() => {
              setSubIndex(prev => (prev + 1) % currentEvent.imageUrls.length);
          }, INNER_SLIDER_DURATION);
          return () => clearTimeout(timer);
      }
  }, [subIndex, mainIndex, events]);

  if (!events || events.length === 0) {
    return <div className="relative w-full h-[90vh] bg-neutral-900 flex items-center justify-center"><p>Loading events...</p></div>;
  }

  const activeEvent = events[mainIndex];

  return (
    <>
      {/* Global Background for Home Page - Fixed, No Scroll Movement */}
      <div 
        className="fixed inset-0 w-full h-screen overflow-hidden z-0 pointer-events-none"
      >
        {events.map((event, index) => {
            // Determine which image to show in background. 
            // If this is the active event, use subIndex. Otherwise default to 0 (or previous state if we tracked it, but 0 is safe).
            const bgImageIndex = index === mainIndex ? subIndex % event.imageUrls.length : 0;
            const bgImageUrl = event.imageUrls[bgImageIndex];

            return (
                <div
                    key={`bg-${event.id}`}
                    className="absolute inset-0 bg-cover bg-center transition-opacity duration-[1500ms] ease-in-out"
                    style={{ 
                        backgroundImage: `url("${bgImageUrl}")`,
                        opacity: mainIndex === index ? 1 : 0,
                        filter: 'blur(60px) brightness(0.3) saturate(1.2)',
                        transform: 'scale(1.2)' // Slight scale to ensure coverage
                    }}
                />
            );
        })}
        <div className="absolute inset-0 bg-black/20"></div>
      </div>

      <section className="relative w-full h-[90vh] overflow-hidden z-10">
        {/* Slides */}
        <div className="relative w-full h-full">
          {events.map((event, index) => (
            <div
              key={event.id}
              className="hero-slide absolute inset-0 transition-opacity duration-[1500ms] ease-[cubic-bezier(0.16,1,0.3,1)]"
              style={{ 
                  opacity: mainIndex === index ? 1 : 0,
                  transform: mainIndex === index ? 'scale(1)' : 'scale(1.05)',
                  transitionProperty: 'opacity, transform',
                  willChange: 'opacity, transform',
                  zIndex: mainIndex === index ? 10 : 1,
              }}
            >
              <InnerImageSlider 
                images={event.imageUrls} 
                title={event.title} 
                activeImageIndex={index === mainIndex ? subIndex : 0}
                isActive={mainIndex === index} 
              />
              <div className="absolute inset-0 bg-gradient-to-r from-black/80 via-black/40 to-transparent"></div>
            </div>
          ))}
          <div className="relative z-10 container mx-auto max-w-7xl px-6 h-full flex flex-col justify-center">
              <div className="w-full md:w-1/2 lg:w-2/5">
              <h1 className="text-5xl lg:text-7xl font-black text-white tracking-tighter mb-4 text-glow">{activeEvent.title}</h1>
              <HostLink 
                  hostId={activeEvent.hostId} 
                  hostName={activeEvent.hostName} 
                  className="text-2xl lg:text-3xl font-semibold text-purple-400 mb-6 block hover:text-purple-300"
              />
              <p className="text-lg text-neutral-300 mb-10">{new Date(activeEvent.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} â€¢ {activeEvent.location}</p>
              <Link to={`/event/${createEventSlug(activeEvent.title, activeEvent.id)}`} className="inline-block px-8 py-5 bg-white/10 backdrop-blur-sm border border-white/20 rounded-full text-lg font-bold text-white text-center hover:bg-white/20 transition-all duration-300">
                  Get Tickets
              </Link>
              </div>
          </div>
        </div>

        {/* Pagination Dots */}
        <div className="absolute bottom-8 left-1/2 -translate-x-1/2 z-20 flex space-x-2">
          {events.map((_, index) => (
            <button
              key={index}
              onClick={() => switchMainSlide(index)}
              className={`h-[10px] rounded-full transition-all duration-300 ease-[cubic-bezier(0.16,1,0.3,1)] ${mainIndex === index ? 'w-12 bg-white' : 'w-[10px] bg-white/30 hover:bg-white/70'}`}
            />
          ))}
        </div>
      </section>
    </>
  );
};

// Add styles for Ken Burns animations
const animStyle = document.createElement('style');
animStyle.innerHTML = `
  .anim-1 { animation: kenburns-tl 12s ease-in-out forwards; }
  .anim-2 { animation: kenburns-br 12s ease-in-out forwards; }
  .anim-3 { animation: kenburns-center 12s ease-in-out forwards; }
`;
document.head.appendChild(animStyle);


export default HeroSlider;

--- END OF FILE ./components/HeroSlider.tsx ---




--- START OF FILE ./components/ImageGalleryEditor.tsx ---


import React, { useState, useRef } from 'react';
import { v4 as uuidv4 } from 'uuid';
import { PlusIcon, TrashIcon, GripVerticalIcon } from './Icons';
import * as api from '../services/api';

interface ImageItem {
  id: string;
  url: string; // Remote URL
}

interface UploadingFile {
  id: string;
  name: string;
  progress: number;
}

interface ImageGalleryEditorProps {
  images: string[];
  onImagesChange: (newImages: string[]) => void;
}

const ImageGalleryEditor: React.FC<ImageGalleryEditorProps> = ({ images, onImagesChange }) => {
  const [galleryImages, setGalleryImages] = useState<ImageItem[]>(() =>
    images.map(url => ({ id: uuidv4(), url }))
  );
  const [uploadingFiles, setUploadingFiles] = useState<UploadingFile[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const dragItem = useRef<number | null>(null);
  const dragOverItem = useRef<number | null>(null);

  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const files: File[] = Array.from(event.target.files || []);
    if (!files.length) return;

    // Create placeholders for progress
    const newUploads: UploadingFile[] = files.map(file => ({
        id: uuidv4(),
        name: file.name,
        progress: 10,
    }));
    setUploadingFiles(prev => [...prev, ...newUploads]);

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const uploadId = newUploads[i].id;
        
        try {
            // Upload to server
            const uploadedUrl = await api.uploadFile(file);
            
            const newImage = { id: uuidv4(), url: uploadedUrl };

            // Update internal state
            setGalleryImages(prev => {
                const updated = [...prev, newImage];
                // Update parent state with all URLs
                onImagesChange(updated.map(img => img.url));
                return updated;
            });

        } catch (error) {
            console.error("Error uploading file:", error);
            alert(`Failed to upload ${file.name}`);
        } finally {
            // Remove from uploading list
            setUploadingFiles(prev => prev.filter(f => f.id !== uploadId));
        }
    }
     // Reset file input
    if(fileInputRef.current) {
        fileInputRef.current.value = "";
    }
  };

  const handleDelete = (idToDelete: string) => {
    const newGalleryImages = galleryImages.filter(img => img.id !== idToDelete);
    setGalleryImages(newGalleryImages);
    onImagesChange(newGalleryImages.map(img => img.url));
  };

  const handleDragSort = () => {
    if (dragItem.current === null || dragOverItem.current === null) return;

    const newGalleryImages = [...galleryImages];
    const draggedItemContent = newGalleryImages.splice(dragItem.current, 1)[0];
    newGalleryImages.splice(dragOverItem.current, 0, draggedItemContent);
    
    dragItem.current = null;
    dragOverItem.current = null;

    setGalleryImages(newGalleryImages);
    onImagesChange(newGalleryImages.map(img => img.url));
  };

  return (
    <div className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        {galleryImages.map((image, index) => (
          <div
            key={image.id}
            className="relative group aspect-video bg-neutral-800 rounded-lg overflow-hidden"
            draggable
            onDragStart={() => dragItem.current = index}
            onDragEnter={() => dragOverItem.current = index}
            onDragEnd={handleDragSort}
            onDragOver={(e) => e.preventDefault()}
          >
            <img src={image.url} alt={`Event image ${index + 1}`} className="w-full h-full object-cover"/>
            <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center space-x-2">
               <button
                onClick={() => handleDelete(image.id)}
                className="w-8 h-8 rounded-full bg-red-600/80 hover:bg-red-600 text-white flex items-center justify-center"
                title="Delete Image"
              >
                <TrashIcon className="w-4 h-4" />
              </button>
               <div className="p-2 text-white cursor-grab" title="Drag to reorder">
                 <GripVerticalIcon className="w-5 h-5"/>
               </div>
            </div>
          </div>
        ))}
         <button
            onClick={() => fileInputRef.current?.click()}
            className="aspect-video w-full bg-neutral-800/50 rounded-lg border-2 border-dashed border-neutral-700 hover:border-purple-500 transition-colors flex flex-col items-center justify-center text-neutral-400 hover:text-white"
            >
            <PlusIcon className="w-8 h-8 mb-2" />
            <span className="text-sm font-semibold">Add Image</span>
        </button>
        <input
            type="file"
            multiple
            accept="image/*"
            ref={fileInputRef}
            onChange={handleFileSelect}
            className="hidden"
        />
      </div>
      
      {uploadingFiles.length > 0 && (
          <div className="space-y-3 mt-4">
              {uploadingFiles.map(file => (
                  <div key={file.id} className="text-white">
                      <p className="text-xs text-neutral-400 truncate mb-1">{file.name}</p>
                      <div className="w-full bg-neutral-700 rounded-full h-2 overflow-hidden">
                           <div 
                                className="bg-purple-600 h-full rounded-full animate-pulse" 
                                style={{ width: '100%' }}
                           ></div>
                      </div>
                  </div>
              ))}
          </div>
      )}
    </div>
  );
};

export default ImageGalleryEditor;

--- END OF FILE ./components/ImageGalleryEditor.tsx ---




--- START OF FILE ./required_server_changes.md ---

[ Skipped binary file ]

--- END OF FILE ./required_server_changes.md ---




--- START OF FILE ./package.json ---

{
  "name": "eventsta-4",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "@google/genai": "^1.27.0",
    "react-router-dom": "^7.9.4",
    "uuid": "^13.0.0",
    "jsqr": "^1.4.0",
    "@react-oauth/google": "^0.12.1",
    "jwt-decode": "^4.0.0",
    "qrcode": "1.5.3",
    "@stripe/stripe-js": "3.0.10",
    "@stripe/react-stripe-js": "2.7.0"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}

--- END OF FILE ./package.json ---




--- START OF FILE ./backend_instructions.md ---

# Backend API Changes: Support for Ordered Inventory

## Overview
The frontend now supports drag-and-drop reordering for tickets and add-ons within the Event Admin panel. To persist this custom order, the backend needs to store and serve the inventory items in their specified sequence.

## Required Changes

### 1. Database Schema Update
**Table:** `inventory` (or whichever table stores tickets and add-ons)
**Action:** Add a new column to store the display order.

```sql
-- Example for PostgreSQL
ALTER TABLE inventory ADD COLUMN display_order INTEGER DEFAULT 0;
```
*   **Column Name:** `display_order`, `position`, `sort_order`, etc.
*   **Type:** `INTEGER`
*   **Default:** `0` or `NULL`

### 2. Modify Event Update Endpoint (`PATCH /events/:id`)
When the backend receives an `inventory` array in the request body, it now represents the complete, ordered list of tickets and add-ons for that event. The backend must process this array to reflect the new order.

**Logic:**
1.  Begin a transaction.
2.  Iterate through the incoming `inventory` array. For each item at index `i`:
    *   **If the item has an `id`:**
        *   Execute an `UPDATE inventory SET ..., display_order = i WHERE id = item.id;`
    *   **If the item does NOT have an `id`:**
        *   Execute an `INSERT INTO inventory (..., display_order) VALUES (..., i);`
3.  **Handle Deletions:**
    *   Get a list of all `id`s from the incoming `inventory` array.
    *   `DELETE FROM inventory WHERE event_id = :eventId AND id NOT IN (:incoming_ids);`
4.  Commit the transaction.

This "sync" approach ensures that added, removed, and reordered items are all handled correctly.

### 3. Modify Event Fetch Endpoint (`GET /events/:id`)
When fetching inventory items for an event, they must be returned in the correct order.

**Logic:**
*   Modify the SQL query to include an `ORDER BY` clause.

```sql
-- Example
SELECT * FROM inventory WHERE event_id = $1 ORDER BY display_order ASC;
```

This ensures that both the public Event Details page and the Event Admin panel will display tickets and add-ons in the user-defined order.
--- END OF FILE ./backend_instructions.md ---




--- START OF FILE ./tsconfig.json ---

{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
--- END OF FILE ./tsconfig.json ---




--- START OF FILE ./vite.config.ts ---

import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});

--- END OF FILE ./vite.config.ts ---




--- START OF FILE ./backend_api_changes.md ---

# Backend API Changes Required

## Promotions & Promo Codes

### 1. Create Promo Code (NEW)
**Endpoint:** `POST /events/:eventId/promocodes`
**Auth:** Required (User must be host of the event)

**Payload (Updated):**
```json
{
  "code": "EARLYBIRD20",
  "discountPercent": 20,
  "maxUses": 100
}
```

**Business Logic Requirements:**
1.  **Accept `discountPercent`:** The endpoint must accept the new `discountPercent` field.
2.  **Validation:**
    *   `discountPercent` must be a number between 0 and 100.
    *   If the event `type` is 'fundraiser', the backend should either reject requests with `discountPercent > 0` or silently set it to 0. A `discountPercent` of 0 is valid and can be used for tracking-only codes.
3.  **Defaulting:** If `discountPercent` is **not** provided in the payload, the backend should use the `defaultPromoDiscount` value from the parent `Event` object.
4.  **Storage:** The `discountPercent` value must be saved on the individual `PromoCode` record in the database.

### 2. Update Promoter Code (Alias/Handle)
**Endpoint:** `PUT /promotions/:eventId/code`
**Auth:** Required (User must be the owner of the promotion)

**Payload:**
```json
{
  "new_code": "NEWALIAS2025"
}
```

**Business Logic Requirements:**
1.  **Normalization:** Convert `new_code` to Uppercase and trim whitespace.
2.  **Uniqueness Check:** Check if `new_code` is already in use for this `eventId`.
    *   If exists (and belongs to another user), return `409 Conflict`.
3.  **Alias Creation (Crucial):**
    *   The user is asking to "change" their code, but we must ensure **previous codes** assigned to this user for this event **continue to attribute sales** to them.
    *   **Do not** simply overwrite the code in a way that orphans usage of the old code (unless your tracking is based solely on `user_id` passed via URL param, ignoring the code itself).
    *   **Recommended Schema:** `PromoCodes` table where multiple codes can map to a single `Promotion/User` entity.
    *   Mark the `new_code` as the **Primary** code (used for generating new links in the UI).
    *   Keep the old code active in the background for tracking purposes.
4.  **Response:**
    *   Success: `200 OK` `{ "success": true, "code": "NEWALIAS2025", "link": "https://..." }`

### 3. Validation Endpoint
**Endpoint:** `POST /events/:eventId/promocodes/validate`

**Requirement:**
*   Ensure this endpoint accepts **ANY** valid alias belonging to the user (old or new).
*   If `OLDCODE` is sent, it should still return `{ valid: true, discountPercent: ..., ownerName: "User Name" }`.
*   This ensures links distributed prior to the code change do not break at checkout.

### 4. Reporting Endpoint Fix (`/events/:id/report`)
**Current Bug:** The endpoint is returning entries with `promoterName: "Unknown User"` and zero stats.
**Fix:** 
*   Ensure the SQL query joins correctly on the `Users` table.
*   Filter out `promotions` rows that have `NULL` user_id or where the user no longer exists.
*   Ensure `sales` and `earned` columns correctly aggregate data from *all* aliases belonging to that user for the event.

--- END OF FILE ./backend_api_changes.md ---




--- START OF FILE ./pages/Settings.tsx ---


import React, { useState, useEffect, useRef } from 'react';
import { useLocation, useNavigate, Link } from 'react-router-dom'; // Added useLocation
import { useAuth } from '../contexts/AuthContext';
import * as api from '../services/api';
import { Host, TeamMember, NotificationPreferences } from '../types';
import SettingsSidebar from '../components/SettingsSidebar';
import { PlusIcon, UploadCloudIcon, CheckCircleIcon, DollarSignIcon, LockIcon, BellIcon, ArrowRightIcon } from '../components/Icons';
import AddHostModal from '../components/AddHostModal';
import Modal from '../components/Modal';

const Settings: React.FC = () => {
    const { user, refreshUser } = useAuth();
    const location = useLocation(); // Hook to access state
    const [activeTab, setActiveTab] = useState('profile');

    // Handle deep linking to specific tabs
    useEffect(() => {
        if (location.state && (location.state as any).defaultTab) {
            setActiveTab((location.state as any).defaultTab);
        }
    }, [location.state]);

    const renderContent = () => {
        switch (activeTab) {
            case 'profile':
                return <ProfileSection />;
            case 'hosts':
                return <HostsSection />;
            case 'team':
                return <TeamSection />;
            case 'payouts':
                return <PayoutsSection />;
            default:
                return <PlaceholderSection title={activeTab.charAt(0).toUpperCase() + activeTab.slice(1)} />;
        }
    };

    if (!user) {
        return <div className="text-center py-20 text-neutral-400">Loading settings...</div>;
    }

    return (
        <div className="container mx-auto max-w-7xl px-6 py-16">
            <h1 className="text-4xl font-bold tracking-tight text-white mb-12">Settings</h1>
            <div className="flex flex-col md:flex-row gap-8 lg:gap-12">
                <SettingsSidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                <main className="flex-1">
                    {renderContent()}
                </main>
            </div>
        </div>
    );
};


const ProfileSection: React.FC = () => {
    const { user, refreshUser, logout } = useAuth();
    const navigate = useNavigate();
    const [name, setName] = useState(user?.name || '');
    const [notifications, setNotifications] = useState<NotificationPreferences>({
        marketingEmails: true,
        transactionalEmails: true,
        promoterAlerts: true,
        ...(user?.notificationPreferences || {})
    });
    
    const [isSaving, setIsSaving] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);
    
    // Modal States
    const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);
    const [isDeleteAccountModalOpen, setIsDeleteAccountModalOpen] = useState(false);

    useEffect(() => {
        setName(user?.name || '');
        if (user?.notificationPreferences) {
            setNotifications(prev => ({ ...prev, ...user.notificationPreferences }));
        }
    }, [user]);

    const handleSave = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!user || !name.trim()) return;
        
        setIsSaving(true);
        try {
            await api.updateUser(user.id, { name });
            await api.updateNotificationPreferences(user.id, notifications);
            await refreshUser();
            setSaveSuccess(true);
            setTimeout(() => setSaveSuccess(false), 2000);
        } catch(e) {
            alert("Failed to save settings.");
        } finally {
            setIsSaving(false);
        }
    };

    const toggleNotification = (key: keyof NotificationPreferences) => {
        setNotifications(prev => ({ ...prev, [key]: !prev[key] }));
    };

    const handleDeleteAccount = async () => {
        if (!user) return;
        try {
            await api.deleteAccount(user.id);
            logout();
            navigate('/');
        } catch (e) {
            alert("Failed to delete account.");
        }
    };

    return (
        <div className="space-y-12">
            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl">
                <div className="p-8">
                    <h2 className="text-xl font-bold text-white mb-2">Profile Information</h2>
                    <p className="text-neutral-400 text-sm mb-6">Update your personal details here.</p>
                    <form onSubmit={handleSave} className="space-y-6">
                        <div>
                            <label htmlFor="user-name" className="block text-sm font-medium text-neutral-300 mb-2">Full Name</label>
                            <input type="text" id="user-name" value={name} onChange={e => setName(e.target.value)} className="w-full max-w-sm h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500" />
                        </div>
                         <div>
                            <label htmlFor="user-email" className="block text-sm font-medium text-neutral-300 mb-2">Email</label>
                            <input type="email" id="user-email" value={user?.email} disabled className="w-full max-w-sm h-12 px-4 bg-neutral-800/50 border border-neutral-700/50 rounded-lg text-neutral-400 cursor-not-allowed" />
                        </div>
                    </form>
                </div>
            </div>

            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-8">
                <h2 className="text-xl font-bold text-white mb-2 flex items-center"><BellIcon className="w-5 h-5 mr-2 text-purple-400" />Notifications</h2>
                <p className="text-neutral-400 text-sm mb-6">Choose what emails you receive.</p>
                <div className="space-y-4 max-w-xl">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-white font-medium">Marketing Emails</p>
                            <p className="text-xs text-neutral-500">Tips, newsletters, and feature updates.</p>
                        </div>
                        <button 
                            onClick={() => toggleNotification('marketingEmails')}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${notifications.marketingEmails ? 'bg-purple-600' : 'bg-neutral-700'}`}
                        >
                            <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${notifications.marketingEmails ? 'translate-x-6' : 'translate-x-1'}`} />
                        </button>
                    </div>
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-white font-medium">Transactional Emails</p>
                            <p className="text-xs text-neutral-500">Order confirmations, ticket receipts, and account alerts.</p>
                        </div>
                        <button 
                            onClick={() => toggleNotification('transactionalEmails')}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${notifications.transactionalEmails ? 'bg-purple-600' : 'bg-neutral-700'}`}
                        >
                            <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${notifications.transactionalEmails ? 'translate-x-6' : 'translate-x-1'}`} />
                        </button>
                    </div>
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-white font-medium">Promoter Alerts</p>
                            <p className="text-xs text-neutral-500">Notifications about your sales and commissions.</p>
                        </div>
                        <button 
                            onClick={() => toggleNotification('promoterAlerts')}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${notifications.promoterAlerts ? 'bg-purple-600' : 'bg-neutral-700'}`}
                        >
                            <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${notifications.promoterAlerts ? 'translate-x-6' : 'translate-x-1'}`} />
                        </button>
                    </div>
                </div>
            </div>

             <div className="bg-neutral-900 border border-neutral-800 rounded-2xl">
                <div className="p-8">
                    <h2 className="text-xl font-bold text-white mb-2 flex items-center"><LockIcon className="w-5 h-5 mr-2 text-purple-400"/>Security Settings</h2>
                    <p className="text-neutral-400 text-sm mb-6">Manage your password and account security.</p>
                    <div className="divide-y divide-neutral-800">
                        <div className="py-4 flex justify-between items-center">
                            <div>
                                <h3 className="font-semibold text-white">Password</h3>
                                <p className="text-sm text-neutral-400">Set a permanent password for your account.</p>
                            </div>
                            <button onClick={() => setIsPasswordModalOpen(true)} className="px-4 py-2 text-sm font-semibold rounded-lg bg-neutral-800 hover:bg-neutral-700 text-white transition-colors">Change Password</button>
                        </div>
                    </div>
                </div>
                <div className="bg-neutral-900/50 border-t border-neutral-800 px-8 py-4 flex justify-end">
                     <button onClick={handleSave} disabled={isSaving || saveSuccess} className="px-5 py-2 text-sm font-semibold rounded-full transition-all duration-300 flex items-center justify-center min-w-[100px] bg-purple-600 text-white hover:bg-purple-500 shadow-lg shadow-purple-500/20 disabled:bg-neutral-700 disabled:text-neutral-500 disabled:shadow-none">
                        {isSaving ? 'Saving...' : saveSuccess ? 'Saved!' : 'Save All Changes'}
                    </button>
                </div>
            </div>

            <div className="bg-transparent border-2 border-red-500/30 rounded-2xl p-8">
                <h3 className="text-xl font-bold text-red-400 mb-2">Danger Zone</h3>
                <p className="text-neutral-400 mb-6">These actions are permanent and cannot be undone.</p>
                <button onClick={() => setIsDeleteAccountModalOpen(true)} className="px-5 py-2 text-sm font-semibold rounded-full bg-red-600/20 text-red-300 hover:bg-red-600/40 hover:text-white transition-colors">Delete My Account</button>
            </div>

            {/* Change Password Modal */}
            <ChangePasswordModal 
                isOpen={isPasswordModalOpen} 
                onClose={() => setIsPasswordModalOpen(false)} 
                userId={user?.id || ''}
            />

            {/* Delete Account Modal */}
            <Modal isOpen={isDeleteAccountModalOpen} onClose={() => setIsDeleteAccountModalOpen(false)}>
                <div className="w-full max-w-sm bg-neutral-900 border border-neutral-700 rounded-2xl p-8 text-center">
                    <h3 className="text-xl font-bold text-white mb-2">Delete Account?</h3>
                    <p className="text-neutral-400 mb-6">Are you sure you want to delete your account? All your data, tickets, and earnings history will be permanently removed.</p>
                    <div className="flex justify-center space-x-4">
                        <button onClick={() => setIsDeleteAccountModalOpen(false)} className="px-6 py-2 text-sm font-semibold text-neutral-300 bg-neutral-800 hover:bg-neutral-700 rounded-full transition-colors">Cancel</button>
                        <button onClick={handleDeleteAccount} className="px-6 py-2 text-sm font-semibold text-white bg-red-600 hover:bg-red-500 rounded-full transition-colors">Confirm Delete</button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

const ChangePasswordModal: React.FC<{ isOpen: boolean, onClose: () => void, userId: string }> = ({ isOpen, onClose, userId }) => {
    const [currentPassword, setCurrentPassword] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [error, setError] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        if (newPassword !== confirmPassword) {
            setError("New passwords do not match.");
            return;
        }
        if (newPassword.length < 6) {
            setError("Password must be at least 6 characters.");
            return;
        }
        
        setIsSubmitting(true);
        try {
            await api.changePassword(userId, currentPassword, newPassword);
            onClose();
            setCurrentPassword('');
            setNewPassword('');
            setConfirmPassword('');
            alert("Password changed successfully.");
        } catch (e) {
            setError((e as Error).message);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose}>
            <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl p-8 shadow-2xl">
                <h3 className="text-xl font-bold text-white mb-6">Change Password</h3>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-xs font-medium text-neutral-400 mb-1">Current Password</label>
                        <input 
                            type="password" 
                            value={currentPassword}
                            onChange={e => setCurrentPassword(e.target.value)}
                            className="w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-xs font-medium text-neutral-400 mb-1">New Password</label>
                        <input 
                            type="password" 
                            value={newPassword}
                            onChange={e => setNewPassword(e.target.value)}
                            className="w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-xs font-medium text-neutral-400 mb-1">Confirm New Password</label>
                        <input 
                            type="password" 
                            value={confirmPassword}
                            onChange={e => setConfirmPassword(e.target.value)}
                            className="w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:border-purple-500"
                            required
                        />
                    </div>
                    {error && <p className="text-red-400 text-sm">{error}</p>}
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onClose} className="px-4 py-2 text-neutral-300 hover:text-white text-sm font-medium">Cancel</button>
                        <button type="submit" disabled={isSubmitting} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold rounded-lg transition-colors disabled:opacity-50">
                            {isSubmitting ? 'Updating...' : 'Update Password'}
                        </button>
                    </div>
                </form>
            </div>
        </Modal>
    );
}

const HostsSection: React.FC = () => {
    const { user, refreshUser } = useAuth();
    const [hosts, setHosts] = useState<Host[]>([]);
    const [selectedHost, setSelectedHost] = useState<Host | null>(null);
    const [isAddHostModalOpen, setAddHostModalOpen] = useState(false);

    useEffect(() => {
        const fetchHosts = async () => {
            if (user?.managedHostIds) {
                const fetchedHosts = await api.getHostsByIds(user.managedHostIds);
                setHosts(fetchedHosts);
            }
        };
        fetchHosts();
    }, [user]);
    
    const handleHostCreated = (newHost: Host) => {
        refreshUser();
        setHosts(prev => [...prev, newHost]);
        setSelectedHost(newHost);
        setAddHostModalOpen(false);
    };

    const handleHostUpdated = (updatedHost: Host) => {
        setHosts(hosts.map(h => h.id === updatedHost.id ? updatedHost : h));
        setSelectedHost(updatedHost);
        refreshUser();
    };
    
    const handleHostDeleted = () => {
        setSelectedHost(null);
        refreshUser(); // This will trigger the useEffect to refetch hosts.
    };

    const getInitials = (name: string) => {
        if (!name) return '?';
        const words = name.trim().split(' ').filter(Boolean);
        if (words.length > 1) {
            return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        }
        if (words.length === 1 && words[0].length > 1) {
            return words[0].substring(0, 2).toUpperCase();
        }
        if (words.length === 1 && words[0].length === 1) {
            return words[0][0].toUpperCase();
        }
        return '?';
    };
    
    if (selectedHost) {
        return <HostEditor 
            host={selectedHost} 
            onBack={() => setSelectedHost(null)} 
            onUpdate={handleHostUpdated} 
            onDelete={handleHostDeleted}
        />;
    }

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h2 className="text-xl font-bold text-white">Your Hosts</h2>
                    <p className="text-neutral-400 text-sm">Manage your host profiles and settings.</p>
                </div>
                <button onClick={() => setAddHostModalOpen(true)} className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 flex items-center justify-center space-x-2">
                    <PlusIcon className="w-4 h-4" /><span>Create Host</span>
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {hosts.map(host => (
                    <div key={host.id} className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 flex flex-col justify-between">
                        <div className="flex items-center mb-4">
                            <div className="w-12 h-12 rounded-full mr-4 bg-neutral-800 flex-shrink-0 flex items-center justify-center">
                                {host.imageUrl ? (
                                    <img src={host.imageUrl} alt={host.name} className="w-full h-full rounded-full object-cover"/>
                                ) : (
                                    <span className="text-xl font-bold text-purple-400">{getInitials(host.name)}</span>
                                )}
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-white">{host.name}</h3>
                                <p className="text-sm text-neutral-500">{host.eventIds.length} events</p>
                            </div>
                        </div>
                         <button onClick={() => setSelectedHost(host)} className="w-full mt-4 py-2 text-sm font-semibold text-center bg-neutral-800 hover:bg-neutral-700 rounded-lg text-neutral-300 hover:text-white transition-colors">Manage</button>
                    </div>
                ))}
            </div>
            <AddHostModal 
                isOpen={isAddHostModalOpen} 
                onClose={() => setAddHostModalOpen(false)} 
                onHostCreated={handleHostCreated}
            />
        </div>
    );
};

const HostEditor: React.FC<{host: Host, onBack: () => void, onUpdate: (host: Host) => void, onDelete: () => void}> = ({ host, onBack, onUpdate, onDelete }) => {
    const { user, refreshUser } = useAuth();
    const [details, setDetails] = useState(host);
    const [isSaving, setIsSaving] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);
    const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
    
    // New state for upload management
    const [uploadingField, setUploadingField] = useState<'profile' | 'cover' | null>(null);

    const getInitials = (name: string) => {
        if (!name) return '?';
        const words = name.trim().split(' ').filter(Boolean);
        if (words.length > 1) {
            return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        }
        if (words.length === 1 && words[0].length > 1) {
            return words[0].substring(0, 2).toUpperCase();
        }
        if (words.length === 1 && words[0].length === 1) {
            return words[0][0].toUpperCase();
        }
        return '?';
    };
    
    const handleFileSelect = async (file: File | null, type: 'profile' | 'cover') => {
        if (!file) return;
        
        setUploadingField(type);
        try {
            // Upload to server to get a URL instead of reading Base64 locally
            const url = await api.uploadFile(file);
            const field = type === 'profile' ? 'imageUrl' : 'coverImageUrl';
            setDetails(prev => ({ ...prev, [field]: url }));
        } catch (error) {
            console.error("Failed to upload host image", error);
            alert("Failed to upload image. Please try again.");
        } finally {
            setUploadingField(null);
        }
    };

    const handleSave = async () => {
        if (uploadingField) return; // Prevent save while uploading
        
        setIsSaving(true);
        try {
            // Prepare payload with only editable fields to conform to backend requirements
            // and ensure no large objects or immutable fields are sent.
            const payload = {
                name: details.name,
                description: details.description,
                imageUrl: details.imageUrl,
                coverImageUrl: details.coverImageUrl,
                reviewsEnabled: details.reviewsEnabled
            };

            const updatedHost = await api.updateHostDetails(host.id, payload);
            onUpdate(updatedHost);
            setSaveSuccess(true);
            setTimeout(() => setSaveSuccess(false), 2000);
        } catch (e) {
            console.error(e);
            alert("Failed to save host details");
        } finally {
            setIsSaving(false);
        }
    };

    const handleDelete = async () => {
        if (details.isDefault || !user) return;
        try {
            await api.deleteHost(user.id, details.id);
            setIsDeleteModalOpen(false);
            onDelete();
        } catch (error) {
            console.error("Failed to delete host:", error);
            alert((error as Error).message);
            setIsDeleteModalOpen(false);
        }
    };

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <button onClick={onBack} className="text-sm text-neutral-400 hover:text-white transition-colors">&larr; Back to all hosts</button>
                <Link 
                    to={`/host/${host.id}`} 
                    className="flex items-center text-sm font-medium text-purple-400 hover:text-purple-300 transition-colors"
                >
                    View Public Page <ArrowRightIcon className="w-4 h-4 ml-1" />
                </Link>
            </div>
            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl">
                <div className="p-8">
                     <div className="relative mb-6">
                        {/* Cover Image Area */}
                        <div className="h-48 bg-neutral-800 rounded-lg overflow-hidden group relative">
                            {details.coverImageUrl ? (
                                <img src={details.coverImageUrl} className="w-full h-full object-cover" />
                            ) : (
                                <div className="w-full h-full bg-gradient-to-br from-purple-900 via-neutral-900 to-black flex items-center justify-center p-4">
                                    <h1 className="text-4xl font-black text-white/10 select-none text-center break-words">{details.name}</h1>
                                </div>
                            )}
                            
                            {uploadingField === 'cover' ? (
                                <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-10">
                                     <div className="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            ) : (
                                <label htmlFor="cover-upload" className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer z-10">
                                    <UploadCloudIcon className="w-8 h-8 text-white" />
                                </label>
                            )}
                            <input id="cover-upload" type="file" className="hidden" accept="image/*" disabled={!!uploadingField} onChange={e => handleFileSelect(e.target.files?.[0] || null, 'cover')} />
                        </div>

                        {/* Profile Image Area */}
                        <div className="absolute -bottom-10 left-6 w-24 h-24 rounded-full border-4 border-neutral-900 bg-neutral-800 overflow-hidden group relative flex items-center justify-center">
                            {details.imageUrl ? (
                                <img src={details.imageUrl} className="w-full h-full object-cover" />
                            ) : (
                                <span className="text-3xl font-bold text-purple-400 select-none">{getInitials(details.name)}</span>
                            )}
                            
                            {uploadingField === 'profile' ? (
                                <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-10">
                                     <div className="w-6 h-6 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            ) : (
                                <label htmlFor="profile-upload" className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer z-10">
                                    <UploadCloudIcon className="w-6 h-6 text-white" />
                                </label>
                            )}
                            <input id="profile-upload" type="file" className="hidden" accept="image/*" disabled={!!uploadingField} onChange={e => handleFileSelect(e.target.files?.[0] || null, 'profile')} />
                        </div>
                    </div>
                    <div className="pt-10 space-y-6">
                       <div>
                           <label htmlFor="host-name" className="block text-sm font-medium text-neutral-300 mb-2">Host Name</label>
                           <input type="text" id="host-name" value={details.name} onChange={e => setDetails({...details, name: e.target.value})} className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500" />
                       </div>
                       <div>
                           <label htmlFor="host-description" className="block text-sm font-medium text-neutral-300 mb-2">Description</label>
                           <textarea id="host-description" value={details.description} onChange={e => setDetails({...details, description: e.target.value})} rows={4} className="w-full p-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none" />
                       </div>
                       <div>
                           <h3 className="text-lg font-bold text-white mb-4">Settings</h3>
                           <div className="bg-neutral-800 p-4 rounded-lg flex justify-between items-center">
                               <div>
                                   <p className="font-semibold text-white">Enable Reviews</p>
                                   <p className="text-sm text-neutral-400">Allow other users to leave public reviews on this host profile.</p>
                               </div>
                               <button onClick={() => setDetails({...details, reviewsEnabled: !details.reviewsEnabled})} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${details.reviewsEnabled ? 'bg-purple-600' : 'bg-neutral-700'}`}>
                                   <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${details.reviewsEnabled ? 'translate-x-6' : 'translate-x-1'}`} />
                               </button>
                           </div>
                       </div>
                    </div>
                </div>
                <div className="bg-neutral-900/50 border-t border-neutral-800 px-8 py-4 flex justify-end">
                     <button onClick={handleSave} disabled={isSaving || saveSuccess || !!uploadingField} className="px-5 py-2 text-sm font-semibold rounded-full transition-all duration-300 flex items-center justify-center min-w-[100px] bg-purple-600 text-white hover:bg-purple-500 shadow-lg shadow-purple-500/20 disabled:bg-neutral-700 disabled:text-neutral-500 disabled:shadow-none">
                         {isSaving ? 'Saving...' : saveSuccess ? 'Saved!' : 'Save Changes'}
                    </button>
                </div>
            </div>

            <div className="mt-8 bg-transparent border-2 border-red-500/30 rounded-2xl p-8">
                <h3 className="text-xl font-bold text-red-400 mb-2">Danger Zone</h3>
                <p className="text-neutral-400 mb-6">This action is permanent and cannot be undone.</p>
                <button 
                    onClick={() => setIsDeleteModalOpen(true)} 
                    disabled={details.isDefault}
                    className="px-5 py-2 text-sm font-semibold rounded-full bg-red-600/20 text-red-300 hover:bg-red-600/40 hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {details.isDefault ? "Cannot Delete Default Host" : "Delete This Host"}
                </button>
            </div>
            
             <Modal isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)}>
                <div className="w-full max-w-sm bg-neutral-900 border border-neutral-700 rounded-2xl p-8 text-center">
                    <h3 className="text-xl font-bold text-white mb-2">Confirm Deletion</h3>
                    <p className="text-neutral-400 mb-6">Are you sure you want to delete the host "{details.name}"? This action is irreversible.</p>
                    <div className="flex justify-center space-x-4">
                        <button onClick={() => setIsDeleteModalOpen(false)} className="px-6 py-2 text-sm font-semibold text-neutral-300 bg-neutral-800 hover:bg-neutral-700 rounded-full transition-colors">Cancel</button>
                        <button onClick={handleDelete} className="px-6 py-2 text-sm font-semibold text-white bg-red-600 hover:bg-red-500 rounded-full transition-colors">Confirm Delete</button>
                    </div>
                </div>
            </Modal>
        </div>
    );
}

const TeamSection: React.FC = () => {
    const { user } = useAuth();
    return (
        <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-8">
            <div className="flex justify-between items-center mb-6">
                <div>
                    <h2 className="text-xl font-bold text-white">Team Members</h2>
                    <p className="text-neutral-400 text-sm">Invite and manage your team.</p>
                </div>
                <button className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 flex items-center justify-center space-x-2">
                    <PlusIcon className="w-4 h-4" /><span>Invite Member</span>
                </button>
            </div>
            <div className="divide-y divide-neutral-800">
                {user?.team?.map(member => (
                    <div key={member.id} className="flex items-center justify-between py-4">
                        <div className="flex items-center">
                            <img src={`https://i.pravatar.cc/150?u=${member.email}`} alt={member.name} className="w-10 h-10 rounded-full mr-4" />
                            <div>
                                <p className="font-semibold text-white">{member.name}</p>
                                <p className="text-sm text-neutral-400">{member.email}</p>
                            </div>
                        </div>
                        <p className="text-sm font-medium text-purple-400 bg-purple-500/10 px-3 py-1 rounded-full">{member.role}</p>
                    </div>
                ))}
            </div>
        </div>
    );
};

const PayoutsSection: React.FC = () => {
    const { user, refreshUser } = useAuth();
    const [isConnecting, setIsConnecting] = useState(false);
    const [successMsg, setSuccessMsg] = useState('');

    const handleConnectStripe = async () => {
        if (!user) return;
        setIsConnecting(true);
        try {
            const result = await api.connectUserStripe(user.id);
            if (result.success) {
                await refreshUser();
                setSuccessMsg('Stripe account connected successfully!');
                setTimeout(() => setSuccessMsg(''), 3000);
            }
        } catch (error) {
            console.error("Stripe connection failed", error);
            alert("Failed to connect Stripe. Please try again.");
        } finally {
            setIsConnecting(false);
        }
    };

    const handleDisconnectStripe = async () => {
        if (!user) return;
        if (!window.confirm("Are you sure? You will no longer be able to receive payouts.")) return;
        
        setIsConnecting(true);
        try {
            await api.disconnectUserStripe(user.id);
            await refreshUser();
        } catch (error) {
            console.error("Stripe disconnection failed", error);
        } finally {
            setIsConnecting(false);
        }
    };

    return (
        <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-8">
            <h3 className="text-xl font-bold text-white mb-6">Payout Settings</h3>
            
            <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
                <div className="flex items-center gap-4">
                    <div className="w-14 h-14 bg-[#635BFF] rounded-xl flex items-center justify-center text-white shadow-lg shadow-[#635BFF]/20 flex-shrink-0">
                        <DollarSignIcon className="w-8 h-8" /> 
                    </div>
                    <div>
                        <h4 className="font-bold text-white text-lg flex flex-wrap items-center gap-2">
                            Stripe Connect
                            {user?.stripeConnected && (
                                <span className="px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 text-xs border border-green-500/20">Active</span>
                            )}
                        </h4>
                        <p className="text-sm text-neutral-400 mt-1">
                            {user?.stripeConnected
                                ? `Linked Account: ${user.stripeAccountId}` 
                                : "Link your Stripe account to enable automated payouts. You will act as the Merchant of Record."}
                        </p>
                        {user?.stripeConnected && <p className="text-xs text-green-400 mt-1 flex items-center"><CheckCircleIcon className="w-3 h-3 mr-1"/> Ready for payouts</p>}
                        {successMsg && <p className="text-xs text-green-400 mt-1 font-semibold animate-pulse">{successMsg}</p>}
                    </div>
                </div>
                
                <div className="w-full lg:w-auto">
                    {user?.stripeConnected ? (
                        <button 
                            onClick={handleDisconnectStripe}
                            disabled={isConnecting}
                            className="w-full lg:w-auto px-4 py-2 bg-transparent border border-red-500/50 text-red-400 rounded-lg text-sm font-semibold hover:bg-red-500/10 transition-colors disabled:opacity-50 min-w-[120px]"
                        >
                            {isConnecting ? 'Processing...' : 'Disconnect'}
                        </button>
                    ) : (
                        <button 
                            onClick={handleConnectStripe}
                            disabled={isConnecting}
                            className="w-full lg:w-auto px-5 py-2.5 bg-[#635BFF] text-white rounded-lg text-sm font-bold hover:bg-[#544DC7] transition-colors shadow-lg shadow-[#635BFF]/20 disabled:opacity-70 flex items-center min-w-[120px] justify-center"
                        >
                            {isConnecting ? (
                                <>Connecting...</> 
                            ) : (
                                <>Connect Stripe</>
                            )}
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

const PlaceholderSection: React.FC<{ title: string }> = ({ title }) => (
    <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-8 text-center h-64 flex flex-col justify-center">
        <h2 className="text-2xl font-bold text-white mb-2">{title}</h2>
        <p className="text-neutral-500">This feature is coming soon. Stay tuned!</p>
    </div>
);

export default Settings;

--- END OF FILE ./pages/Settings.tsx ---




--- START OF FILE ./pages/EditEvent.tsx ---

[ Skipped binary file ]

--- END OF FILE ./pages/EditEvent.tsx ---




--- START OF FILE ./pages/HostPage.tsx ---


import React, { useState, useEffect, useMemo } from 'react';
import { useParams, useLocation, useNavigate } from 'react-router-dom';
import * as api from '../services/api';
import { Host, Event as EventType, Review } from '../types';
import { EventCard } from '../components/EventCard';
import { RatingDisplay } from '../components/RatingDisplay';
import { useAuth } from '../contexts/AuthContext';
import { ArrowLeftIcon } from '../components/Icons';
import SEOHead from '../components/SEOHead';

const HostPage: React.FC = () => {
    const { id } = useParams<{ id: string }>();
    const { user } = useAuth();
    const location = useLocation();
    const navigate = useNavigate();
    const [host, setHost] = useState<Host | null>(null);
    const [events, setEvents] = useState<EventType[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [activeTab, setActiveTab] = useState<'upcoming' | 'past'>('upcoming');

    const fromLocation = location.state?.from;

    const getInitials = (name: string) => {
        if (!name) return '?';
        const words = name.trim().split(' ').filter(Boolean);
        if (words.length > 1) {
            return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        }
        if (words.length === 1 && words[0].length > 1) {
            return words[0].substring(0, 2).toUpperCase();
        }
        if (words.length === 1 && words[0].length === 1) {
            return words[0][0].toUpperCase();
        }
        return '?';
    };

    useEffect(() => {
        const fetchHostData = async () => {
            if (!id) return;
            try {
                setIsLoading(true);
                
                // Fetch host details and events in parallel for better performance
                const [hostData, eventData] = await Promise.all([
                    api.getHostDetails(id),
                    api.getEventsByHost(id) // Fetch events directly by host ID
                ]);

                setHost(hostData);
                setEvents(eventData);
            } catch (err) {
                setError('Failed to load host details.');
                console.error(err);
            } finally {
                setIsLoading(false);
            }
        };
        fetchHostData();
    }, [id]);

    const { upcomingEvents, pastEvents } = useMemo(() => {
        const now = new Date();
        const upcoming = events
            .filter(event => new Date(event.date) >= now)
            .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
        const past = events
            .filter(event => new Date(event.date) < now)
            .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
        return { upcomingEvents: upcoming, pastEvents: past };
    }, [events]);
    
    const averageRating = useMemo(() => {
        if (!host || host.reviews.length === 0) return 0;
        const total = host.reviews.reduce((sum, review) => sum + review.rating, 0);
        return total / host.reviews.length;
    }, [host]);

    if (isLoading) return <div className="text-center py-20 text-neutral-400">Loading host profile...</div>;
    if (error) return <div className="text-center py-20 text-red-400">{error}</div>;
    if (!host) return <div className="text-center py-20 text-neutral-400">Host not found.</div>;
    
    const eventsToShow = activeTab === 'upcoming' ? upcomingEvents : pastEvents;
    const canLeaveReview = host.reviewsEnabled && user && user.id !== host.ownerUserId;

    return (
        <>
            <SEOHead 
                title={host.name}
                description={host.description || `Check out events by ${host.name} on Eventsta.`}
                image={host.coverImageUrl || host.imageUrl}
                type="profile"
            />

            {/* Blurred Background Layer - Fixed, No Scroll Movement */}
            <div className="fixed inset-0 z-[-1]">
                {host.coverImageUrl ? (
                    <div
                        className="absolute inset-0 bg-cover bg-center filter blur-3xl transition-opacity duration-1000 ease-in-out"
                        style={{ backgroundImage: `url(${host.coverImageUrl})`, transform: 'scale(1.2)' }}
                    />
                ) : (
                    <div className="absolute inset-0 bg-gradient-to-br from-purple-950 via-black to-black" />
                )}
            </div>
            <div className="fixed inset-0 bg-black/70 z-[-1]"></div>

            <div className="-mt-20">
                {/* Hero Section */}
                <div className="relative h-[50vh] min-h-[400px] w-full overflow-hidden flex flex-col justify-end">
                    {host.coverImageUrl ? (
                        <div
                            className="absolute top-0 left-0 w-full h-[120%] bg-cover bg-center"
                            style={{ backgroundImage: `url(${host.coverImageUrl})` }}
                        />
                    ) : (
                        <div className="absolute top-0 left-0 w-full h-[120%] bg-gradient-to-br from-purple-900 via-neutral-900 to-black flex items-center justify-center p-8">
                            <h1 className="text-6xl md:text-8xl font-black text-white/20 select-none text-center break-words">{host.name}</h1>
                        </div>
                    )}
                    <div className="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] via-[#0a0a0a]/50 to-transparent" />
                    
                    <div className="relative container mx-auto max-w-7xl px-6 pb-8 z-10">
                        <div className="flex flex-col items-center md:flex-row md:items-end">
                        <div className="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-[#0a0a0a] bg-neutral-800 overflow-hidden flex-shrink-0 flex items-center justify-center">
                            {host.imageUrl ? (
                                <img src={host.imageUrl} alt={host.name} className="w-full h-full object-cover" />
                            ) : (
                                <span className="text-5xl md:text-6xl font-bold text-purple-400 select-none">{getInitials(host.name)}</span>
                            )}
                        </div>
                        <div className="mt-4 md:mt-0 md:ml-6 text-center md:text-left">
                            <h1 className="text-3xl md:text-5xl font-bold text-white text-glow">{host.name}</h1>
                            {host.reviewsEnabled && host.reviews.length > 0 && (
                                <div className="mt-2 flex justify-center md:justify-start">
                                    <RatingDisplay rating={averageRating} reviewCount={host.reviews.length} />
                                </div>
                            )}
                        </div>
                        </div>
                    </div>
                </div>

                {/* Main Content */}
                <div className="container mx-auto max-w-7xl px-6 py-16">
                    {fromLocation && (
                        <button onClick={() => navigate(fromLocation)} className="flex items-center space-x-2 text-sm font-semibold text-purple-400 hover:text-purple-300 transition-colors mb-8">
                            <ArrowLeftIcon className="w-4 h-4" />
                            <span>Back to previous page</span>
                        </button>
                    )}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-x-12 gap-y-8">
                        {/* Left/Main Column - Events */}
                        <div className="lg:col-span-2">
                            <div className="border-b border-neutral-800 mb-8">
                                <nav className="flex -mb-px space-x-8">
                                    <button onClick={() => setActiveTab('upcoming')} className={`tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${activeTab === 'upcoming' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}>
                                        Upcoming Events ({upcomingEvents.length})
                                    </button>
                                    <button onClick={() => setActiveTab('past')} className={`tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${activeTab === 'past' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}>
                                        Past Events ({pastEvents.length})
                                    </button>
                                </nav>
                            </div>
                            <div className="space-y-8">
                                {eventsToShow.length > 0 ? (
                                    eventsToShow.map(event => <EventCard key={event.id} event={event} />)
                                ) : (
                                    <div className="text-center py-16 bg-neutral-900/50 border border-neutral-800 rounded-2xl">
                                        <p className="text-neutral-500">No {activeTab} events found.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* Right/Side Column - About & Reviews */}
                        <div className="relative">
                            <div className="lg:sticky top-28 space-y-8">
                                {host.description && (
                                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 backdrop-blur-md">
                                        <h2 className="text-xl font-bold text-white mb-4">About {host.name}</h2>
                                        <p className="text-neutral-300 leading-relaxed text-sm">{host.description}</p>
                                    </div>
                                )}
                                {host.reviewsEnabled && host.reviews.length > 0 && (
                                     <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 backdrop-blur-md">
                                        <h2 className="text-xl font-bold text-white mb-4">Reviews</h2>
                                        <div className="space-y-4">
                                            {host.reviews.slice(0, 3).map((review, index) => (
                                                <div key={index} className="border-b border-neutral-800 pb-4 last:border-b-0 last:pb-0">
                                                    <RatingDisplay rating={review.rating} reviewCount={0} size="sm" />
                                                    <p className="text-neutral-300 text-sm mt-2">"{review.comment}"</p>
                                                    <p className="text-neutral-500 text-xs mt-2 text-right">- {review.author}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {canLeaveReview && (
                                     <button className="w-full py-3 text-sm font-semibold text-center bg-purple-600 hover:bg-purple-500 rounded-lg text-white transition-colors">
                                        Leave a Review
                                     </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </>
    );
};

export default HostPage;

--- END OF FILE ./pages/HostPage.tsx ---




--- START OF FILE ./pages/Reports.tsx ---

[ Skipped binary file ]

--- END OF FILE ./pages/Reports.tsx ---




--- START OF FILE ./pages/EventDetails.tsx ---


import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
import { useParams, Link, useLocation } from 'react-router-dom';
import * as api from '../services/api';
import { Event as EventType, CheckoutCart, User, PromoCode, Competition } from '../types';
import { CalendarIcon, MapPinIcon, SettingsIcon, MegaphoneIcon, ClipboardIcon, MinusIcon, PlusIcon, PackageIcon, EyeIcon, ArrowLeftIcon, ClockIcon, ArrowRightIcon, UserIcon, CheckCircleIcon, UsersIcon } from '../components/Icons';
import QuantitySelector from '../components/QuantitySelector';
import { useAuth } from '../contexts/AuthContext';
import SignInModal from '../components/SignInModal';
import CheckoutModal from '../components/CheckoutModal';
import { RatingDisplay } from '../components/RatingDisplay';
import HostLink from '../components/HostLink';
import FloatingTicketButton from '../components/FloatingTicketButton';
import EventSchedule from '../components/EventSchedule';
import DonationItemSelector from '../components/DonationItemSelector';
import { createEventSlug, extractEventId } from '../utils/url';
import SEOHead from '../components/SEOHead';
import SocialShareButtons from '../components/SocialShareButtons';

const EVENT_DETAIL_SLIDER_DURATION = 5000;

const EventDetails: React.FC = () => {
  const { id: slugParam } = useParams<{ id: string }>();
  const id = extractEventId(slugParam);
  
  const location = useLocation();
  const [event, setEvent] = useState<EventType | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [activeIndex, setActiveIndex] = useState(0);
  const [outgoingIndex, setOutgoingIndex] = useState<number | null>(null); // New state for smooth transitions
  const [cart, setCart] = useState<CheckoutCart>({});
  const { isAuthenticated, user, refreshUser } = useAuth();
  const [isSignInModalOpen, setSignInModalOpen] = useState(false);
  const [isCheckoutModalOpen, setCheckoutModalOpen] = useState(false);
  
  const [isPromoting, setIsPromoting] = useState(false);
  const [promoLink, setPromoLink] = useState('');
  const [isPromotingLoading, setIsPromotingLoading] = useState(false);
  const [copied, setCopied] = useState(false);
  const [isJoiningCompetition, setIsJoiningCompetition] = useState(false);

  // For fundraisers/competitions, which artist to support
  const [selectedRecipient, setSelectedRecipient] = useState<string>('');
  
  // For promo codes
  const [promoCodeInput, setPromoCodeInput] = useState('');
  const [appliedPromoCode, setAppliedPromoCode] = useState<PromoCode | null>(null);
  const [urlTrackingCode, setUrlTrackingCode] = useState<string>(''); // Tracking-only code fallback
  const [promoError, setPromoError] = useState('');
  // Only admins need the full list
  const [eventPromoCodes, setEventPromoCodes] = useState<PromoCode[]>([]);

  // For ended events: Related events from host
  const [moreEventsFromHost, setMoreEventsFromHost] = useState<EventType[]>([]);

  // Refs for slider, filmstrips, and ticket section visibility
  const timerRef = useRef<number | null>(null);
  const mobileFilmstripRef = useRef<HTMLDivElement>(null);
  const desktopFilmstripRef = useRef<HTMLDivElement>(null);
  const ticketSectionRef = useRef<HTMLDivElement>(null);
  const trackPromoRef = useRef<string | null>(null); // Prevent duplicate tracking

  const [isTicketSectionVisible, setIsTicketSectionVisible] = useState(false);


  const isOwner = useMemo(() => {
    if (!user || !event) return false;
    return user.managedHostIds.includes(event.hostId) || user.isSystemAdmin;
  }, [user, event]);
  
  const isCompetitor = useMemo(() => {
    if (!user || !event || !event.competitions || event.competitions.length === 0) return false;
    // Check if user is a competitor in ANY competition for this event
    return event.competitions.some(c => c.competitorIds.includes(user.id));
  }, [user, event]);
  
  const hasActiveCompetition = useMemo(() => {
    if (!event || !event.competitions || event.competitions.length === 0) return false;
    // An active competition is one that can be joined (i.e., not completed or cancelled).
    return event.competitions.some(c => c.status === 'ACTIVE' || c.status === 'SETUP');
  }, [event]);

  useEffect(() => {
    if (user && event) {
        const existingPromo = user.promoStats.find(p => p.eventId === event.id && p.status === 'active');
        if (existingPromo) {
            setIsPromoting(true);
            setPromoLink(existingPromo.promoLink || `${window.location.origin}/event/${createEventSlug(event.title, event.id)}`);
        } else {
            setIsPromoting(false);
            setPromoLink('');
        }
    }
  }, [user, event]);


  useEffect(() => {
    const fetchEvent = async () => {
      if (!id) return;
      try {
        setIsLoading(true);
        const eventData = await api.getEventDetails(id);
        
        // Double check: if host name is generic 'Host' and we have an ID, try fetching host info
        if ((!eventData.hostName || eventData.hostName === 'Host') && eventData.hostId) {
            try {
                const hostData = await api.getHostDetails(eventData.hostId);
                eventData.hostName = hostData.name;
            } catch (hostErr) {
                console.warn("Could not fetch host details to populate name", hostErr);
            }
        }

        setEvent(eventData);
        if (eventData.competitions && eventData.competitions.length > 0 && eventData.competitions[0].competitorIds.length > 0) {
            // Default to first competitor if none selected
            if (!selectedRecipient) {
                setSelectedRecipient(eventData.competitions[0].competitorIds[0]);
            }
        }

        // If event is ended, fetch other events from this host
        if (new Date(eventData.endDate || eventData.date) < new Date()) {
            const otherEvents = await api.getOtherEventsByHost(eventData.hostId, eventData.id);
            setMoreEventsFromHost(otherEvents.slice(0, 3)); // Take top 3
        }

      } catch (err) {
        setError('Failed to load event details.');
        console.error(err);
      } finally {
        setIsLoading(false);
      }
    };
    
    // Only owners should fetch full list of codes
    const fetchPromoCodesForAdmin = async () => {
        if (id && isOwner) {
            try {
                const codes = await api.getPromoCodesForEvent(id);
                setEventPromoCodes(codes);
            } catch (e) {
                console.warn("Could not fetch promo codes for admin");
            }
        }
    };

    fetchEvent();
    if (isOwner) fetchPromoCodesForAdmin();
  }, [id, isOwner]);

  // Handle URL Promo Parameters & Tracking
  useEffect(() => {
      const handlePromoLogic = async () => {
          if (!event) return;
          console.debug("[Promo Debug] ðŸ”— URL Parameter Check. Search:", location.search);
          const searchParams = new URLSearchParams(location.search);
          const urlPromo = searchParams.get('promo');
          
          if (urlPromo) {
              console.debug("[Promo Debug] ðŸŽ¯ Found promo code in URL:", urlPromo);
              // Store tracking code regardless of validation status
              setUrlTrackingCode(urlPromo);

              // 1. Track Click (Fire and Forget - do not wait for validation)
              if (trackPromoRef.current !== urlPromo) {
                  console.debug(`[Promo Debug] Tracking click for code: ${urlPromo}`);
                  api.trackPromoClick(event.id, urlPromo).catch(e => console.warn("Failed to track promo click", e));
                  trackPromoRef.current = urlPromo;
              }
              
              try {
                  // 2. Validate Code (for Discount Logic)
                  console.debug(`[Promo Debug] â³ Validating URL code '${urlPromo}' against event '${event.id}'...`);
                  const result = await api.validatePromoCode(event.id, urlPromo);
                  console.debug("[Promo Debug] ðŸ Validation Result:", result);
                  
                  if (result.valid) {
                      setAppliedPromoCode({
                          id: 'validated-code',
                          eventId: event.id,
                          code: result.code,
                          discountPercent: result.discountPercent,
                          uses: 0,
                          maxUses: null,
                          isActive: true,
                          ownerName: result.ownerName // Store attribution name
                      });
                      setPromoCodeInput(result.code);
                  } else {
                      // Code is invalid for discount, but we still keep urlTrackingCode for potential affiliate tracking during checkout
                      console.log("Promo code not valid for discount, treated as tracking only.");
                  }
              } catch (e) {
                  // Ignore validation error from URL param
                  console.warn("Promo validation failed from URL", e);
              }
          } else {
              console.debug("[Promo Debug] âšª No promo code found in URL.");
          }
      };
      handlePromoLogic();
  }, [location.search, event]);

  // PENDING CHECKOUT RESTORATION LOGIC
  useEffect(() => {
      if (isAuthenticated && id) {
          const pendingEventId = sessionStorage.getItem('pendingCheckoutEventId');
          
          if (pendingEventId === id) {
              const savedCart = sessionStorage.getItem('pendingCheckoutCart');
              const savedPromoCode = sessionStorage.getItem('pendingCheckoutPromoCode');

              if (savedCart) {
                  try {
                      const parsedCart = JSON.parse(savedCart);
                      setCart(parsedCart);
                      
                      // Restore Promo Code logic
                      if (savedPromoCode) {
                          console.debug(`[Promo Debug] â™»ï¸ Restoring promo code from session: ${savedPromoCode}`);
                          setUrlTrackingCode(savedPromoCode);
                          setPromoCodeInput(savedPromoCode);
                          
                          // Re-validate to get discount applied if valid
                          api.validatePromoCode(id, savedPromoCode).then(result => {
                              if (result.valid) {
                                  setAppliedPromoCode({
                                      id: 'validated-code',
                                      eventId: id,
                                      code: result.code,
                                      discountPercent: result.discountPercent,
                                      uses: 0,
                                      maxUses: null,
                                      isActive: true,
                                      ownerName: result.ownerName
                                  });
                              }
                          }).catch(e => console.warn("Failed to re-validate restored promo code", e));
                      }

                      setCheckoutModalOpen(true);
                  } catch (e) {
                      console.error("Failed to restore cart", e);
                  }
              }
              // Clear storage
              sessionStorage.removeItem('pendingCheckoutEventId');
              sessionStorage.removeItem('pendingCheckoutCart');
              sessionStorage.removeItem('pendingCheckoutPromoCode');
          }
      }
  }, [isAuthenticated, id]);
  
  // New slider logic with pause/resume and timer reset
  const startTimer = useCallback(() => {
    if (typeof window === 'undefined') return;
    if (timerRef.current) {
      clearInterval(timerRef.current);
    }
    if (event && event.imageUrls.length > 1) {
        timerRef.current = window.setInterval(() => {
            setActiveIndex((prevIndex) => {
                setOutgoingIndex(prevIndex);
                const nextIndex = (prevIndex + 1) % event.imageUrls.length;
                // After the fade, clear the outgoing index to remove its animation class
                setTimeout(() => {
                    setOutgoingIndex(null);
                }, 1000); // Must match opacity transition duration
                return nextIndex;
            });
        }, EVENT_DETAIL_SLIDER_DURATION);
    }
  }, [event]);

  useEffect(() => {
    startTimer();
    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, [startTimer]);
  
  const handleThumbnailClick = (index: number) => {
    if (index === activeIndex) return; // Prevent re-triggering on the same thumbnail
    
    setOutgoingIndex(activeIndex);
    setActiveIndex(index);
    startTimer(); // Reset timer on click
    
    // After the fade, clear the outgoing index
    setTimeout(() => {
        setOutgoingIndex(null);
    }, 1000); // Must match opacity transition duration
  };

  // Effect to scroll the filmstrip to the active thumbnail
  useEffect(() => {
    if (!event || event.imageUrls.length <= 1) return;

    const scrollFilmstrip = (ref: React.RefObject<HTMLDivElement>) => {
        if (ref.current) {
            const activeChild = ref.current.children[activeIndex] as HTMLElement;
            if (activeChild) {
                const container = ref.current;
                const scrollLeft = activeChild.offsetLeft - (container.offsetWidth / 2) + (activeChild.offsetWidth / 2);
                container.scrollTo({
                    left: scrollLeft,
                    behavior: 'smooth'
                });
            }
        }
    };
    
    // Scroll both; only the visible one will matter.
    scrollFilmstrip(mobileFilmstripRef);
    scrollFilmstrip(desktopFilmstripRef);
  }, [activeIndex, event]);

  
    // Observer for ticket section visibility
    useEffect(() => {
        if (typeof window === 'undefined') return;
        const currentRef = ticketSectionRef.current;
        if (!currentRef) return;

        const observer = new IntersectionObserver(
            ([entry]) => {
                setIsTicketSectionVisible(entry.isIntersecting);
            },
            {
                root: null,
                rootMargin: '0px',
                threshold: 0.1, // Trigger when 10% of the element is visible
            }
        );

        observer.observe(currentRef);

        return () => {
            if (currentRef) {
                observer.unobserve(currentRef);
            }
        };
    }, [isLoading]);


  // FIX: Wrap handleQuantityChange in useCallback to prevent infinite re-renders when passed to child components like DonationItemSelector.
  const handleQuantityChange = useCallback((itemType: string, quantity: number, donationAmount?: number) => {
      setCart(prevCart => {
          const newCart = { ...prevCart };
          if (quantity > 0) {
              newCart[itemType] = { quantity, donationAmount };
          } else {
              delete newCart[itemType];
          }
          return newCart;
      });
  }, []);
  
  const totalTicketsInCart = useMemo(() => {
    if (!event) return 0;
    return Object.keys(cart).reduce((total, itemType) => {
        const isTicket = event.tickets.some(t => t.type === itemType);
        if (isTicket) {
            return total + cart[itemType].quantity;
        }
        return total;
    }, 0);
  }, [cart, event]);


  const { totalPrice, discountAmount, finalPrice } = useMemo(() => {
    if (!event) return { totalPrice: 0, discountAmount: 0, finalPrice: 0 };
    let total = 0;
    let discount = 0;

    Object.keys(cart).forEach(itemType => {
        const details = cart[itemType];
        let price = 0;
        let isTicket = false;

        if (event.type === 'ticketed') {
            const ticketOption = event.tickets.find(t => t.type === itemType);
            const addOnOption = event.addOns?.find(a => a.name === itemType);
            
            if (ticketOption) {
                price = ticketOption.price;
                isTicket = true;
            } else if (addOnOption) {
                price = addOnOption.price;
            }
        } else { // fundraiser
            price = details.donationAmount || 0;
        }
        
        const itemTotal = price * details.quantity;
        total += itemTotal;

        // Discount only applies to tickets in ticketed events
        if (appliedPromoCode && event.type === 'ticketed' && isTicket) {
            discount += itemTotal * (appliedPromoCode.discountPercent / 100);
        }
    });
    
    return { totalPrice: total, discountAmount: discount, finalPrice: total - discount };
  }, [cart, event, appliedPromoCode]);

  const handleApplyPromoCode = async () => {
    if (!event) return;
    setPromoError('');
    setAppliedPromoCode(null);
    
    if (!promoCodeInput) return;
    
    console.debug(`[Promo Debug] âœï¸ Manual Promo Entry: '${promoCodeInput}'`);

    try {
        // Use the new public validation endpoint
        const result = await api.validatePromoCode(event.id, promoCodeInput);
        if (result.valid) {
            setAppliedPromoCode({
                id: 'validated-code', // Dummy ID since we don't need real ID for display
                eventId: event.id,
                code: result.code,
                discountPercent: result.discountPercent,
                uses: 0,
                maxUses: null,
                isActive: true,
                ownerName: result.ownerName
            });
            setPromoCodeInput(result.code);
        } else {
            setPromoError('Invalid or expired promo code.');
        }
    } catch (e) {
        setPromoError("Validation failed. Please try again.");
    }
  };

  const removePromoCode = () => {
    setAppliedPromoCode(null);
    setPromoError('');
    setPromoCodeInput('');
  };

  const handleCheckout = () => {
      if (!isAuthenticated) {
          // Save intent to checkout
          if (event) {
              sessionStorage.setItem('pendingCheckoutEventId', event.id);
              sessionStorage.setItem('pendingCheckoutCart', JSON.stringify(cart));
              // Save Promo Code State
              if (appliedPromoCode) {
                  sessionStorage.setItem('pendingCheckoutPromoCode', appliedPromoCode.code);
              } else if (urlTrackingCode) {
                  sessionStorage.setItem('pendingCheckoutPromoCode', urlTrackingCode);
              }
          }
          setSignInModalOpen(true);
      } else {
          setCheckoutModalOpen(true);
      }
  }
  
  const handlePromote = async () => {
    if (!isAuthenticated) {
        setSignInModalOpen(true);
        return;
    }
    if (!user || !event) return;
    setIsPromotingLoading(true);
    try {
        const newPromo: any = await api.startPromotion(user.id, event);
        await refreshUser();
        setIsPromoting(true);
        
        // Use returned code or fallback if response doesn't contain code (depends on backend)
        const code = newPromo.code || newPromo.promo_code || `PROMO_${user.id.slice(0,4)}`;
        
        setPromoLink(`${window.location.origin}/event/${createEventSlug(event.title, event.id)}?promo=${code}`);
    } catch (error) {
        console.error("Failed to start promotion:", error);
    } finally {
        setIsPromotingLoading(false);
    }
  };

   const handleJoinCompetition = async () => {
    if (!isAuthenticated) {
        setSignInModalOpen(true);
        return;
    }
    if (!user || !event) return;
    setIsJoiningCompetition(true);
    try {
        // Pass the specific competition ID if multiple exist, assuming UI defaults to first/active
        const targetCompetition = event.competitions?.find(c => c.status === 'ACTIVE') || event.competitions?.[0];
        const competitionId = targetCompetition ? targetCompetition.id : undefined;

        await api.joinCompetition(user.id, event, competitionId);
        await refreshUser();
        // The user is now a competitor and a promoter
        setIsPromoting(true);
        
        // Refresh event data to include new competitor
        const refreshedEvent = await api.getEventDetails(event.id);
        setEvent(refreshedEvent);
    } catch (error) {
        console.error("Failed to join competition:", error);
    } finally {
        setIsJoiningCompetition(false);
    }
  };
  
  const handleCopyLink = () => {
    navigator.clipboard.writeText(promoLink);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  if (isLoading) return <div className="text-center py-20 text-neutral-400">Loading event...</div>;
  if (error) return <div className="text-center py-20 text-red-400">{error}</div>;
  if (!event) return <div className="text-center py-20 text-neutral-400">Event not found.</div>;
  
  // DRAFT MODE CHECK
  if (event.status === 'DRAFT' && !isOwner) {
      return (
          <div className="min-h-screen flex flex-col items-center justify-center text-center px-6 -mt-20 bg-[#0a0a0a]">
              <h2 className="text-3xl font-bold text-white mb-4">Event Unavailable</h2>
              <p className="text-neutral-400 max-w-md">This event is currently hidden or does not exist. Please check back later.</p>
              <Link to="/" className="mt-8 px-6 py-3 bg-neutral-800 hover:bg-neutral-700 text-white rounded-full font-semibold transition-colors">
                  Browse Events
              </Link>
          </div>
      );
  }

  const formattedDate = new Date(event.date).toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
  const isEventEnded = new Date(event.endDate || event.date) < new Date();
  const isCompetitionEvent = event.competitions && event.competitions.length > 0;

  const Thumbnails = () => (
    <>
      {event!.imageUrls.map((url, index) => (
        <button
          key={index}
          onClick={() => handleThumbnailClick(index)}
          aria-label={`View image ${index + 1}`}
          className={`filmstrip-button relative w-16 h-16 rounded-full flex-shrink-0 focus:outline-none shadow-lg shadow-black/50 ${
            activeIndex === index ? 'is-active' : ''
          }`}
        >
          <div className="w-full h-full rounded-full overflow-hidden">
            <img src={url} alt={`thumbnail ${index + 1}`} className="w-full h-full object-cover" />
          </div>
        </button>
      ))}
    </>
  );

  return (
    <>
      <SEOHead 
        title={event.title}
        description={event.description}
        image={event.imageUrls[0]}
        type="event"
      />

      {/* Draft Banner */}
      {event.status === 'DRAFT' && isOwner && (
          <div className="fixed top-20 left-0 right-0 z-40 bg-yellow-500 text-black px-6 py-3 text-center font-bold text-sm flex items-center justify-center gap-3 shadow-md">
              <EyeIcon className="w-5 h-5" />
              <span>This event is in DRAFT mode. Only you can see this page.</span>
              <Link to={`/event/${event.id}/admin/details`} className="underline hover:text-neutral-800">Edit Details</Link>
          </div>
      )}

      {/* Blurred Background Layer - Fixed, No Parallax */}
      <div 
        className="fixed top-0 left-0 w-full h-screen z-0 pointer-events-none overflow-hidden"
      >
        {event.imageUrls.map((url, index) => (
          <div
            key={`bg-${index}`}
            className="absolute inset-0 bg-cover bg-center transition-opacity duration-[1500ms] ease-in-out"
            style={{ 
                backgroundImage: `url("${url}")`, 
                opacity: index === activeIndex ? 1 : 0,
                filter: 'blur(60px) brightness(0.3) saturate(1.2)',
                transform: 'scale(1.2)'
            }}
          />
        ))}
        <div className="absolute inset-0 bg-black/40"></div>
      </div>

      <section className={`relative w-full -mt-20 pt-20 ${event.status === 'DRAFT' ? 'mt-8' : ''}`}>
        <div className="md:container md:mx-auto md:max-w-7xl md:px-6">
            {/* Main hero container: flex for mobile (col) and desktop (row) */}
            <div className="relative z-10 flex flex-col md:flex-row md:items-center">
            
            {/* Image Container: Full width on mobile, 5/12 on desktop. */}
            <div
              className="relative aspect-video md:aspect-auto md:h-[75vh] w-full md:w-5/12 md:flex-shrink-0 shadow-[0_0_35px_rgba(0,0,0,0.8)] overflow-visible md:overflow-hidden md:rounded-bl-2xl md:rounded-br-2xl"
            >
                <div className="relative h-full w-full overflow-hidden md:rounded-bl-2xl md:rounded-br-2xl">
                    {event.imageUrls.map((url, index) => {
                        const isActive = index === activeIndex;
                        const kenburnsClass = `event-details-kenburns-${(index % 3) + 1}`;
                        
                        return (
                            <img
                                key={index}
                                src={url}
                                alt={`${event.title} view ${index + 1}`}
                                className={`absolute inset-0 h-full w-full object-cover transition-opacity duration-1000 ease-in-out ${isActive ? kenburnsClass : ''}`}
                                style={{ opacity: isActive ? 1 : 0 }}
                            />
                        );
                    })}
                </div>
                {/* MOBILE-ONLY FILMSTRIP */}
                {event.imageUrls.length > 1 && (
                    <div className="md:hidden absolute bottom-0 translate-y-1/2 left-1/2 -translate-x-1/2 w-full max-w-[90%] z-10">
                        <div 
                            ref={mobileFilmstripRef}
                            className="flex items-center justify-center space-x-3 overflow-x-auto px-12 py-12"
                            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
                        >
                            <Thumbnails />
                        </div>
                    </div>
                )}
            </div>

            {/* Details Container: Padded on mobile, specific left padding on desktop. */}
            <div
              className="w-full md:w-7/12 flex-grow flex items-center px-6 pt-24 pb-8 md:py-0 md:px-0 md:pl-16"
            >
                <div>
                    {isEventEnded && <p className="text-yellow-400 font-bold mb-2 text-glow flex items-center gap-2"><ClockIcon className="w-4 h-4" /> PAST EVENT</p>}
                    
                    {/* ENHANCED PROMO BADGE */}
                    {appliedPromoCode && !isEventEnded && (
                        event.type === 'ticketed' && appliedPromoCode.discountPercent > 0 ? (
                            <div className="mb-4 inline-block bg-gradient-to-r from-green-600/30 to-green-500/20 border border-green-500/40 rounded-lg px-4 py-2 backdrop-blur-md shadow-lg shadow-green-900/20 animate-fade-in-up">
                                <span className="text-base font-bold text-green-300 flex items-center gap-2">
                                    <CheckCircleIcon className="w-5 h-5 text-green-400" />
                                    Deal Unlocked: <span className="text-white">{appliedPromoCode.discountPercent}% Off Tickets</span>
                                </span>
                            </div>
                        ) : event.type === 'fundraiser' && (
                            <div className="mb-4 inline-block bg-gradient-to-r from-purple-600/30 to-blue-500/20 border border-purple-500/40 rounded-lg px-4 py-2 backdrop-blur-md shadow-lg shadow-purple-900/20 animate-fade-in-up">
                                <span className="text-base font-bold text-purple-300 flex items-center gap-2">
                                    <UsersIcon className="w-5 h-5 text-purple-400" />
                                    Supporting <span className="text-white">{appliedPromoCode.ownerName || appliedPromoCode.code}</span>
                                </span>
                            </div>
                        )
                    )}

                    <h1 className="text-4xl font-bold tracking-tighter text-white md:text-7xl">{event.title}</h1>
                    <HostLink 
                        hostId={event.hostId} 
                        hostName={event.hostName} 
                        className="mt-1 text-2xl font-light text-purple-400 md:text-4xl hover:text-purple-300"
                    />
                    
                    <SocialShareButtons url={window.location.href} title={event.title} />

                    <div className="mt-6 flex flex-col sm:flex-row sm:items-center sm:space-x-6 text-lg text-neutral-200 space-y-3 sm:space-y-0">
                        <div className="flex items-center space-x-2"><CalendarIcon className="w-5 h-5 text-neutral-400" /><span>{formattedDate}</span></div>
                        <div className="flex items-center space-x-2"><MapPinIcon className="w-5 h-5 text-neutral-400" /><span>{event.location}</span></div>
                    </div>

                    {/* DESKTOP-ONLY FILMSTRIP */}
                    {event.imageUrls.length > 1 && (
                      <div className="hidden md:block mt-8">
                        <style>{`
                          .overflow-x-auto::-webkit-scrollbar { display: none; }
                          
                          @keyframes breathe-ring {
                              0%, 100% {
                                  transform: scale(1);
                                  box-shadow: 0 0 4px rgba(168, 85, 247, 0.4);
                                  opacity: 0.7;
                              }
                              50% {
                                  transform: scale(1.02);
                                  box-shadow: 0 0 8px rgba(168, 85, 247, 0.6);
                                  opacity: 1;
                              }
                          }

                          .filmstrip-button {
                            transform: scale(1);
                            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Springy scale */
                          }

                          .filmstrip-button::before {
                              content: "";
                              position: absolute;
                              inset: -2px; /* Creates space for the ring */
                              border-radius: 50%;
                              border: 1px solid rgba(168, 85, 247, 0); /* purple-500 with alpha */
                              opacity: 0;
                              transform: scale(0.8);
                              transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), border-color 0.4s ease;
                              pointer-events: none;
                          }
                          
                          .filmstrip-button.is-active {
                            transform: scale(1.1);
                          }

                          .filmstrip-button.is-active::before {
                              opacity: 1;
                              transform: scale(1);
                              animation: breathe-ring 2.5s ease-in-out infinite;
                              border-color: rgba(168, 85, 247, 0.4);
                          }

                          .filmstrip-button::after {
                            content: "";
                            position: absolute;
                            inset: 0;
                            border-radius: 50%;
                            background-color: black;
                            opacity: 0.4;
                            transition: opacity 0.4s ease;
                          }

                          .filmstrip-button.is-active::after, .filmstrip-button:hover::after {
                              opacity: 0;
                          }

                          .filmstrip-button:focus-visible {
                            outline: 2px solid #a855f7;
                            outline-offset: 4px;
                          }
                        `}</style>
                        <div 
                          ref={desktopFilmstripRef}
                          className="flex items-center space-x-3 overflow-x-auto py-12 -mx-12 px-12"
                          style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
                        >
                          <Thumbnails />
                        </div>
                      </div>
                    )}

                    {event.rating && event.reviewCount && (
                        <div className="mt-6">
                            <RatingDisplay rating={event.rating} reviewCount={event.reviewCount} />
                        </div>
                    )}
                </div>
            </div>
            </div>
        </div>
      </section>

      <div className="relative z-10 container mx-auto max-w-7xl px-6 pt-16 pb-16">
         {isOwner && (
            <div className="mb-12">
                 <Link to={`/event/${event.id}/admin/reports`} className="w-full md:w-auto flex items-center justify-center px-8 py-4 bg-purple-600 text-white text-base font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 space-x-3">
                    <SettingsIcon className="w-5 h-5" />
                    <span>Manage Event</span>
                </Link>
            </div>
        )}
        <div className="flex flex-col lg:flex-row gap-16">
          <div className="w-full lg:w-2/3">
             <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-8 backdrop-blur-md">
                <h2 className="text-2xl font-bold text-white mb-6">About This Event</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div className="flex items-start gap-4"><CalendarIcon className="w-8 h-8 text-purple-400 flex-shrink-0 mt-1" /><div><h3 className="text-lg font-semibold text-white">Date & Time</h3><p className="text-neutral-400">{new Date(event.date).toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'short' })}</p></div></div>
                    <div className="flex items-start gap-4"><MapPinIcon className="w-8 h-8 text-purple-400 flex-shrink-0 mt-1" /><div><h3 className="text-lg font-semibold text-white">Location</h3><p className="text-neutral-400">{event.location}</p></div></div>
                </div>
                <div className="border-t border-neutral-700 my-6"></div>
                <p className="text-neutral-300 leading-relaxed">{event.description}</p>
            </div>
            
            {event && <EventSchedule event={event} />}

          </div>
          <div ref={ticketSectionRef} className="w-full lg:w-1/3">
            <div className="sticky top-28">
                {isEventEnded ? (
                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 backdrop-blur-md">
                        <h2 className="text-xl font-bold text-white mb-4">Event Ended</h2>
                        <p className="text-neutral-400 mb-6 text-sm">This event has passed. Check out what's next!</p>
                        
                        {moreEventsFromHost.length > 0 ? (
                            <div>
                                <p className="text-xs font-bold text-neutral-500 uppercase tracking-wider mb-3">Upcoming from {event.hostName}</p>
                                <div className="space-y-3">
                                    {moreEventsFromHost.map(otherEvent => (
                                        <Link key={otherEvent.id} to={`/event/${createEventSlug(otherEvent.title, otherEvent.id)}`} className="block group">
                                            <div className="flex items-center gap-3 p-2 rounded-lg hover:bg-neutral-800 transition-colors">
                                                <img src={otherEvent.imageUrls[0]} className="w-12 h-12 rounded-lg object-cover" alt="" />
                                                <div className="min-w-0">
                                                    <p className="text-white font-medium text-sm truncate group-hover:text-purple-400 transition-colors">{otherEvent.title}</p>
                                                    <p className="text-xs text-neutral-500">{new Date(otherEvent.date).toLocaleDateString()}</p>
                                                </div>
                                            </div>
                                        </Link>
                                    ))}
                                </div>
                                <div className="mt-6 pt-4 border-t border-neutral-800 text-center">
                                     <Link to={`/host/${event.hostId}`} className="text-sm text-purple-400 hover:text-purple-300 font-semibold">View Host Profile</Link>
                                </div>
                            </div>
                        ) : (
                            <div className="text-center py-4">
                                <Link 
                                    to={`/host/${event.hostId}`}
                                    className="inline-block px-6 py-3 bg-neutral-800 hover:bg-neutral-700 text-white rounded-full font-medium transition-colors"
                                >
                                    View {event.hostName}'s Profile
                                </Link>
                            </div>
                        )}
                    </div>
                ) : (
                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 backdrop-blur-md">
                        <h2 className="text-2xl font-bold text-white mb-6">{event.type === 'ticketed' ? 'Select Tickets' : 'Make a Donation'}</h2>
                        <div className="space-y-4 mb-6">
                            {event.type === 'ticketed' && event.tickets.map((ticket, idx) => {
                                // Calculate discount for this ticket
                                const hasDiscount = appliedPromoCode && appliedPromoCode.discountPercent > 0 && event.type === 'ticketed';
                                const discountPct = hasDiscount ? appliedPromoCode!.discountPercent : 0;
                                const discountedPrice = ticket.price * (1 - discountPct / 100);
                                
                                // Check availability
                                const now = new Date();
                                const isSalesEnded = ticket.saleEndDate ? new Date(ticket.saleEndDate) < now : false;
                                const isSoldOut = (ticket.quantity !== undefined && (ticket.sold || 0) >= ticket.quantity);
                                const isUnavailable = isSalesEnded || isSoldOut;

                                return (
                                    <div key={ticket.id || ticket.type || idx} className={`bg-neutral-900 border border-neutral-800 rounded-xl p-5 flex items-center justify-between gap-4 ${isUnavailable ? 'opacity-60 grayscale' : ''}`}>
                                        <div>
                                            <h4 className="text-lg font-semibold text-white">{ticket.type}</h4>
                                            <p className="text-neutral-400 text-sm mb-2">{ticket.description || ''}</p>
                                            {hasDiscount && !isUnavailable ? (
                                                <div className="flex flex-col">
                                                    <span className="text-sm text-neutral-500 line-through">${ticket.price.toFixed(2)}</span>
                                                    <span className="text-xl font-bold text-green-400">${discountedPrice.toFixed(2)}</span>
                                                </div>
                                            ) : (
                                                <span className="text-xl font-bold text-purple-400">${ticket.price.toFixed(2)}</span>
                                            )}
                                            
                                            {isSoldOut && <p className="text-red-500 text-xs font-bold mt-1 uppercase">Sold Out</p>}
                                            {isSalesEnded && !isSoldOut && <p className="text-yellow-500 text-xs font-bold mt-1 uppercase">Sales Ended</p>}
                                        </div>
                                        {isUnavailable ? (
                                            <button disabled className="px-3 py-1.5 bg-neutral-800 text-neutral-500 text-xs font-bold rounded cursor-not-allowed">Unavailable</button>
                                        ) : (
                                            <QuantitySelector initialQuantity={cart[ticket.type]?.quantity} ticketType={ticket.type} onChange={(type, qty) => handleQuantityChange(type, qty)} />
                                        )}
                                    </div>
                                );
                            })}
                            
                            {event.type === 'fundraiser' && event.tickets.map((ticket, idx) => (
                                <DonationItemSelector key={ticket.id || ticket.type || idx} item={ticket} onChange={handleQuantityChange} cartItem={cart[ticket.type]} />
                            ))}

                            {event.addOns && event.addOns.length > 0 && (
                                <div className={`pt-4 transition-opacity ${totalTicketsInCart === 0 ? 'opacity-50' : ''}`}>
                                    <h3 className="text-lg font-bold text-white mb-4 flex items-center"><PackageIcon className="w-5 h-5 mr-3 text-purple-400"/>Add-ons</h3>
                                     <div className="space-y-4">
                                        {event.type === 'ticketed' && event.addOns.map(addOn => (
                                            <div key={addOn.name} className="bg-neutral-900 border border-neutral-800 rounded-xl p-5 flex items-center justify-between gap-4">
                                                <div>
                                                    <h4 className="text-lg font-semibold text-white">{addOn.name}</h4>
                                                    <p className="text-neutral-400 text-sm mb-2">{addOn.description || ''}</p>
                                                    {/* Add-ons do not get discounted */}
                                                    <span className="text-xl font-bold text-purple-400">${addOn.price.toFixed(2)}</span>
                                                </div>
                                                <QuantitySelector disabled={totalTicketsInCart === 0} initialQuantity={cart[addOn.name]?.quantity} ticketType={addOn.name} onChange={(type, qty) => handleQuantityChange(type, qty)} />
                                            </div>
                                        ))}
                                        {event.type === 'fundraiser' && event.addOns.map(addOn => (
                                            <DonationItemSelector key={addOn.name} item={addOn} onChange={handleQuantityChange} cartItem={cart[addOn.name]} />
                                        ))}
                                     </div>
                                     {totalTicketsInCart === 0 && <p className="text-xs text-neutral-500 text-center mt-2">You must select a ticket before adding add-ons.</p>}
                                </div>
                            )}
                        </div>
                        {hasActiveCompetition && (
                          <div className="mb-6">
                              <label htmlFor="support-artist" className="block text-sm font-medium text-neutral-300 mb-2">Support a Competitor</label>
                              <CompetitorDropdown eventId={event.id} selected={selectedRecipient} onSelect={setSelectedRecipient} />
                          </div>
                        )}
                        {event.type === 'ticketed' && (
                          <div className="border-t border-neutral-800 pt-4">
                              {appliedPromoCode ? (
                                  <div className="bg-green-500/10 border border-green-500/20 text-green-300 rounded-lg p-3 text-sm flex justify-between items-center">
                                      <div>
                                          <span className="font-bold">'{appliedPromoCode.code}'</span> applied! Saving ${discountAmount.toFixed(2)}.
                                      </div>
                                      <button onClick={removePromoCode} className="font-bold text-lg">&times;</button>
                                  </div>
                              ) : (
                                  <div className="flex gap-2">
                                      <input 
                                          type="text" 
                                          value={promoCodeInput}
                                          onChange={e => setPromoCodeInput(e.target.value.toUpperCase())}
                                          placeholder="Promo Code" 
                                          className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white" 
                                      />
                                      <button 
                                          onClick={handleApplyPromoCode}
                                          className="h-12 px-5 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-500 disabled:opacity-50"
                                          disabled={!promoCodeInput}
                                      >
                                          Apply
                                      </button>
                                  </div>
                              )}
                              {promoError && <p className="text-red-400 text-xs mt-2">{promoError}</p>}
                          </div>
                        )}
                        <div className="border-t border-neutral-800 pt-4 flex justify-between items-center mb-6 mt-4">
                            <span className="text-lg font-semibold text-neutral-300">Total</span>
                            <span id="event-total-price" className="text-3xl font-bold text-white">${finalPrice.toFixed(2)}</span>
                        </div>
                        <button onClick={handleCheckout} disabled={totalPrice === 0} className="w-full h-14 px-6 bg-purple-600 text-white text-lg font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 disabled:bg-neutral-700 disabled:text-neutral-500 disabled:shadow-none">
                            {event.type === 'ticketed' ? 'Checkout' : 'Donate Now'}
                        </button>
                        <div className="border-t border-neutral-800 mt-6 pt-6">
                            {hasActiveCompetition && !isCompetitor && !isOwner && !isEventEnded ? (
                                <button onClick={handleJoinCompetition} disabled={isJoiningCompetition} className="w-full h-12 px-6 bg-green-500/20 text-green-300 text-sm font-semibold rounded-full hover:bg-green-500/30 hover:text-green-200 transition-colors flex items-center justify-center space-x-2">
                                    <span>Join "{event.competitions?.find(c => c.status === 'ACTIVE' || c.status === 'SETUP')?.name || event.competitions?.[0].name}"</span>
                                </button>
                            ) : isPromoting ? (
                                <div className="text-center">
                                    <p className="text-sm text-green-400 mb-3 font-semibold">âœ“ You are promoting this event!</p>
                                    <div className="flex">
                                        <input type="text" readOnly value={promoLink} className="w-full h-10 px-4 bg-neutral-800 border border-neutral-700 rounded-l-full text-white text-sm focus:outline-none"/>
                                        <button onClick={handleCopyLink} className="h-10 px-4 bg-purple-600 text-white text-sm font-semibold rounded-r-full hover:bg-purple-500 transition-colors flex-shrink-0">
                                            {copied ? 'Copied!' : <ClipboardIcon className="w-4 h-4" />}
                                        </button>
                                    </div>
                                     <Link to="/promotions" className="text-xs text-neutral-400 hover:text-white mt-3 inline-block">Manage promotions &rarr;</Link>
                                </div>
                            ) : !isEventEnded && !isOwner ? (
                                <button onClick={handlePromote} disabled={isPromotingLoading} className="w-full h-12 px-6 bg-purple-500/20 text-purple-300 text-sm font-semibold rounded-full hover:bg-purple-500/30 hover:text-purple-200 transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <MegaphoneIcon className="w-4 h-4" />
                                    <span>
                                        {event.defaultPromoDiscount > 0 && event.type === 'ticketed'
                                            ? `Promote: Earn ${event.commission}% + Give ${event.defaultPromoDiscount}% Off`
                                            : `Promote & Earn ${event.commission}%`}
                                    </span>
                                </button>
                            ) : null}
                       </div>
                    </div>
                )}
            </div>
          </div>
        </div>
      </div>
      <SignInModal isOpen={isSignInModalOpen} onClose={() => setSignInModalOpen(false)} />
      <CheckoutModal 
        isOpen={isCheckoutModalOpen}
        onClose={() => setCheckoutModalOpen(false)}
        cart={cart}
        event={event}
        recipientUserId={selectedRecipient}
        promoCode={appliedPromoCode?.code || urlTrackingCode}
        appliedDiscountPercent={appliedPromoCode?.discountPercent}
        promoOwnerName={appliedPromoCode?.ownerName} // Pass promoter name to checkout
      />
      {/* Pass necessary props to FloatingTicketButton to enable drawer functionality */}
      <FloatingTicketButton 
        ticketSectionRef={ticketSectionRef}
        isVisible={!isTicketSectionVisible && !isEventEnded && event.status === 'PUBLISHED'}
        event={event}
        cart={cart}
        onQuantityChange={handleQuantityChange}
        onCheckout={handleCheckout}
        appliedPromoCode={appliedPromoCode}
      />
    </>
  );
};

// --- Sub-components for EventDetails Page ---
const CompetitorDropdown: React.FC<{ eventId: string, selected: string, onSelect: (userId: string) => void }> = ({ eventId, selected, onSelect }) => {
    const [competitors, setCompetitors] = useState<User[]>([]);
    
    useEffect(() => {
        const fetchCompetitors = async () => {
            try {
                const event = await api.getEventDetails(eventId);
                if (event.competitions && event.competitions.length > 0) {
                     const comp = event.competitions.find(c => c.status === 'ACTIVE') || event.competitions[0];
                     if (comp && comp.competitorIds.length > 0) {
                         const users = await api.getUsersByIds(comp.competitorIds);
                         setCompetitors(users);
                     }
                }
            } catch (e) {
                console.error("Failed to load competitors", e);
            }
        };
        fetchCompetitors();
    }, [eventId]);

    if (competitors.length === 0) return null;

    return (
        <div className="relative">
            <select 
                id="support-artist"
                value={selected} 
                onChange={(e) => onSelect(e.target.value)}
                className="w-full h-12 px-4 bg-neutral-800 border border-neutral-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none"
            >
                {competitors.map(comp => (
                    <option key={comp.id} value={comp.id}>Support {comp.name}</option>
                ))}
            </select>
             <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-neutral-400">
                <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
            </div>
        </div>
    );
};

export default EventDetails;

--- END OF FILE ./pages/EventDetails.tsx ---




--- START OF FILE ./pages/EventAdmin.tsx ---


import React, { useState, useEffect, useCallback } from 'react';
import { useParams, useNavigate, Navigate } from 'react-router-dom';
import * as api from '../services/api';
import { useAuth } from '../contexts/AuthContext';
import { Event as EventType } from '../types';
import { extractEventId } from '../utils/url';

// Import new modular components
import AdminSidebar from '../components/admin/AdminSidebar';
import ReportsTab from '../components/admin/ReportsTab';
import CheckInTab from '../components/admin/CheckInTab';
import DetailsTab from '../components/admin/DetailsTab';
import TicketingTab from '../components/admin/TicketingTab'; // NEW
import MarketingTab from '../components/admin/MarketingTab'; // NEW
import SectionsTab from '../components/admin/SectionsTab';
import ScheduleTab from '../components/admin/ScheduleTab';
import OrdersTab from '../components/admin/OrdersTab';

const EventAdmin: React.FC = () => {
    const { id: slugParam, tab } = useParams<{ id: string, tab: string }>();
    const eventId = extractEventId(slugParam);
    const navigate = useNavigate();
    const { user, isAuthenticated } = useAuth();
    
    const [event, setEvent] = useState<EventType | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    const activeTab = tab || 'reports';

    const fetchEvent = useCallback(async () => {
        if (!eventId) {
            navigate('/events');
            return;
        }
        try {
            const eventData = await api.getEventDetails(eventId);
            
            if (user && (user.isSystemAdmin || user.managedHostIds.includes(eventData.hostId))) {
                setEvent(eventData);
            } else {
                setError("You are not authorized to manage this event.");
            }
        } catch (err) {
            setError('Failed to load event details.');
            console.error(err);
        } finally {
            setIsLoading(false);
        }
    }, [eventId, user, navigate]);
    
    useEffect(() => {
        if (!isAuthenticated) {
            navigate('/');
            return;
        }
        if (user) {
            fetchEvent();
        }
    }, [user, isAuthenticated, fetchEvent, navigate]);

    const renderContent = () => {
        if (!event) return null;
        switch (activeTab) {
            case 'reports': return <ReportsTab eventId={event.id} />;
            case 'checkin': return <CheckInTab eventId={event.id} />;
            case 'details': return <DetailsTab event={event} onEventUpdate={fetchEvent}/>;
            case 'ticketing': return <TicketingTab event={event} onEventUpdate={fetchEvent} />;
            case 'marketing': return <MarketingTab event={event} onEventUpdate={fetchEvent} />;
            case 'sections': return <SectionsTab event={event} onEventUpdate={fetchEvent} />;
            case 'schedule': return <ScheduleTab event={event} onEventUpdate={fetchEvent} />;
            case 'orders': return <OrdersTab eventId={event.id} />;
            default: return <Navigate to={`/event/${eventId}/admin/reports`} replace />;
        }
    };

    if (isLoading) return <div className="text-center py-20 text-neutral-400">Loading Event Dashboard...</div>;
    if (error) return <div className="text-center py-20 text-red-400">{error}</div>;
    if (!event) return <div className="text-center py-20 text-neutral-400">Event not found.</div>;

    return (
        <div className="container mx-auto max-w-7xl px-6 py-16">
             <div className="flex flex-col md:flex-row gap-8 lg:gap-12">
                <AdminSidebar event={event} activeTab={activeTab} user={user} />
                <main className="flex-1 min-w-0">
                    {renderContent()}
                </main>
             </div>
        </div>
    );
};

export default EventAdmin;

--- END OF FILE ./pages/EventAdmin.tsx ---




--- START OF FILE ./pages/Dashboard.tsx ---

[ Skipped binary file ]

--- END OF FILE ./pages/Dashboard.tsx ---




--- START OF FILE ./pages/ProfilePage.tsx ---


import React, { useState, useEffect, useMemo, useRef } from 'react';
import { useParams } from 'react-router-dom';
import { v4 as uuidv4 } from 'uuid';

import * as api from '../services/api';
import { useAuth } from '../contexts/AuthContext';
import { User, ArtistProfile, ProfileSection } from '../types';
import { SaveIcon, CheckCircleIcon, UploadCloudIcon, UserIcon } from '../components/Icons';
import AddSectionBar from '../components/AddSectionBar';
import SectionEditor from '../components/SectionEditor';

const ProfilePage: React.FC = () => {
    const { id } = useParams<{ id: string }>();
    const { user: currentUser } = useAuth();
    const [profileUser, setProfileUser] = useState<User | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [isEditing, setIsEditing] = useState(false);
    
    // Create a separate state for the profile being edited
    const [editedProfile, setEditedProfile] = useState<ArtistProfile | null>(null);
    
    const [isSaving, setIsSaving] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);
    
    // Upload state tracking
    const [uploadingField, setUploadingField] = useState<'header' | 'profile' | null>(null);

    // Refs for file inputs and drag-and-drop
    const headerInputRef = useRef<HTMLInputElement>(null);
    const profileInputRef = useRef<HTMLInputElement>(null);
    const [draggingIndex, setDraggingIndex] = useState<number | null>(null);
    const dragItem = useRef<number | null>(null);
    const dragOverItem = useRef<number | null>(null);
    
    const isOwner = useMemo(() => currentUser?.id === id, [currentUser, id]);

    useEffect(() => {
        const fetchProfile = async () => {
            if (!id) return;
            setIsLoading(true);
            try {
                const fetchedUser = await api.getProfileForView(id);
                setProfileUser(fetchedUser);
                // Initialize the editedProfile state when data is fetched
                setEditedProfile(fetchedUser.artistProfile || {});
            } catch (err) {
                setError("Artist profile not found.");
            } finally {
                setIsLoading(false);
            }
        };
        fetchProfile();
    }, [id]);

    const handleEditToggle = () => {
        if (isEditing) {
            // If cancelling edit, revert changes
            setEditedProfile(profileUser?.artistProfile || {});
        }
        setIsEditing(!isEditing);
    };
    
    const handleProfileChange = (newProfileData: Partial<ArtistProfile>) => {
        setEditedProfile(prev => ({ ...prev, ...newProfileData } as ArtistProfile));
    };

    const handleImageChange = async (event: React.ChangeEvent<HTMLInputElement>, type: 'header' | 'profile') => {
        const file = event.target.files?.[0];
        if (!file) return;

        // 1. Instant Preview with Object URL
        const objectUrl = URL.createObjectURL(file);
        const field = type === 'header' ? 'headerImageUrl' : 'profileImageUrl';
        
        // Update local state with preview
        handleProfileChange({ [field]: objectUrl });
        
        // Set uploading state
        setUploadingField(type);

        try {
            // 2. Upload file
            const uploadedUrl = await api.uploadFile(file);
            // 3. Update state with remote URL
            handleProfileChange({ [field]: uploadedUrl });
        } catch (error) {
            console.error("Image upload failed", error);
            alert("Failed to upload image. Please try again.");
        } finally {
            setUploadingField(null);
            // Reset input
            if (type === 'header' && headerInputRef.current) headerInputRef.current.value = '';
            if (type === 'profile' && profileInputRef.current) profileInputRef.current.value = '';
        }
    };
    
    const handleSectionChange = (updatedSection: ProfileSection) => {
        setEditedProfile(prev => {
            if (!prev || !prev.sections) return prev;
            const newSections = prev.sections.map(s => s.id === updatedSection.id ? updatedSection : s);
            return { ...prev, sections: newSections };
        });
    };

    const handleAddSection = (type: ProfileSection['type']) => {
        const newSection: ProfileSection = {
            id: uuidv4(),
            type,
            content: {}
        };
        switch (type) {
            case 'TEXT':
                newSection.content = { title: 'New Section', body: 'Start writing here...' };
                break;
            case 'GALLERY':
                newSection.content = { images: [] };
                break;
            case 'SOUNDCLOUD':
                newSection.content = { url: '' };
                break;
            case 'YOUTUBE':
                newSection.content = { url: '' };
                break;
        }
        setEditedProfile(prev => ({
            ...prev,
            sections: [...(prev?.sections || []), newSection]
        } as ArtistProfile));
    };
    
     const handleDeleteSection = (idToDelete: string) => {
        setEditedProfile(prev => {
            if (!prev || !prev.sections) return prev;
            return { ...prev, sections: prev.sections.filter(s => s.id !== idToDelete) };
        });
    };

    const handleDragSort = () => {
        if (!editedProfile?.sections || dragItem.current === null || dragOverItem.current === null) {
            setDraggingIndex(null);
            return;
        }

        const items = [...editedProfile.sections];
        const [reorderedItem] = items.splice(dragItem.current, 1);
        items.splice(dragOverItem.current, 0, reorderedItem);

        dragItem.current = null;
        dragOverItem.current = null;
        setDraggingIndex(null);

        handleProfileChange({ sections: items });
    };
    
    const handleSave = async () => {
        if (!id || !editedProfile) return;
        
        if (uploadingField) {
            alert("Please wait for images to finish uploading.");
            return;
        }

        setIsSaving(true);
        setSaveSuccess(false);
        try {
            await api.updateUserProfile(id, editedProfile);
            const refreshedUser = await api.getProfileForView(id);
            setProfileUser(refreshedUser);
            setEditedProfile(refreshedUser.artistProfile || {});
            setIsEditing(false);
            setSaveSuccess(true);
            setTimeout(() => setSaveSuccess(false), 2500);
        } catch (error) {
            console.error("Failed to save profile:", error);
            alert("Could not save profile. Please try again.");
        } finally {
            setIsSaving(false);
        }
    };
    
    if (isLoading) return <div className="text-center py-20">Loading profile...</div>;
    if (error) return <div className="text-center py-20 text-red-500">{error}</div>;
    if (!profileUser) return <div className="text-center py-20 text-neutral-400">User not found.</div>;

    // Check if profile is empty and user is NOT the owner
    if (!isOwner && !profileUser.artistProfile) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center text-center px-6 -mt-20 bg-[#0a0a0a]">
                <div className="w-24 h-24 bg-neutral-900 rounded-full flex items-center justify-center mb-6 border border-neutral-800">
                    <UserIcon className="w-10 h-10 text-neutral-600" />
                </div>
                <h2 className="text-2xl font-bold text-white mb-2">Profile Not Set Up</h2>
                <p className="text-neutral-400 max-w-md">This user hasn't customized their public profile yet.</p>
            </div>
        );
    }
    
    const profileToDisplay = isEditing ? editedProfile : (profileUser.artistProfile || {});

    return (
        <>
            {/* Parallax Background - Fixed, No Scroll Movement */}
            {profileToDisplay?.headerImageUrl && (
                <div
                className="fixed inset-0 z-[-1]"
                style={{
                    willChange: 'transform',
                }}
                >
                <div
                    className="absolute inset-0 bg-cover bg-center filter blur-3xl transform scale-125"
                    style={{ backgroundImage: `url(${profileToDisplay.headerImageUrl})` }}
                />
                </div>
            )}
            <div className="fixed inset-0 bg-black/80 z-[-1]" />
            <div className="min-h-screen">
                {/* Header and Profile Picture */}
                <div className="relative -mt-20 pt-20">
                    <div className="relative h-[40vh] min-h-[300px] bg-neutral-900 border-b border-neutral-800 group overflow-hidden">
                        {profileToDisplay?.headerImageUrl ? (
                            <img src={profileToDisplay.headerImageUrl} alt="Header" className="w-full h-full object-cover"/>
                        ) : (
                            <div className="w-full h-full bg-gradient-to-b from-neutral-800 to-neutral-900 flex items-center justify-center">
                                {isOwner && !isEditing && <p className="text-neutral-500 text-sm font-medium">No cover image set</p>}
                            </div>
                        )}
                        {isEditing && (
                            <>
                                <div 
                                    onClick={() => headerInputRef.current?.click()}
                                    className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer z-10"
                                >
                                    <div className="text-center text-white p-4 bg-black/30 rounded-lg backdrop-blur-sm border border-white/10">
                                        <UploadCloudIcon className="w-10 h-10 mx-auto" />
                                        <p className="font-semibold mt-2">Change Header Image</p>
                                    </div>
                                </div>
                                {uploadingField === 'header' && (
                                    <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-20 pointer-events-none">
                                        <div className="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                                    </div>
                                )}
                                <input
                                    ref={headerInputRef}
                                    type="file"
                                    accept="image/*"
                                    className="hidden"
                                    onChange={(e) => handleImageChange(e, 'header')}
                                />
                            </>
                        )}
                    </div>
                    <div className="container mx-auto max-w-5xl px-6">
                        <div className="relative -mt-20 md:-mt-24 flex flex-col md:flex-row items-center md:items-end">
                            <div className="relative w-40 h-40 md:w-48 md:h-48 rounded-full border-4 border-black bg-neutral-800 overflow-hidden flex-shrink-0 group shadow-2xl">
                                {profileToDisplay?.profileImageUrl ? (
                                    <img src={profileToDisplay.profileImageUrl} alt="Profile" className="w-full h-full object-cover"/>
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center bg-neutral-800">
                                        <span className="text-4xl font-bold text-neutral-600">{profileUser.name.charAt(0).toUpperCase()}</span>
                                    </div>
                                )}
                                {isEditing && (
                                    <>
                                        <div 
                                            onClick={() => profileInputRef.current?.click()}
                                            className="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer text-center text-white z-10"
                                        >
                                            <div>
                                                <UploadCloudIcon className="w-8 h-8 mx-auto"/>
                                                <p className="text-xs font-semibold mt-1">Change</p>
                                            </div>
                                        </div>
                                        {uploadingField === 'profile' && (
                                            <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-20 pointer-events-none">
                                                <div className="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                                            </div>
                                        )}
                                        <input
                                            ref={profileInputRef}
                                            type="file"
                                            accept="image/*"
                                            className="hidden"
                                            onChange={(e) => handleImageChange(e, 'profile')}
                                        />
                                    </>
                                )}
                            </div>
                            <div className="mt-4 md:ml-6 text-center md:text-left flex-grow">
                                {isEditing ? (
                                    <input
                                        type="text"
                                        value={editedProfile?.displayName || ''}
                                        onChange={(e) => handleProfileChange({ displayName: e.target.value })}
                                        className="w-full text-3xl md:text-5xl font-bold bg-transparent text-white focus:outline-none focus:ring-2 focus:ring-purple-500 rounded-lg -ml-2 px-2 py-1"
                                        placeholder="Your Display Name"
                                    />
                                ) : (
                                    <h1 className="text-3xl md:text-5xl font-bold text-white text-glow">
                                        {profileToDisplay?.displayName || profileUser.name}
                                    </h1>
                                )}
                            </div>
                            {isOwner && (
                                <div className="mt-4 md:ml-auto flex items-center gap-4 flex-shrink-0">
                                    {isEditing && (
                                        <button onClick={handleSave} disabled={isSaving || saveSuccess || !!uploadingField} className="px-5 py-2 text-sm font-semibold rounded-full transition-all duration-300 flex items-center justify-center min-w-[100px] bg-green-600 text-white hover:bg-green-500 shadow-lg shadow-green-500/20 disabled:bg-neutral-700 disabled:text-neutral-500 disabled:shadow-none">
                                            {isSaving ? 'Saving...' : saveSuccess ? <><CheckCircleIcon className="w-5 h-5 mr-2"/>Saved!</> : <><SaveIcon className="w-4 h-4 mr-2"/>Save</>}
                                        </button>
                                    )}
                                    <button onClick={handleEditToggle} className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20">
                                        {isEditing ? 'Cancel' : 'Edit Profile'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                
                {/* Page Content */}
                <main className="container mx-auto max-w-5xl px-6 py-12">
                    {isEditing ? (
                        <div className="space-y-8 pb-32">
                            <div className="text-center p-4 bg-neutral-900/50 border border-neutral-800 rounded-xl mb-8">
                                <p className="text-neutral-400 text-sm">Click the + buttons below to add content sections. Drag to reorder.</p>
                            </div>
                            
                            {editedProfile?.sections?.map((section, index) => (
                                <div
                                    key={section.id}
                                    draggable
                                    onDragStart={() => {
                                        dragItem.current = index;
                                        setDraggingIndex(index);
                                    }}
                                    onDragEnter={() => {
                                        dragOverItem.current = index;
                                    }}
                                    onDragEnd={handleDragSort}
                                    onDragOver={(e) => e.preventDefault()}
                                    className={`transition-all ${draggingIndex === index ? 'opacity-50 scale-[1.02] shadow-2xl shadow-purple-500/20' : ''}`}
                                >
                                    <SectionEditor
                                        section={section}
                                        onUpdate={handleSectionChange}
                                        onDelete={handleDeleteSection}
                                    />
                                </div>
                            ))}
                            
                            {(!editedProfile?.sections || editedProfile.sections.length === 0) && (
                                <div className="text-center py-12 border-2 border-dashed border-neutral-800 rounded-2xl">
                                    <p className="text-neutral-500">Your profile is empty. Add a section to get started.</p>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="space-y-12">
                            {profileToDisplay?.sections?.map(section => (
                                <section key={section.id} className="animate-fade-in">
                                    {section.type === 'TEXT' && (
                                        <div className="prose prose-invert max-w-none">
                                            <h2 className="text-2xl font-bold text-white mb-4">{section.content.title}</h2>
                                            <p className="text-neutral-300 leading-relaxed whitespace-pre-wrap text-lg">{section.content.body}</p>
                                        </div>
                                    )}
                                    {section.type === 'GALLERY' && section.content.images?.length > 0 && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                            {section.content.images.map((img: string, index: number) => (
                                                <div key={index} className="aspect-video bg-neutral-900 rounded-xl overflow-hidden border border-neutral-800 hover:border-purple-500/50 transition-colors">
                                                    <img src={img} alt={`Gallery item ${index}`} className="w-full h-full object-cover"/>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {section.type === 'SOUNDCLOUD' && section.content.url && (
                                        <div className="rounded-xl overflow-hidden border border-neutral-800 shadow-lg">
                                            <iframe title="SoundCloud" width="100%" height="166" scrolling="no" frameBorder="no" allow="autoplay" src={section.content.url}></iframe>
                                        </div>
                                    )}
                                    {section.type === 'YOUTUBE' && section.content.url && (
                                        <div className="aspect-video rounded-xl overflow-hidden border border-neutral-800 shadow-lg">
                                            <iframe width="100%" height="100%" src={section.content.url} title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                                        </div>
                                    )}
                                </section>
                            ))}
                            
                            {(!profileToDisplay?.sections || profileToDisplay.sections.length === 0) && isOwner && (
                                <div className="text-center py-12">
                                    <p className="text-neutral-500 mb-4">Your profile is currently empty.</p>
                                    <button onClick={handleEditToggle} className="text-purple-400 hover:text-white font-semibold underline">Start Building</button>
                                </div>
                            )}
                        </div>
                    )}
                </main>
                {isEditing && <AddSectionBar onAddSection={handleAddSection} />}
            </div>
        </>
    );
};

export default ProfilePage;

--- END OF FILE ./pages/ProfilePage.tsx ---




--- START OF FILE ./pages/PublicFormPage.tsx ---


import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import * as api from '../services/api';
import { CompetitionForm, Event as EventType } from '../types';
import { CheckCircleIcon, UploadCloudIcon, ArrowRightIcon, LockIcon } from '../components/Icons';
import { useAuth } from '../contexts/AuthContext';
import SignInModal from '../components/SignInModal';

const PublicFormPage: React.FC = () => {
    const { id } = useParams<{ id: string }>();
    const navigate = useNavigate();
    const { user, isAuthenticated } = useAuth();
    
    const [form, setForm] = useState<CompetitionForm | null>(null);
    const [relatedEvent, setRelatedEvent] = useState<EventType | null>(null);
    
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [formData, setFormData] = useState<Record<string, any>>({});
    const [emailInput, setEmailInput] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isSuccess, setIsSuccess] = useState(false);
    const [isSignInOpen, setIsSignInOpen] = useState(false);

    // Sync email with authenticated user
    useEffect(() => {
        if (user?.email) {
            setEmailInput(user.email);
        }
    }, [user]);

    useEffect(() => {
        if (!id) return;
        const fetchFormAndEvent = async () => {
            try {
                let foundForm: CompetitionForm | null = null;
                let parentEvent: EventType | undefined = undefined;

                // 1. Try Direct Lookup
                try {
                    const response = await api.getPublicForm(id);
                    // Explicitly check for null/undefined/empty object which might come from JSON.parse("null")
                    if (response && Object.keys(response).length > 0) {
                        foundForm = response;
                    }
                } catch (e) {
                    console.warn("Direct form lookup failed, attempting rescue scan...", e);
                }

                // 2. Fallback / Parent Search ("Rescue Scan")
                // If direct lookup failed (backend bug) OR we need the parent event anyway:
                if (!foundForm || !parentEvent) {
                    console.log("Scanning events for form:", id);
                    try {
                        // Fetch general events feed to scan for the form
                        const allEvents = await api.getFeaturedEvents(); 
                        
                        for (const evt of allEvents) {
                            const match = evt.forms?.find(f => f.id === id);
                            if (match) {
                                // If we didn't have the form yet, use this one
                                if (!foundForm) foundForm = match;
                                // We found the parent event
                                parentEvent = evt;
                                console.log("Form found via scan in event:", evt.id);
                                break;
                            }
                        }
                    } catch (scanErr) {
                        console.error("Form rescue scan failed", scanErr);
                    }
                }

                if (!foundForm) {
                    throw new Error("Form not found. The event may be unpublished or the form ID is incorrect.");
                }

                setForm(foundForm);
                if (parentEvent) {
                    setRelatedEvent(parentEvent);
                }
            } catch (err: any) {
                console.error(err);
                setError(err.message || "Form not found.");
            } finally {
                setIsLoading(false);
            }
        };
        fetchFormAndEvent();
    }, [id]);

    const handleInputChange = (elementId: string, value: any) => {
        setFormData(prev => ({ ...prev, [elementId]: value }));
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!form) return;
        
        // Ensure email is provided (either auto-populated or manual)
        if (!emailInput.trim()) {
            alert("Please enter your email address.");
            return;
        }

        setIsSubmitting(true);
        try {
            // 1. Submit the form data with email and linked competition ID
            const submissionPayload = {
                ...formData,
                email: emailInput,
                linked_competition_id: form.linkedCompetitionId // Help backend automate linkage
            };
            
            await api.submitFormResponse(form.id, submissionPayload);
            
            // 2. Join competition explicitly if authenticated (immediate UI update safe-guard)
            // Guests cannot "join" a competition in the context of the leaderboard without an account
            if (relatedEvent && user) {
                if (form.linkedCompetitionId) {
                    await api.joinCompetition(user.id, relatedEvent, form.linkedCompetitionId);
                } else {
                    await api.joinCompetition(user.id, relatedEvent);
                }
            } 

            setIsSuccess(true);
        } catch (err) {
            console.error(err);
            alert("Failed to submit form. Please try again.");
        } finally {
            setIsSubmitting(false);
        }
    };

    if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-black text-neutral-500">Loading form...</div>;
    if (error || !form) return <div className="min-h-screen flex items-center justify-center bg-black text-red-400 p-4 text-center">{error || 'Form not found'}</div>;

    if (isSuccess) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-black p-6 relative overflow-hidden">
                 {form.headerImageUrl && (
                    <div 
                        className="absolute inset-0 z-0 opacity-30 blur-3xl scale-110"
                        style={{ backgroundImage: `url(${form.headerImageUrl})`, backgroundSize: 'cover', backgroundPosition: 'center' }}
                    ></div>
                )}
                <div className="max-w-md w-full bg-neutral-900/80 backdrop-blur-xl border border-white/10 rounded-3xl p-10 text-center shadow-2xl relative z-10 animate-fade-in-up">
                    <div className="w-20 h-20 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-500/30">
                        <CheckCircleIcon className="w-10 h-10" />
                    </div>
                    <h2 className="text-3xl font-bold text-white mb-4">Submission Received!</h2>
                    <p className="text-neutral-300 mb-8">Thank you for your submission! You'll receive an email shortly with more information.</p>
                    <button onClick={() => navigate('/')} className="text-purple-400 hover:text-white font-semibold text-sm transition-colors flex items-center justify-center gap-2 mx-auto">
                        Go to Eventsta <ArrowRightIcon className="w-4 h-4" />
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-[#050505] relative text-neutral-200 font-sans selection:bg-purple-500/30 overflow-x-hidden">
            {/* Full Page Blurred Background */}
            <div className="fixed inset-0 z-0 pointer-events-none">
                {form.headerImageUrl ? (
                    <div 
                        className="absolute inset-0 bg-cover bg-center transform scale-110"
                        style={{ 
                            backgroundImage: `url(${form.headerImageUrl})`,
                        }}
                    >
                        <div className="absolute inset-0 backdrop-blur-[80px] bg-black/70"></div>
                    </div>
                ) : (
                    <div className="absolute inset-0 bg-[#050505]"></div>
                )}
            </div>

            <div className="relative z-10 container mx-auto max-w-3xl px-4 py-12 md:py-20">
                {/* Form Card */}
                <div className="bg-neutral-900/90 backdrop-blur-xl border border-white/10 rounded-3xl shadow-2xl overflow-hidden animate-fade-in-up">
                    
                    {/* Header Image Inside Card */}
                    {form.headerImageUrl && (
                        <div className="w-full aspect-[3/1] bg-neutral-800/50 border-b border-white/5 relative overflow-hidden">
                            <img 
                                src={form.headerImageUrl} 
                                alt={form.title} 
                                className="w-full h-full object-cover"
                            />
                            <div className="absolute inset-0 bg-gradient-to-t from-neutral-900/80 to-transparent"></div>
                        </div>
                    )}

                    <div className="p-8 md:p-12">
                        {/* Intro */}
                        <div className="mb-10 text-center md:text-left">
                            <h1 className="text-4xl md:text-5xl font-black text-white mb-4 tracking-tight leading-tight">{form.title}</h1>
                            <div 
                                className="text-lg text-neutral-300 leading-relaxed prose prose-invert max-w-none"
                                dangerouslySetInnerHTML={{ __html: form.description }}
                            />
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-8">
                            {/* Standard Email Field */}
                            <div className="space-y-3">
                                <label className="block text-lg font-medium text-white flex justify-between items-center">
                                    <span>Email Address <span className="text-purple-500">*</span></span>
                                    {isAuthenticated && (
                                        <span className="text-xs font-normal text-green-400 bg-green-500/10 border border-green-500/20 rounded-full px-2 py-0.5 flex items-center gap-1">
                                            <LockIcon className="w-3 h-3"/> Authenticated
                                        </span>
                                    )}
                                </label>
                                <input 
                                    type="email" 
                                    required
                                    placeholder="name@example.com"
                                    value={emailInput}
                                    onChange={e => setEmailInput(e.target.value)}
                                    readOnly={isAuthenticated}
                                    className={`w-full bg-black/20 border border-neutral-700 rounded-xl px-5 py-4 text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all ${isAuthenticated ? 'opacity-70 cursor-not-allowed bg-neutral-800/50' : ''}`}
                                />
                                {!isAuthenticated && (
                                    <p className="text-sm text-neutral-500">
                                        <button type="button" onClick={() => setIsSignInOpen(true)} className="text-purple-400 hover:text-white underline">Sign in</button> to link this to your account.
                                    </p>
                                )}
                            </div>

                            {form.elements.map(element => (
                                <div key={element.id} className="space-y-3">
                                    <label className="block text-lg font-medium text-white">
                                        {element.label} {element.required && <span className="text-purple-500">*</span>}
                                    </label>
                                    
                                    {element.type === 'SHORT_TEXT' && (
                                        <input 
                                            type="text" 
                                            required={element.required}
                                            placeholder={element.placeholder}
                                            value={formData[element.id] || ''}
                                            onChange={e => handleInputChange(element.id, e.target.value)}
                                            className="w-full bg-black/20 border border-neutral-700 rounded-xl px-5 py-4 text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all"
                                        />
                                    )}

                                    {element.type === 'LONG_TEXT' && (
                                        <textarea 
                                            rows={4}
                                            required={element.required}
                                            placeholder={element.placeholder}
                                            value={formData[element.id] || ''}
                                            onChange={e => handleInputChange(element.id, e.target.value)}
                                            className="w-full bg-black/20 border border-neutral-700 rounded-xl px-5 py-4 text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all resize-none"
                                        />
                                    )}

                                    {element.type === 'SINGLE_CHOICE' && (
                                        <div className="space-y-2">
                                            {element.options?.map(option => (
                                                <label key={option.id} className="flex items-center space-x-3 p-4 rounded-xl bg-black/20 border border-neutral-800 hover:border-neutral-600 hover:bg-neutral-800/50 transition-all cursor-pointer group">
                                                    <input 
                                                        type="radio" 
                                                        name={element.id}
                                                        required={element.required}
                                                        value={option.label}
                                                        checked={formData[element.id] === option.label}
                                                        onChange={e => handleInputChange(element.id, e.target.value)}
                                                        className="w-5 h-5 text-purple-600 bg-neutral-800 border-neutral-600 focus:ring-purple-500 focus:ring-2 focus:ring-offset-0"
                                                    />
                                                    <span className="text-neutral-300 group-hover:text-white transition-colors font-medium">{option.label}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}

                                    {element.type === 'MULTIPLE_CHOICE' && (
                                        <div className="space-y-2">
                                            {element.options?.map(option => (
                                                <label key={option.id} className="flex items-center space-x-3 p-4 rounded-xl bg-black/20 border border-neutral-800 hover:border-neutral-600 hover:bg-neutral-800/50 transition-all cursor-pointer group">
                                                    <input 
                                                        type="checkbox" 
                                                        value={option.label}
                                                        checked={(formData[element.id] || []).includes(option.label)}
                                                        onChange={e => {
                                                            const current = formData[element.id] || [];
                                                            const updated = e.target.checked 
                                                                ? [...current, option.label]
                                                                : current.filter((v: string) => v !== option.label);
                                                            handleInputChange(element.id, updated);
                                                        }}
                                                        className="w-5 h-5 rounded text-purple-600 bg-neutral-800 border-neutral-600 focus:ring-purple-500 focus:ring-2 focus:ring-offset-0"
                                                    />
                                                    <span className="text-neutral-300 group-hover:text-white transition-colors font-medium">{option.label}</span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}

                            <div className="pt-8 border-t border-white/10">
                                <button 
                                    type="submit" 
                                    disabled={isSubmitting}
                                    className="w-full h-16 bg-purple-600 hover:bg-purple-500 text-white text-lg font-bold rounded-2xl shadow-lg shadow-purple-600/20 transition-all transform hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isSubmitting ? 'Submitting...' : <>Submit Application <ArrowRightIcon className="w-6 h-6" /></>}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div className="text-center mt-8 text-neutral-500 text-sm">
                    Powered by <span className="font-bold text-neutral-400">Eventsta</span>
                </div>
            </div>
            
            <SignInModal 
                isOpen={isSignInOpen} 
                onClose={() => setIsSignInOpen(false)} 
                context="application" 
            />
        </div>
    );
};

export default PublicFormPage;

--- END OF FILE ./pages/PublicFormPage.tsx ---




--- START OF FILE ./pages/Home.tsx ---


import React, { useState, useEffect } from 'react';
import { getFeaturedEvents } from '../services/api';
import { Event } from '../types';
import HeroSlider from '../components/HeroSlider';
import { EventCard } from '../components/EventCard';
import SEOHead from '../components/SEOHead';

const Home: React.FC = () => {
  const [events, setEvents] = useState<Event[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchEvents = async () => {
      try {
        setIsLoading(true);
        const fetchedEvents = await getFeaturedEvents();
        setEvents(fetchedEvents);
        setError(null);
      } catch (err) {
        setError("Failed to load events.");
        console.error(err);
      } finally {
        setIsLoading(false);
      }
    };
    fetchEvents();
  }, []);

  return (
    <div className="flex flex-col min-h-[calc(100vh-80px)]">
      <SEOHead 
        title="Discover Events" 
        description="Find the best concerts, festivals, and parties near you with Eventsta." 
      />
      
      <div className="flex-grow">
        <HeroSlider events={events} />
        <section className="container mx-auto max-w-7xl px-6 py-24 relative z-10">
          <h2 className="text-4xl font-bold tracking-tight text-white mb-12 text-glow">Upcoming Events</h2>
          {isLoading ? (
            <p className="text-neutral-400">Loading events...</p>
          ) : error ? (
            <p className="text-red-400">{error}</p>
          ) : (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              {events.map(event => (
                <EventCard key={event.id} event={event} />
              ))}
            </div>
          )}
        </section>
      </div>

      <footer className="relative z-10 w-full py-8 mt-auto border-t border-white/5 bg-black/30 backdrop-blur-xl text-center">
          <p className="text-neutral-400 text-sm font-medium tracking-wide">
              Non-profit Event Management Platform by <span className="text-neutral-200">Community Arts and Festivals</span>
          </p>
      </footer>
    </div>
  );
};

export default Home;

--- END OF FILE ./pages/Home.tsx ---




--- START OF FILE ./pages/HostPortal.tsx ---




















import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import * as api from '../services/api';
import { Event, Host } from '../types';
import HostEventFlow from '../components/HostEventFlow';
import PortalHeader from '../components/PortalHeader';
import { PlusIcon, SettingsIcon, MapPinIcon, ArrowRightIcon, BarChartIcon, CalendarPlusIcon, DollarSignIcon, ClockIcon } from '../components/Icons';
import HostFinancialsDashboard from '../components/HostFinancialsDashboard';

const HostPortal: React.FC = () => {
    const { user, isAuthenticated, refreshUser } = useAuth();
    const navigate = useNavigate();
    const [isHostFlowOpen, setHostFlowOpen] = useState(false);
    const [selectedHostForNewEvent, setSelectedHostForNewEvent] = useState<Host | null>(null);
    const [activeTab, setActiveTab] = useState<'events' | 'financials'>('events');

    useEffect(() => {
        if (!isAuthenticated) {
        navigate('/');
        }
    }, [isAuthenticated, navigate]);

    const handleOpenHostFlow = (host: Host) => {
        setSelectedHostForNewEvent(host);
        setHostFlowOpen(true);
    };

    const handleEventCreated = (newEvent: Event) => {
        refreshUser();
        setHostFlowOpen(false);
        navigate(`/event/${newEvent.id}/admin/details`);
    };

    if (!user) {
        return <div className="text-center py-20">Loading...</div>;
    }

    return (
        <>
            <div className="container mx-auto max-w-7xl px-6 py-16">
                <PortalHeader 
                    title={activeTab === 'events' ? "Events" : "Financials"}
                    subtitle={activeTab === 'events' ? "Manage your host profiles and create new events." : "Track earnings, fees, and payouts across all your events."}
                >
                    <div className="flex bg-neutral-900 p-1 rounded-lg border border-neutral-800">
                        <button 
                            onClick={() => setActiveTab('events')}
                            className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${activeTab === 'events' ? 'bg-neutral-800 text-white shadow-sm' : 'text-neutral-400 hover:text-white'}`}
                        >
                            <CalendarPlusIcon className="w-4 h-4" /> Events
                        </button>
                        <button 
                            onClick={() => setActiveTab('financials')}
                            className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${activeTab === 'financials' ? 'bg-neutral-800 text-white shadow-sm' : 'text-neutral-400 hover:text-white'}`}
                        >
                            <DollarSignIcon className="w-4 h-4" /> Financials
                        </button>
                    </div>
                </PortalHeader>
                
                {activeTab === 'events' ? (
                    <HostingContent user={user} onAddEventClick={handleOpenHostFlow} />
                ) : (
                    <HostFinancialsDashboard user={user} />
                )}
            </div>
            <HostEventFlow 
                isOpen={isHostFlowOpen} 
                onClose={() => setHostFlowOpen(false)} 
                onEventCreated={handleEventCreated}
                host={selectedHostForNewEvent}
            />
        </>
    );
};

const HostingContent: React.FC<{ user: any, onAddEventClick: (host: Host) => void }> = ({ user, onAddEventClick }) => {
    const navigate = useNavigate();
    const [hosts, setHosts] = useState<Host[]>([]);
    const [events, setEvents] = useState<Event[]>([]);
    const [selectedHostId, setSelectedHostId] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [eventFilter, setEventFilter] = useState<'upcoming' | 'ended'>('upcoming');

    const fetchHosts = async () => {
        if (user.managedHostIds.length > 0) {
            const fetchedHosts = await api.getHostsByIds(user.managedHostIds);
            setHosts(fetchedHosts);
            if (!selectedHostId) {
                setSelectedHostId(fetchedHosts[0]?.id || null);
            }
        }
        setIsLoading(false);
    };

    useEffect(() => {
        setIsLoading(true);
        fetchHosts();
    }, [user.managedHostIds]);

    const selectedHost = hosts.find(h => h.id === selectedHostId);

    useEffect(() => {
        const fetchEvents = async () => {
            if (!selectedHostId) {
                setEvents([]);
                return;
            };
            
            try {
                // Strategy 1: Try getEventsByHost first (standard path)
                let fetchedEvents = await api.getEventsByHost(selectedHostId, true);
                
                // Strategy 2: If empty, but the host object has known event IDs, try fetching specific IDs.
                // This covers cases where backend filtering for drafts via host_id might be overly strict,
                // but direct ID lookups are permitted.
                if (fetchedEvents.length === 0 && selectedHost && selectedHost.eventIds.length > 0) {
                    console.log("getEventsByHost returned empty, falling back to ID lookup for potential drafts...");
                    try {
                        const fallbackEvents = await api.getEventsByIds(selectedHost.eventIds, true);
                        if (fallbackEvents.length > 0) {
                            fetchedEvents = fallbackEvents;
                        }
                    } catch (err) {
                        console.warn("Fallback ID fetch failed", err);
                    }
                }

                setEvents(fetchedEvents.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()));
            } catch (e) {
                console.error("Failed to fetch events for host", e);
                setEvents([]);
            }
        };
        if (selectedHostId) {
            fetchEvents();
        }
    }, [selectedHostId, selectedHost]); // Add selectedHost to dependency for fallback logic

    const filteredEvents = events.filter(event => {
        const isEnded = new Date(event.endDate || event.date) < new Date();
        // Drafts are always "upcoming" for management purposes unless ended in past
        return eventFilter === 'upcoming' ? !isEnded : isEnded;
    });

    if (isLoading) {
        return <p className="text-neutral-500">Loading hosts...</p>;
    }

    return (
        <div className="flex flex-col md:flex-row gap-8">
            <div className="w-full md:w-1/3 lg:w-1/4">
                <h3 className="text-xl font-bold text-white mb-4">Your Hosts</h3>
                <div className="space-y-2 mb-4">
                    {hosts.map(host => (
                         <button 
                            key={host.id} 
                            onClick={() => setSelectedHostId(host.id)} 
                            className={`w-full text-left px-4 py-3 font-medium rounded-lg transition-colors ${selectedHostId === host.id ? 'bg-purple-600/20 text-purple-300' : 'text-neutral-300 hover:bg-neutral-800'}`}
                         >
                            {host.name}
                        </button>
                    ))}
                </div>
                <button onClick={() => navigate('/settings', { state: { defaultTab: 'hosts' }})} className="w-full px-4 py-3 text-sm font-semibold text-purple-400 hover:text-white bg-purple-500/10 hover:bg-purple-500/20 rounded-lg transition-colors flex items-center justify-center space-x-2">
                    <span>Manage Host Profiles</span>
                    <ArrowRightIcon className="w-4 h-4" />
                </button>
            </div>
            <div className="w-full md:w-2/3 lg:w-3/4">
                {selectedHost ? (
                    <div>
                         <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                            <h3 className="text-2xl font-bold text-white">Events for {selectedHost.name}</h3>
                            <button onClick={() => onAddEventClick(selectedHost)} className="w-full sm:w-auto px-6 py-3 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 flex items-center justify-center space-x-2">
                                <PlusIcon className="w-4 h-4" /><span>Host New Event</span>
                            </button>
                        </div>

                        {/* Event Filters */}
                        <div className="flex border-b border-neutral-800 mb-6">
                            <button 
                                onClick={() => setEventFilter('upcoming')}
                                className={`pb-3 px-4 text-sm font-medium border-b-2 transition-colors ${eventFilter === 'upcoming' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}
                            >
                                Upcoming
                            </button>
                            <button 
                                onClick={() => setEventFilter('ended')}
                                className={`pb-3 px-4 text-sm font-medium border-b-2 transition-colors ${eventFilter === 'ended' ? 'border-purple-500 text-white' : 'border-transparent text-neutral-400 hover:text-white'}`}
                            >
                                Ended
                            </button>
                        </div>

                        {filteredEvents.length > 0 ? (
                             <div className="space-y-6">
                                {filteredEvents.map(event => (
                                    <div key={event.id} className="event-card w-full text-left bg-neutral-900 rounded-2xl overflow-hidden flex flex-row shadow-lg border border-neutral-800 relative group">
                                        {event.status === 'DRAFT' && (
                                            <div className="absolute top-3 left-3 z-10 bg-yellow-500/20 text-yellow-400 text-xs font-bold px-2 py-1 rounded border border-yellow-500/30 shadow-md backdrop-blur-md">
                                                DRAFT - HIDDEN
                                            </div>
                                        )}
                                        {eventFilter === 'ended' && (
                                            <div className="absolute top-3 left-3 z-10 bg-neutral-800 text-neutral-400 text-xs font-bold px-2 py-1 rounded border border-neutral-700 shadow-md flex items-center gap-1">
                                                <ClockIcon className="w-3 h-3" /> ENDED
                                            </div>
                                        )}
                                        <div className="relative w-32 md:w-40 flex-shrink-0 bg-neutral-800">
                                            <img src={event.imageUrls[0]} alt={event.title} className={`w-full h-36 object-cover ${event.status === 'DRAFT' || eventFilter === 'ended' ? 'opacity-50 grayscale' : ''}`}/>
                                        </div>
                                        <div className="p-5 md:p-6 flex-grow flex flex-col justify-center overflow-hidden">
                                            <h3 className="text-lg md:text-xl font-bold text-white mb-2 truncate">{event.title}</h3>
                                            <p className="text-neutral-400 text-sm flex items-center gap-2 truncate">
                                                <MapPinIcon className="w-4 h-4 text-neutral-500 shrink-0" />
                                                <span>{new Date(event.date).toLocaleDateString()} â€¢ {event.location}</span>
                                            </p>
                                        </div>
                                        <div className="flex-shrink-0 flex flex-col">
                                            <button 
                                                onClick={() => navigate(`/event/${event.id}/admin/reports`)} 
                                                className="flex-1 flex flex-col items-center justify-center w-28 bg-neutral-900 hover:bg-purple-600 text-neutral-400 hover:text-white transition-all duration-300 border-b border-neutral-800"
                                                aria-label={`Manage event ${event.title}`}
                                            >
                                                <SettingsIcon className="w-6 h-6" />
                                                <span className="text-xs font-medium mt-1">MANAGE</span>
                                            </button>
                                            <button 
                                                onClick={() => navigate(`/event/${event.id}/admin/reports`)} 
                                                className="flex-1 flex flex-col items-center justify-center w-28 bg-neutral-900 hover:bg-blue-600 text-neutral-400 hover:text-white transition-all duration-300"
                                                aria-label={`View reports for ${event.title}`}
                                            >
                                                <BarChartIcon className="w-6 h-6" />
                                                <span className="text-xs font-medium mt-1">REPORTS</span>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            }
                            </div>
                        ) : (
                             <div className="text-center py-16 bg-neutral-900/50 border-2 border-dashed border-neutral-800 rounded-2xl">
                                <CalendarPlusIcon className="w-12 h-12 mx-auto text-neutral-600 mb-4" />
                                <h3 className="text-xl font-bold text-white">
                                    {eventFilter === 'upcoming' ? 'No Upcoming Events' : 'No Past Events'}
                                </h3>
                                <p className="text-neutral-500 mt-2 mb-6 max-w-md mx-auto">
                                    {eventFilter === 'upcoming' ? "Ready to get the party started?" : "Your completed events will appear here."}
                                </p>
                                {eventFilter === 'upcoming' && (
                                    <button onClick={() => onAddEventClick(selectedHost)} className="px-6 py-3 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 flex items-center justify-center space-x-2 mx-auto">
                                        <PlusIcon className="w-4 h-4" /><span>Host New Event</span>
                                    </button>
                                )}
                            </div>
                        )}
                    </div>
                ) : (
                    <div className="text-center py-10">
                        <h3 className="text-xl font-bold text-white mb-2">No Host Accounts Found</h3>
                        <p className="text-neutral-500">Create a host profile in the settings to get started.</p>
                         <button onClick={() => navigate('/settings', { state: { defaultTab: 'hosts' }})} className="mt-6 px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20">
                            Go to Settings
                          </button>
                    </div>
                )}
            </div>
        </div>
    );
};

export default HostPortal;

--- END OF FILE ./pages/HostPortal.tsx ---




--- START OF FILE ./pages/SystemAdmin.tsx ---


import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { v4 as uuidv4 } from 'uuid';
import { useAuth } from '../contexts/AuthContext';
import * as api from '../services/api';
import { User, Event, Host, PurchasedTicket, PromoStat, EmailDraft, EmailCampaign, TargetRole, PayoutRequest, SystemEmailTemplate, SystemEmailTrigger, SystemSettings } from '../types';
import { 
    ShieldIcon, UsersIcon, CalendarIcon, DollarSignIcon, 
    ActivityIcon, SearchIcon, BanIcon, CheckCircleIcon, 
    LockIcon, ServerIcon, ArrowRightIcon, SettingsIcon,
    BarChartIcon, ArrowLeftIcon, MapPinIcon, SaveIcon,
    TicketIcon, MegaphoneIcon, CreditCardIcon, MailIcon,
    PlusIcon, SendIcon, RefreshCwIcon, StopCircleIcon,
    TrashIcon, EditIcon, ClipboardIcon, XIcon, MenuIcon,
    LogOutIcon, ClockIcon, TerminalIcon
} from '../components/Icons';
import RichTextEditor from '../components/RichTextEditor';
import Modal from '../components/Modal';
import * as emailService from '../services/emailService';

// --- Main Layout & Router for Admin Panel ---

const SystemAdmin: React.FC = () => {
    const { user, isAuthenticated } = useAuth();
    const navigate = useNavigate();
    const location = useLocation();
    const [activeTab, setActiveTab] = useState<'dashboard' | 'users' | 'events' | 'email' | 'system-emails' | 'settings' | 'payouts'>('dashboard');
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

    useEffect(() => {
        if (!isAuthenticated) {
            navigate('/');
            return;
        }
        // Strict Role Check
        if (user && !user.isSystemAdmin) {
            navigate('/');
        }
    }, [user, isAuthenticated, navigate]);

    // Handle deep linking to tabs via state
    useEffect(() => {
        if (location.state && (location.state as any).activeTab) {
            setActiveTab((location.state as any).activeTab);
        }
        // Close mobile menu on navigation
        setIsMobileMenuOpen(false);
    }, [location.state]);

    if (!user || !user.isSystemAdmin) return null;

    const renderContent = () => {
        switch (activeTab) {
            case 'dashboard': return <AdminDashboard />;
            case 'users': return <AdminUserManagement />;
            case 'events': return <AdminEventManagement />;
            case 'email': return <AdminEmailManager />;
            case 'system-emails': return <AdminSystemEmailsManager />;
            case 'payouts': return <AdminPayoutsManager />;
            case 'settings': return <AdminSettings />;
            default: return <AdminDashboard />;
        }
    };

    return (
        <div className="flex h-screen bg-[#050505] overflow-hidden text-neutral-200 font-sans selection:bg-purple-500/30">
            {/* Desktop Sidebar (Shared Space) */}
            <aside className="hidden md:flex w-64 flex-col bg-neutral-950 border-r border-neutral-800 flex-shrink-0 transition-all duration-300">
                <div className="p-6 flex items-center gap-3 border-b border-neutral-800/50 h-20">
                    <div className="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-purple-500/20">
                        <ShieldIcon className="w-5 h-5" />
                    </div>
                    <div>
                        <h1 className="font-bold text-white tracking-tight leading-tight">Eventsta Admin</h1>
                        <p className="text-[10px] uppercase tracking-widest text-neutral-500 font-semibold">v3.0.1</p>
                    </div>
                </div>
                
                <nav className="flex-1 overflow-y-auto py-6 px-4 space-y-1 custom-scrollbar">
                    <SidebarItem id="dashboard" label="Dashboard" icon={BarChartIcon} active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                    <SidebarItem id="users" label="User Management" icon={UsersIcon} active={activeTab === 'users'} onClick={() => setActiveTab('users')} />
                    <SidebarItem id="events" label="Global Events" icon={CalendarIcon} active={activeTab === 'events'} onClick={() => setActiveTab('events')} />
                    <SidebarItem id="payouts" label="Payouts" icon={DollarSignIcon} active={activeTab === 'payouts'} onClick={() => setActiveTab('payouts')} />
                    <SidebarItem id="email" label="Email Campaigns" icon={MailIcon} active={activeTab === 'email'} onClick={() => setActiveTab('email')} />
                    <SidebarItem id="system-emails" label="System Emails" icon={TerminalIcon} active={activeTab === 'system-emails'} onClick={() => setActiveTab('system-emails')} />
                    <SidebarItem id="settings" label="System Settings" icon={SettingsIcon} active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} />
                    
                    <div className="pt-4 mt-4 border-t border-neutral-800/50">
                        <SidebarItem id="exit" label="Exit to Main Site" icon={LogOutIcon} active={false} onClick={() => navigate('/')} />
                    </div>
                </nav>

                <div className="p-4 border-t border-neutral-800/50 bg-neutral-900/30">
                    <div className="flex items-center gap-3">
                        <div className="relative">
                            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <div className="absolute inset-0 w-2 h-2 rounded-full bg-green-500 animate-ping opacity-75"></div>
                        </div>
                        <span className="text-xs text-green-400 font-mono font-medium">System Operational</span>
                    </div>
                </div>
            </aside>

            {/* Mobile Sidebar (Overlay Modal) */}
            <div className={`fixed inset-0 z-50 flex md:hidden transition-opacity duration-300 ${isMobileMenuOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}>
                {/* Backdrop */}
                <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setIsMobileMenuOpen(false)} />
                
                {/* Drawer */}
                <aside className={`relative w-72 flex flex-col bg-neutral-950 border-r border-neutral-800 h-full shadow-2xl transform transition-transform duration-300 ease-out ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                     <div className="p-4 flex items-center justify-between border-b border-neutral-800/50 h-16 bg-neutral-950">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center text-white">
                                <ShieldIcon className="w-5 h-5" />
                            </div>
                            <span className="font-bold text-white tracking-tight">Eventsta Admin</span>
                        </div>
                        <button onClick={() => setIsMobileMenuOpen(false)} className="text-neutral-400 hover:text-white p-2 rounded-lg hover:bg-neutral-800 transition-colors">
                            <XIcon className="w-6 h-6" />
                        </button>
                    </div>
                    <nav className="flex-1 overflow-y-auto p-4 space-y-2 bg-neutral-950">
                        <SidebarItem id="dashboard" label="Dashboard" icon={BarChartIcon} active={activeTab === 'dashboard'} onClick={() => { setActiveTab('dashboard'); setIsMobileMenuOpen(false); }} />
                        <SidebarItem id="users" label="User Management" icon={UsersIcon} active={activeTab === 'users'} onClick={() => { setActiveTab('users'); setIsMobileMenuOpen(false); }} />
                        <SidebarItem id="events" label="Global Events" icon={CalendarIcon} active={activeTab === 'events'} onClick={() => { setActiveTab('events'); setIsMobileMenuOpen(false); }} />
                        <SidebarItem id="payouts" label="Payouts" icon={DollarSignIcon} active={activeTab === 'payouts'} onClick={() => { setActiveTab('payouts'); setIsMobileMenuOpen(false); }} />
                        <SidebarItem id="email" label="Email Campaigns" icon={MailIcon} active={activeTab === 'email'} onClick={() => { setActiveTab('email'); setIsMobileMenuOpen(false); }} />
                        <SidebarItem id="system-emails" label="System Emails" icon={TerminalIcon} active={activeTab === 'system-emails'} onClick={() => { setActiveTab('system-emails'); setIsMobileMenuOpen(false); }} />
                        <SidebarItem id="settings" label="System Settings" icon={SettingsIcon} active={activeTab === 'settings'} onClick={() => { setActiveTab('settings'); setIsMobileMenuOpen(false); }} />
                        
                        <div className="pt-4 mt-4 border-t border-neutral-800/50">
                            <SidebarItem id="exit" label="Exit to Main Site" icon={LogOutIcon} active={false} onClick={() => navigate('/')} />
                        </div>
                    </nav>
                    <div className="p-4 border-t border-neutral-800/50">
                        <div className="flex items-center gap-3">
                            <div className="w-2 h-2 rounded-full bg-green-500"></div>
                            <span className="text-xs text-neutral-400">Mobile Mode</span>
                        </div>
                    </div>
                </aside>
            </div>

            {/* Main Content Wrapper */}
            <div className="flex-1 flex flex-col min-w-0 bg-[#050505] relative">
                {/* Mobile Header */}
                <header className="md:hidden flex items-center justify-between h-16 px-4 border-b border-neutral-800 bg-neutral-950/80 backdrop-blur-md sticky top-0 z-30 flex-shrink-0">
                    <div className="flex items-center gap-2">
                        <div className="w-6 h-6 bg-purple-600 rounded-md flex items-center justify-center text-white">
                            <ShieldIcon className="w-3 h-3" />
                        </div>
                        <span className="font-bold text-white text-sm tracking-tight">Admin Console</span>
                    </div>
                    <button onClick={() => setIsMobileMenuOpen(true)} className="text-neutral-400 hover:text-white p-2 -mr-2 rounded-lg active:bg-neutral-800 transition-colors">
                        <MenuIcon className="w-6 h-6" />
                    </button>
                </header>

                {/* Scrollable Content Area */}
                <main className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth custom-scrollbar">
                    <div className="max-w-7xl mx-auto pb-12">
                        {renderContent()}
                    </div>
                </main>
            </div>
        </div>
    );
};

const SidebarItem: React.FC<{ id: string, label: string, icon: React.FC<any>, active: boolean, onClick: () => void }> = ({ label, icon: Icon, active, onClick }) => (
    <button
        onClick={onClick}
        className={`w-full flex items-center px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 ${
            active 
            ? 'bg-purple-900/20 text-purple-300 border border-purple-500/20 shadow-[0_0_15px_rgba(168,85,247,0.15)]' 
            : 'text-neutral-400 hover:bg-neutral-900 hover:text-white border border-transparent'
        }`}
    >
        <Icon className={`w-5 h-5 mr-3 transition-colors ${active ? 'text-purple-400' : 'text-neutral-500 group-hover:text-white'}`} />
        {label}
    </button>
);

// --- DASHBOARD ---
const AdminDashboard: React.FC = () => {
    const [stats, setStats] = useState({ totalUsers: 0, totalEvents: 0, grossVolume: 0, platformFees: 0 });
    
    useEffect(() => {
        api.getSystemStats().then(setStats).catch(() => {
            // Fallback is handled in api.getSystemStats but extra catch here just in case
            setStats({ totalUsers: 0, totalEvents: 0, grossVolume: 0, platformFees: 0 });
        });
    }, []);

    return (
        <div className="space-y-8 animate-fade-in">
            <div>
                <h2 className="text-2xl font-bold text-white mb-2">System Overview</h2>
                <p className="text-neutral-400 text-sm">Real-time platform metrics.</p>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <StatCard label="Total Users" value={stats?.totalUsers?.toLocaleString() ?? '0'} icon={UsersIcon} color="blue" />
                <StatCard label="Total Events" value={stats?.totalEvents?.toLocaleString() ?? '0'} icon={CalendarIcon} color="purple" />
                <StatCard label="Gross Volume" value={`$${stats?.grossVolume?.toLocaleString() ?? '0'}`} icon={DollarSignIcon} color="green" />
                <StatCard label="Platform Fees" value={`$${stats?.platformFees?.toLocaleString() ?? '0'}`} icon={ActivityIcon} color="yellow" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4">System Health</h3>
                    <div className="space-y-4">
                        <HealthBar label="API Latency" value={24} max={100} unit="ms" status="good" />
                        <HealthBar label="Database Load" value={12} max={100} unit="%" status="good" />
                        <HealthBar label="Email Queue" value={0} max={50} unit="pending" status="good" />
                        <HealthBar label="Storage Usage" value={45} max={100} unit="%" status="warning" />
                    </div>
                </div>
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 flex flex-col justify-center items-center text-center">
                    <div className="w-16 h-16 bg-purple-900/20 rounded-full flex items-center justify-center mb-4">
                        <ServerIcon className="w-8 h-8 text-purple-400" />
                    </div>
                    <h3 className="text-lg font-bold text-white">All Systems Operational</h3>
                    <p className="text-neutral-400 text-sm mt-2">Last check: Just now</p>
                </div>
            </div>
        </div>
    );
};

const StatCard: React.FC<{ label: string, value: string, icon: any, color: 'blue'|'purple'|'green'|'yellow' }> = ({ label, value, icon: Icon, color }) => {
    const colors = {
        blue: 'text-blue-400 bg-blue-400/10',
        purple: 'text-purple-400 bg-purple-400/10',
        green: 'text-green-400 bg-green-400/10',
        yellow: 'text-yellow-400 bg-yellow-400/10'
    };
    
    return (
        <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 flex items-center justify-between">
            <div>
                <p className="text-neutral-400 text-xs font-bold uppercase tracking-wider mb-1">{label}</p>
                <p className="text-2xl font-bold text-white">{value}</p>
            </div>
            <div className="p-3 rounded-xl">
                <Icon className={`w-6 h-6 ${colors[color]}`} />
            </div>
        </div>
    );
};

const HealthBar: React.FC<{ label: string, value: number, max: number, unit: string, status: 'good'|'warning'|'critical' }> = ({ label, value, max, unit, status }) => {
    const percentage = Math.min((value / max) * 100, 100);
    const colors = {
        good: 'bg-green-500',
        warning: 'bg-yellow-500',
        critical: 'bg-red-500'
    };

    return (
        <div>
            <div className="flex justify-between text-xs mb-1">
                <span className="text-neutral-400 font-medium">{label}</span>
                <span className="text-white">{value} {unit}</span>
            </div>
            <div className="w-full bg-neutral-800 rounded-full h-2 overflow-hidden">
                <div className={`h-full rounded-full ${colors[status]}`} style={{ width: `${percentage}%` }}></div>
            </div>
        </div>
    );
};

// --- USER MANAGEMENT ---
const AdminUserManagement: React.FC = () => {
    const [users, setUsers] = useState<User[]>([]);
    const [page, setPage] = useState(1);
    const [search, setSearch] = useState('');
    const [total, setTotal] = useState(0);
    const [loading, setLoading] = useState(false);

    const fetchUsers = useCallback(async () => {
        setLoading(true);
        try {
            const res = await api.getAllUsersAdmin(page, 20, search);
            setUsers(res.users);
            setTotal(res.total);
        } catch (error) {
            console.error("Failed to load users:", error);
        } finally {
            setLoading(false);
        }
    }, [page, search]);

    useEffect(() => {
        fetchUsers();
    }, [fetchUsers]);

    const toggleStatus = async (userId: string, currentStatus: boolean) => {
        await api.updateUserStatus(userId, !currentStatus);
        fetchUsers();
    };

    return (
        <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-white">User Management</h2>
                <div className="relative">
                    <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500" />
                    <input 
                        type="text" 
                        placeholder="Search users..." 
                        value={search}
                        onChange={e => setSearch(e.target.value)}
                        className="bg-neutral-900 border border-neutral-800 rounded-full py-2 pl-10 pr-4 text-sm text-white focus:border-purple-500 outline-none w-64"
                    />
                </div>
            </div>

            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden">
                <table className="w-full text-sm text-left text-neutral-300">
                    <thead className="text-xs text-neutral-500 uppercase bg-neutral-950 border-b border-neutral-800">
                        <tr>
                            <th className="px-6 py-4">User</th>
                            <th className="px-6 py-4">Role</th>
                            <th className="px-6 py-4">Hosts</th>
                            <th className="px-6 py-4 text-center">Status</th>
                            <th className="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-800">
                        {users.map(user => (
                            <tr key={user.id} className="hover:bg-neutral-800/30 transition-colors">
                                <td className="px-6 py-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-neutral-800 flex items-center justify-center text-xs font-bold text-neutral-400">
                                            {user.name.charAt(0)}
                                        </div>
                                        <div>
                                            <p className="font-medium text-white">{user.name}</p>
                                            <p className="text-xs text-neutral-500">{user.email}</p>
                                        </div>
                                    </div>
                                </td>
                                <td className="px-6 py-4">
                                    {user.isSystemAdmin ? <span className="text-purple-400 font-bold">Admin</span> : 'User'}
                                </td>
                                <td className="px-6 py-4">
                                    {user.managedHostIds?.length || 0}
                                </td>
                                <td className="px-6 py-4 text-center">
                                    <span className={`inline-block px-2 py-1 rounded-full text-xs font-bold ${user.isDisabled ? 'bg-red-500/10 text-red-500' : 'bg-green-500/10 text-green-500'}`}>
                                        {user.isDisabled ? 'Disabled' : 'Active'}
                                    </span>
                                </td>
                                <td className="px-6 py-4 text-right">
                                    <button 
                                        onClick={() => toggleStatus(user.id, !!user.isDisabled)}
                                        className={`text-xs font-bold px-3 py-1 rounded border transition-colors ${
                                            user.isDisabled 
                                            ? 'border-green-500/30 text-green-400 hover:bg-green-500/10' 
                                            : 'border-red-500/30 text-red-400 hover:bg-red-500/10'
                                        }`}
                                    >
                                        {user.isDisabled ? 'Enable' : 'Disable'}
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// --- EVENT MANAGEMENT ---
const AdminEventManagement: React.FC = () => {
    const [events, setEvents] = useState<Event[]>([]);
    const [page, setPage] = useState(1);
    const [search, setSearch] = useState('');
    const [loading, setLoading] = useState(false);
    const navigate = useNavigate();

    const fetchEvents = useCallback(async () => {
        setLoading(true);
        const res = await api.getAllEventsAdmin(page, 20, search);
        setEvents(res.events);
        setLoading(false);
    }, [page, search]);

    useEffect(() => {
        fetchEvents();
    }, [fetchEvents]);

    return (
        <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-white">Global Events</h2>
                <div className="relative">
                    <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500" />
                    <input 
                        type="text" 
                        placeholder="Search events..." 
                        value={search}
                        onChange={e => setSearch(e.target.value)}
                        className="bg-neutral-900 border border-neutral-800 rounded-full py-2 pl-10 pr-4 text-sm text-white focus:border-purple-500 outline-none w-64"
                    />
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {events.map(event => (
                    <div key={event.id} className="bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden group hover:border-purple-500/50 transition-all">
                        <div className="h-32 bg-neutral-800 relative">
                            <img src={event.imageUrls[0]} alt="" className="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity" />
                            <div className="absolute top-2 right-2">
                                <span className={`px-2 py-1 rounded text-xs font-bold bg-black/50 text-white backdrop-blur-md`}>
                                    {event.status}
                                </span>
                            </div>
                        </div>
                        <div className="p-4">
                            <h3 className="font-bold text-white truncate mb-1">{event.title}</h3>
                            <p className="text-xs text-neutral-400 mb-4">{event.hostName} â€¢ {new Date(event.date).toLocaleDateString()}</p>
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-neutral-500">{event.location}</span>
                                <button 
                                    onClick={() => navigate(`/event/${event.id}/admin/reports`)}
                                    className="text-xs font-bold text-purple-400 hover:text-white flex items-center gap-1"
                                >
                                    Manage <ArrowRightIcon className="w-3 h-3" />
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

// --- EMAIL MANAGER ---
const AdminEmailManager: React.FC = () => {
    const [view, setView] = useState<'campaigns' | 'drafts' | 'compose'>('campaigns');
    const [draftToEdit, setDraftToEdit] = useState<EmailDraft | undefined>(undefined);

    const handleEditDraft = (draft: EmailDraft) => {
        setDraftToEdit(draft);
        setView('compose');
    };

    return (
        <div className="space-y-6 animate-fade-in h-[calc(100vh-120px)] flex flex-col">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-white">Email Campaigns</h2>
                <div className="flex bg-neutral-900 p-1 rounded-lg border border-neutral-800">
                    <button onClick={() => setView('campaigns')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${view === 'campaigns' ? 'bg-neutral-800 text-white' : 'text-neutral-400 hover:text-white'}`}>Campaigns</button>
                    <button onClick={() => setView('drafts')} className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${view === 'drafts' ? 'bg-neutral-800 text-white' : 'text-neutral-400 hover:text-white'}`}>Drafts</button>
                    <button onClick={() => { setDraftToEdit(undefined); setView('compose'); }} className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${view === 'compose' ? 'bg-purple-600 text-white' : 'text-neutral-400 hover:text-white'}`}>Compose</button>
                </div>
            </div>

            <div className="flex-1 overflow-hidden bg-neutral-900 border border-neutral-800 rounded-2xl relative">
                {view === 'campaigns' && <CampaignsView />}
                {view === 'drafts' && <DraftsView onEdit={handleEditDraft} />}
                {view === 'compose' && <ComposeView initialDraft={draftToEdit} onCancel={() => setView('drafts')} onSent={() => setView('campaigns')} />}
            </div>
        </div>
    );
};

const CampaignsView: React.FC = () => {
    const [campaigns, setCampaigns] = useState<EmailCampaign[]>([]);
    
    useEffect(() => {
        api.getEmailCampaigns().then(setCampaigns);
    }, []);

    return (
        <div className="p-6 h-full overflow-y-auto custom-scrollbar">
            <table className="w-full text-sm text-left text-neutral-300">
                <thead className="text-xs text-neutral-500 uppercase border-b border-neutral-800">
                    <tr>
                        <th className="py-3">Subject</th>
                        <th className="py-3">Target</th>
                        <th className="py-3">Status</th>
                        <th className="py-3 text-right">Sent</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-neutral-800">
                    {campaigns.map(camp => (
                        <tr key={camp.id}>
                            <td className="py-4 font-medium text-white">{camp.subject}</td>
                            <td className="py-4">{camp.targetRole}</td>
                            <td className="py-4">
                                <span className={`px-2 py-1 rounded text-xs font-bold ${camp.status === 'COMPLETED' ? 'bg-green-500/10 text-green-500' : camp.status === 'SENDING' ? 'bg-blue-500/10 text-blue-500' : 'bg-neutral-800 text-neutral-500'}`}>
                                    {camp.status}
                                </span>
                            </td>
                            <td className="py-4 text-right">{new Date(camp.startTime).toLocaleDateString()}</td>
                        </tr>
                    ))}
                    {campaigns.length === 0 && <tr><td colSpan={4} className="text-center py-8 text-neutral-500">No campaigns sent yet.</td></tr>}
                </tbody>
            </table>
        </div>
    );
};

const DraftsView: React.FC<{ onEdit: (draft: EmailDraft) => void }> = ({ onEdit }) => {
    const [drafts, setDrafts] = useState<EmailDraft[]>([]);

    const fetchDrafts = () => api.getEmailDrafts().then(setDrafts);

    useEffect(() => { fetchDrafts(); }, []);

    const handleDelete = async (id: string, e: React.MouseEvent) => {
        e.stopPropagation();
        if (window.confirm("Delete this draft?")) {
            await api.deleteEmailDraft(id);
            fetchDrafts();
        }
    };

    return (
        <div className="p-6 h-full overflow-y-auto custom-scrollbar">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {drafts.map(draft => (
                    <div key={draft.id} onClick={() => onEdit(draft)} className="bg-neutral-950 border border-neutral-800 rounded-xl p-5 cursor-pointer hover:border-purple-500/50 transition-colors group">
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="font-bold text-white truncate pr-2">{draft.name || 'Untitled Draft'}</h3>
                            <button onClick={(e) => handleDelete(draft.id, e)} className="text-neutral-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                <TrashIcon className="w-4 h-4" />
                            </button>
                        </div>
                        <p className="text-sm text-neutral-400 mb-4 truncate">{draft.subject}</p>
                        <div className="flex justify-between items-center text-xs text-neutral-500">
                            <span className="bg-neutral-900 px-2 py-1 rounded">{draft.targetRole}</span>
                            <span>{new Date(draft.lastModified).toLocaleDateString()}</span>
                        </div>
                    </div>
                ))}
                {drafts.length === 0 && <p className="text-neutral-500 col-span-full text-center py-12">No drafts found.</p>}
            </div>
        </div>
    );
};

const ComposeView: React.FC<{ initialDraft?: EmailDraft, onCancel: () => void, onSent: () => void }> = ({ initialDraft, onCancel, onSent }) => {
    const [draft, setDraft] = useState<Partial<EmailDraft>>(initialDraft || {
        id: uuidv4(),
        name: '',
        subject: '',
        body: '',
        targetRole: 'All Users',
        lastModified: new Date().toISOString()
    });
    const [sending, setSending] = useState(false);

    const handleSave = async () => {
        await api.saveEmailDraft(draft as EmailDraft);
        alert('Draft saved');
    };

    const handleSend = async () => {
        if (!draft.subject || !draft.body) return alert("Subject and body required");
        if (window.confirm(`Send this campaign to ${draft.targetRole}?`)) {
            setSending(true);
            try {
                await api.launchEmailCampaign(draft.id!, draft.targetRole!);
                onSent();
            } catch (e) {
                alert("Failed to send");
            } finally {
                setSending(false);
            }
        }
    };

    return (
        <div className="flex flex-col h-full">
            <div className="p-6 border-b border-neutral-800 space-y-4 bg-neutral-900 z-10">
                <div className="flex gap-4">
                    <input 
                        type="text" 
                        placeholder="Internal Draft Name" 
                        value={draft.name} 
                        onChange={e => setDraft({...draft, name: e.target.value})}
                        className="flex-1 bg-neutral-950 border border-neutral-800 rounded-lg px-4 py-2 text-white focus:border-purple-500 outline-none"
                    />
                    <select 
                        value={draft.targetRole} 
                        onChange={e => setDraft({...draft, targetRole: e.target.value as TargetRole})}
                        className="bg-neutral-950 border border-neutral-800 rounded-lg px-4 py-2 text-white focus:border-purple-500 outline-none"
                    >
                        <option value="All Users">All Users</option>
                        <option value="Hosts">Hosts</option>
                        <option value="Promoters">Promoters</option>
                        <option value="Artists">Artists</option>
                        <option value="Admins">Admins</option>
                    </select>
                </div>
                <input 
                    type="text" 
                    placeholder="Email Subject Line" 
                    value={draft.subject} 
                    onChange={e => setDraft({...draft, subject: e.target.value})}
                    className="w-full bg-neutral-950 border border-neutral-800 rounded-lg px-4 py-2 text-white focus:border-purple-500 outline-none font-bold"
                />
            </div>
            
            <div className="flex-1 bg-white text-black relative">
                <div className="absolute inset-0">
                    <RichTextEditor value={draft.body || ''} onChange={val => setDraft({...draft, body: val})} />
                </div>
            </div>

            <div className="p-4 border-t border-neutral-800 bg-neutral-900 flex justify-end gap-3">
                <button onClick={onCancel} className="px-4 py-2 text-neutral-400 hover:text-white">Cancel</button>
                <button onClick={handleSave} className="px-4 py-2 border border-neutral-700 rounded-lg text-white hover:bg-neutral-800">Save Draft</button>
                <button onClick={handleSend} disabled={sending} className="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-lg flex items-center gap-2 disabled:opacity-50">
                    <SendIcon className="w-4 h-4" /> {sending ? 'Sending...' : 'Send Campaign'}
                </button>
            </div>
        </div>
    );
};

// --- SYSTEM EMAILS MANAGER (Revised) ---

const AdminSystemEmailsManager: React.FC = () => {
    const [templates, setTemplates] = useState<SystemEmailTemplate[]>([]);
    const [selectedTrigger, setSelectedTrigger] = useState<SystemEmailTrigger | ''>('');
    const [loading, setLoading] = useState(true);
    const [formData, setFormData] = useState<{ subject: string; body: string }>({ subject: '', body: '' });
    const [isSaving, setIsSaving] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);
    const [copiedVar, setCopiedVar] = useState<string | null>(null);
    
    // Test Email State
    const [isTestModalOpen, setIsTestModalOpen] = useState(false);
    const [testEmail, setTestEmail] = useState('');

    useEffect(() => {
        const loadTemplates = async () => {
            try {
                const data = await api.getSystemEmailTemplates();
                // FIX: Ensure it's an array to prevent crash
                const safeData = Array.isArray(data) ? data : [];
                setTemplates(safeData);
                if (safeData.length > 0) {
                    setSelectedTrigger(safeData[0].trigger);
                }
            } catch (e) {
                console.error("Failed to load email templates", e);
                setTemplates([]);
            } finally {
                setLoading(false);
            }
        };
        loadTemplates();
    }, []);

    useEffect(() => {
        if (selectedTrigger) {
            const tmpl = templates.find(t => t.trigger === selectedTrigger);
            if (tmpl) {
                setFormData({ subject: tmpl.subject, body: tmpl.body });
            }
        } else {
            setFormData({ subject: '', body: '' });
        }
    }, [selectedTrigger, templates]);

    const currentTemplate = templates.find(t => t.trigger === selectedTrigger);

    const handleSave = async () => {
        if (!selectedTrigger) return;
        setIsSaving(true);
        try {
            const updated = await api.updateSystemEmailTemplate(selectedTrigger as SystemEmailTrigger, formData);
            setTemplates(prev => prev.map(t => t.trigger === selectedTrigger ? updated : t));
            setSaveSuccess(true);
            setTimeout(() => setSaveSuccess(false), 2000);
        } catch (e) {
            alert("Failed to save template. Backend route may be missing.");
        } finally {
            setIsSaving(false);
        }
    };

    const handleSendTest = async () => {
        if (!selectedTrigger || !testEmail) return;
        try {
            await emailService.sendTestSystemEmail(selectedTrigger as SystemEmailTrigger, testEmail, formData.subject, formData.body);
            alert(`Test email request sent to server.`);
            setIsTestModalOpen(false);
        } catch (e) {
            alert("Failed to send test email.");
        }
    };

    const copyVariable = (v: string) => {
        navigator.clipboard.writeText(v);
        setCopiedVar(v);
        setTimeout(() => setCopiedVar(null), 1500);
    };

    if (loading) return <div className="text-neutral-500 text-center py-12">Loading templates...</div>;

    return (
        <div className="space-y-6 animate-fade-in flex flex-col pb-12">
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-2xl font-bold text-white">System Transaction Emails</h2>
                    <p className="text-neutral-400 text-sm">Configure automated email notifications.</p>
                </div>
            </div>

            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl flex flex-col overflow-hidden">
                
                {/* Toolbar / Selector */}
                <div className="p-6 border-b border-neutral-800 bg-neutral-950/50 flex flex-col md:flex-row gap-6 items-start md:items-center justify-between shrink-0">
                    <div className="w-full md:w-1/2">
                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-2">Select Email Template</label>
                        <div className="relative">
                            <select 
                                value={selectedTrigger} 
                                onChange={e => setSelectedTrigger(e.target.value as SystemEmailTrigger)}
                                className="w-full appearance-none bg-neutral-800 border border-neutral-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 font-medium"
                            >
                                {templates.map(t => (
                                    <option key={t.trigger} value={t.trigger}>{t.name}</option>
                                ))}
                            </select>
                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-neutral-400">
                                <svg className="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    {currentTemplate && (
                        <div className="flex gap-3">
                            <button 
                                onClick={() => setIsTestModalOpen(true)} 
                                className="px-4 py-2.5 bg-neutral-800 text-neutral-300 hover:text-white border border-neutral-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                            >
                                <MailIcon className="w-4 h-4" /> Send Test
                            </button>
                            <button 
                                onClick={handleSave} 
                                disabled={isSaving}
                                className="px-6 py-2.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-bold transition-colors disabled:opacity-50 flex items-center gap-2 shadow-lg shadow-purple-900/20"
                            >
                                {isSaving ? 'Saving...' : saveSuccess ? <><CheckCircleIcon className="w-4 h-4"/> Saved!</> : 'Save Changes'}
                            </button>
                        </div>
                    )}
                </div>

                {currentTemplate ? (
                    <div className="flex flex-col">
                        {/* Subject & Vars */}
                        <div className="p-6 border-b border-neutral-800 bg-neutral-900 shrink-0 space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 uppercase mb-2">Subject Line</label>
                                <input 
                                    type="text" 
                                    value={formData.subject} 
                                    onChange={e => setFormData({...formData, subject: e.target.value})}
                                    className="w-full bg-neutral-800 border border-neutral-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-purple-500 font-medium text-lg"
                                    placeholder="Email Subject"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 uppercase mb-2">Available Variables <span className="font-normal normal-case text-neutral-600 ml-1">(Click to copy)</span></label>
                                <div className="flex flex-wrap gap-2">
                                    {currentTemplate.variables.map(v => (
                                        <button 
                                            key={v} 
                                            onClick={() => copyVariable(v)}
                                            className={`px-3 py-1.5 rounded text-xs font-mono transition-all border ${
                                                copiedVar === v 
                                                ? 'bg-green-500/20 text-green-400 border-green-500/30' 
                                                : 'bg-neutral-800 hover:bg-neutral-700 text-purple-400 border-neutral-700'
                                            }`}
                                            title="Click to copy to clipboard"
                                        >
                                            {v} {copiedVar === v && 'âœ“'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Editor Wrapper */}
                        <div className="bg-white text-black">
                            <RichTextEditor 
                                key={selectedTrigger} 
                                value={formData.body} 
                                onChange={val => setFormData({...formData, body: val})} 
                                autoHeight={true}
                                className="border-none rounded-none shadow-none"
                            />
                        </div>
                    </div>
                ) : (
                    <div className="flex flex-1 items-center justify-center text-neutral-500 py-12">
                        Select an email template above to start editing.
                    </div>
                )}
            </div>

            {/* Test Email Modal */}
            <Modal isOpen={isTestModalOpen} onClose={() => setIsTestModalOpen(false)}>
                <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl p-8 text-center shadow-2xl">
                    <div className="w-16 h-16 bg-purple-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-purple-500/20">
                        <MailIcon className="w-8 h-8 text-purple-400" />
                    </div>
                    <h3 className="text-xl font-bold text-white mb-2">Send Test Email</h3>
                    <p className="text-neutral-400 text-sm mb-6">Send a preview of <strong>{currentTemplate?.name}</strong> to:</p>
                    
                    <input 
                        type="email" 
                        placeholder="Enter email address" 
                        value={testEmail}
                        onChange={e => setTestEmail(e.target.value)}
                        className="w-full bg-neutral-800 border border-neutral-700 rounded-lg px-4 py-3 text-white mb-6 focus:outline-none focus:border-purple-500"
                        autoFocus
                    />
                    
                    <div className="flex gap-3 justify-center">
                        <button 
                            onClick={() => setIsTestModalOpen(false)}
                            className="px-6 py-2.5 rounded-full text-neutral-300 hover:text-white hover:bg-neutral-800 transition-colors font-medium"
                        >
                            Cancel
                        </button>
                        <button 
                            onClick={handleSendTest}
                            disabled={!testEmail}
                            className="px-6 py-2.5 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-full shadow-lg shadow-purple-900/20 transition-colors disabled:opacity-50"
                        >
                            Send Preview
                        </button>
                    </div>
                </div>
            </Modal>
        </div>
    );
};

// --- PAYOUTS MANAGER ---
const AdminPayoutsManager: React.FC = () => {
    const [requests, setRequests] = useState<PayoutRequest[]>([]);
    const [loading, setLoading] = useState(true);
    const [isProcessing, setIsProcessing] = useState(false);

    const fetchRequests = async () => {
        setLoading(true);
        const data = await api.getPayoutRequests();
        setRequests(data);
        setLoading(false);
    };

    useEffect(() => { fetchRequests(); }, []);

    const handleApprove = async (id: string) => {
        if (window.confirm("Approve this payout? Funds will be transferred.")) {
            await api.approvePayoutRequests([id]);
            fetchRequests();
        }
    };

    const handleBackfill = async () => {
        if (!window.confirm("Are you sure? This will recalculate missing commissions for all completed orders based on proper attribution rules.")) return;
        setIsProcessing(true);
        try {
            const res = await api.backfillCommissions();
            alert(`Backfill Complete! ${res.message || 'Processed.'}`);
        } catch (e) {
            console.error(e);
            alert("Failed to run backfill script.");
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-white">Payout Requests</h2>
                <div className="flex gap-2">
                    <button 
                        onClick={handleBackfill} 
                        disabled={isProcessing}
                        className="px-4 py-2 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 hover:text-white text-sm font-medium rounded-lg transition-colors border border-neutral-700 flex items-center gap-2"
                        title="Re-run commission logic for past orders to fix missing ledger entries"
                    >
                        <RefreshCwIcon className={`w-4 h-4 ${isProcessing ? 'animate-spin' : ''}`} />
                        {isProcessing ? 'Processing...' : 'Data Reconciliation (Backfill)'}
                    </button>
                </div>
            </div>
            
            <div className="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden">
                <table className="w-full text-sm text-left text-neutral-300">
                    <thead className="text-xs text-neutral-500 uppercase bg-neutral-950 border-b border-neutral-800">
                        <tr>
                            <th className="px-6 py-4">User</th>
                            <th className="px-6 py-4">Amount</th>
                            <th className="px-6 py-4">Requested</th>
                            <th className="px-6 py-4 text-center">Status</th>
                            <th className="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-800">
                        {requests.map(req => (
                            <tr key={req.id}>
                                <td className="px-6 py-4">
                                    <div className="font-bold text-white">{req.userName}</div>
                                    <div className="text-xs text-neutral-500">{req.userEmail}</div>
                                </td>
                                <td className="px-6 py-4 font-mono text-white">${req.amount.toFixed(2)}</td>
                                <td className="px-6 py-4">{new Date(req.requestedDate).toLocaleDateString()}</td>
                                <td className="px-6 py-4 text-center">
                                    <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${
                                        req.status === 'pending' ? 'bg-yellow-500/10 text-yellow-500' :
                                        req.status === 'approved' ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'
                                    }`}>
                                        {req.status}
                                    </span>
                                </td>
                                <td className="px-6 py-4 text-right">
                                    {req.status === 'pending' && (
                                        <button onClick={() => handleApprove(req.id)} className="text-xs font-bold px-3 py-1 bg-green-600 hover:bg-green-500 text-white rounded">Approve</button>
                                    )}
                                </td>
                            </tr>
                        ))}
                        {requests.length === 0 && <tr><td colSpan={5} className="text-center py-8 text-neutral-500">No pending payouts.</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// --- SETTINGS ---
const AdminSettings: React.FC = () => {
    const [settings, setSettings] = useState<SystemSettings | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [saveSuccess, setSaveSuccess] = useState(false);

    useEffect(() => {
        const fetchSettings = async () => {
            try {
                const data = await api.getSystemSettings();
                setSettings(data);
            } catch (e) {
                console.error("Failed to load settings");
            } finally {
                setIsLoading(false);
            }
        };
        fetchSettings();
    }, []);

    const handleSave = async () => {
        if (!settings) return;
        setIsSaving(true);
        try {
            await api.updateSystemSettings(settings);
            setSaveSuccess(true);
            setTimeout(() => setSaveSuccess(false), 2000);
        } catch (e) {
            alert("Failed to save settings.");
        } finally {
            setIsSaving(false);
        }
    };

    if (isLoading) return <div className="text-center py-12 text-neutral-500">Loading configuration...</div>;
    if (!settings) return <div className="text-center py-12 text-red-500">Failed to load settings.</div>;

    return (
        <div className="space-y-6 animate-fade-in max-w-4xl">
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-2xl font-bold text-white">System Settings</h2>
                    <p className="text-neutral-400 text-sm">Configure global platform parameters.</p>
                </div>
                <button 
                    onClick={handleSave} 
                    disabled={isSaving}
                    className="px-6 py-2.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-bold transition-colors disabled:opacity-50 flex items-center gap-2 shadow-lg shadow-purple-900/20"
                >
                    {isSaving ? 'Saving...' : saveSuccess ? <><CheckCircleIcon className="w-4 h-4"/> Saved!</> : 'Save Configuration'}
                </button>
            </div>

            <div className="grid grid-cols-1 gap-6">
                
                {/* General Settings */}
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <SettingsIcon className="w-5 h-5 text-purple-400" /> General
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Platform Name</label>
                            <input 
                                type="text" 
                                value={settings.platformName}
                                onChange={e => setSettings({...settings, platformName: e.target.value})}
                                className="w-full bg-neutral-800 border border-neutral-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-purple-500"
                            />
                            <p className="text-xs text-neutral-500 mt-1">Displayed in emails and headers.</p>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Support Email</label>
                            <input 
                                type="email" 
                                value={settings.supportEmail}
                                onChange={e => setSettings({...settings, supportEmail: e.target.value})}
                                className="w-full bg-neutral-800 border border-neutral-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-purple-500"
                            />
                            <p className="text-xs text-neutral-500 mt-1">Used as the 'From' address for system emails.</p>
                        </div>
                    </div>
                </div>

                {/* Financials */}
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <DollarSignIcon className="w-5 h-5 text-green-400" /> Financials
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Platform Fee (%)</label>
                            <div className="relative">
                                <input 
                                    type="number" 
                                    value={settings.platformFeePercent}
                                    onChange={e => setSettings({...settings, platformFeePercent: parseFloat(e.target.value)})}
                                    className="w-full bg-neutral-800 border border-neutral-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-green-500"
                                    step="0.1"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-neutral-500">%</span>
                            </div>
                            <p className="text-xs text-neutral-500 mt-1">Percentage fee added to every ticket purchase.</p>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-neutral-300 mb-2">Fixed Fee ($)</label>
                            <div className="relative">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">$</span>
                                <input 
                                    type="number" 
                                    value={settings.platformFeeFixed}
                                    onChange={e => setSettings({...settings, platformFeeFixed: parseFloat(e.target.value)})}
                                    className="w-full bg-neutral-800 border border-neutral-700 rounded-lg pl-8 pr-4 py-2.5 text-white focus:outline-none focus:border-green-500"
                                    step="0.01"
                                />
                            </div>
                            <p className="text-xs text-neutral-500 mt-1">Fixed fee added to every ticket purchase.</p>
                        </div>
                    </div>
                </div>

                {/* Access Control */}
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <LockIcon className="w-5 h-5 text-red-400" /> Access Control
                    </h3>
                    <div className="space-y-4">
                        <div className="flex items-center justify-between p-4 bg-neutral-800/30 border border-neutral-800 rounded-xl">
                            <div>
                                <p className="font-medium text-white">Maintenance Mode</p>
                                <p className="text-sm text-neutral-400">Display a banner and warn users of potential downtime.</p>
                            </div>
                            <button 
                                onClick={() => setSettings({...settings, maintenanceMode: !settings.maintenanceMode})}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${settings.maintenanceMode ? 'bg-yellow-500' : 'bg-neutral-700'}`}
                            >
                                <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${settings.maintenanceMode ? 'translate-x-6' : 'translate-x-1'}`} />
                            </button>
                        </div>

                        <div className="flex items-center justify-between p-4 bg-neutral-800/30 border border-neutral-800 rounded-xl">
                            <div>
                                <p className="font-medium text-white">Disable New Registrations</p>
                                <p className="text-sm text-neutral-400">Prevent new users from creating accounts.</p>
                            </div>
                            <button 
                                onClick={() => setSettings({...settings, disableRegistration: !settings.disableRegistration})}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${settings.disableRegistration ? 'bg-red-600' : 'bg-neutral-700'}`}
                            >
                                <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${settings.disableRegistration ? 'translate-x-6' : 'translate-x-1'}`} />
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
};

export default SystemAdmin;

--- END OF FILE ./pages/SystemAdmin.tsx ---




--- START OF FILE ./pages/UserPortal.tsx ---


import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import * as api from '../services/api';
import { Order, Event as EventType } from '../types';
import TicketViewModal from '../components/TicketViewModal';
import PortalHeader from '../components/PortalHeader';
import { CalendarIcon, EyeIcon, TicketIcon, ClockIcon, XCircleIcon, MapPinIcon, PackageIcon, ArrowLeftIcon, RefreshCwIcon } from '../components/Icons';

// Helper for FLIP animation
interface Rect {
    top: number;
    left: number;
    width: number;
    height: number;
}

const UserPortal: React.FC = () => {
  const { user, isAuthenticated } = useAuth();
  const navigate = useNavigate();
  
  const [activeTab, setActiveTab] = useState<'available' | 'used'>('available');
  const [orders, setOrders] = useState<Order[]>([]);
  const [eventsMap, setEventsMap] = useState<Map<string, EventType>>(new Map());
  const [isLoading, setIsLoading] = useState(true);

  // Expansion State
  const [expandedOrderId, setExpandedOrderId] = useState<string | null>(null);
  const [originRect, setOriginRect] = useState<Rect | null>(null);
  
  // QR Modal State
  const [selectedTicketItem, setSelectedTicketItem] = useState<{ id: string; type: string; name: string; holderName: string } | null>(null);

  // Refs
  const orderRefs = useRef<Map<string, HTMLButtonElement>>(new Map());
  const hasInitiatedPendingCheck = useRef(false);

  useEffect(() => {
    if (!isAuthenticated) {
      navigate('/');
    }
  }, [isAuthenticated, navigate]);

  const fetchOrderData = useCallback(async (isSilentRefresh = false) => {
    if (user) {
      if (!isSilentRefresh) setIsLoading(true);
      try {
        const myOrders = await api.getUserOrders();
        setOrders(myOrders);

        if (myOrders.length > 0) {
            const eventIds = [...new Set(myOrders.map(o => o.eventId))];
            if (eventIds.length > 0) {
              const eventPromises = eventIds.map(id => api.getEventDetails(id).catch(e => null));
              const eventsResults = await Promise.all(eventPromises);
              const events = eventsResults.filter(e => e !== null) as EventType[];
              setEventsMap(new Map(events.map(e => [e.id, e])));
            }
        }
      } catch (error) {
        console.error("Failed to fetch user orders:", error);
      } finally {
        if (!isSilentRefresh) setIsLoading(false);
      }
    } else {
      setOrders([]);
      if (!isSilentRefresh) setIsLoading(false);
    }
  }, [user]);

  useEffect(() => {
    fetchOrderData();
  }, [fetchOrderData]);

  // Effect to automatically re-verify pending orders on page load
  useEffect(() => {
    // Only run if we have orders and haven't checked yet
    if (orders.length > 0 && !hasInitiatedPendingCheck.current) {
        
        const pendingOrders = orders.filter(o => o.status === 'Pending');

        if (pendingOrders.length > 0) {
            console.log(`Found ${pendingOrders.length} pending orders. Verifying with Stripe...`);
            hasInitiatedPendingCheck.current = true;

            const verifyAndRefetch = async () => {
                // 1. Force confirm each pending order
                const confirmationPromises = pendingOrders.map(async (order) => {
                    try {
                        console.log(`Verifying Order: ${order.orderId}`);
                        // This forces the backend to call Stripe
                        await api.confirmOrderPayment(order.orderId); 
                        return true;
                    } catch (err) {
                        console.warn(`Failed to re-verify order ${order.orderId}:`, err);
                        return false;
                    }
                });

                await Promise.allSettled(confirmationPromises);
                
                // 2. Fetch updated list immediately after checks complete
                console.log("Verification complete. Refreshing order list...");
                fetchOrderData(true);
            };

            verifyAndRefetch();
        }
    }
  }, [orders, fetchOrderData]);

  const handleExpandOrder = (orderId: string) => {
      const el = orderRefs.current.get(orderId);
      if (el) {
          const rect = el.getBoundingClientRect();
          setOriginRect({
              top: rect.top,
              left: rect.left,
              width: rect.width,
              height: rect.height
          });
          setExpandedOrderId(orderId);
      }
  };

  const handleCloseExpanded = () => {
      setExpandedOrderId(null);
      setTimeout(() => setOriginRect(null), 500); 
  };

  const handleItemClick = (ticketId: string, type: string, name: string) => {
      setSelectedTicketItem({
          id: ticketId,
          type,
          name,
          holderName: user?.name || 'Guest'
      });
  };

  if (!user && !isLoading) {
    return <div className="text-center py-20 text-neutral-400">Please sign in to view your tickets.</div>;
  }

  const displayedOrders = orders.filter(order => {
      const event = eventsMap.get(order.eventId);
      const isPast = event ? new Date(event.endDate || event.date) < new Date() : false;
      
      if (activeTab === 'available') {
          return !isPast;
      }
      return isPast || order.status === 'Refunded';
  }).sort((a, b) => {
      const dateA = new Date(eventsMap.get(a.eventId)?.date || 0).getTime();
      const dateB = new Date(eventsMap.get(b.eventId)?.date || 0).getTime();
      return dateB - dateA; // Sort by event date descending
  });

  const expandedOrder = orders.find(o => o.orderId === expandedOrderId);
  const expandedEvent = expandedOrder ? eventsMap.get(expandedOrder.eventId) : null;
  
  const pendingCount = orders.filter(o => o.status === 'Pending').length;

  return (
    <>
      <div className="container mx-auto max-w-7xl px-6 py-16 relative">
        <PortalHeader 
            title="My Tickets"
            subtitle="View and manage all your purchased event tickets."
        >
            <div className="flex gap-2">
                <button 
                    onClick={() => fetchOrderData()}
                    className="px-3 py-2 bg-neutral-900 border border-neutral-800 text-neutral-400 hover:text-white rounded-lg transition-colors"
                    title="Refresh Orders"
                    disabled={isLoading}
                >
                    <RefreshCwIcon className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} />
                </button>
                <div className="flex bg-neutral-900 p-1 rounded-lg border border-neutral-800">
                    <button 
                        onClick={() => setActiveTab('available')}
                        className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${activeTab === 'available' ? 'bg-neutral-800 text-white shadow-sm' : 'text-neutral-400 hover:text-white'}`}
                    >
                        <TicketIcon className="w-4 h-4" /> Available
                    </button>
                    <button 
                        onClick={() => setActiveTab('used')}
                        className={`px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${activeTab === 'used' ? 'bg-neutral-800 text-white shadow-sm' : 'text-neutral-400 hover:text-white'}`}
                    >
                        <ClockIcon className="w-4 h-4" /> Past / Cancelled
                    </button>
                </div>
            </div>
        </PortalHeader>

        {pendingCount > 0 && activeTab === 'available' && (
            <div className="mb-8 p-5 bg-yellow-900/10 border border-yellow-500/20 rounded-2xl flex items-center gap-4 relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-r from-yellow-500/5 to-transparent pointer-events-none"></div>
                <div className="p-3 bg-yellow-500/20 rounded-full text-yellow-400 relative z-10">
                    <ClockIcon className="w-6 h-6 animate-spin" />
                </div>
                <div className="relative z-10">
                    <h4 className="text-white font-bold text-lg">Payment Processing</h4>
                    <p className="text-yellow-200/70 text-sm">
                        We are currently confirming payment for <strong>{pendingCount} order{pendingCount > 1 ? 's' : ''}</strong>. 
                        Your tickets will appear below and unlock automatically once confirmed.
                    </p>
                </div>
            </div>
        )}

        {isLoading && orders.length === 0 ? (
            <div className="text-center py-12 text-neutral-500">Loading orders...</div>
        ) : (
            <div className="space-y-6">
                {displayedOrders.length > 0 ? (
                displayedOrders.map(order => {
                    const event = eventsMap.get(order.eventId);
                    const eventImage = event?.imageUrls[0] || `https://picsum.photos/seed/${order.eventId}/400/400`;
                    const eventName = event?.title || 'Unknown Event';
                    const summary = order.items.map(item => `${item.quantity} x ${item.ticketType}`).join(', ');
                    const isRefunded = order.status === 'Refunded';
                    const isPending = order.status === 'Pending';

                    if (expandedOrderId === order.orderId) {
                        const placeholderHeight = originRect ? originRect.height : '9rem';
                        return <div key={order.orderId} style={{ height: placeholderHeight }} className="w-full rounded-2xl bg-transparent transition-all"></div>;
                    }

                    return (
                        <button 
                            key={order.orderId} 
                            ref={el => { if (el) orderRefs.current.set(order.orderId, el); }}
                            onClick={() => !isPending && !isRefunded && handleExpandOrder(order.orderId)} 
                            disabled={isPending || isRefunded}
                            className={`event-card group w-full text-left bg-neutral-900 rounded-2xl overflow-hidden flex flex-row shadow-lg border border-neutral-800 transition-all duration-300 ${activeTab === 'available' && !isPending && !isRefunded ? 'hover:border-purple-500 hover:shadow-purple-500/10 hover:-translate-y-1 cursor-pointer' : 'opacity-80 cursor-default border-neutral-800/50'}`}
                        >
                            <div className="relative w-32 md:w-40 flex-shrink-0 bg-neutral-800 h-full min-h-[9rem]">
                                <img src={eventImage} alt={eventName} className={`w-full h-full object-cover absolute inset-0 ${activeTab === 'used' ? 'grayscale' : ''}`}/>
                                {isRefunded && (
                                    <div className="absolute inset-0 bg-black/60 flex items-center justify-center backdrop-blur-sm">
                                        <div className="text-red-400 font-bold text-xs uppercase border border-red-400/50 px-2 py-1 rounded bg-red-900/20 flex items-center gap-1">
                                            <XCircleIcon className="w-3 h-3" /> Refunded
                                        </div>
                                    </div>
                                )}
                                {isPending && (
                                    <div className="absolute inset-0 bg-black/60 flex items-center justify-center backdrop-blur-sm">
                                        <div className="text-yellow-400 font-bold text-xs uppercase border border-yellow-400/50 px-2 py-1 rounded bg-yellow-900/20 flex items-center gap-1 shadow-lg shadow-black/50">
                                            <ClockIcon className="w-3 h-3 animate-spin" /> Processing
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="p-5 md:p-6 flex-grow flex flex-col justify-center overflow-hidden">
                                <div className="flex justify-between items-start">
                                    <span className="text-sm font-semibold text-purple-400 mb-1 block">ORDER #{order.orderId.slice(-6).toUpperCase()}</span>
                                    {isRefunded && <span className="text-xs font-bold text-red-500 uppercase tracking-wider">Cancelled</span>}
                                    {isPending && <span className="text-xs font-bold text-yellow-500 uppercase tracking-wider animate-pulse">Payment Pending</span>}
                                </div>
                                <h3 className={`text-lg md:text-xl font-bold text-white mb-1 truncate ${isRefunded ? 'line-through text-neutral-500' : ''}`}>{eventName}</h3>
                                <p className="text-neutral-300 text-sm mb-2 truncate">{summary}</p>
                                
                                <div className="flex flex-col sm:flex-row sm:items-center gap-3 text-neutral-400 text-xs">
                                    <span className="flex items-center gap-2"><CalendarIcon className="w-3.5 h-3.5 shrink-0" />Purchased: {new Date(order.purchaseDate).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div className={`flex-shrink-0 flex flex-col items-center justify-center w-16 md:w-24 bg-neutral-950 transition-all duration-300 ${activeTab === 'available' && !isPending && !isRefunded ? 'group-hover:bg-purple-600 text-neutral-400 group-hover:text-white' : 'text-neutral-600'}`}>
                                <EyeIcon className="w-6 h-6" />
                                <span className="text-xs font-medium mt-1 text-center px-1">VIEW</span>
                            </div>
                        </button>
                    );
                })
                ) : (
                <div className="text-center py-12 border-2 border-dashed border-neutral-800 rounded-2xl">
                    <p className="text-neutral-500">
                        {activeTab === 'available' ? "You don't have any upcoming orders." : "No past orders found."}
                    </p>
                </div>
                )}
            </div>
        )}
      </div>

      {expandedOrder && expandedEvent && originRect && (
          <ExpandedOrderOverlay 
            order={expandedOrder}
            event={expandedEvent}
            originRect={originRect}
            onClose={handleCloseExpanded}
            onItemClick={handleItemClick}
          />
      )}

      <TicketViewModal 
        isOpen={!!selectedTicketItem}
        onClose={() => setSelectedTicketItem(null)}
        ticketData={selectedTicketItem}
        eventData={selectedTicketItem && expandedEvent ? expandedEvent : null}
      />
    </>
  );
};

const ExpandedOrderOverlay: React.FC<{ 
    order: Order, 
    event: EventType, 
    originRect: Rect, 
    onClose: () => void,
    onItemClick: (id: string, type: string, name: string) => void
}> = ({ order, event, originRect, onClose, onItemClick }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [isClosing, setIsClosing] = useState(false);
    
    useEffect(() => {
        requestAnimationFrame(() => {
            setIsExpanded(true);
        });
    }, []);

    const handleCloseInternal = () => {
        setIsClosing(true);
        setIsExpanded(false);
        setTimeout(() => {
            onClose();
        }, 500);
    };

    const style = isExpanded
        ? { top: '16px', left: '16px', right: '16px', bottom: '16px', borderRadius: '1rem' } 
        : { top: `${originRect.top}px`, left: `${originRect.left}px`, width: `${originRect.width}px`, height: `${originRect.height}px`, borderRadius: '1rem' };

    const tickets = React.useMemo(() => {
        const flatItems: any[] = [];
        let globalIndex = 0;
        order.items.forEach(item => {
            const isAddon = event.addOns?.some(a => a.name === item.ticketType);
            for(let i=0; i<item.quantity; i++) {
                flatItems.push({
                    id: `${order.orderId}-${globalIndex}`,
                    name: item.ticketType,
                    type: isAddon ? 'Add-on' : 'Ticket',
                    index: globalIndex
                });
                globalIndex++;
            }
        });
        return flatItems;
    }, [order, event]);

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
            <div 
                className={`absolute inset-0 bg-black/80 transition-opacity duration-500 ease-out ${isExpanded ? 'opacity-100' : 'opacity-0'}`} 
                onClick={handleCloseInternal}
            ></div>

            <div 
                className="absolute bg-neutral-900 overflow-hidden shadow-2xl border border-neutral-800"
                style={{
                    ...style,
                    transition: 'all 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                    maxWidth: isExpanded ? '800px' : undefined,
                    margin: isExpanded ? '0 auto' : undefined
                }}
            >
                <div className={`absolute inset-0 opacity-20 pointer-events-none transition-opacity duration-500 ${isExpanded ? 'opacity-20' : 'opacity-0'}`}>
                    <img src={event.imageUrls[0]} alt="" className="w-full h-full object-cover blur-2xl scale-125"/>
                </div>

                <div className="relative z-10 flex flex-col h-full">
                    <div className="flex-shrink-0 p-6 md:p-8 flex items-start justify-between border-b border-white/5 bg-neutral-900/50 backdrop-blur-md">
                        <div className="flex gap-6 items-center">
                            <div 
                                className={`flex-shrink-0 bg-neutral-800 overflow-hidden shadow-lg transition-all duration-500 rounded-xl ${isExpanded ? 'w-24 h-24' : 'w-20 h-20'}`}
                            >
                                <img src={event.imageUrls[0]} alt={event.title} className="w-full h-full object-cover"/>
                            </div>
                            <div className={`transition-all duration-500 delay-100 ${isExpanded ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`}>
                                <h2 className="text-2xl md:text-3xl font-bold text-white mb-2">{event.title}</h2>
                                <div className="flex flex-col gap-1 text-neutral-400 text-sm">
                                    <span className="flex items-center gap-2"><MapPinIcon className="w-4 h-4 text-neutral-500 shrink-0"/> {event.location}</span>
                                    <span className="flex items-center gap-2"><CalendarIcon className="w-4 h-4 text-neutral-500 shrink-0"/> {new Date(event.date).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                            </div>
                        </div>
                        <button 
                            onClick={(e) => { e.stopPropagation(); handleCloseInternal(); }}
                            className="p-2 bg-black/20 hover:bg-black/40 rounded-full text-neutral-400 hover:text-white transition-colors"
                        >
                            <XCircleIcon className="w-8 h-8" />
                        </button>
                    </div>

                    <div className="flex-grow overflow-y-auto p-6 md:p-8 space-y-4 custom-scrollbar">
                        <h3 className={`text-sm font-bold text-neutral-500 uppercase tracking-wider mb-4 transition-opacity duration-500 ${isExpanded ? 'opacity-100' : 'opacity-0'}`}>Your Items</h3>
                        
                        {tickets.map((ticket, idx) => (
                            <div 
                                key={ticket.id}
                                onClick={() => onItemClick(ticket.id, ticket.type, ticket.name)}
                                className={`
                                    bg-neutral-800/60 hover:bg-neutral-700/80 border border-white/5 rounded-xl p-4 flex items-center justify-between cursor-pointer transition-all duration-500 ease-out transform
                                    ${isExpanded ? 'translate-y-0 opacity-100' : 'translate-y-20 opacity-0'}
                                `}
                                style={{ transitionDelay: isClosing ? '0ms' : `${150 + (idx * 50)}ms` }}
                            >
                                <div className="flex items-center gap-4">
                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${ticket.type === 'Ticket' ? 'bg-purple-600/20 text-purple-400' : 'bg-blue-600/20 text-blue-400'}`}>
                                        {ticket.type === 'Ticket' ? <TicketIcon className="w-6 h-6"/> : <PackageIcon className="w-6 h-6"/>}
                                    </div>
                                    <div>
                                        <h4 className="text-white font-bold text-lg">{ticket.name}</h4>
                                        <p className="text-neutral-400 text-xs uppercase font-mono tracking-wider">{ticket.id}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3 text-neutral-400 group-hover:text-white">
                                    <span className="text-sm font-medium">View QR</span>
                                    <div className="bg-black/30 p-2 rounded-lg">
                                        <EyeIcon className="w-5 h-5" />
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className={`flex-shrink-0 p-6 bg-neutral-950/80 border-t border-white/5 flex justify-between items-center text-sm transition-opacity duration-300 ${isExpanded ? 'opacity-100' : 'opacity-0'}`}>
                        <span className="text-neutral-500 font-mono">Order ID: {order.orderId}</span>
                        <div className="flex items-center gap-2">
                            <span className="text-neutral-400">Total Paid:</span>
                            <span className="text-white font-bold text-lg">${order.totalPaid.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default UserPortal;

--- END OF FILE ./pages/UserPortal.tsx ---




--- START OF FILE ./pages/PromoterPortal.tsx ---

import React, { useState, useMemo, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import * as api from '../services/api';
import { PromoStat, User, Event as EventType, HostFinancials, LedgerEntry } from '../types';
import PortalHeader from '../components/PortalHeader';
import { TrashIcon, ClipboardIcon, MegaphoneIcon, DollarSignIcon, ArrowRightIcon, CheckCircleIcon, ClockIcon, EditIcon, SaveIcon, XIcon } from '../components/Icons';
import CompetitionLeaderboard from '../components/CompetitionLeaderboard';

const PromoterPortal: React.FC = () => {
    const { user, isAuthenticated, refreshUser } = useAuth();
    const navigate = useNavigate();

    useEffect(() => {
        if (!isAuthenticated) {
            navigate('/');
        }
    }, [isAuthenticated, navigate]);

    if (!user) {
        return <div className="text-center py-20">Loading...</div>;
    }

    return (
        <div className="container mx-auto max-w-7xl px-6 py-16">
            <PortalHeader 
                title="Promoter Portal"
                subtitle="Track your campaign performance and manage your earnings."
            />
            <PromotionsContent user={user} onUserUpdate={refreshUser} />
        </div>
    );
};

const TransactionRow: React.FC<{ entry: LedgerEntry }> = ({ entry }) => (
    <tr className="border-b border-neutral-800 hover:bg-neutral-800/30">
        <td className="px-6 py-4 text-neutral-400 text-sm">
            {new Date(entry.createdAt).toLocaleDateString()}
        </td>
        <td className="px-6 py-4">
            <div className="font-medium text-white">{entry.description}</div>
            <div className="text-xs text-neutral-500 font-mono mt-1">{entry.referenceId}</div>
            <span className={`mt-1 inline-block text-[10px] font-bold px-1.5 py-0.5 rounded border uppercase ${
                entry.type === 'COMMISSION' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 
                entry.type === 'PAYOUT' ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20' : 
                entry.type === 'CLAWBACK' ? 'bg-red-500/10 text-red-400 border-red-500/20' : 
                'bg-neutral-800 text-neutral-500 border-neutral-700'
            }`}>
                {entry.type}
            </span>
        </td>
        <td className={`px-6 py-4 font-mono font-bold text-right ${entry.amount >= 0 ? 'text-green-400' : 'text-red-400'}`}>
            {entry.amount >= 0 ? '+' : ''}{entry.amount.toFixed(2)}
        </td>
        <td className="px-6 py-4 text-center">
            <span className="text-xs bg-neutral-800 text-neutral-400 px-2 py-1 rounded">
                {entry.status}
            </span>
        </td>
    </tr>
);

const PromotionsContent: React.FC<{ user: User, onUserUpdate: () => void }> = ({ user, onUserUpdate }) => {
    const [activeSubTab, setActiveSubTab] = useState('active');
    const [promoToStop, setPromoToStop] = useState<PromoStat | null>(null);
    const [copiedLink, setCopiedLink] = useState<string | null>(null);
    const navigate = useNavigate();
    
    // Note: User profile already fetches promotions and enriches them in api.ts
    // eventsMap is mostly redundant if api.ts does its job, but we keep it for competition data
    const [eventsMap, setEventsMap] = useState<Map<string, EventType>>(new Map());
    const [isLoadingEvents, setIsLoadingEvents] = useState(true);
    
    // Track locally deleted IDs to support optimistic UI updates when API returns stale data
    const [deletedEventIds, setDeletedEventIds] = useState<string[]>([]);

    // New State for Ledger
    const [financials, setFinancials] = useState<HostFinancials | null>(null);
    const [ledger, setLedger] = useState<LedgerEntry[]>([]);

    // Editing Codes
    const [editingEventId, setEditingEventId] = useState<string | null>(null);
    const [newCodeDraft, setNewCodeDraft] = useState('');
    const [isSavingCode, setIsSavingCode] = useState(false);

    // Force a refresh of user data (including promoStats) on mount
    useEffect(() => {
        onUserUpdate();
    }, []);

    useEffect(() => {
        const loadFinancials = async () => {
            try {
                const finData = await api.getHostFinancials(user.id);
                setFinancials(finData);
                
                const ledgerData = await api.getLedgerHistory(user.id);
                setLedger(ledgerData);
            } catch (error) {
                console.error("Error loading financials or ledger", error);
            }
        };
        loadFinancials();
    }, [user.id]);

    const activePromos = useMemo(() => {
        return user.promoStats
            .filter(p => p.status === 'active')
            .filter(p => !deletedEventIds.includes(p.eventId)); // Filter out locally deleted items
    }, [user.promoStats, deletedEventIds]);

    // Fix: Client-side aggregation of ledger to patch missing API stats
    const ledgerStatsByEvent = useMemo(() => {
        const stats: Record<string, { earned: number, sales: number }> = {};
        
        ledger.forEach(entry => {
            if (entry.type !== 'COMMISSION') return;
            // Extract Event Name from Description: "Commission for order #... (Event Name)"
            const match = entry.description.match(/\((.+)\)$/);
            
            if (match && match[1]) {
                const eventName = match[1].trim();
                
                if (eventName) {
                    if (!stats[eventName]) {
                        stats[eventName] = { earned: 0, sales: 0 };
                    }
                    stats[eventName].earned += entry.amount;
                    stats[eventName].sales += 1;
                }
            }
        });
        return stats;
    }, [ledger]);

    const displayedPromos = useMemo(() => {
        return activePromos.map(promo => {
            // FIX: If API returns 0 earned but we have sales volume, calculate it ourselves
            // This is the "Real Time Self-Healing" logic for the frontend view
            let finalEarned = promo.earned;
            
            // If we have sales volume data (from new API fields) but 0 earned
            const salesVol = (promo as any).salesVolume || (promo as any).sales_volume || 0;
            if (finalEarned === 0 && salesVol > 0 && promo.commissionPct > 0) {
                finalEarned = salesVol * (promo.commissionPct / 100);
            }

            // Also check ledger as a secondary source of truth
            const ledgerStat = ledgerStatsByEvent[promo.eventName];
            if ((finalEarned === 0 || promo.sales === 0) && ledgerStat) {
                return {
                    ...promo,
                    earned: ledgerStat.earned,
                    sales: ledgerStat.sales
                };
            }
            
            return {
                ...promo,
                earned: finalEarned
            };
        });
    }, [activePromos, ledgerStatsByEvent]);

    const currentBalance = financials?.pendingBalance || 0;
    const totalEarned = financials?.netRevenue || 0;

     useEffect(() => {
        const fetchEventDetails = async () => {
            if (activePromos.length === 0) {
                setIsLoadingEvents(false);
                return;
            }
            try {
                setIsLoadingEvents(true);
                const eventIds = activePromos.map(p => p.eventId);
                const events = await api.getEventsByIds(eventIds);
                setEventsMap(new Map(events.map(e => [e.id, e])));
            } catch (error) {
                console.error("Failed to fetch event details for promos:", error);
            } finally {
                setIsLoadingEvents(false);
            }
        };

        fetchEventDetails();
    }, [activePromos]);

    const handleStopPromotion = async () => {
        if (!promoToStop) return;
        try {
            await api.stopPromotion(user.id, promoToStop.eventId);
            setDeletedEventIds(prev => [...prev, promoToStop.eventId]);
            onUserUpdate(); 
        } catch (error) {
            console.error("Failed to stop promotion", error);
            alert("Failed to stop promotion. Please try again.");
        } finally {
            setPromoToStop(null);
        }
    };

    const handleCopyLink = (link: string) => {
        navigator.clipboard.writeText(link);
        setCopiedLink(link);
        setTimeout(() => setCopiedLink(null), 2000);
    };

    const handleStartEditing = (eventId: string, currentLink: string) => {
        // Extract code from link: ...?promo=CODE
        try {
            const match = currentLink.match(/[?&]promo=([^&]+)/);
            if (match) {
                setNewCodeDraft(match[1]);
            } else {
                setNewCodeDraft('');
            }
        } catch (e) {
            setNewCodeDraft('');
        }
        setEditingEventId(eventId);
    };

    const handleCancelEdit = () => {
        setEditingEventId(null);
        setNewCodeDraft('');
    };

    const handleSaveCode = async (eventId: string) => {
        if (!newCodeDraft.trim()) return;
        setIsSavingCode(true);
        try {
            await api.updatePromoterCode(user.id, eventId, newCodeDraft.trim());
            await onUserUpdate(); // Refresh user object to get new link/code
            setEditingEventId(null);
        } catch (error: any) {
            alert(error.message || "Failed to update code. It may be taken.");
        } finally {
            setIsSavingCode(false);
        }
    };
    
    const SubTabButton: React.FC<{ tabName: string, label: string }> = ({ tabName, label }) => (
        <button
            onClick={() => setActiveSubTab(tabName)}
            className={`px-4 py-2 rounded-full text-sm font-semibold transition-colors ${
                activeSubTab === tabName ? 'bg-purple-600 text-white' : 'text-neutral-400 hover:bg-neutral-800 hover:text-white'
            }`}
        >
            {label}
        </button>
    );

    return (
        <div>
            {/* Header Stats */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 relative">
                    <h3 className="text-sm font-medium text-neutral-400 mb-2">Current Balance</h3>
                    <p className="text-4xl font-bold text-green-400 text-glow">${currentBalance.toFixed(2)}</p>
                </div>
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-sm font-medium text-neutral-400 mb-2">Total Earned (All Time)</h3>
                    <p className="text-4xl font-bold text-white">${totalEarned.toFixed(2)}</p>
                </div>
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    <h3 className="text-sm font-medium text-neutral-400 mb-2">Next Payout</h3>
                    <p className="text-3xl font-bold text-white">TBD</p>
                </div>
            </div>

            {/* Sub-tabs */}
            <div className="flex items-center space-x-2 mb-8">
                <SubTabButton tabName="active" label={`Active Promotions (${displayedPromos.length})`} />
                <SubTabButton tabName="transactions" label="Transaction History" />
                <SubTabButton tabName="payouts" label={`Payout History (${user.payouts.length})`} />
            </div>

            {/* Content */}
            {activeSubTab === 'active' && (
                <div className="space-y-6">
                    {displayedPromos.length > 0 ? (
                        displayedPromos.map(promo => {
                             const event = eventsMap.get(promo.eventId);
                             let competition = null;
                             if (event?.competitions) {
                                 const linkedCompId = (promo as any).competitionId || (promo as any).competition_id;
                                 if (linkedCompId) {
                                     competition = event.competitions.find(c => c.id === linkedCompId);
                                 }
                                 if (!competition) {
                                     competition = event.competitions.find(c => c.status === 'ACTIVE' || c.status === 'SETUP');
                                 }
                             }

                             // Extract code for display if not editing
                             let currentCode = 'LINK_ONLY';
                             const match = promo.promoLink.match(/[?&]promo=([^&]+)/);
                             if (match) currentCode = match[1];

                            return (
                                <div key={promo.eventId} className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                                    <div className="flex flex-col md:flex-row md:items-center gap-6">
                                        <div className="flex-grow">
                                            <div className="flex justify-between items-start">
                                                <h4 className="text-xl font-bold text-white mb-4">{promo.eventName}</h4>
                                                <button onClick={() => setPromoToStop(promo)} className="text-neutral-500 hover:text-red-400 transition-colors"><TrashIcon className="w-5 h-5"/></button>
                                            </div>
                                        
                                            {/* Code / Link Section */}
                                            <div className="mb-2">
                                                {editingEventId === promo.eventId ? (
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <input 
                                                            type="text" 
                                                            value={newCodeDraft}
                                                            onChange={e => setNewCodeDraft(e.target.value.toUpperCase())}
                                                            className="h-10 px-4 bg-neutral-800 border border-purple-500 rounded-lg text-white font-mono text-sm focus:outline-none w-48"
                                                            placeholder="NEW_CODE"
                                                            autoFocus
                                                        />
                                                        <button onClick={() => handleSaveCode(promo.eventId)} disabled={isSavingCode} className="p-2 bg-green-600 hover:bg-green-500 rounded-lg text-white">
                                                            <CheckCircleIcon className="w-5 h-5" />
                                                        </button>
                                                        <button onClick={handleCancelEdit} className="p-2 bg-neutral-800 hover:bg-neutral-700 rounded-lg text-neutral-400">
                                                            <XIcon className="w-5 h-5" />
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="text-sm text-neutral-400 uppercase font-bold text-[10px] tracking-wider">Your Code:</span>
                                                        <span className="text-white font-mono font-bold bg-neutral-800 px-2 py-0.5 rounded border border-neutral-700">{currentCode}</span>
                                                        <button onClick={() => handleStartEditing(promo.eventId, promo.promoLink)} className="text-neutral-500 hover:text-white transition-colors" title="Edit Code">
                                                            <EditIcon className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="flex items-center space-x-2">
                                                <input type="text" readOnly value={promo.promoLink} className="w-full h-10 px-4 bg-neutral-800 border border-neutral-700 rounded-l-full text-neutral-400 text-sm focus:outline-none"/>
                                                <button onClick={() => handleCopyLink(promo.promoLink)} className="h-10 px-4 bg-purple-600 text-white text-sm font-semibold rounded-r-full hover:bg-purple-500 transition-colors flex-shrink-0">
                                                    {copiedLink === promo.promoLink ? 'Copied!' : <ClipboardIcon className="w-4 h-4" />}
                                                </button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 flex-shrink-0 md:w-1/2">
                                            <div className="text-center md:text-left"><p className="text-sm text-neutral-400">Clicks</p><p className="text-2xl font-bold text-white">{promo.clicks}</p></div>
                                            <div className="text-center md:text-left"><p className="text-sm text-neutral-400">Sales</p><p className="text-2xl font-bold text-white">{promo.sales}</p></div>
                                            <div className="text-center md:text-left"><p className="text-sm text-neutral-400">Commission</p><p className="text-2xl font-bold text-white">{promo.commissionPct}%</p></div>
                                            <div className="text-center md:text-left"><p className="text-sm text-neutral-400">Earned</p><p className="text-2xl font-bold text-green-400">${promo.earned.toFixed(2)}</p></div>
                                        </div>
                                    </div>
                                    {competition && !isLoadingEvents && (
                                        <CompetitionLeaderboard eventId={promo.eventId} userId={user.id} />
                                    )}
                                </div>
                            )
                        })
                    ) : (
                        <div className="text-center py-16 bg-neutral-900/50 border border-neutral-800 rounded-2xl">
                            <MegaphoneIcon className="w-12 h-12 mx-auto text-neutral-600 mb-4" />
                            <h3 className="text-xl font-bold text-white">No Active Promotions</h3>
                            <p className="text-neutral-500 mt-2 mb-6">Find an event you love and start promoting to earn commissions.</p>
                            <button onClick={() => navigate('/')} className="px-5 py-2 bg-purple-600 text-white text-sm font-semibold rounded-full hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20">Discover Events</button>
                        </div>
                    )}
                </div>
            )}

            {activeSubTab === 'transactions' && (
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden">
                    {ledger.length > 0 ? (
                        <table className="w-full text-left">
                            <thead className="bg-neutral-950 border-b border-neutral-800 text-xs text-neutral-500 uppercase">
                                <tr>
                                    <th className="px-6 py-4">Date</th>
                                    <th className="px-6 py-4">Description</th>
                                    <th className="px-6 py-4 text-right">Amount</th>
                                    <th className="px-6 py-4 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {ledger.map(entry => (
                                    <TransactionRow key={entry.id} entry={entry} />
                                ))}
                            </tbody>
                        </table>
                    ) : (
                        <div className="text-center py-16">
                            <h3 className="text-xl font-bold text-white">No Transactions Yet</h3>
                            <p className="text-neutral-500 mt-2">Transactions from your sales and payouts will appear here.</p>
                        </div>
                    )}
                </div>
            )}
            
             {activeSubTab === 'payouts' && (
                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-6">
                    {user.payouts.length > 0 ? (
                        <div className="divide-y divide-neutral-800">
                            {user.payouts.map(payout => (
                                <div key={payout.id} className="flex items-center justify-between py-4">
                                    <div className="flex items-center">
                                        <div className="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center mr-4"><DollarSignIcon className="w-5 h-5 text-green-400"/></div>
                                        <div>
                                            <p className="font-semibold text-white">Payout Received</p>
                                            <p className="text-sm text-neutral-400">{new Date(payout.date).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <p className="text-lg font-bold text-white">${payout.amount.toFixed(2)}</p>
                                        {payout.status === 'Completed' ? (
                                            <div title="Completed">
                                                <CheckCircleIcon className="w-5 h-5 text-green-400" />
                                            </div>
                                        ) : (
                                            <p className="text-sm font-medium text-yellow-400 bg-yellow-500/10 px-3 py-1 rounded-full">{payout.status}</p>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                         <div className="text-center py-16">
                            <h3 className="text-xl font-bold text-white">No Payout History</h3>
                            <p className="text-neutral-500 mt-2">Your completed payouts will appear here.</p>
                        </div>
                    )}
                </div>
            )}

            {promoToStop && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm">
                    <div className="w-full max-w-sm bg-neutral-900 border border-neutral-700 rounded-2xl p-8 text-center">
                        <h3 className="text-xl font-bold text-white mb-2">Are you sure?</h3>
                        <p className="text-neutral-400 mb-6">This will stop your promotion for "{promoToStop.eventName}". You will keep your earnings.</p>
                        <div className="flex justify-center space-x-4">
                            <button onClick={() => setPromoToStop(null)} className="px-6 py-2 text-sm font-semibold text-neutral-300 bg-neutral-800 hover:bg-neutral-700 rounded-full transition-colors">Cancel</button>
                            <button onClick={handleStopPromotion} className="px-6 py-2 text-sm font-semibold text-white bg-red-600 hover:bg-red-500 rounded-full transition-colors">Stop Promoting</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default PromoterPortal;
--- END OF FILE ./pages/PromoterPortal.tsx ---




--- START OF FILE ./fix_stripe_webhook.md ---

# ðŸš¨ CRITICAL: Stripe Webhook Failure on Port 8181

## Diagnosis
The frontend reports successful payments (`payment_intent.succeeded`) via the Stripe Element, but orders remain `Pending` in the database. This confirms that **Stripe Webhooks are not reaching the backend**.

**Likely Causes:**
1.  **Port 8181:** Stripe does not officially restrict ports, but intermediate firewalls, cloud security groups (AWS/GCP), or corporate networks often block INBOUND traffic on non-standard ports like 8181.
2.  **SSL/TLS:** If `https://api.eventsta.com:8181` is using a self-signed certificate or an invalid chain, Stripe will fail to deliver the webhook event.
3.  **Webhook Configuration:** The URL in the Stripe Dashboard might be set to the main domain (port 443) instead of specifically `:8181`.

## ðŸ› ï¸ REQUIRED FIX: Implement Manual Confirmation Endpoint (Robust Fallback)

Since we cannot rely solely on webhooks (especially in dev/staging environments or with port restrictions), you **MUST** implement a manual confirmation endpoint. The frontend has been updated to call this immediately after a successful payment to force-sync the status.

### New Endpoint Specification

**Method:** `POST`
**URL:** `/orders/:id/confirm`
**Auth:** Protected (User must own the order)

**Required Backend Logic:**
1.  **Lookup:** Find the Order by `:id`.
2.  **Retrieve:** Get the associated `payment_intent_id` stored in your DB for this order.
3.  **Stripe API Call:** Perform a direct API call to Stripe:
    ```javascript
    const paymentIntent = await stripe.paymentIntents.retrieve(order.payment_intent_id);
    ```
4.  **Verify & Update:**
    *   **If `paymentIntent.status === 'succeeded'`:**
        *   Update the Order `status` to `'Completed'` in the database.
        *   Trigger ticket generation and email confirmation logic (same logic as your webhook handler).
        *   Return `200 OK` `{ status: 'Completed' }`.
    *   **If not succeeded:**
        *   Return the current status or `400 Bad Request`.

### Why this fixes it:
The frontend *knows* the payment succeeded because the Stripe JS SDK returns `success`. By calling this endpoint, the frontend tells the server "I paid, please double-check Stripe now!" This bypasses the blocked webhook channel entirely for the critical user path.

--- END OF FILE ./fix_stripe_webhook.md ---




--- START OF FILE ./backend_promo_code_fix.md ---

# ðŸš¨ CRITICAL BACKEND BUG: Promo Code Deletion Fails to Persist

## Severity: High
**Impact:** Event hosts cannot delete promo codes. This breaks a core part of marketing and promotion management, leading to user frustration and potentially unwanted discounts remaining active.

## The Issue
The API endpoint for deleting a promo code is responding with a success message, but the data is not being removed from the database.

## Evidence from Logs
A sequence of API calls shows the following behavior:
1.  `DELETE /events/{eventId}/promocodes/{codeId}` is called.
2.  The API correctly responds with `200 OK` and `{"success":true}`.
3.  An immediate `GET /events/{eventId}/promocodes` is called.
4.  The API response for the `GET` request **still contains the supposedly deleted promo code**.

This confirms that the delete operation is not being persisted, despite the API claiming success.

## Likely Causes (Using StaxDB ORM)
Given that an ORM is in use, the issue is likely not with raw SQL but with how the ORM is being instructed to handle the data modification. Common causes include:
1.  **Transaction Not Committed:** The delete operation is performed within a transaction that is never committed to the database.
2.  **Incorrect Entity State:** The ORM's `delete()` or `remove()` method is called, but the changes are not saved or flushed to the database (e.g., a required `unitOfWork.commit()` or `entityManager.flush()` call is missing).
3.  **"Soft Delete" Misconfiguration:** If the system uses soft deletes (e.g., setting an `is_deleted` flag), the `DELETE` handler might be setting the flag, but the `GET` handler is not filtering out records where `is_deleted = true`.
4.  **Entity Not Found:** The logic to find the `PromoCode` entity before deleting it might be failing silently, but the controller proceeds to return a success message regardless.

## Required Fix (For Backend Team)

Please investigate the controller/handler for the following endpoint:
**`DELETE /events/:eventId/promocodes/:codeId`**

1.  **Verify Entity Retrieval:** Ensure that the `PromoCode` entity is being correctly fetched from the database using the `codeId` from the URL. If no entity is found, the endpoint should return a `404 Not Found` error, not a success message.

2.  **Ensure Deletion Logic:** Confirm that the appropriate StaxDB method to delete an entity is being called on the fetched `PromoCode` object.

3.  **Commit the Transaction:** **This is the most likely culprit.** After calling the delete method, ensure that the transaction or session is explicitly committed to persist the change. The exact method will depend on your StaxDB setup (e.g., `StaxDB.save()`, `transaction.commit()`, etc.).

4.  **Check Soft Delete Logic:**
    *   If you are using soft deletes, verify that the `DELETE` handler correctly sets the `is_deleted` (or similar) flag.
    *   Crucially, you must also update the `GET /events/:eventId/promocodes` handler to filter out these records by adding a condition like `WHERE is_deleted = false`.

## Verification Steps
To confirm the fix:
1.  Create a new, temporary promo code for an event using the API.
2.  Call the `DELETE /events/{eventId}/promocodes/{newCodeId}` endpoint for the new code. Verify it returns `200 OK`.
3.  Immediately call `GET /events/{eventId}/promocodes`.
4.  **Success:** The response should **NOT** contain the deleted promo code.
5.  Check the database directly to confirm the record is either physically gone or its soft-delete flag is set correctly.

--- END OF FILE ./backend_promo_code_fix.md ---




--- START OF FILE ./services/api.ts ---


export * from './api/index';

--- END OF FILE ./services/api.ts ---




--- START OF FILE ./services/geminiService.ts ---


import { GoogleGenAI, Modality } from "@google/genai";

const API_KEY = process.env.API_KEY;

if (!API_KEY) {
  console.warn("Gemini API key not found. AI features will be disabled.");
}

const ai = new GoogleGenAI({ apiKey: API_KEY! });

export const generateEventDescription = async (title: string, currentDescription: string): Promise<string> => {
  if (!API_KEY) {
    return Promise.resolve("AI functionality is disabled. Please configure your API key.");
  }
  
  try {
    const prompt = `Rewrite and improve this event description to be more compelling, exciting, and professional. Keep it to 2-3 sentences.
Event Title: "${title}"
Current Description: "${currentDescription || 'No description provided yet.'}"

Do not use markdown in your response.`;

    const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: prompt,
    });
    
    return response.text;
  } catch (error) {
    console.error("Error generating event description:", error);
    return "There was an error generating the description.";
  }
};

export const generateEventImage = async (title: string, description: string): Promise<string> => {
    if (!API_KEY) {
        // Return a placeholder if AI is disabled
        return Promise.resolve("https://picsum.photos/seed/ai-disabled/1024/768");
    }

    try {
        const prompt = `Create a vibrant, abstract, and visually stunning event flyer image for an event titled "${title}". Description: "${description}". The image should be suitable as a promotional background. It needs to be high-energy and eye-catching. Do not include any text, letters, or words in the image.`;

        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash-image',
            contents: {
                parts: [{ text: prompt }],
            },
            config: {
                responseModalities: [Modality.IMAGE],
            },
        });

        for (const part of response.candidates[0].content.parts) {
            if (part.inlineData) {
                return `data:image/png;base64,${part.inlineData.data}`;
            }
        }
        throw new Error("No image data found in response");

    } catch (error) {
        console.error("Error generating event image:", error);
        // Return a placeholder on error
        return "https://picsum.photos/seed/ai-error/1024/768";
    }
};
--- END OF FILE ./services/geminiService.ts ---




--- START OF FILE ./services/api/core.ts ---



import { v4 as uuidv4 } from 'uuid';
import { createEventSlug } from '../../utils/url';
import { User, Event, Host, PurchasedTicket, PromoStat, Payout, TicketOption, CompetitionForm, Competition, Order, AddOn } from '../../types';

export const getBaseUrl = () => {
    // Check if the code is running in a browser environment
    if (typeof window !== 'undefined') {
        const hostname = window.location.hostname;

        // If the hostname is NOT 'eventsta.com', we assume it's a development environment.
        // This covers localhost, 127.0.0.1, and any cloud-based dev server (like *.github.dev).
        if (hostname !== 'eventsta.com') {
            // In development, ALWAYS point to the live production API.
            console.log(`[API] Development mode detected on host: ${hostname}. Using production API endpoint.`);
            return 'https://eventsta.com/api/v1';
        }
    }

    // In production (when served from eventsta.com), use a relative path.
    // This is the most robust option for the deployed site.
    return '/api/v1';
};

export const API_URL = getBaseUrl();

// --- LOCAL STORAGE HELPERS ---
export const getToken = (): string | null => localStorage.getItem('auth_token');
export const setToken = (token: string) => localStorage.setItem('auth_token', token);
export const removeToken = () => localStorage.removeItem('auth_token');

// --- MOCK DATA ---
export const MOCK_USER = {
    id: 'demo_user',
    name: 'Demo User',
    email: 'demo@eventsta.com',
    role: 'USER',
    stripe_connected: false,
    stripe_account_id: null
};

// --- API CLIENT ---
export async function request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {
    const token = getToken();
    
    // Determine headers
    const headers: any = {
        ...(options.headers || {}),
    };

    // FIX: Only set Content-Type to application/json if there is a body AND it is not FormData.
    if (options.body) {
        if (!(options.body instanceof FormData)) {
            // Default to JSON if not explicitly set
            if (!headers['Content-Type']) {
                headers['Content-Type'] = 'application/json';
            }
        }
    }

    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    const url = `${API_URL}${endpoint}`;
    const method = options.method || 'GET';
    const timestamp = new Date().toISOString().split('T')[1].slice(0, -1); // HH:mm:ss.sss

    // LOGGING: REQUEST
    console.log(`[${timestamp}] ðŸ“¡ [API REQ] ${method} ${url}`);
    if (options.body && !(options.body instanceof FormData)) {
        console.log("TX Data:", options.body);
    } else if (options.body instanceof FormData) {
        console.log("TX Data: [FormData]");
    }
    
    const isMixedContent = typeof window !== 'undefined' && window.location.protocol === 'https:' && url.startsWith('http:');

    try {
        if (isMixedContent) {
            throw new Error("Mixed Content Blocked: The page is loaded over HTTPS but is requesting an insecure HTTP API.");
        }

        const response = await fetch(url, { ...options, headers });
        const text = await response.text();

        // LOGGING: RESPONSE
        console.log(`[${timestamp}] ðŸ“¥ [API RES] ${response.status} ${url}`);
        if (text && text.length < 500) {
             console.log("RX Data:", text);
        } else if (text) {
             console.log("RX Data: [Large Response]");
        }

        if (!response.ok) {
            let errorMessage = `HTTP Error: ${response.status} ${response.statusText}`;
            let data;
            try {
                if (text) {
                    data = JSON.parse(text);
                    if (data.error) errorMessage = data.error;
                    else if (data.message) errorMessage = data.message;
                }
            } catch (e) {
                if (text && text.length < 200) errorMessage = text;
            }
            throw new Error(errorMessage);
        }

        let data;
        try {
            data = text ? JSON.parse(text) : {};
        } catch(e) {
            data = {};
        }
        return data as T;
    } catch (error: any) {
        const timestampErr = new Date().toISOString().split('T')[1].slice(0, -1);
        let failureReason = error.message || 'Unknown Error';
        
        if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
             if (typeof navigator !== 'undefined' && !navigator.onLine) {
                 failureReason = "Offline: Device is not connected to the internet.";
             } else if (isMixedContent) {
                 failureReason = "Mixed Content: Browser blocked insecure HTTP request from HTTPS origin.";
             } else {
                 failureReason = "Network/CORS Error: The server is unreachable, refused connection, or CORS headers are missing.";
             }
        } else if (isMixedContent) {
             failureReason = "Mixed Content Blocked: Browser security prevented HTTP request.";
        }

        console.group(`âŒ [API FAILURE] ${method} ${url}`);
        console.error(`Time: ${timestampErr}`);
        console.error(`Reason: ${failureReason}`);
        console.error(`Origin: ${typeof window !== 'undefined' ? window.location.origin : 'Server'}`);
        console.error(`Target: ${url}`);
        console.groupEnd();
        
        throw error;
    }
}

// --- FILE UPLOAD ---
export const uploadFile = async (file: File | Blob): Promise<string> => {
    console.info(`[ACTION] uploadFile: ${file.size} bytes`);
    const formData = new FormData();
    formData.append('file', file);

    const res = await request<{ url: string }>('/upload', {
        method: 'POST',
        body: formData
    });

    // REMOVED: Obsolete URL fix for port 8181. Backend is now expected
    // to return the full, correct URL for the uploaded resource.
    return res.url;
};

// --- MAPPERS ---

export function parseImages(input: any): string[] {
    if (Array.isArray(input)) return input;
    if (typeof input === 'string') return input.split(',').filter(s => s.trim() !== '');
    return [];
}

export function mapApiUserToFrontend(apiUser: any, promoStats: PromoStat[] = [], payouts: Payout[] = []): User {
    const isSuperAdminEmail = apiUser.email && apiUser.email.toLowerCase() === 'superadmin@eventsta.com';
    const isActuallyAdmin = apiUser.isSystemAdmin === true || apiUser.role === 'SUPER_ADMIN' || isSuperAdminEmail;

    const mappedTickets: PurchasedTicket[] = (apiUser.purchasedTickets || []).map((t: any) => ({
        id: t.id || uuidv4(),
        orderId: t.order_id || t.orderId || 'unknown_order',
        eventId: t.event_id || t.eventId || '',
        eventName: t.event_name || t.eventName || 'Event',
        ticketType: t.ticket_type || t.ticketType || 'Ticket',
        inventoryId: t.inventory_id || t.inventoryId,
        qty: t.qty || 1,
        purchaseDate: t.purchased_at || t.purchaseDate || new Date().toISOString()
    }));

    return {
        id: apiUser.id,
        name: apiUser.name,
        email: apiUser.email,
        managedHostIds: apiUser.managedHostIds || [],
        purchasedTickets: mappedTickets,
        promoStats: promoStats,
        payouts: payouts,
        isSystemAdmin: isActuallyAdmin,
        stripeConnected: apiUser.stripe_connected,
        stripeAccountId: apiUser.stripe_account_id,
        artistProfile: apiUser.artist_profile,
        notificationPreferences: apiUser.notification_preferences,
        isDisabled: apiUser.is_disabled
    };
}

export function mapApiOrderToFrontend(apiOrder: any): Order {
    // 1. Handle items array
    let items = apiOrder.items;
    
    if (typeof items === 'string') {
        try {
            items = JSON.parse(items);
        } catch (e) {
            console.warn("Failed to parse order items JSON string:", items, e);
            items = [];
        }
    }
    
    if (!Array.isArray(items)) {
        items = [];
    }

    // Helper to safely clean strings
    const cleanString = (val: any) => (val === 'null' || val === null ? undefined : val);

    // Helper to extract numeric total
    const getTotal = (o: any) => {
        if (typeof o.totalPaid === 'number') return o.totalPaid;
        if (typeof o.total_paid === 'number') return o.total_paid;
        if (typeof o.total_amount === 'number') return o.total_amount;
        return 0;
    };

    // Resolving Purchaser Name
    // Priority: Explicit purchaser_name -> Nested User object -> Fallback
    let resolvedPurchaserName = cleanString(apiOrder.purchaserName || apiOrder.purchaser_name);
    if (!resolvedPurchaserName && apiOrder.user && apiOrder.user.name) {
        resolvedPurchaserName = apiOrder.user.name;
    }
    if (!resolvedPurchaserName) resolvedPurchaserName = 'Guest';

    // Resolving Purchaser Email
    let resolvedPurchaserEmail = cleanString(apiOrder.purchaserEmail || apiOrder.purchaser_email);
    if (!resolvedPurchaserEmail && apiOrder.user && apiOrder.user.email) {
        resolvedPurchaserEmail = apiOrder.user.email;
    }

    // Resolving Affiliate Name
    // Priority: Explicit affiliate_name -> recipientUserName -> "Unknown" if ID exists
    let resolvedAffiliateName = cleanString(apiOrder.affiliate_name || apiOrder.recipientUserName || apiOrder.recipient_user_name);
    const hasAffiliateId = cleanString(apiOrder.recipientUserId || apiOrder.recipient_user_id || apiOrder.affiliate_user_id);
    
    if (!resolvedAffiliateName && hasAffiliateId) {
        // If we have an ID but no name, we might display the ID or just wait for backend fix
        resolvedAffiliateName = hasAffiliateId; // Better than nothing
    }

    return {
        orderId: apiOrder.orderId || apiOrder.order_id || apiOrder.id || 'unknown_id',
        eventId: apiOrder.eventId || apiOrder.event_id || '',
        purchaserName: resolvedPurchaserName,
        purchaserEmail: resolvedPurchaserEmail || '',
        userId: apiOrder.userId || apiOrder.user_id, 
        purchaseDate: apiOrder.purchaseDate || apiOrder.purchase_date || apiOrder.created_at || new Date().toISOString(),
        items: items.map((item: any) => ({
            ticketType: item.ticketType || item.ticket_type || item.name || 'Unknown Ticket',
            quantity: item.quantity || item.qty || 0,
            pricePerTicket: typeof item.pricePerTicket === 'number' ? item.pricePerTicket : (typeof item.price === 'number' ? item.price : (item.price_per_ticket || 0)),
            recipientUserId: item.recipientUserId || item.recipient_user_id
        })),
        totalPaid: getTotal(apiOrder),
        status: apiOrder.status || 'Pending',
        promoCode: cleanString(apiOrder.promoCode || apiOrder.promo_code),
        recipientUserId: hasAffiliateId,
        recipientUserName: resolvedAffiliateName, // NEW: Enriched field
        fees: apiOrder.fees || { mandatory: 0, donation: 0 }
    };
}

export function mapApiEventToFrontend(apiEvent: any): Event {
    let schedule = [];
    let venueAreas = [];
    
    if (Array.isArray(apiEvent.schedule)) {
        schedule = apiEvent.schedule;
    }
    
    if (Array.isArray(apiEvent.venueAreas)) {
        venueAreas = apiEvent.venueAreas;
    }

    const rawInventory = apiEvent.inventory || [];
    const tickets: TicketOption[] = [];
    const addOns: AddOn[] = [];
    const uniqueIds = new Set();

    // Map unified inventory array to frontend specific arrays
    for (const inv of rawInventory) {
        if (inv.id && uniqueIds.has(inv.id)) {
            continue;
        }
        if (inv.id) uniqueIds.add(inv.id);
        
        // CRITICAL FIX: Filter out malformed items that missing essential fields
        // This prevents frontend crashes when iterating over corrupted data (e.g. { category: "TICKET" })
        if (!inv.type && typeof inv.price !== 'number' && !inv.id) {
            console.warn(`[DATA ERROR] Skipping malformed inventory item:`, inv);
            continue;
        }

        if (inv.category === 'ADD_ON') {
            addOns.push({
                id: inv.id,
                name: inv.type || 'Unknown Add-on', // Map 'type' back to 'name' for AddOn
                price: typeof inv.price === 'number' ? inv.price : 0,
                description: inv.description || '',
                minimumDonation: typeof inv.min_donation === 'number' ? inv.min_donation : 0,
                category: 'ADD_ON'
            });
        } else {
            // Default to ticket if category is TICKET or missing (legacy)
            tickets.push({
                id: inv.id,
                type: inv.type || 'Unknown Ticket',
                price: typeof inv.price === 'number' ? inv.price : 0,
                quantity: typeof inv.quantity_total === 'number' ? inv.quantity_total : 0,
                sold: typeof inv.quantity_sold === 'number' ? inv.quantity_sold : 0,
                minimumDonation: typeof inv.min_donation === 'number' ? inv.min_donation : 0,
                description: inv.description || '',
                category: 'TICKET'
            });
        }
    }

    const forms = (apiEvent.forms || []).map((f: any) => ({
        id: f.id,
        title: f.title,
        description: f.description,
        headerImageUrl: f.headerImageUrl || f.header_image_url,
        elements: f.elements || [],
        isActive: f.isActive ?? f.is_active ?? true,
        responsesCount: f.responsesCount ?? f.responses_count ?? 0,
        lastUpdated: f.lastUpdated || f.last_updated || new Date().toISOString(),
        linkedCompetitionId: f.linkedCompetitionId || f.linked_competition_id
    }));

    const competitions = (apiEvent.competitions || []).map((c: any) => ({
        id: c.id,
        type: c.type || 'DJ_TICKET_SALES',
        status: c.status || 'SETUP',
        name: c.name,
        description: c.description,
        sectionIds: c.sectionIds || c.section_ids || [],
        competitorIds: c.competitorIds || c.competitor_ids || [],
        startDate: c.startDate || c.start_date || new Date().toISOString(),
        cutoffDate: c.cutoffDate || c.cutoff_date || new Date().toISOString(),
        promoDiscountPercent: c.promoDiscountPercent || c.promo_discount_percent || 0,
        commissionPercent: c.commissionPercent || c.commission_percent || 0,
        winnerIds: c.winnerIds || c.winner_ids || []
    }));

    return {
        id: apiEvent.id,
        title: apiEvent.title,
        hostId: apiEvent.hostId || apiEvent.host_id,
        hostName: apiEvent.hostName || apiEvent.host_name || "Host",
        date: apiEvent.start_time || apiEvent.start_date || apiEvent.date, 
        endDate: apiEvent.end_time || apiEvent.end_date || apiEvent.endDate || apiEvent.date,
        location: apiEvent.location || 'TBD',
        imageUrls: parseImages(apiEvent.images || apiEvent.imageUrls),
        description: apiEvent.description || '',
        commission: apiEvent.commission || apiEvent.commission_rate || 0,
        defaultPromoDiscount: apiEvent.defaultPromoDiscount || apiEvent.promo_discount_rate || 0,
        type: (apiEvent.type?.toLowerCase() as 'ticketed' | 'fundraiser') || 'ticketed',
        status: apiEvent.status || 'DRAFT',
        tickets: tickets,
        addOns: addOns,
        venueAreas: venueAreas,
        schedule: schedule,
        competitions: competitions,
        forms: forms,
        checkIns: apiEvent.checkIns || {}
    };
}

export function mapApiHostToFrontend(apiHost: any): Host {
    const parseBool = (val: any) => {
        if (typeof val === 'boolean') return val;
        if (typeof val === 'string') return val.toLowerCase() === 'true';
        return !!val;
    };

    return {
        id: apiHost.id,
        name: apiHost.name,
        ownerUserId: apiHost.ownerUserId || apiHost.owner_user_id,
        eventIds: apiHost.eventIds || apiHost.event_ids || [],
        reviews: apiHost.reviews || [],
        description: apiHost.description || '',
        imageUrl: apiHost.imageUrl || apiHost.image_url,
        coverImageUrl: apiHost.coverImageUrl || apiHost.cover_image_url,
        isDefault: parseBool(apiHost.isDefault ?? apiHost.is_default),
        reviewsEnabled: parseBool(apiHost.reviewsEnabled ?? apiHost.reviews_enabled)
    };
}

// --- BASIC LOOKUPS (Shared) ---

export const getUsersByIds = async (ids: string[]): Promise<User[]> => {
    console.info(`[ACTION] getUsersByIds: Fetching ${ids.length} users`);
    if (ids.length === 0) return [];
    const users = await request<any[]>(`/users?ids=${ids.join(',')}`);
    return users.map(u => mapApiUserToFrontend(u));
};

export const getHostsByIds = async (ids: string[]): Promise<Host[]> => {
    console.info(`[ACTION] getHostsByIds: Fetching ${ids.length} hosts`);
    if (ids.length === 0) return [];
    const rawHosts = await request<any[]>(`/hosts?ids=${ids.join(',')}`);
    return rawHosts.map(mapApiHostToFrontend);
};

export const createHost = async (userId: string, name: string): Promise<Host> => {
    console.info(`[ACTION] createHost: User ${userId} creating host "${name}"`);
    const res = await request<any>('/hosts', { method: 'POST', body: JSON.stringify({ name }) });
    return mapApiHostToFrontend(res);
};

// --- DATA ENRICHMENT HELPERS ---

/**
 * Automatically fetches host details for events where the hostName is missing or generic.
 * This compensates for API endpoints that don't join the Host table.
 */
export const backfillHostNames = async (events: Event[]): Promise<Event[]> => {
    const missingHostIds = new Set<string>();
    
    // Identify events needing backfill
    events.forEach(e => {
        if (e.hostId && (e.hostName === 'Host' || !e.hostName)) {
            missingHostIds.add(e.hostId);
        }
    });

    if (missingHostIds.size > 0) {
        try {
            console.debug(`[Backfill] Fetching names for ${missingHostIds.size} hosts...`);
            const hosts = await getHostsByIds(Array.from(missingHostIds));
            const hostMap = new Map(hosts.map(h => [h.id, h.name]));
            
            // Update events in place (or new array if strict immutability desired, but this is a helper)
            events.forEach(e => {
                if (hostMap.has(e.hostId)) {
                    e.hostName = hostMap.get(e.hostId)!;
                }
            });
        } catch (e) {
            console.warn("Failed to backfill host names", e);
        }
    }
    return events;
};

export const getEventsByIds = async (ids: string[], includeDrafts: boolean = false): Promise<Event[]> => {
    console.info(`[ACTION] getEventsByIds: Fetching ${ids.length} events (Drafts: ${includeDrafts})`);
    if (ids.length === 0) return [];
    // Append include_drafts if true
    const queryString = `ids=${ids.join(',')}${includeDrafts ? '&include_drafts=true' : ''}`;
    const eventsRaw = await request<any[]>(`/events?${queryString}`);
    const mapped = eventsRaw.map(mapApiEventToFrontend);
    return backfillHostNames(mapped);
};
--- END OF FILE ./services/api/core.ts ---




--- START OF FILE ./services/api/events.ts ---





import { Event, Host, PromoStat, ReportData, Order, PromoCode, LeaderboardEntry, CheckoutCart, CompetitionForm, PayoutRequest, HostFinancials, SystemEmailTemplate, SystemEmailTrigger, SystemSettings, EmailDraft, EmailCampaign, TargetRole, Review, TicketOption } from '../../types';
import { request, uploadFile, mapApiEventToFrontend, mapApiHostToFrontend, mapApiOrderToFrontend, parseImages, getUsersByIds, backfillHostNames } from './core';
import * as emailService from '../emailService';

// --- EVENTS ---

export const getFeaturedEvents = async (): Promise<Event[]> => {
    console.info(`[ACTION] getFeaturedEvents: Loading homepage events`);
    const events = await request<any[]>('/events');
    const mapped = events.map(mapApiEventToFrontend);
    return backfillHostNames(mapped);
};

export const getEventDetails = async (id: string): Promise<Event> => {
    console.info(`[ACTION] getEventDetails: Fetching ${id}`);
    const event = await request<any>(`/events/${id}`);
    return mapApiEventToFrontend(event);
};

export const createEvent = async (userId: string, hostId: string, eventData: Partial<Event>): Promise<Event> => {
    console.info(`[ACTION] createEvent: User ${userId} creating event for Host ${hostId}`);
    
    // Construct unified inventory payload
    const inventoryPayload = [
        ...(eventData.tickets || []).map(t => ({
            type: t.type,
            price: t.price,
            quantity_total: t.quantity || 100, 
            min_donation: t.minimumDonation,
            description: t.description,
            category: 'TICKET'
        })),
        ...(eventData.addOns || []).map(a => ({
            type: a.name, // Map name to type
            price: a.price,
            quantity_total: 1000, 
            min_donation: a.minimumDonation, 
            description: a.description,
            category: 'ADD_ON'
        }))
    ];

    const backendPayload = {
        host_id: hostId,
        title: eventData.title,
        description: eventData.description,
        location: eventData.location,
        start_time: eventData.date,
        end_time: eventData.endDate,
        type: eventData.type ? eventData.type.toUpperCase() : 'TICKETED',
        images: eventData.imageUrls || [],
        commission_rate: eventData.commission,
        promo_discount_rate: eventData.defaultPromoDiscount,
        inventory: inventoryPayload, // Unified inventory
        addOns: [], // Empty legacy field
        schedule: eventData.schedule || [],
        venueAreas: eventData.venueAreas || [],
        status: eventData.status 
    };

    const res = await request<any>('/events', {
        method: 'POST',
        body: JSON.stringify(backendPayload)
    });
    
    const mappedEvent = mapApiEventToFrontend(res);
    
    if ((!mappedEvent.hostName || mappedEvent.hostName === 'Host') && eventData.hostName) {
        mappedEvent.hostName = eventData.hostName;
    }
    
    return mappedEvent;
};

export const updateEvent = async (userId: string, eventId: string, updates: Partial<Event>): Promise<Event> => {
    console.info(`[ACTION] updateEvent: Updating ${eventId}`);
    
    const payload: any = { ...updates };
    
    if (updates.date) {
        payload.start_time = updates.date;
        delete payload.date;
    }
    if (updates.endDate) {
        payload.end_time = updates.endDate;
        delete payload.endDate;
    }
    
    if ('start_date' in payload) delete payload.start_date;
    if ('end_date' in payload) delete payload.end_date;

    if (updates.imageUrls) {
        payload.images = updates.imageUrls;
        delete payload.imageUrls;
    }
    if (updates.commission !== undefined) {
        payload.commission_rate = updates.commission;
        delete payload.commission;
    }
    if (updates.defaultPromoDiscount !== undefined) {
        payload.promo_discount_rate = updates.defaultPromoDiscount;
        delete payload.defaultPromoDiscount;
    }
    if (updates.hostId) {
        payload.host_id = updates.hostId;
        delete payload.hostId;
    }
    
    // Check if we are updating inventory items (either tickets or addOns)
    // NOTE: It is the responsibility of the calling component to provide BOTH tickets and addOns
    // if either is being updated, to ensure the full inventory list is sent to the backend.
    if (updates.tickets || updates.addOns) {
        const inventoryPayload = [
            ...(updates.tickets || []).map(t => ({
                id: t.id,
                type: t.type,
                price: t.price,
                quantity_total: t.quantity,
                min_donation: t.minimumDonation,
                description: t.description,
                category: 'TICKET'
            })),
            ...(updates.addOns || []).map(a => ({
                id: a.id,
                type: a.name,
                price: a.price,
                quantity_total: 1000, 
                min_donation: a.minimumDonation,
                description: a.description,
                category: 'ADD_ON'
            }))
        ];
        
        payload.inventory = inventoryPayload;
        delete payload.tickets;
        delete payload.addOns;
    }

    const res = await request<any>(`/events/${eventId}`, {
        method: 'PATCH',
        body: JSON.stringify(payload)
    });
    return mapApiEventToFrontend(res);
};

export const getOtherEventsByHost = async (hostId: string, excludeEventId: string): Promise<Event[]> => {
    console.info(`[ACTION] getOtherEventsByHost: Host ${hostId} excluding ${excludeEventId}`);
    const events = await request<any[]>(`/events?host_id=${hostId}&exclude=${excludeEventId}`);
    const mapped = events.map(mapApiEventToFrontend);
    return backfillHostNames(mapped);
};

export const getEventsByHost = async (hostId: string, includeDrafts: boolean = false): Promise<Event[]> => {
    console.info(`[ACTION] getEventsByHost: Fetching all events for host ${hostId} (Drafts: ${includeDrafts})`);
    const events = await request<any[]>(`/events?host_id=${hostId}${includeDrafts ? '&include_drafts=true' : ''}`);
    const mapped = events.map(mapApiEventToFrontend);
    return backfillHostNames(mapped);
};

export const getAllEventsAdmin = async (page: number, limit: number, search: string) => {
    console.info(`[ACTION] getAllEventsAdmin`);
    const res = await request<{ events: any[], total: number }>(`/admin/events?page=${page}&limit=${limit}&search=${encodeURIComponent(search)}`);
    const mapped = res.events.map(mapApiEventToFrontend);
    const enriched = await backfillHostNames(mapped);
    return { events: enriched, total: res.total };
};

export const generateEventDescription = async (title: string, current: string) => {
    console.info(`[ACTION] generateEventDescription: ${title}`);
    const res = await request<any>('/ai/generate-description', { method: 'POST', body: JSON.stringify({ title, current }) });
    return res.description;
};

// --- HOSTS ---

export const getHostDetails = async (id: string): Promise<Host> => {
    console.info(`[ACTION] getHostDetails: Fetching ${id}`);
    const raw = await request<any>(`/hosts/${id}`);
    return mapApiHostToFrontend(raw);
};

export const getHostReviews = async (hostId: string): Promise<Review[]> => { 
    console.info(`[ACTION] getHostReviews: Fetching for ${hostId}`);
    return await request<Review[]>(`/hosts/${hostId}/reviews`);
};

export const createHostReview = async (hostId: string, review: any): Promise<void> => {
    console.info(`[ACTION] createHostReview: Reviewing ${hostId}`);
    await request(`/hosts/${hostId}/reviews`, { method: 'POST', body: JSON.stringify(review) });
};

export const deleteHost = (userId: string, hostId: string) => {
    console.info(`[ACTION] deleteHost: ${hostId}`);
    return request(`/hosts/${hostId}`, { method: 'DELETE' });
};

export const updateHostDetails = async (id: string, data: Partial<Host>) => {
    console.info(`[ACTION] updateHostDetails: ${id}`);
    const res = await request<any>(`/hosts/${id}`, { method: 'PATCH', body: JSON.stringify(data) });
    return mapApiHostToFrontend(res);
};

// --- TICKETING & ORDERS ---

export const purchaseTicket = async (userId: string, eventId: string, cart: CheckoutCart, recipientUserId?: string, promoCode?: string, fees?: any): Promise<{ clientSecret: string, orderId: string }> => {
    console.debug(`[Promo Debug] ðŸ›’ API purchaseTicket. User: ${userId}, Event: ${eventId}, Promo: ${promoCode || 'None'}`);
    
    // CRITICAL FIX: Sanitize recipientUserId. 
    // The backend crashes if it receives the string "null" instead of a null value.
    const cleanRecipientId = (recipientUserId === 'null' || recipientUserId === 'undefined') ? undefined : recipientUserId;

    return await request<any>('/orders/checkout', {
        method: 'POST',
        body: JSON.stringify({ 
            event_id: eventId, 
            items: cart, 
            recipient_user_id: cleanRecipientId, 
            promo_code: promoCode, 
            fees 
        })
    });
};

export const confirmOrderPayment = async (orderId: string): Promise<void> => {
    console.info(`[ACTION] confirmOrderPayment: Forcing sync for Order ${orderId}`);
    // This endpoint should be implemented by backend as described in fix_stripe_webhook.md
    await request(`/orders/${orderId}/confirm`, { method: 'POST' });
};

export const getOrdersForEvent = async (eventId: string): Promise<Order[]> => {
    console.info(`[ACTION] getOrdersForEvent: Fetching orders for ${eventId}`);
    const rawOrders = await request<any[]>(`/events/${eventId}/orders`);
    return rawOrders.map(mapApiOrderToFrontend);
};

export const getUserOrders = async (): Promise<Order[]> => {
    console.info(`[ACTION] getUserOrders: Fetching orders for current user`);
    const rawOrders = await request<any[]>('/orders/mine');
    return rawOrders.map(mapApiOrderToFrontend);
};

export const validateTicket = async (eventId: string, ticketData: string): Promise<{valid: boolean, message: string, ticket?: any}> => {
    console.info(`[ACTION] validateTicket: Validating for Event ${eventId}`);
    return await request<{valid: boolean, message: string, ticket?: any}>('/check-in/validate', {
        method: 'POST',
        body: JSON.stringify({ event_id: eventId, qr_data: ticketData })
    });
};

export const checkInTicket = async (eventId: string, ticketId: string): Promise<void> => {
    console.info(`[ACTION] checkInTicket: Checking in ticket ${ticketId}`);
    await request('/check-in/commit', { method: 'POST', body: JSON.stringify({ event_id: eventId, ticket_id: ticketId }) });
};

export const undoCheckIn = (eventId: string, ticketId: string) => {
    console.info(`[ACTION] undoCheckIn: ${ticketId}`);
    return request('/check-in/undo', { method: 'POST', body: JSON.stringify({ event_id: eventId, ticket_id: ticketId }) });
};

export const getOrderDetails = async (id: string): Promise<Order> => {
    console.info(`[ACTION] getOrderDetails: ${id}`);
    const raw = await request<any>(`/orders/${id}`);
    return mapApiOrderToFrontend(raw);
};

export const refundOrder = async (userId: string, orderId: string): Promise<Order> => {
    console.info(`[ACTION] refundOrder: ${orderId}`);
    const raw = await request<any>(`/orders/${orderId}/refund`, { method: 'POST' });
    return mapApiOrderToFrontend(raw);
};

// --- PROMOTIONS ---

export const getPromoCodesForEvent = (eventId: string) => {
    console.info(`[ACTION] getPromoCodesForEvent: ${eventId}`);
    return request<PromoCode[]>(`/events/${eventId}/promocodes`);
};

export const createPromoCode = (userId: string, eventId: string, data: any) => {
    console.info(`[ACTION] createPromoCode: Event ${eventId}`);
    return request<PromoCode>(`/events/${eventId}/promocodes`, { method: 'POST', body: JSON.stringify(data) });
};

export const validatePromoCode = async (eventId: string, code: string): Promise<{ valid: boolean, discountPercent: number, code: string, ownerName?: string }> => {
    console.debug(`[Promo Debug] ðŸ” API validatePromoCode request: Code '${code}' for Event '${eventId}'`);
    const res = await request<{ valid: boolean, discountPercent: number, code: string, ownerName?: string }>(`/events/${eventId}/promocodes/validate`, {
        method: 'POST',
        body: JSON.stringify({ code })
    });
    console.debug(`[Promo Debug] âœ… API validatePromoCode response:`, res);
    return res;
};

export const updatePromoterCode = async (userId: string, eventId: string, newCode: string): Promise<any> => {
    console.info(`[ACTION] updatePromoterCode: User ${userId} Event ${eventId} NewCode ${newCode}`);
    return request(`/promotions/${eventId}/code`, { 
        method: 'PUT', 
        body: JSON.stringify({ new_code: newCode }) 
    });
};

export const deletePromoCode = (userId: string, eventId: string, codeId: string) => {
    console.info(`[ACTION] deletePromoCode: ${codeId}`);
    return request<{ success: boolean }>(`/events/${eventId}/promocodes/${codeId}`, { method: 'DELETE' });
};

export const getCompetitionLeaderboard = async (eventId: string): Promise<LeaderboardEntry[]> => {
    console.info(`[ACTION] getCompetitionLeaderboard: ${eventId}`);
    const rawData = await request<any[]>(`/competitions/${eventId}/leaderboard`);
    
    const missingNameIds = rawData
        .filter(item => !item.user_name && !item.name && item.user_id)
        .map(item => item.user_id);
    
    let userMap: Record<string, string> = {};
    
    if (missingNameIds.length > 0) {
        try {
            console.debug(`[Leaderboard] Fetching ${missingNameIds.length} missing user names...`);
            const uniqueIds = Array.from(new Set(missingNameIds));
            const users = await getUsersByIds(uniqueIds);
            users.forEach(u => {
                userMap[u.id] = u.name;
            });
        } catch (e) {
            console.warn("[Leaderboard] Failed to fetch missing user names", e);
        }
    }

    return rawData.map(item => ({
        userId: item.user_id,
        userName: item.user_name || item.name || userMap[item.user_id] || 'Unknown User',
        salesCount: item.sales_count || 0,
        salesValue: item.sales_volume || 0,
        lastSaleDate: item.last_sale_date 
    }));
};

export const joinCompetition = (userId: string, event: Event, competitionId?: string) => {
    console.info(`[ACTION] joinCompetition: User ${userId} -> Event ${event.id} ${competitionId ? `(Comp: ${competitionId})` : ''}`);
    return request('/promotions/join', { 
        method: 'POST', 
        body: JSON.stringify({ 
            event_id: event.id,
            competition_id: competitionId 
        }) 
    });
};

export const startPromotion = (userId: string, event: Event) => {
    console.info(`[ACTION] startPromotion: User ${userId} -> Event ${event.id}`);
    return request('/promotions/join', { method: 'POST', body: JSON.stringify({ event_id: event.id }) });
};

export const stopPromotion = (userId: string, eventId: string) => {
    console.info(`[ACTION] stopPromotion: ${eventId}`);
    return request(`/promotions/${eventId}`, { method: 'DELETE' });
};

export const trackPromoClick = async (eventId: string, code: string): Promise<void> => {
    console.debug(`[Promo Debug] ðŸ–±ï¸ API trackPromoClick: Code '${code}' for Event '${eventId}'`);
    request(`/promotions/track-click`, {
        method: 'POST',
        body: JSON.stringify({ event_id: eventId, code })
    }).catch(err => console.warn("Failed to track promo click", err));
};

export const finalizeCompetition = (userId: string, eventId: string, compId: string) => {
    console.info(`[ACTION] finalizeCompetition: ${compId}`);
    return request(`/competitions/${eventId}/${compId}/finalize`, { method: 'POST' });
};

// --- FORMS ---

export const getPublicForm = (formId: string) => {
    console.info(`[ACTION] getPublicForm: ${formId}`);
    return request<CompetitionForm>(`/forms/${formId}`);
};

export const submitFormResponse = (formId: string, data: any) => {
    console.info(`[ACTION] submitFormResponse: ${formId}`);
    return request(`/forms/${formId}/submit`, { method: 'POST', body: JSON.stringify(data) });
};

export const getFormResponses = (formId: string) => {
    console.info(`[ACTION] getFormResponses: ${formId}`);
    return request<any[]>(`/forms/${formId}/responses`);
};

// --- REPORTS & FINANCIALS ---

export const getReportData = async (eventId: string): Promise<ReportData> => {
    console.info(`[ACTION] getReportData: ${eventId}`);
    
    // Fetch report and leaderboard in parallel to ensure we have promoter data
    // even if the report endpoint fails to return it (current backend issue)
    const [rawReport, leaderboard] = await Promise.all([
        request<any>(`/events/${eventId}/report`),
        getCompetitionLeaderboard(eventId).catch(e => {
            console.warn("Failed to fetch leaderboard for report fallback", e);
            return [];
        })
    ]);

    const event = mapApiEventToFrontend(rawReport.event || {});
    
    // Helper to safely parse numbers, handling potential backend corruption like "[object Promise]"
    const parseSafeFloat = (val: any) => {
        if (typeof val === 'number') return val;
        if (typeof val === 'string') {
            // Remove non-numeric chars except dot and minus, but handle the specific corruption case
            if (val.includes('object Promise')) return 0; // Backend corruption detected
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        }
        return 0;
    };

    // Use promotions from report if available, otherwise array is empty
    let promotions: any[] = Array.isArray(rawReport.promotions) ? rawReport.promotions : [];

    // Fallback logic: If report promotions are missing but leaderboard exists, use leaderboard
    // to construct the promoter list so the admin can at least see sales stats.
    if (promotions.length === 0 && leaderboard.length > 0) {
        console.debug("[Report] Using leaderboard fallback for promotions list.");
        promotions = leaderboard.map(entry => ({
            userId: entry.userId,
            promoterName: entry.userName,
            artistName: '', 
            isCompetitor: true,
            clicks: 0, 
            sales: entry.salesCount,
            salesVolume: entry.salesValue, // Store raw volume for calculation
            earned: entry.salesValue * (event.commission / 100), // Estimated earnings
            promoLink: '' 
        }));
    } else {
        // Even if promotions exist, ensure they have proper fields if API returns 0 earned
        // And sanitize potential corrupted strings
        promotions = promotions.map(p => ({
            ...p,
            sales: parseSafeFloat(p.sales),
            clicks: parseSafeFloat(p.clicks),
            // Ensure sales volume is preserved if available
            salesVolume: parseSafeFloat(p.salesVolume || p.sales_volume),
            earned: parseSafeFloat(p.earned || p.earned_amount)
        }));
    }

    return {
        event: event,
        kpis: {
            grossSales: parseSafeFloat(rawReport.kpis?.grossSales),
            ticketsSold: parseSafeFloat(rawReport.kpis?.ticketsSold),
            pageViews: parseSafeFloat(rawReport.kpis?.pageViews),
            promoterSales: parseSafeFloat(rawReport.kpis?.promoterSales)
        },
        salesByTicketType: Array.isArray(rawReport.salesByTicketType) ? rawReport.salesByTicketType.map((item: any) => ({
            type: item.type,
            quantitySold: parseSafeFloat(item.quantitySold),
            grossSales: parseSafeFloat(item.grossSales)
        })) : [],
        promotions: promotions
    };
};

export const requestEarlyPayout = async (userId: string, amount: number) => {
    console.info(`[ACTION] requestEarlyPayout: ${userId} for $${amount}`);
    return await request<any>('/payouts/request', { method: 'POST', body: JSON.stringify({ amount }) });
};

export const getPayoutRequests = async (): Promise<PayoutRequest[]> => {
    console.info(`[ACTION] getPayoutRequests (Admin)`);
    return await request<PayoutRequest[]>('/admin/payouts');
};

export const approvePayoutRequests = (ids: string[]) => {
    console.info(`[ACTION] approvePayoutRequests: ${ids.length} items`);
    return request('/admin/payouts/approve', { method: 'POST', body: JSON.stringify({ ids }) });
};

// --- SYSTEM ADMIN ---

export const getSystemStats = async () => { 
    console.info(`[ACTION] getSystemStats`);
    const raw = await request<any>('/admin/stats'); 
    return {
        totalUsers: raw.totalUsers || raw.total_users || 0,
        totalEvents: raw.totalEvents || raw.total_events || 0,
        grossVolume: raw.grossVolume || raw.gross_volume || 0,
        platformFees: raw.platformFees || raw.platform_fees || 0
    };
};

export const getSystemSettings = async (): Promise<SystemSettings> => {
    console.info(`[ACTION] getSystemSettings`);
    const raw = await request<any>('/system/settings');
    const parseNum = (val: any, fallback: number) => {
        const n = parseFloat(val);
        return isNaN(n) ? fallback : n;
    };
    return {
        platformName: raw.platformName || raw.platform_name || 'Eventsta',
        supportEmail: raw.supportEmail || raw.support_email || '',
        platformFeePercent: parseNum(raw.platformFeePercent ?? raw.platform_fee_percent, 5.9),
        platformFeeFixed: parseNum(raw.platformFeeFixed ?? raw.platform_fee_fixed, 0.35),
        maintenanceMode: !!(raw.maintenanceMode ?? raw.maintenance_mode),
        disableRegistration: !!(raw.disableRegistration ?? raw.disable_registration),
    };
};

export const updateSystemSettings = async (settings: SystemSettings): Promise<SystemSettings> => {
    console.info(`[ACTION] updateSystemSettings`);
    return await request<SystemSettings>('/system/settings', { method: 'PUT', body: JSON.stringify(settings) });
};

export const getEmailDrafts = async (): Promise<EmailDraft[]> => {
    console.info(`[ACTION] getEmailDrafts`);
    return await request<EmailDraft[]>('/admin/email/drafts');
};

export const getSystemEmailTemplates = async (): Promise<SystemEmailTemplate[]> => {
    console.info(`[ACTION] getSystemEmailTemplates`);
    return await request<SystemEmailTemplate[]>('/admin/email/system-templates');
};

export const launchEmailCampaign = async (id: string, role: TargetRole): Promise<EmailCampaign> => {
    console.info(`[ACTION] launchEmailCampaign: Draft ${id} to ${role}`);
    return await request<EmailCampaign>('/admin/email/campaigns', { method: 'POST', body: JSON.stringify({ draft_id: id, target_role: role }) });
};

export const sendTestSystemEmail = async (trigger: string, recipient: string, subject: string, body: string) => {
    console.info(`[ACTION] sendTestSystemEmail: ${trigger} to ${recipient}`);
    return request('/admin/email/send-test', {
        method: 'POST',
        body: JSON.stringify({ trigger, recipient, subject, body })
    });
};

export const getEmailCampaigns = () => {
    console.info(`[ACTION] getEmailCampaigns`);
    return request<EmailCampaign[]>('/admin/email/campaigns');
};

export const saveEmailDraft = (d: EmailDraft) => {
    console.info(`[ACTION] saveEmailDraft`);
    return request('/admin/email/drafts', { method: 'POST', body: JSON.stringify(d) });
};

export const deleteEmailDraft = (id: string) => {
    console.info(`[ACTION] deleteEmailDraft: ${id}`);
    return request(`/admin/email/drafts/${id}`, { method: 'DELETE' });
};

export const getSystemEmailTemplate = (t: SystemEmailTrigger) => {
    console.info(`[ACTION] getSystemEmailTemplate: ${t}`);
    return request<SystemEmailTemplate>(`/admin/email/system-templates/${t}`);
};

export const updateSystemEmailTemplate = (t: SystemEmailTrigger, data: any) => {
    console.info(`[ACTION] updateSystemEmailTemplate: ${t}`);
    return request<SystemEmailTemplate>(`/admin/email/system-templates/${t}`, { method: 'PUT', body: JSON.stringify(data) });
};

export const cancelCampaign = (id: string) => {
    console.info(`[ACTION] cancelCampaign: ${id}`);
    return request<EmailCampaign>(`/admin/email/campaigns/${id}/cancel`, { method: 'POST' });
};

export const getMockLocations = () => {
    console.info(`[ACTION] getMockLocations`);
    return request<string[]>('/locations');
};

export const backfillCommissions = async () => {
    console.info(`[ACTION] backfillCommissions`);
    return request<{ processed: number, message: string }>('/admin/backfill-commissions', { method: 'POST' });
};

export const getRawEvent = (id: string) => {
    console.warn(`[DEPRECATED] getRawEvent called for ${id}. This function is removed.`);
    return undefined; 
};
--- END OF FILE ./services/api/events.ts ---




--- START OF FILE ./services/api/index.ts ---


export * from './core';
export * from './auth';
export * from './events';

--- END OF FILE ./services/api/index.ts ---




--- START OF FILE ./services/api/auth.ts ---


import { User, PromoStat, Payout, PayoutRequest, NotificationPreferences, HostFinancials, LedgerEntry } from '../../types';
import { request, setToken, mapApiUserToFrontend, createHost, MOCK_USER, getEventsByIds } from './core';
import { createEventSlug } from '../../utils/url';

// --- AUTHENTICATION ---

export const checkUserExists = async (email: string): Promise<boolean> => {
    console.info(`[ACTION] checkUserExists: Checking ${email}`);
    const res = await request<{ exists: boolean }>(`/auth/check?email=${encodeURIComponent(email)}`);
    return res.exists;
};

export const registerUser = async (email: string, name: string, role: 'attendee' | 'host', password?: string): Promise<User> => {
    console.info(`[ACTION] registerUser: Registering ${email} as ${role}`);
    const res = await request<any>('/auth/register', {
        method: 'POST',
        body: JSON.stringify({ 
            email, 
            password: password || 'placeholder123', 
            name, 
            role: 'USER' 
        })
    });
    
    if (res.token) setToken(res.token);
    
    try {
        const user = mapApiUserToFrontend(res.user);
        console.info(`[ACTION] registerUser: Auto-creating default host profile for ${user.name}`);
        const newHost = await createHost(user.id, user.name);
        
        if (newHost && newHost.id) {
            user.managedHostIds = [...(user.managedHostIds || []), newHost.id];
        }
        return user;
    } catch (error) {
        console.error("Failed to auto-create default host profile during registration.", error);
        return await getUserProfile();
    }
};

export const signIn = async (provider: string, credentials?: string, userInfo?: { name?: string, email?: string }): Promise<User> => {
    console.info(`[ACTION] signIn: Provider ${provider}`);
    if (provider === 'demo' || provider === 'admin') {
        const mockUser = { 
            ...MOCK_USER, 
            isSystemAdmin: provider === 'admin', 
            id: provider === 'admin' ? 'admin_id' : 'demo_id', 
            name: provider === 'admin' ? 'System Admin' : 'Demo User',
            role: provider === 'admin' ? 'SUPER_ADMIN' : 'USER'
        };
        return mapApiUserToFrontend(mockUser);
    }

    let bodyPayload: any = {};
    let requestedEmail = '';
    
    if (provider === 'email' && credentials) {
        const parts = credentials.split('|');
        requestedEmail = parts[0];
        const password = parts.slice(1).join('|'); 
        bodyPayload = { email: requestedEmail, password };
    } else {
        bodyPayload = { 
            password: 'placeholder-provider-login', 
            provider_token: credentials 
        };
        if (userInfo) {
            if (userInfo.name) bodyPayload.name = userInfo.name;
            if (userInfo.email) {
                bodyPayload.email = userInfo.email;
                requestedEmail = userInfo.email;
            }
        }
    }

    const res = await request<any>('/auth/login', {
        method: 'POST',
        body: JSON.stringify(bodyPayload) 
    });

    if (requestedEmail && res.user && res.user.email) {
        if (requestedEmail.toLowerCase().trim() !== res.user.email.toLowerCase().trim()) {
            console.error(`[CRITICAL SECURITY] Identity Mismatch! Requested: ${requestedEmail}, Returned: ${res.user.email}`);
            console.error("Blocking session creation due to backend logic error.");
            throw new Error("Security Error: The server returned an incorrect user account. Please contact support.");
        }
    }
    
    if (res.token) setToken(res.token);
    
    try {
        const userProfile = await getUserProfile();
        
        if (userProfile.managedHostIds.length === 0) {
             console.info(`[ACTION] signIn: Auto-creating default host profile for ${userProfile.name}`);
             try {
                 const newHost = await createHost(userProfile.id, userProfile.name);
                 userProfile.managedHostIds = [newHost.id];
             } catch (hostErr) {
                 console.warn("Failed to auto-create host on login", hostErr);
             }
        }
        
        return userProfile;
    } catch (e) {
        console.warn("Failed to fetch full profile after login, using basic response", e);
        return mapApiUserToFrontend(res.user);
    }
};

export const loginWithPassword = async (email: string, password: string): Promise<User> => {
    console.info(`[ACTION] loginWithPassword: ${email}`);
    return signIn('email', `${email}|${password}`);
};

export const getUserProfile = async (): Promise<User> => {
    console.info(`[ACTION] getUserProfile: Fetching 'me'`);
    const me = await request<any>('/users/me');
    
    let promoStats: PromoStat[] = [];
    try {
        const rawPromos = await request<any[]>('/promotions/mine');
        
        const eventIds = [...new Set(rawPromos.map((p: any) => p.event_id || p.eventId))];
        let eventsMap: Record<string, any> = {};
        
        if (eventIds.length > 0) {
            try {
                const events = await getEventsByIds(eventIds);
                events.forEach(e => eventsMap[e.id] = e);
            } catch (e) {
                console.warn("Could not fetch events for promotions enrichment");
            }
        }

        promoStats = rawPromos.map((raw: any) => {
            const evtId = raw.event_id || raw.eventId;
            const event = eventsMap[evtId];
            
            let promoCode = raw.code || raw.promo_code;
            
            if (!promoCode && (raw.link || raw.promoLink)) {
                try {
                    const urlStr = raw.link || raw.promoLink;
                    const match = urlStr.match(/[?&]promo=([^&]+)/);
                    if (match) promoCode = match[1];
                } catch (e) { /* ignore */ }
            }

            let finalLink = raw.link || raw.promoLink || '';
            const titleForSlug = event?.title || raw.event_title || raw.eventName || 'event';
            
            if (promoCode && evtId && typeof window !== 'undefined') {
                 const slug = createEventSlug(titleForSlug, evtId);
                 finalLink = `${window.location.origin}/event/${slug}?promo=${promoCode}`;
            }

            const commissionRate = raw.commission_rate || event?.commission || 0;
            const salesVolume = raw.sales_volume || raw.sales || 0;
            let earnedAmount = typeof raw.earned_amount === 'number' ? raw.earned_amount : (raw.earned || 0);

            if (earnedAmount === 0 && salesVolume > 0 && commissionRate > 0) {
                earnedAmount = salesVolume * (commissionRate / 100);
            }

            return {
                eventId: evtId,
                eventName: raw.event_title || raw.eventName || event?.title || 'Unknown Event',
                promoLink: finalLink,
                clicks: raw.clicks || 0, 
                sales: raw.sales_count || raw.sales || 0,
                commissionPct: commissionRate, 
                earned: earnedAmount,
                status: raw.status || 'active'
            };
        });

    } catch (e) {
        console.warn("[WARN] Failed to load promotions for profile (non-critical)", e);
    }
    
    let payouts: Payout[] = [];
    
    return mapApiUserToFrontend(me, promoStats, payouts);
};

export const getUserPayoutRequests = async (): Promise<PayoutRequest[]> => {
    console.info(`[ACTION] getUserPayoutRequests`);
    try {
        return await request<PayoutRequest[]>('/payouts/mine');
    } catch (e) {
        console.warn("Failed to fetch user payout requests, returning empty.", e);
        return [];
    }
};

export const requestPasswordReset = (email: string) => {
    console.info(`[ACTION] requestPasswordReset: ${email}`);
    return request('/auth/forgot-password', { method: 'POST', body: JSON.stringify({ email }) });
};

export const changePassword = (userId: string, current: string, newPass: string) => {
    console.info(`[ACTION] changePassword: ${userId}`);
    return request('/auth/change-password', { method: 'POST', body: JSON.stringify({ current_password: current, new_password: newPass }) });
};

export const deleteAccount = (userId: string) => {
    console.info(`[ACTION] deleteAccount: ${userId}`);
    return request(`/users/${userId}`, { method: 'DELETE' });
};

export const updateNotificationPreferences = (userId: string, prefs: NotificationPreferences) => {
    console.info(`[ACTION] updateNotificationPreferences: ${userId}`);
    return request<User>(`/users/${userId}/notifications`, { method: 'PUT', body: JSON.stringify(prefs) });
};

export const updateUser = (userId: string, data: Partial<User>) => {
    console.info(`[ACTION] updateUser: ${userId}`);
    return request<User>(`/users/${userId}`, { method: 'PATCH', body: JSON.stringify(data) });
};

export const updateUserStatus = (userId: string, status: boolean) => {
    console.info(`[ACTION] updateUserStatus: ${userId} -> disabled: ${status}`);
    return request<User>(`/admin/users/${userId}/status`, { method: 'PUT', body: JSON.stringify({ is_disabled: status }) });
};

export const getAllUsersAdmin = async (page: number, limit: number, search: string) => {
    console.info(`[ACTION] getAllUsersAdmin: Page ${page}`);
    const res = await request<{ users: any[], total: number }>(`/admin/users?page=${page}&limit=${limit}&search=${encodeURIComponent(search)}`);
    return {
        users: (res.users || []).map(u => mapApiUserToFrontend(u)),
        total: res.total || 0
    };
};

export const getStripeConnectionStatus = () => {
    console.info(`[ACTION] getStripeConnectionStatus`);
    return request<{ connected: boolean, accountId: string | null }>('/users/me/stripe/status');
};

export const connectStripeAccount = () => {
    console.info(`[ACTION] connectStripeAccount`);
    return request<{ success: boolean, accountId: string }>('/users/me/stripe/connect', { method: 'POST' });
};

export const disconnectStripeAccount = () => {
    console.info(`[ACTION] disconnectStripeAccount`);
    return request('/users/me/stripe/disconnect', { method: 'POST' });
};

export const getHostFinancials = async (userId: string): Promise<HostFinancials> => {
    console.info(`[ACTION] getHostFinancials: ${userId}`);
    const raw = await request<any>(`/users/${userId}/financials`);
    return {
        grossVolume: typeof raw.grossVolume === 'number' ? raw.grossVolume : 0,
        platformFees: typeof raw.platformFees === 'number' ? raw.platformFees : 0,
        netRevenue: typeof raw.netRevenue === 'number' ? raw.netRevenue : 0,
        pendingBalance: typeof raw.pendingBalance === 'number' ? raw.pendingBalance : (raw.balance || 0),
        totalPayouts: typeof raw.totalPayouts === 'number' ? raw.totalPayouts : 0,
        payouts: Array.isArray(raw.payouts) ? raw.payouts : []
    };
};

export const getLedgerHistory = async (userId: string): Promise<LedgerEntry[]> => {
    console.info(`[ACTION] getLedgerHistory: ${userId}`);
    try {
        const raw = await request<any[]>(`/users/${userId}/ledger`);
        return raw.map(entry => ({
            id: entry.id,
            userId: entry.user_id,
            type: entry.type,
            amount: entry.amount,
            referenceId: entry.reference_id,
            description: entry.description,
            status: entry.status,
            createdAt: entry.created_at
        }));
    } catch (e) {
        console.warn("Failed to fetch ledger history", e);
        return [];
    }
};

export const getProfileForView = (id: string) => {
    console.info(`[ACTION] getProfileForView: ${id}`);
    return request<User>(`/users/${id}/public`); 
};

export const updateUserProfile = (id: string, data: any) => {
    console.info(`[ACTION] updateUserProfile: ${id}`);
    return request<User>(`/users/${id}/profile`, { method: 'PUT', body: JSON.stringify(data) });
};

export const getAllArtists = () => {
    console.info(`[ACTION] getAllArtists`);
    return request<User[]>('/artists');
};

export const connectUserStripe = async (userId: string) => {
    console.info(`[ACTION] connectUserStripe: ${userId}`);
    return await request<any>('/users/me/stripe/connect', { method: 'POST' });
};

export const disconnectUserStripe = async (userId: string) => {
    console.info(`[ACTION] disconnectUserStripe: ${userId}`);
    return await request<any>('/users/me/stripe/disconnect', { method: 'POST' });
};

--- END OF FILE ./services/api/auth.ts ---




--- START OF FILE ./services/emailService.ts ---

import { Order, User, PayoutRequest, SystemEmailTrigger } from '../types';
import * as api from './api';

// Mock Email Service to simulate Transactional Emails using System Templates

const LOG_STYLE = "background: #222; color: #bada55; padding: 4px; border-radius: 4px;";

/**
 * Helper to fetch the template, replace variables, and "send" (log) the email.
 */
const sendTemplateEmail = async (
    trigger: SystemEmailTrigger, 
    recipientEmail: string, 
    variables: Record<string, string>
) => {
    try {
        const [template, settings] = await Promise.all([
            api.getSystemEmailTemplate(trigger),
            api.getSystemSettings()
        ]);

        if (!template) {
            console.error(`Template for trigger ${trigger} not found.`);
            return;
        }

        let subject = template.subject;
        let body = template.body;

        // Inject Global Platform Variables
        const allVariables = {
            ...variables,
            platform_name: settings.platformName,
            support_email: settings.supportEmail
        };

        // Replace variables in Subject and Body
        Object.entries(allVariables).forEach(([key, value]) => {
            const placeholder = `{{${key}}}`;
            // Simple replaceAll
            subject = subject.split(placeholder).join(value);
            body = body.split(placeholder).join(value);
        });

        console.group(`ðŸ“§ Sending System Email: [${trigger}] ${subject}`);
        console.log(`From: ${settings.platformName} <noreply@eventsta.com>`);
        console.log(`To: ${recipientEmail}`);
        console.log('%c[HTML Content]', LOG_STYLE);
        console.log(body);
        console.groupEnd();

    } catch (error) {
        console.error(`Failed to send email for ${trigger}`, error);
    }
};

export const sendOrderConfirmation = async (order: Order, eventName: string, eventDate: string, location: string) => {
    const ticketId = order.items[0]?.ticketType || 'TICKET';
    const qrCodeLink = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${order.orderId}`;
    
    // Create summary of tickets
    const ticketSummary = `<ul>${order.items.map(item => `<li>${item.quantity}x ${item.ticketType} - $${item.pricePerTicket.toFixed(2)}</li>`).join('')}</ul>`;

    await sendTemplateEmail('ORDER_CONFIRMATION', order.purchaserEmail, {
        user_name: order.purchaserName,
        event_name: eventName,
        event_date: new Date(eventDate).toLocaleString(),
        event_location: location,
        order_id: order.orderId,
        total_paid: `$${order.totalPaid.toFixed(2)}`,
        ticket_summary: ticketSummary,
        qr_code_link: `<img src="${qrCodeLink}" alt="QR Code" />`
    });
};

export const sendPasswordResetEmail = async (email: string, token: string) => {
    const resetLink = `${window.location.origin}/reset-password?token=${token}`;
    
    await sendTemplateEmail('PASSWORD_RESET', email, {
        user_name: 'User', // We might not have name if only email provided, simplified
        reset_link: resetLink
    });
};

export const sendPayoutNotification = async (request: PayoutRequest) => {
    await sendTemplateEmail('PAYOUT_PROCESSED', request.userEmail, {
        user_name: request.userName,
        amount: `$${request.amount.toFixed(2)}`,
        payout_id: request.id
    });
};

export const sendEventReminder = async (email: string, eventName: string, eventDate: string) => {
    await sendTemplateEmail('EVENT_REMINDER', email, {
        user_name: 'Valued Attendee', // Generic for bulk
        event_name: eventName,
        event_date: new Date(eventDate).toLocaleString(),
        event_location: 'Check event page' // Simplified
    });
};

// Exposed for Admin "Send Test" functionality
export const sendTestSystemEmail = async (trigger: SystemEmailTrigger, to: string, subject: string, body: string) => {
    return api.sendTestSystemEmail(trigger, to, subject, body);
}
--- END OF FILE ./services/emailService.ts ---




--- START OF FILE ./backend_host_image_instructions.md ---


# Backend API Changes Required: Host Image Handling

## Overview
The frontend has been updated to upload Host profile images and cover images to the file server first, and then send the resulting URL to the API. 

Previously, the frontend might have been sending Base64 strings. This change ensures better performance and smaller database payloads.

## Required Changes

### 1. Database Schema
Ensure the `hosts` table columns for images are standard `VARCHAR` or `TEXT` fields capable of storing URLs.
*   `image_url` (or `imageUrl`)
*   `cover_image_url` (or `coverImageUrl`)

**Do not** use `BLOB` or binary types for these fields if you are storing the URL.

### 2. Update Endpoint (`PATCH /hosts/:id`)
The endpoint must accept standard string URLs for the image fields.

**Payload Example:**
```json
{
  "name": "My Host Name",
  "description": "...",
  "imageUrl": "https://api.eventsta.com/uploads/profile_123.jpg", 
  "coverImageUrl": "https://api.eventsta.com/uploads/cover_456.jpg",
  "reviewsEnabled": true
}
```

**Validation Logic:**
*   If your backend currently validates for Base64 format on these fields, **remove that validation**.
*   Accept valid URL strings.
*   Sanitize inputs to prevent XSS (standard practice).

### 3. File Upload Endpoint (`POST /upload`)
Ensure the existing `/upload` endpoint (used for Event images) is accessible to authenticated users for Host image uploads as well. No specific change is likely needed here if it's already generic.

--- END OF FILE ./backend_host_image_instructions.md ---



